/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { LogService, UserPreferencesService, UserPreferenceValues, FormFieldModel, FormModel } from '@alfresco/adf-core';
import { Component, EventEmitter, Input, Output, ViewEncapsulation } from '@angular/core';
import { DateAdapter, MAT_DATE_FORMATS } from '@angular/material/core';
import { MOMENT_DATE_FORMATS, MomentDateAdapter } from '@alfresco/adf-core';
import moment from 'moment-es6';
import { of } from 'rxjs';
import { TaskDetailsModel } from '../models/task-details.model';
import { TaskListService } from './../services/tasklist.service';
import { switchMap, defaultIfEmpty } from 'rxjs/operators';
import { FormBuilder, Validators, FormControl } from '@angular/forms';
var ɵ0 = MOMENT_DATE_FORMATS;
var StartTaskComponent = /** @class */ (function () {
    /**
     * Constructor
     * @param auth
     * @param translate
     * @param taskService
     */
    function StartTaskComponent(taskService, dateAdapter, userPreferencesService, formBuilder, logService) {
        this.taskService = taskService;
        this.dateAdapter = dateAdapter;
        this.userPreferencesService = userPreferencesService;
        this.formBuilder = formBuilder;
        this.logService = logService;
        this.FORMAT_DATE = 'DD/MM/YYYY';
        this.MAX_LENGTH = 255;
        /**
         * Default Task Name.
         */
        this.name = '';
        /**
         * Emitted when the task is successfully created.
         */
        this.success = new EventEmitter();
        /**
         * Emitted when the cancel button is clicked by the user.
         */
        this.cancel = new EventEmitter();
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
        this.taskDetailsModel = new TaskDetailsModel();
        this.dateError = false;
        this.maxTaskNameLength = this.MAX_LENGTH;
        this.loading = false;
    }
    /**
     * @return {?}
     */
    StartTaskComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.name) {
            this.taskDetailsModel.name = this.name;
        }
        this.validateMaxTaskNameLength();
        this.field = new FormFieldModel(new FormModel(), { id: this.assigneeId, value: this.assigneeId, placeholder: 'Assignee' });
        this.userPreferencesService.select(UserPreferenceValues.Locale).subscribe(function (locale) {
            _this.dateAdapter.setLocale(locale);
        });
        this.loadFormsTask();
        this.buildForm();
    };
    /**
     * @return {?}
     */
    StartTaskComponent.prototype.buildForm = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.taskForm = this.formBuilder.group({
            name: new FormControl(this.taskDetailsModel.name, [Validators.required, Validators.maxLength(this.maxTaskNameLength)]),
            description: new FormControl(''),
            formKey: new FormControl('')
        });
        this.taskForm.valueChanges.subscribe(function (taskFormValues) { return _this.setTaskDetails(taskFormValues); });
    };
    /**
     * @param {?} form
     * @return {?}
     */
    StartTaskComponent.prototype.setTaskDetails = /**
     * @param {?} form
     * @return {?}
     */
    function (form) {
        this.taskDetailsModel.name = form.name;
        this.taskDetailsModel.description = form.description;
        this.taskDetailsModel.formKey = form.formKey ? form.formKey.toString() : null;
    };
    /**
     * @return {?}
     */
    StartTaskComponent.prototype.isFormValid = /**
     * @return {?}
     */
    function () {
        return this.taskForm.valid && !this.dateError && !this.loading;
    };
    /**
     * @return {?}
     */
    StartTaskComponent.prototype.saveTask = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.loading = true;
        if (this.appId) {
            this.taskDetailsModel.category = this.appId.toString();
        }
        this.taskService.createNewTask(this.taskDetailsModel)
            .pipe(switchMap(function (createRes) {
            return _this.attachForm(createRes.id, _this.taskDetailsModel.formKey).pipe(defaultIfEmpty(createRes), switchMap(function (attachRes) {
                return _this.assignTaskByUserId(createRes.id, _this.assigneeId).pipe(defaultIfEmpty(attachRes ? attachRes : createRes));
            }));
        }))
            .subscribe(function (res) {
            _this.loading = false;
            _this.success.emit(res);
        }, function (err) {
            _this.loading = false;
            _this.error.emit(err);
            _this.logService.error('An error occurred while creating new task');
        });
    };
    /**
     * @param {?} userId
     * @return {?}
     */
    StartTaskComponent.prototype.getAssigneeId = /**
     * @param {?} userId
     * @return {?}
     */
    function (userId) {
        this.assigneeId = userId;
    };
    /**
     * @private
     * @param {?} taskId
     * @param {?} formKey
     * @return {?}
     */
    StartTaskComponent.prototype.attachForm = /**
     * @private
     * @param {?} taskId
     * @param {?} formKey
     * @return {?}
     */
    function (taskId, formKey) {
        /** @type {?} */
        var response = of();
        if (taskId && formKey) {
            response = this.taskService.attachFormToATask(taskId, parseInt(formKey, 10));
        }
        return response;
    };
    /**
     * @private
     * @param {?} taskId
     * @param {?} userId
     * @return {?}
     */
    StartTaskComponent.prototype.assignTaskByUserId = /**
     * @private
     * @param {?} taskId
     * @param {?} userId
     * @return {?}
     */
    function (taskId, userId) {
        /** @type {?} */
        var response = of();
        if (taskId && userId) {
            response = this.taskService.assignTaskByUserId(taskId, userId);
        }
        return response;
    };
    /**
     * @return {?}
     */
    StartTaskComponent.prototype.onCancel = /**
     * @return {?}
     */
    function () {
        this.cancel.emit();
    };
    /**
     * @private
     * @return {?}
     */
    StartTaskComponent.prototype.loadFormsTask = /**
     * @private
     * @return {?}
     */
    function () {
        this.forms$ = this.taskService.getFormList();
    };
    /**
     * @param {?} user
     * @return {?}
     */
    StartTaskComponent.prototype.isUserNameEmpty = /**
     * @param {?} user
     * @return {?}
     */
    function (user) {
        return !user || (this.isEmpty(user.firstName) && this.isEmpty(user.lastName));
    };
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    StartTaskComponent.prototype.isEmpty = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        return data === undefined || data === null || data.trim().length === 0;
    };
    /**
     * @param {?} firstName
     * @param {?} lastName
     * @param {?=} delimiter
     * @return {?}
     */
    StartTaskComponent.prototype.getDisplayUser = /**
     * @param {?} firstName
     * @param {?} lastName
     * @param {?=} delimiter
     * @return {?}
     */
    function (firstName, lastName, delimiter) {
        if (delimiter === void 0) { delimiter = '-'; }
        firstName = (firstName !== null ? firstName : '');
        lastName = (lastName !== null ? lastName : '');
        return firstName + delimiter + lastName;
    };
    /**
     * @param {?} newDateValue
     * @return {?}
     */
    StartTaskComponent.prototype.onDateChanged = /**
     * @param {?} newDateValue
     * @return {?}
     */
    function (newDateValue) {
        this.dateError = false;
        if (newDateValue) {
            /** @type {?} */
            var momentDate = void 0;
            if (typeof newDateValue === 'string') {
                momentDate = moment(newDateValue, this.FORMAT_DATE, true);
            }
            else {
                momentDate = newDateValue;
            }
            if (momentDate.isValid()) {
                this.taskDetailsModel.dueDate = momentDate.toDate();
            }
            else {
                this.dateError = true;
                this.taskDetailsModel.dueDate = null;
            }
        }
        else {
            this.taskDetailsModel.dueDate = null;
        }
    };
    /**
     * @private
     * @return {?}
     */
    StartTaskComponent.prototype.validateMaxTaskNameLength = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.maxTaskNameLength > this.MAX_LENGTH) {
            this.maxTaskNameLength = this.MAX_LENGTH;
            this.logService.log("the task name length cannot be greater than " + this.MAX_LENGTH);
        }
    };
    Object.defineProperty(StartTaskComponent.prototype, "nameController", {
        get: /**
         * @return {?}
         */
        function () {
            return this.taskForm.get('name');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StartTaskComponent.prototype, "descriptionController", {
        get: /**
         * @return {?}
         */
        function () {
            return this.taskForm.get('description');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StartTaskComponent.prototype, "formKeyController", {
        get: /**
         * @return {?}
         */
        function () {
            return this.taskForm.get('formKey');
        },
        enumerable: true,
        configurable: true
    });
    StartTaskComponent.decorators = [
        { type: Component, args: [{
                    selector: 'adf-start-task',
                    template: "<mat-card fxFlex=\"70%\" class=\"adf-new-task-layout-card\">\n    <mat-card-header fxLayout=\"row\" fxLayoutAlign=\"start center\" fxLayoutGap=\"10px\" class=\"adf-new-task-heading\">\n        <mat-card-title>{{'ADF_TASK_LIST.START_TASK.FORM.TITLE' | translate}}</mat-card-title>\n    </mat-card-header>\n    <mat-card-content>\n        <form [formGroup]=\"taskForm\" fxLayout=\"column\" fxLayoutGap=\"10px\">\n            <div class=\"adf-task-name\">\n                <mat-form-field fxFlex>\n                    <mat-label>{{'ADF_TASK_LIST.START_TASK.FORM.LABEL.NAME' | translate}}</mat-label>\n                    <input \n                        matInput\n                        id=\"name_id\"\n                        formControlName=\"name\">\n                        <mat-error *ngIf=\"nameController.hasError('required')\">\n                            {{ 'ADF_TASK_LIST.START_TASK.FORM.ERROR.REQUIRED' | translate }}\n                        </mat-error>\n                        <mat-error *ngIf=\"nameController.hasError('maxlength')\">\n                            {{ 'ADF_TASK_LIST.START_TASK.FORM.ERROR.MAXIMUM_LENGTH' | translate : { characters : maxTaskNameLength } }}\n                        </mat-error>\n                </mat-form-field>\n            </div>\n            <div class=\"adf-task-description\">\n                <mat-form-field fxFlex>\n                    <mat-label>{{'ADF_TASK_LIST.START_TASK.FORM.LABEL.DESCRIPTION' | translate}}</mat-label>\n                    <textarea\n                        matInput\n                        rows=\"1\"\n                        id=\"description_id\"\n                        formControlName=\"description\">\n                    </textarea>\n                </mat-form-field>\n            </div>\n            <div class=\"input-row\" fxLayout=\"row\" fxLayout.lt-md=\"column\" fxLayoutGap=\"20px\" fxLayoutGap.lt-md=\"0px\">\n                <mat-form-field fxFlex>\n                    <input \n                        matInput\n                        (keyup)=\"onDateChanged($event.srcElement.value)\"\n                        (dateInput)=\"onDateChanged($event.value)\"\n                        [matDatepicker]=\"taskDatePicker\"\n                        placeholder=\"{{'ADF_TASK_LIST.START_TASK.FORM.LABEL.DATE'|translate}}\"\n                        id=\"date_id\">\n                    <mat-datepicker-toggle \n                        matSuffix\n                        [for]=\"taskDatePicker\"></mat-datepicker-toggle>\n                    <mat-datepicker \n                        #taskDatePicker\n                        [touchUi]=\"true\">\n                    </mat-datepicker>\n                    <div class=\"adf-error-text-container\">\n                        <div *ngIf=\"dateError\">\n                            <div class=\"adf-error-text\">{{'ADF_TASK_LIST.START_TASK.FORM.ERROR.DATE'|translate}}</div>\n                            <mat-icon class=\"adf-error-icon\">warning</mat-icon>\n                        </div>\n                    </div>\n                </mat-form-field>\n                <div fxFlex>\n                    <people-widget \n                        (peopleSelected)=\"getAssigneeId($event)\" \n                        [field]=\"field\" \n                        class=\"adf-people-widget-content\"></people-widget>\n                </div>\n            </div>\n            <div class=\"adf-task-form\">\n                <mat-form-field fxFlex=\"48%\" fxFlex.xs=\"100%\">\n                    <mat-label id=\"form_label\">{{'ADF_TASK_LIST.START_TASK.FORM.LABEL.FORM'|translate}}</mat-label>\n                    <mat-select\n                        id=\"form_id\"\n                        class=\"form-control\"\n                        formControlName=\"formKey\">\n                    <mat-option>{{'ADF_TASK_LIST.START_TASK.FORM.LABEL.NONE'|translate}}</mat-option>\n                    <mat-option *ngFor=\"let form of forms$ | async\" [value]=\"form.id\">{{ form.name }}</mat-option>\n                    </mat-select>\n                </mat-form-field>\n            </div>\n        </form>\n    </mat-card-content>\n    <mat-card-actions>\n        <div class=\"adf-new-task-footer\" fxLayout=\"row\" fxLayoutAlign=\"end end\">\n            <button\n                mat-button\n                (click)=\"onCancel()\"\n                id=\"button-cancel\">\n                {{'ADF_TASK_LIST.START_TASK.FORM.ACTION.CANCEL'|translate}}\n            </button>\n            <button\n                color=\"primary\"\n                mat-button\n                [disabled]=\"!isFormValid()\"\n                (click)=\"saveTask()\"\n                id=\"button-start\">\n                {{'ADF_TASK_LIST.START_TASK.FORM.ACTION.START'|translate}}\n            </button>\n        </div>\n    </mat-card-actions>\n</mat-card>\n",
                    providers: [
                        { provide: DateAdapter, useClass: MomentDateAdapter },
                        { provide: MAT_DATE_FORMATS, useValue: ɵ0 }
                    ],
                    encapsulation: ViewEncapsulation.None,
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    StartTaskComponent.ctorParameters = function () { return [
        { type: TaskListService },
        { type: DateAdapter },
        { type: UserPreferencesService },
        { type: FormBuilder },
        { type: LogService }
    ]; };
    StartTaskComponent.propDecorators = {
        appId: [{ type: Input }],
        name: [{ type: Input }],
        success: [{ type: Output }],
        cancel: [{ type: Output }],
        error: [{ type: Output }]
    };
    return StartTaskComponent;
}());
export { StartTaskComponent };
if (false) {
    /** @type {?} */
    StartTaskComponent.prototype.FORMAT_DATE;
    /** @type {?} */
    StartTaskComponent.prototype.MAX_LENGTH;
    /**
     * (required) The id of the app.
     * @type {?}
     */
    StartTaskComponent.prototype.appId;
    /**
     * Default Task Name.
     * @type {?}
     */
    StartTaskComponent.prototype.name;
    /**
     * Emitted when the task is successfully created.
     * @type {?}
     */
    StartTaskComponent.prototype.success;
    /**
     * Emitted when the cancel button is clicked by the user.
     * @type {?}
     */
    StartTaskComponent.prototype.cancel;
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    StartTaskComponent.prototype.error;
    /** @type {?} */
    StartTaskComponent.prototype.taskDetailsModel;
    /** @type {?} */
    StartTaskComponent.prototype.forms$;
    /** @type {?} */
    StartTaskComponent.prototype.assigneeId;
    /** @type {?} */
    StartTaskComponent.prototype.field;
    /** @type {?} */
    StartTaskComponent.prototype.taskForm;
    /** @type {?} */
    StartTaskComponent.prototype.dateError;
    /** @type {?} */
    StartTaskComponent.prototype.maxTaskNameLength;
    /** @type {?} */
    StartTaskComponent.prototype.loading;
    /**
     * @type {?}
     * @private
     */
    StartTaskComponent.prototype.taskService;
    /**
     * @type {?}
     * @private
     */
    StartTaskComponent.prototype.dateAdapter;
    /**
     * @type {?}
     * @private
     */
    StartTaskComponent.prototype.userPreferencesService;
    /**
     * @type {?}
     * @private
     */
    StartTaskComponent.prototype.formBuilder;
    /**
     * @type {?}
     * @private
     */
    StartTaskComponent.prototype.logService;
}
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtdGFzay5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLXByb2Nlc3Mtc2VydmljZXMvIiwic291cmNlcyI6WyJ0YXNrLWxpc3QvY29tcG9uZW50cy9zdGFydC10YXNrLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLHNCQUFzQixFQUFFLG9CQUFvQixFQUFvQixjQUFjLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDM0ksT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRyxPQUFPLEVBQUUsV0FBVyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdkUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDNUUsT0FBTyxNQUFNLE1BQU0sWUFBWSxDQUFDO0FBRWhDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFdEMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLFdBQVcsRUFBbUIsVUFBVSxFQUFhLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO1NBUW5ELG1CQUFtQjtBQU5sRTtJQTJDSTs7Ozs7T0FLRztJQUNILDRCQUFvQixXQUE0QixFQUM1QixXQUFnQyxFQUNoQyxzQkFBOEMsRUFDOUMsV0FBd0IsRUFDeEIsVUFBc0I7UUFKdEIsZ0JBQVcsR0FBWCxXQUFXLENBQWlCO1FBQzVCLGdCQUFX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O2dCQVdsQyxXQUFXO2dCQVhYLFVBQVU7Ozt3QkE0QmQsS0FBSzt1QkFJTCxLQUFLOzBCQUlMLE1BQU07eUJBSU4sTUFBTTt3QkFJTixNQUFNOztJQThLWCx5QkFBQztDQUFBLEFBN01ELElBNk1DO1NBcE1ZLGtCQUFrQjs7O0lBRTNCLHlDQUEwQzs7SUFDMUMsd0NBQXlCOzs7OztJQUd6QixtQ0FDYzs7Ozs7SUFHZCxrQ0FDa0I7Ozs7O0lBR2xCLHFDQUNxRDs7Ozs7SUFHckQsb0NBQ3NEOzs7OztJQUd0RCxtQ0FDbUQ7O0lBRW5ELDhDQUE0RDs7SUFDNUQsb0NBQTJCOztJQUMzQix3Q0FBbUI7O0lBQ25CLG1DQUFzQjs7SUFDdEIsc0NBQW9COztJQUNwQix1Q0FBMkI7O0lBQzNCLCtDQUE0Qzs7SUFDNUMscUNBQWdCOzs7OztJQVFKLHlDQUFvQzs7Ozs7SUFDcEMseUNBQXdDOzs7OztJQUN4QyxvREFBc0Q7Ozs7O0lBQ3RELHlDQUFnQzs7Ozs7SUFDaEMsd0NBQThCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgTG9nU2VydmljZSwgVXNlclByZWZlcmVuY2VzU2VydmljZSwgVXNlclByZWZlcmVuY2VWYWx1ZXMsIFVzZXJQcm9jZXNzTW9kZWwsIEZvcm1GaWVsZE1vZGVsLCBGb3JtTW9kZWwgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgVmlld0VuY2Fwc3VsYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERhdGVBZGFwdGVyLCBNQVRfREFURV9GT1JNQVRTIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvY29yZSc7XG5pbXBvcnQgeyBNT01FTlRfREFURV9GT1JNQVRTLCBNb21lbnREYXRlQWRhcHRlciB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudC1lczYnO1xuaW1wb3J0IHsgTW9tZW50IH0gZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBGb3JtIH0gZnJvbSAnLi4vbW9kZWxzL2Zvcm0ubW9kZWwnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNNb2RlbCB9IGZyb20gJy4uL21vZGVscy90YXNrLWRldGFpbHMubW9kZWwnO1xuaW1wb3J0IHsgVGFza0xpc3RTZXJ2aWNlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy90YXNrbGlzdC5zZXJ2aWNlJztcbmltcG9ydCB7IHN3aXRjaE1hcCwgZGVmYXVsdElmRW1wdHkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBGb3JtQnVpbGRlciwgQWJzdHJhY3RDb250cm9sLCBWYWxpZGF0b3JzLCBGb3JtR3JvdXAsIEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2FkZi1zdGFydC10YXNrJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vc3RhcnQtdGFzay5jb21wb25lbnQuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vc3RhcnQtdGFzay5jb21wb25lbnQuc2NzcyddLFxuICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7IHByb3ZpZGU6IERhdGVBZGFwdGVyLCB1c2VDbGFzczogTW9tZW50RGF0ZUFkYXB0ZXIgfSxcbiAgICAgICAgeyBwcm92aWRlOiBNQVRfREFURV9GT1JNQVRTLCB1c2VWYWx1ZTogTU9NRU5UX0RBVEVfRk9STUFUUyB9XSxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXG59KVxuZXhwb3J0IGNsYXNzIFN0YXJ0VGFza0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG5cbiAgICBwdWJsaWMgRk9STUFUX0RBVEU6IHN0cmluZyA9ICdERC9NTS9ZWVlZJztcbiAgICBNQVhfTEVOR1RIOiBudW1iZXIgPSAyNTU7XG5cbiAgICAvKiogKHJlcXVpcmVkKSBUaGUgaWQgb2YgdGhlIGFwcC4gKi9cbiAgICBASW5wdXQoKVxuICAgIGFwcElkOiBudW1iZXI7XG5cbiAgICAvKiogRGVmYXVsdCBUYXNrIE5hbWUuICovXG4gICAgQElucHV0KClcbiAgICBuYW1lOiBzdHJpbmcgPSAnJztcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIHRhc2sgaXMgc3VjY2Vzc2Z1bGx5IGNyZWF0ZWQuICovXG4gICAgQE91dHB1dCgpXG4gICAgc3VjY2VzczogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGNhbmNlbCBidXR0b24gaXMgY2xpY2tlZCBieSB0aGUgdXNlci4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBjYW5jZWw6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGVycm9yOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgdGFza0RldGFpbHNNb2RlbDogVGFza0RldGFpbHNNb2RlbCA9IG5ldyBUYXNrRGV0YWlsc01vZGVsKCk7XG4gICAgZm9ybXMkOiBPYnNlcnZhYmxlPEZvcm1bXT47XG4gICAgYXNzaWduZWVJZDogbnVtYmVyO1xuICAgIGZpZWxkOiBGb3JtRmllbGRNb2RlbDtcbiAgICB0YXNrRm9ybTogRm9ybUdyb3VwO1xuICAgIGRhdGVFcnJvcjogYm9vbGVhbiA9IGZhbHNlO1xuICAgIG1heFRhc2tOYW1lTGVuZ3RoOiBudW1iZXIgPSB0aGlzLk1BWF9MRU5HVEg7XG4gICAgbG9hZGluZyA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICogQ29uc3RydWN0b3JcbiAgICAgKiBAcGFyYW0gYXV0aFxuICAgICAqIEBwYXJhbSB0cmFuc2xhdGVcbiAgICAgKiBAcGFyYW0gdGFza1NlcnZpY2VcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRhc2tTZXJ2aWNlOiBUYXNrTGlzdFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkYXRlQWRhcHRlcjogRGF0ZUFkYXB0ZXI8TW9tZW50PixcbiAgICAgICAgICAgICAgICBwcml2YXRlIHVzZXJQcmVmZXJlbmNlc1NlcnZpY2U6IFVzZXJQcmVmZXJlbmNlc1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBmb3JtQnVpbGRlcjogRm9ybUJ1aWxkZXIsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIGlmICh0aGlzLm5hbWUpIHtcbiAgICAgICAgICAgIHRoaXMudGFza0RldGFpbHNNb2RlbC5uYW1lID0gdGhpcy5uYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZU1heFRhc2tOYW1lTGVuZ3RoKCk7XG5cbiAgICAgICAgdGhpcy5maWVsZCA9IG5ldyBGb3JtRmllbGRNb2RlbChuZXcgRm9ybU1vZGVsKCksIHsgaWQ6IHRoaXMuYXNzaWduZWVJZCwgdmFsdWU6IHRoaXMuYXNzaWduZWVJZCwgcGxhY2Vob2xkZXI6ICdBc3NpZ25lZScgfSk7XG4gICAgICAgIHRoaXMudXNlclByZWZlcmVuY2VzU2VydmljZS5zZWxlY3QoVXNlclByZWZlcmVuY2VWYWx1ZXMuTG9jYWxlKS5zdWJzY3JpYmUoKGxvY2FsZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5kYXRlQWRhcHRlci5zZXRMb2NhbGUobG9jYWxlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sb2FkRm9ybXNUYXNrKCk7XG4gICAgICAgIHRoaXMuYnVpbGRGb3JtKCk7XG4gICAgfVxuXG4gICAgYnVpbGRGb3JtKCkge1xuICAgICAgICB0aGlzLnRhc2tGb3JtID0gdGhpcy5mb3JtQnVpbGRlci5ncm91cCh7XG4gICAgICAgICAgICBuYW1lOiBuZXcgRm9ybUNvbnRyb2wodGhpcy50YXNrRGV0YWlsc01vZGVsLm5hbWUsIFtWYWxpZGF0b3JzLnJlcXVpcmVkLCBWYWxpZGF0b3JzLm1heExlbmd0aCh0aGlzLm1heFRhc2tOYW1lTGVuZ3RoKV0pLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IG5ldyBGb3JtQ29udHJvbCgnJyksXG4gICAgICAgICAgICBmb3JtS2V5OiBuZXcgRm9ybUNvbnRyb2woJycpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudGFza0Zvcm0udmFsdWVDaGFuZ2VzLnN1YnNjcmliZSgodGFza0Zvcm1WYWx1ZXMpID0+IHRoaXMuc2V0VGFza0RldGFpbHModGFza0Zvcm1WYWx1ZXMpKTtcbiAgICB9XG5cbiAgICBzZXRUYXNrRGV0YWlscyhmb3JtKSB7XG4gICAgICAgIHRoaXMudGFza0RldGFpbHNNb2RlbC5uYW1lID0gZm9ybS5uYW1lO1xuICAgICAgICB0aGlzLnRhc2tEZXRhaWxzTW9kZWwuZGVzY3JpcHRpb24gPSBmb3JtLmRlc2NyaXB0aW9uO1xuICAgICAgICB0aGlzLnRhc2tEZXRhaWxzTW9kZWwuZm9ybUtleSA9IGZvcm0uZm9ybUtleSA/IGZvcm0uZm9ybUtleS50b1N0cmluZygpIDogbnVsbDtcbiAgICB9XG5cbiAgICBpc0Zvcm1WYWxpZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGFza0Zvcm0udmFsaWQgJiYgIXRoaXMuZGF0ZUVycm9yICYmICF0aGlzLmxvYWRpbmc7XG4gICAgfVxuXG4gICAgcHVibGljIHNhdmVUYXNrKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xuICAgICAgICBpZiAodGhpcy5hcHBJZCkge1xuICAgICAgICAgICAgdGhpcy50YXNrRGV0YWlsc01vZGVsLmNhdGVnb3J5ID0gdGhpcy5hcHBJZC50b1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudGFza1NlcnZpY2UuY3JlYXRlTmV3VGFzayh0aGlzLnRhc2tEZXRhaWxzTW9kZWwpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKGNyZWF0ZVJlczogYW55KSA9PlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaEZvcm0oY3JlYXRlUmVzLmlkLCB0aGlzLnRhc2tEZXRhaWxzTW9kZWwuZm9ybUtleSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRJZkVtcHR5KGNyZWF0ZVJlcyksXG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKGF0dGFjaFJlczogYW55KSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXNzaWduVGFza0J5VXNlcklkKGNyZWF0ZVJlcy5pZCwgdGhpcy5hc3NpZ25lZUlkKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0SWZFbXB0eShhdHRhY2hSZXMgPyBhdHRhY2hSZXMgOiBjcmVhdGVSZXMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzcy5lbWl0KHJlcyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBjcmVhdGluZyBuZXcgdGFzaycpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldEFzc2lnbmVlSWQodXNlcklkKSB7XG4gICAgICAgIHRoaXMuYXNzaWduZWVJZCA9IHVzZXJJZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGF0dGFjaEZvcm0odGFza0lkOiBzdHJpbmcsIGZvcm1LZXk6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGxldCByZXNwb25zZSA9IG9mKCk7XG4gICAgICAgIGlmICh0YXNrSWQgJiYgZm9ybUtleSkge1xuICAgICAgICAgICAgcmVzcG9uc2UgPSB0aGlzLnRhc2tTZXJ2aWNlLmF0dGFjaEZvcm1Ub0FUYXNrKHRhc2tJZCwgcGFyc2VJbnQoZm9ybUtleSwgMTApKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3NpZ25UYXNrQnlVc2VySWQodGFza0lkOiBzdHJpbmcsIHVzZXJJZDogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbGV0IHJlc3BvbnNlID0gb2YoKTtcbiAgICAgICAgaWYgKHRhc2tJZCAmJiB1c2VySWQpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy50YXNrU2VydmljZS5hc3NpZ25UYXNrQnlVc2VySWQodGFza0lkLCB1c2VySWQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25DYW5jZWwoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY2FuY2VsLmVtaXQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxvYWRGb3Jtc1Rhc2soKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZm9ybXMkID0gdGhpcy50YXNrU2VydmljZS5nZXRGb3JtTGlzdCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc1VzZXJOYW1lRW1wdHkodXNlcjogVXNlclByb2Nlc3NNb2RlbCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gIXVzZXIgfHwgKHRoaXMuaXNFbXB0eSh1c2VyLmZpcnN0TmFtZSkgJiYgdGhpcy5pc0VtcHR5KHVzZXIubGFzdE5hbWUpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRW1wdHkoZGF0YTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBkYXRhID09PSB1bmRlZmluZWQgfHwgZGF0YSA9PT0gbnVsbCB8fCBkYXRhLnRyaW0oKS5sZW5ndGggPT09IDA7XG4gICAgfVxuXG4gICAgcHVibGljIGdldERpc3BsYXlVc2VyKGZpcnN0TmFtZTogc3RyaW5nLCBsYXN0TmFtZTogc3RyaW5nLCBkZWxpbWl0ZXI6IHN0cmluZyA9ICctJyk6IHN0cmluZyB7XG4gICAgICAgIGZpcnN0TmFtZSA9IChmaXJzdE5hbWUgIT09IG51bGwgPyBmaXJzdE5hbWUgOiAnJyk7XG4gICAgICAgIGxhc3ROYW1lID0gKGxhc3ROYW1lICE9PSBudWxsID8gbGFzdE5hbWUgOiAnJyk7XG4gICAgICAgIHJldHVybiBmaXJzdE5hbWUgKyBkZWxpbWl0ZXIgKyBsYXN0TmFtZTtcbiAgICB9XG5cbiAgICBvbkRhdGVDaGFuZ2VkKG5ld0RhdGVWYWx1ZTogYW55KSB7XG4gICAgICAgIHRoaXMuZGF0ZUVycm9yID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKG5ld0RhdGVWYWx1ZSkge1xuICAgICAgICAgICAgbGV0IG1vbWVudERhdGU7XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3RGF0ZVZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIG1vbWVudERhdGUgPSBtb21lbnQobmV3RGF0ZVZhbHVlLCB0aGlzLkZPUk1BVF9EQVRFLCB0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbW9tZW50RGF0ZSA9IG5ld0RhdGVWYWx1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG1vbWVudERhdGUuaXNWYWxpZCgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy50YXNrRGV0YWlsc01vZGVsLmR1ZURhdGUgPSBtb21lbnREYXRlLnRvRGF0ZSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGVFcnJvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy50YXNrRGV0YWlsc01vZGVsLmR1ZURhdGUgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50YXNrRGV0YWlsc01vZGVsLmR1ZURhdGUgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZU1heFRhc2tOYW1lTGVuZ3RoKCkge1xuICAgICAgICBpZiAodGhpcy5tYXhUYXNrTmFtZUxlbmd0aCA+IHRoaXMuTUFYX0xFTkdUSCkge1xuICAgICAgICAgICAgdGhpcy5tYXhUYXNrTmFtZUxlbmd0aCA9IHRoaXMuTUFYX0xFTkdUSDtcbiAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5sb2coYHRoZSB0YXNrIG5hbWUgbGVuZ3RoIGNhbm5vdCBiZSBncmVhdGVyIHRoYW4gJHt0aGlzLk1BWF9MRU5HVEh9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXQgbmFtZUNvbnRyb2xsZXIoKTogQWJzdHJhY3RDb250cm9sIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGFza0Zvcm0uZ2V0KCduYW1lJyk7XG4gICAgfVxuXG4gICAgZ2V0IGRlc2NyaXB0aW9uQ29udHJvbGxlcigpOiBBYnN0cmFjdENvbnRyb2wge1xuICAgICAgICByZXR1cm4gdGhpcy50YXNrRm9ybS5nZXQoJ2Rlc2NyaXB0aW9uJyk7XG4gICAgfVxuXG4gICAgZ2V0IGZvcm1LZXlDb250cm9sbGVyKCk6IEFic3RyYWN0Q29udHJvbCB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhc2tGb3JtLmdldCgnZm9ybUtleScpO1xuICAgIH1cbn1cbiJdfQ==