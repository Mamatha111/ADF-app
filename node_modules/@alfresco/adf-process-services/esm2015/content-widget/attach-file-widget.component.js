/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector */
import { Component, ViewEncapsulation } from '@angular/core';
import { UploadWidgetComponent, FormService, LogService, ThumbnailService, ProcessContentService, ActivitiContentService, ContentService, AppConfigValues, AppConfigService } from '@alfresco/adf-core';
import { ContentNodeDialogService } from '@alfresco/adf-content-services';
import { from, zip, of } from 'rxjs';
import { mergeMap } from 'rxjs/operators';
import { AttachFileWidgetDialogService } from './attach-file-widget-dialog.service';
export class AttachFileWidgetComponent extends UploadWidgetComponent {
    /**
     * @param {?} formService
     * @param {?} logger
     * @param {?} thumbnails
     * @param {?} processContentService
     * @param {?} activitiContentService
     * @param {?} contentService
     * @param {?} contentDialog
     * @param {?} appConfigService
     * @param {?} attachDialogService
     */
    constructor(formService, logger, thumbnails, processContentService, activitiContentService, contentService, contentDialog, appConfigService, attachDialogService) {
        super(formService, logger, thumbnails, processContentService);
        this.formService = formService;
        this.logger = logger;
        this.thumbnails = thumbnails;
        this.processContentService = processContentService;
        this.activitiContentService = activitiContentService;
        this.contentService = contentService;
        this.contentDialog = contentDialog;
        this.appConfigService = appConfigService;
        this.attachDialogService = attachDialogService;
        this.repositoryList = [];
        this.tempFilesList = [];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.field &&
            this.field.value &&
            this.field.value.length > 0) {
            this.hasFile = true;
        }
        this.getMultipleFileParam();
        this.activitiContentService.getAlfrescoRepositories(null, true).subscribe((repoList) => {
            this.repositoryList = repoList;
        });
        this.formService.taskSaved.subscribe((formSaved) => {
            if (formSaved.form.id === this.field.form.id) {
                this.tempFilesList = [];
            }
        });
    }
    /**
     * @return {?}
     */
    isFileSourceConfigured() {
        return !!this.field.params && !!this.field.params.fileSource;
    }
    /**
     * @return {?}
     */
    isMultipleSourceUpload() {
        return !this.field.readOnly && this.isFileSourceConfigured() && !this.isOnlyLocalSourceSelected();
    }
    /**
     * @return {?}
     */
    isAllFileSourceSelected() {
        return this.field.params &&
            this.field.params.fileSource &&
            this.field.params.fileSource.serviceId === 'all-file-sources';
    }
    /**
     * @return {?}
     */
    isOnlyLocalSourceSelected() {
        return this.field.params &&
            this.field.params.fileSource &&
            this.field.params.fileSource.serviceId === 'local-file';
    }
    /**
     * @return {?}
     */
    isSimpleUploadButton() {
        return this.isUploadButtonVisible() &&
            !this.isFileSourceConfigured() ||
            this.isOnlyLocalSourceSelected();
    }
    /**
     * @return {?}
     */
    isUploadButtonVisible() {
        return (!this.hasFile || this.multipleOption) && !this.field.readOnly;
    }
    /**
     * @return {?}
     */
    isDefinedSourceFolder() {
        return !!this.field.params &&
            !!this.field.params.fileSource &&
            !!this.field.params.fileSource.selectedFolder;
    }
    /**
     * @param {?} file
     * @return {?}
     */
    isTemporaryFile(file) {
        return this.tempFilesList.findIndex((elem) => elem.name === file.name) >= 0;
    }
    /**
     * @return {?}
     */
    openSelectDialogFromFileSource() {
        /** @type {?} */
        let params = this.field.params;
        if (this.isDefinedSourceFolder()) {
            this.contentDialog.openFileBrowseDialogByFolderId(params.fileSource.selectedFolder.pathId).subscribe((selections) => {
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, this.field.params.fileSource.selectedFolder.accountId, this.field.params.fileSource.selectedFolder.siteId);
            });
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onAttachFileChanged(event) {
        this.tempFilesList.push(...Array.from(event.target.files));
        this.onFileChanged(event);
    }
    /**
     * @param {?} file
     * @return {?}
     */
    onRemoveAttachFile(file) {
        if (this.isTemporaryFile(file)) {
            this.tempFilesList.splice(this.tempFilesList.indexOf(((/** @type {?} */ (file))).contentBlob), 1);
        }
        this.removeFile(file);
    }
    /**
     * @param {?} file
     * @return {?}
     */
    onAttachFileClicked(file) {
        if (file.isExternal) {
            this.logger.info(`The file ${file.name} comes from an external source and cannot be showed at this moment`);
            return;
        }
        if (this.isTemporaryFile(file)) {
            this.formService.formContentClicked.next(file);
        }
        else {
            this.fileClicked(file);
        }
    }
    /**
     * @param {?} file
     * @return {?}
     */
    downloadContent(file) {
        if (this.isTemporaryFile(file)) {
            this.contentService.downloadBlob(((/** @type {?} */ (file))).contentBlob, file.name);
        }
        else {
            this.processContentService.getFileRawContent(((/** @type {?} */ (file))).id).subscribe((blob) => {
                this.contentService.downloadBlob(blob, ((/** @type {?} */ (file))).name);
            }, (err) => {
                this.logger.error('Impossible retrieve content for download');
            });
        }
    }
    /**
     * @param {?} repository
     * @return {?}
     */
    openSelectDialog(repository) {
        /** @type {?} */
        const accountIdentifier = 'alfresco-' + repository.id + '-' + repository.name;
        /** @type {?} */
        let currentECMHost = this.getDomainHost(this.appConfigService.get(AppConfigValues.ECMHOST));
        /** @type {?} */
        let chosenRepositoryHost = this.getDomainHost(repository.repositoryUrl);
        if (chosenRepositoryHost !== currentECMHost) {
            /** @type {?} */
            let formattedRepositoryHost = repository.repositoryUrl.replace('/alfresco', '');
            this.attachDialogService.openLogin(formattedRepositoryHost).subscribe((selections) => {
                selections.forEach((node) => node.isExternal = true);
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, accountIdentifier);
            });
        }
        else {
            this.contentDialog.openFileBrowseDialogBySite().subscribe((selections) => {
                this.tempFilesList.push(...selections);
                this.uploadFileFromCS(selections, accountIdentifier);
            });
        }
    }
    /**
     * @private
     * @param {?} fileNodeList
     * @param {?} accountId
     * @param {?=} siteId
     * @return {?}
     */
    uploadFileFromCS(fileNodeList, accountId, siteId) {
        /** @type {?} */
        const filesSaved = [];
        from(fileNodeList).pipe(mergeMap((node) => zip(of(node.content.mimeType), this.activitiContentService.applyAlfrescoNode(node, siteId, accountId), of(node.isExternal))))
            .subscribe(([mimeType, res, isExternal]) => {
            res.mimeType = mimeType;
            res.isExternal = isExternal;
            filesSaved.push(res);
        }, (error) => {
            this.logger.error(error);
        }, () => {
            this.field.value = filesSaved;
            this.field.json.value = filesSaved;
            this.hasFile = true;
        });
    }
    /**
     * @private
     * @param {?} urlToCheck
     * @return {?}
     */
    getDomainHost(urlToCheck) {
        /** @type {?} */
        let result = urlToCheck.match('^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/?\n]+)');
        return result[1];
    }
}
AttachFileWidgetComponent.decorators = [
    { type: Component, args: [{
                selector: 'attach-widget',
                template: "<div class=\"adf-attach-widget {{field.className}}\"\n    [class.adf-invalid]=\"!field.isValid\"\n    [class.adf-readonly]=\"field.readOnly\">\n    <label class=\"adf-label\" [attr.for]=\"field.id\">{{field.name}}\n        <span *ngIf=\"isRequired()\">*</span>\n    </label>\n    <div class=\"adf-attach-widget-container\">\n        <div id=\"adf-attach-widget-simple-upload\" *ngIf=\"isSimpleUploadButton() && isUploadButtonVisible()\">\n            <a mat-raised-button color=\"primary\">\n                {{ 'FORM.FIELD.UPLOAD' | translate }}\n                <mat-icon>file_upload</mat-icon>\n                <input #uploadFiles\n                        [multiple]=\"multipleOption\"\n                        type=\"file\"\n                        [id]=\"field.id\"\n                        (change)=\"onAttachFileChanged($event)\" />\n            </a>\n        </div>\n        <div class=\"adf-attach-widget__menu-upload\" *ngIf=\"isUploadButtonVisible() && isMultipleSourceUpload()\">\n            <button mat-raised-button color=\"primary\" [matMenuTriggerFor]=\"menu\" [id]=\"field.id\">\n                    {{ 'FORM.FIELD.UPLOAD' | translate }}\n                    <mat-icon>attach_file</mat-icon>\n            </button>\n            <mat-menu #menu=\"matMenu\" class=\"adf-attach-widget__menu-content\">\n                <button mat-menu-item (click)=\"uploadFile.click()\"\n                        id=\"attach-local-file\"\n                        *ngIf=\"isAllFileSourceSelected()\">\n                    {{ 'FORM.FIELD.LOCALSTORAGE' | translate }}\n                    <mat-icon>file_upload</mat-icon>\n                    <input #uploadFile\n                            class=\"adf-attach-widget__input-type\"\n                            [multiple]=\"multipleOption\"\n                            type=\"file\"\n                            [id]=\"field.id\"\n                            (change)=\"onAttachFileChanged($event)\" />\n                </button>\n                <button mat-menu-item\n                        *ngIf=\"isDefinedSourceFolder()\"\n                        id=\"attach-{{field.params?.fileSource?.name}}\"\n                        (click)=\"openSelectDialogFromFileSource()\">\n                        {{field.params?.fileSource?.name}}\n                        <mat-icon>\n                            <img class=\"adf-attach-widget__image-logo\" src=\"../assets/images/alfresco-flower.svg\">\n                        </mat-icon>\n                </button>\n                <div *ngIf=\"!isDefinedSourceFolder()\">\n                    <button mat-menu-item *ngFor=\"let repo of repositoryList\"\n                            id=\"attach-{{repo?.name}}\"\n                           (click)=\"openSelectDialog(repo)\">\n                            {{repo.name}}\n                            <mat-icon>\n                                <img class=\"adf-attach-widget__image-logo\" src=\"../assets/images/alfresco-flower.svg\">\n                            </mat-icon>\n                    </button>\n                </div>\n            </mat-menu>\n        </div>\n    </div>\n</div>\n\n<div id=\"adf-attach-widget-readonly-list\">\n    <mat-list *ngIf=\"hasFile\">\n        <mat-list-item class=\"adf-attach-files-row\" *ngFor=\"let file of field.value\">\n            <img mat-list-icon class=\"adf-attach-widget__icon\"\n                 [id]=\"'file-'+file.id+'-icon'\"\n                 [src]=\"file.content ? getIcon(file.content.mimeType) : getIcon(file.mimeType)\"\n                 [alt]=\"mimeTypeIcon\"\n                 (click)=\"onAttachFileClicked(file)\"\n                 (keyup.enter)=\"onAttachFileClicked(file)\"\n                 role=\"button\"\n                 tabindex=\"0\"/>\n            <span matLine id=\"{{'file-'+file.id}}\" (click)=\"onAttachFileClicked(file)\" (keyup.enter)=\"onAttachFileClicked(file)\"\n                  role=\"button\" tabindex=\"0\" class=\"adf-file\">{{file.name}}</span>\n            <button id=\"{{'file-'+file.id+'-option-menu'}}\" mat-icon-button [matMenuTriggerFor]=\"fileActionMenu\">\n                <mat-icon>more_vert</mat-icon>\n            </button>\n            <mat-menu #fileActionMenu=\"matMenu\" xPosition=\"before\">\n                <button id=\"{{'file-'+file.id+'-show-file'}}\"\n                    [disabled]=\"file.isExternal\"\n                    mat-menu-item (click)=\"onAttachFileClicked(file)\">\n                    <mat-icon>image</mat-icon>\n                    <span>{{ 'FORM.FIELD.SHOW_FILE' | translate }}</span>\n                </button>\n                <button id=\"{{'file-'+file.id+'-download-file'}}\"\n                    mat-menu-item (click)=\"downloadContent(file)\">\n                    <mat-icon>file_download</mat-icon>\n                    <span>{{ 'FORM.FIELD.DOWNLOAD_FILE' | translate }}</span>\n                </button>\n                <button *ngIf=\"!field.readOnly\" id=\"{{'file-'+file.id+'-remove-file'}}\"\n                        mat-menu-item [id]=\"'file-'+file.id+'-remove'\"\n                        (click)=\"onRemoveAttachFile(file);\" (keyup.enter)=\"onRemoveAttachFile(file);\">\n                    <mat-icon class=\"mat-24\">highlight_off</mat-icon>\n                    <span>{{ 'FORM.FIELD.REMOVE_FILE' | translate }}</span>\n                </button>\n            </mat-menu>\n        </mat-list-item>\n    </mat-list>\n</div>\n\n<error-widget [error]=\"field.validationSummary\"></error-widget>\n<error-widget *ngIf=\"isInvalidFieldRequired()\" required=\"{{ 'FORM.FIELD.REQUIRED' | translate }}\"></error-widget>\n",
                host: {
                    '(click)': 'event($event)',
                    '(blur)': 'event($event)',
                    '(change)': 'event($event)',
                    '(focus)': 'event($event)',
                    '(focusin)': 'event($event)',
                    '(focusout)': 'event($event)',
                    '(input)': 'event($event)',
                    '(invalid)': 'event($event)',
                    '(select)': 'event($event)'
                },
                encapsulation: ViewEncapsulation.None,
                styles: [".adf-attach-widget-container{margin-bottom:15px;display:flex;align-items:center}.adf-attach-widget-container input{cursor:pointer;height:100%;right:0;opacity:0;position:absolute;top:0;width:300px;z-index:4}.adf-attach-widget__menu-upload{display:flex;align-items:center}.adf-attach-widget__input-type{width:.1px;height:.1px;opacity:0;overflow:hidden;position:absolute;z-index:-1}.adf-attach-widget__image-logo{padding-left:5px}.adf-attach-widget-repo-button{padding-left:10px}.adf-attach-widget-repo-button .mat-button-wrapper{display:inline}.adf-attach-widget-repo-button .mat-mini-fab.mat-accent{background-color:inherit}.adf-attach-widget{width:100%;word-break:break-all;padding:.4375em 0;border-top:.84375em solid transparent}.adf-attach-widget__icon{padding:6px;float:left;cursor:pointer}.adf-attach-widget__reset{margin-top:-2px}.adf-attach-files-row .mat-line{margin-bottom:0}"]
            }] }
];
/** @nocollapse */
AttachFileWidgetComponent.ctorParameters = () => [
    { type: FormService },
    { type: LogService },
    { type: ThumbnailService },
    { type: ProcessContentService },
    { type: ActivitiContentService },
    { type: ContentService },
    { type: ContentNodeDialogService },
    { type: AppConfigService },
    { type: AttachFileWidgetDialogService }
];
if (false) {
    /** @type {?} */
    AttachFileWidgetComponent.prototype.repositoryList;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.tempFilesList;
    /** @type {?} */
    AttachFileWidgetComponent.prototype.formService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.logger;
    /** @type {?} */
    AttachFileWidgetComponent.prototype.thumbnails;
    /** @type {?} */
    AttachFileWidgetComponent.prototype.processContentService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.activitiContentService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.contentService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.contentDialog;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.appConfigService;
    /**
     * @type {?}
     * @private
     */
    AttachFileWidgetComponent.prototype.attachDialogService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNoLWZpbGUtd2lkZ2V0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtcHJvY2Vzcy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImNvbnRlbnQtd2lkZ2V0L2F0dGFjaC1maWxlLXdpZGdldC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbUJBLE9BQU8sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDckUsT0FBTyxFQUNILHFCQUFxQixFQUNyQixXQUFXLEVBQ1gsVUFBVSxFQUNWLGdCQUFnQixFQUNoQixxQkFBcUIsRUFDckIsc0JBQXNCLEVBQ3RCLGNBQWMsRUFFZCxlQUFlLEVBQ2YsZ0JBQWdCLEVBQ25CLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFMUUsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQW1CcEYsTUFBTSxPQUFPLHlCQUEwQixTQUFRLHFCQUFxQjs7Ozs7Ozs7Ozs7O0lBS2hFLFlBQW1CLFdBQXdCLEVBQ3ZCLE1BQWtCLEVBQ25CLFVBQTRCLEVBQzVCLHFCQUE0QyxFQUMzQyxzQkFBOEMsRUFDOUMsY0FBOEIsRUFDOUIsYUFBdUMsRUFDdkMsZ0JBQWtDLEVBQ2xDLG1CQUFrRDtRQUNsRSxLQUFLLENBQUMsV0FBVyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQVQvQyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN2QixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ25CLGVBQVUsR0FBVixVQUFVLENB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QUksQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztJQUNmLENBQUM7Ozs7OztJQUVPLGFBQWEsQ0FBQyxVQUFVOztZQUN4QixNQUFNLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyx3REFBd0QsQ0FBQztRQUN2RixPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyQixDQUFDOzs7WUFuTUosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxlQUFlO2dCQUN6QixnK0tBQWtEO2dCQUVsRCxJQUFJLEVBQUU7b0JBQ0YsU0FBUyxFQUFFLGVBQWU7b0JBQzFCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixVQUFVLEVBQUUsZUFBZTtvQkFDM0IsU0FBUyxFQUFFLGVBQWU7b0JBQzFCLFdBQVcsRUFBRSxlQUFlO29CQUM1QixZQUFZLEVBQUUsZUFBZTtvQkFDN0IsU0FBUyxFQUFFLGVBQWU7b0JBQzFCLFdBQVcsRUFBRSxlQUFlO29CQUM1QixVQUFVLEVBQUUsZUFBZTtpQkFDOUI7Z0JBQ0QsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7O2FBQ3hDOzs7O1lBaENHLFdBQVc7WUFDWCxVQUFVO1lBQ1YsZ0JBQWdCO1lBQ2hCLHFCQUFxQjtZQUNyQixzQkFBc0I7WUFDdEIsY0FBYztZQUtULHdCQUF3QjtZQUY3QixnQkFBZ0I7WUFNWCw2QkFBNkI7Ozs7SUFxQmxDLG1EQUFvQjs7Ozs7SUFDcEIsa0RBQTJCOztJQUVmLGdEQUErQjs7Ozs7SUFDL0IsMkNBQTBCOztJQUMxQiwrQ0FBbUM7O0lBQ25DLDBEQUFtRDs7Ozs7SUFDbkQsMkRBQXNEOzs7OztJQUN0RCxtREFBc0M7Ozs7O0lBQ3RDLGtEQUErQzs7Ozs7SUFDL0MscURBQTBDOzs7OztJQUMxQyx3REFBMEQiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBWaWV3RW5jYXBzdWxhdGlvbiwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIFVwbG9hZFdpZGdldENvbXBvbmVudCxcbiAgICBGb3JtU2VydmljZSxcbiAgICBMb2dTZXJ2aWNlLFxuICAgIFRodW1ibmFpbFNlcnZpY2UsXG4gICAgUHJvY2Vzc0NvbnRlbnRTZXJ2aWNlLFxuICAgIEFjdGl2aXRpQ29udGVudFNlcnZpY2UsXG4gICAgQ29udGVudFNlcnZpY2UsXG4gICAgRm9ybUV2ZW50LFxuICAgIEFwcENvbmZpZ1ZhbHVlcyxcbiAgICBBcHBDb25maWdTZXJ2aWNlXG59IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMnO1xuaW1wb3J0IHsgTm9kZSwgUmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvbiB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgZnJvbSwgemlwLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBdHRhY2hGaWxlV2lkZ2V0RGlhbG9nU2VydmljZSB9IGZyb20gJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LWRpYWxvZy5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhdHRhY2gtd2lkZ2V0JyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXR0YWNoLWZpbGUtd2lkZ2V0LmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9hdHRhY2gtZmlsZS13aWRnZXQuY29tcG9uZW50LnNjc3MnXSxcbiAgICBob3N0OiB7XG4gICAgICAgICcoY2xpY2spJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGJsdXIpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGNoYW5nZSknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoZm9jdXMpJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGZvY3VzaW4pJzogJ2V2ZW50KCRldmVudCknLFxuICAgICAgICAnKGZvY3Vzb3V0KSc6ICdldmVudCgkZXZlbnQpJyxcbiAgICAgICAgJyhpbnB1dCknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoaW52YWxpZCknOiAnZXZlbnQoJGV2ZW50KScsXG4gICAgICAgICcoc2VsZWN0KSc6ICdldmVudCgkZXZlbnQpJ1xuICAgIH0sXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBBdHRhY2hGaWxlV2lkZ2V0Q29tcG9uZW50IGV4dGVuZHMgVXBsb2FkV2lkZ2V0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICAgIHJlcG9zaXRvcnlMaXN0ID0gW107XG4gICAgcHJpdmF0ZSB0ZW1wRmlsZXNMaXN0ID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgZm9ybVNlcnZpY2U6IEZvcm1TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nZ2VyOiBMb2dTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHB1YmxpYyB0aHVtYm5haWxzOiBUaHVtYm5haWxTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBwcm9jZXNzQ29udGVudFNlcnZpY2U6IFByb2Nlc3NDb250ZW50U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGFjdGl2aXRpQ29udGVudFNlcnZpY2U6IEFjdGl2aXRpQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50U2VydmljZTogQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50RGlhbG9nOiBDb250ZW50Tm9kZURpYWxvZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhcHBDb25maWdTZXJ2aWNlOiBBcHBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXR0YWNoRGlhbG9nU2VydmljZTogQXR0YWNoRmlsZVdpZGdldERpYWxvZ1NlcnZpY2UpIHtcbiAgICAgICAgc3VwZXIoZm9ybVNlcnZpY2UsIGxvZ2dlciwgdGh1bWJuYWlscywgcHJvY2Vzc0NvbnRlbnRTZXJ2aWNlKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZmllbGQgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5oYXNGaWxlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmdldE11bHRpcGxlRmlsZVBhcmFtKCk7XG5cbiAgICAgICAgdGhpcy5hY3Rpdml0aUNvbnRlbnRTZXJ2aWNlLmdldEFsZnJlc2NvUmVwb3NpdG9yaWVzKG51bGwsIHRydWUpLnN1YnNjcmliZSgocmVwb0xpc3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVwb3NpdG9yeUxpc3QgPSByZXBvTGlzdDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5mb3JtU2VydmljZS50YXNrU2F2ZWQuc3Vic2NyaWJlKChmb3JtU2F2ZWQ6IEZvcm1FdmVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZvcm1TYXZlZC5mb3JtLmlkID09PSB0aGlzLmZpZWxkLmZvcm0uaWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRlbXBGaWxlc0xpc3QgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaXNGaWxlU291cmNlQ29uZmlndXJlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5maWVsZC5wYXJhbXMgJiYgISF0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlO1xuICAgIH1cblxuICAgIGlzTXVsdGlwbGVTb3VyY2VVcGxvYWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhdGhpcy5maWVsZC5yZWFkT25seSAmJiB0aGlzLmlzRmlsZVNvdXJjZUNvbmZpZ3VyZWQoKSAmJiAhdGhpcy5pc09ubHlMb2NhbFNvdXJjZVNlbGVjdGVkKCk7XG4gICAgfVxuXG4gICAgaXNBbGxGaWxlU291cmNlU2VsZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpZWxkLnBhcmFtcyAmJlxuICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZSAmJlxuICAgICAgICAgICAgdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZS5zZXJ2aWNlSWQgPT09ICdhbGwtZmlsZS1zb3VyY2VzJztcbiAgICB9XG5cbiAgICBpc09ubHlMb2NhbFNvdXJjZVNlbGVjdGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5maWVsZC5wYXJhbXMgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQucGFyYW1zLmZpbGVTb3VyY2UgJiZcbiAgICAgICAgICAgIHRoaXMuZmllbGQucGFyYW1zLmZpbGVTb3VyY2Uuc2VydmljZUlkID09PSAnbG9jYWwtZmlsZSc7XG4gICAgfVxuXG4gICAgaXNTaW1wbGVVcGxvYWRCdXR0b24oKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzVXBsb2FkQnV0dG9uVmlzaWJsZSgpICYmXG4gICAgICAgICAgICAhdGhpcy5pc0ZpbGVTb3VyY2VDb25maWd1cmVkKCkgfHxcbiAgICAgICAgICAgIHRoaXMuaXNPbmx5TG9jYWxTb3VyY2VTZWxlY3RlZCgpO1xuICAgIH1cblxuICAgIGlzVXBsb2FkQnV0dG9uVmlzaWJsZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICghdGhpcy5oYXNGaWxlIHx8IHRoaXMubXVsdGlwbGVPcHRpb24pICYmICF0aGlzLmZpZWxkLnJlYWRPbmx5O1xuICAgIH1cblxuICAgIGlzRGVmaW5lZFNvdXJjZUZvbGRlcigpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5maWVsZC5wYXJhbXMgJiZcbiAgICAgICAgICAgICEhdGhpcy5maWVsZC5wYXJhbXMuZmlsZVNvdXJjZSAmJlxuICAgICAgICAgICAgISF0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyO1xuICAgIH1cblxuICAgIGlzVGVtcG9yYXJ5RmlsZShmaWxlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRlbXBGaWxlc0xpc3QuZmluZEluZGV4KChlbGVtKSA9PiBlbGVtLm5hbWUgPT09IGZpbGUubmFtZSkgPj0gMDtcbiAgICB9XG5cbiAgICBvcGVuU2VsZWN0RGlhbG9nRnJvbUZpbGVTb3VyY2UoKSB7XG4gICAgICAgIGxldCBwYXJhbXMgPSB0aGlzLmZpZWxkLnBhcmFtcztcbiAgICAgICAgaWYgKHRoaXMuaXNEZWZpbmVkU291cmNlRm9sZGVyKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudERpYWxvZy5vcGVuRmlsZUJyb3dzZURpYWxvZ0J5Rm9sZGVySWQocGFyYW1zLmZpbGVTb3VyY2Uuc2VsZWN0ZWRGb2xkZXIucGF0aElkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKHNlbGVjdGlvbnM6IE5vZGVbXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBGaWxlc0xpc3QucHVzaCguLi5zZWxlY3Rpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlRnJvbUNTKHNlbGVjdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnBhcmFtcy5maWxlU291cmNlLnNlbGVjdGVkRm9sZGVyLmFjY291bnRJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQucGFyYW1zLmZpbGVTb3VyY2Uuc2VsZWN0ZWRGb2xkZXIuc2l0ZUlkKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uQXR0YWNoRmlsZUNoYW5nZWQoZXZlbnQ6IGFueSkge1xuICAgICAgICB0aGlzLnRlbXBGaWxlc0xpc3QucHVzaCguLi5BcnJheS5mcm9tKGV2ZW50LnRhcmdldC5maWxlcykpO1xuICAgICAgICB0aGlzLm9uRmlsZUNoYW5nZWQoZXZlbnQpO1xuICAgIH1cblxuICAgIG9uUmVtb3ZlQXR0YWNoRmlsZShmaWxlOiBGaWxlIHwgUmVsYXRlZENvbnRlbnRSZXByZXNlbnRhdGlvbikge1xuICAgICAgICBpZiAodGhpcy5pc1RlbXBvcmFyeUZpbGUoZmlsZSkpIHtcbiAgICAgICAgICAgIHRoaXMudGVtcEZpbGVzTGlzdC5zcGxpY2UodGhpcy50ZW1wRmlsZXNMaXN0LmluZGV4T2YoKDxSZWxhdGVkQ29udGVudFJlcHJlc2VudGF0aW9uPiBmaWxlKS5jb250ZW50QmxvYiksIDEpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVtb3ZlRmlsZShmaWxlKTtcbiAgICB9XG5cbiAgICBvbkF0dGFjaEZpbGVDbGlja2VkKGZpbGU6IGFueSkge1xuICAgICAgICBpZiAoZmlsZS5pc0V4dGVybmFsKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKGBUaGUgZmlsZSAke2ZpbGUubmFtZX0gY29tZXMgZnJvbSBhbiBleHRlcm5hbCBzb3VyY2UgYW5kIGNhbm5vdCBiZSBzaG93ZWQgYXQgdGhpcyBtb21lbnRgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pc1RlbXBvcmFyeUZpbGUoZmlsZSkpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2UuZm9ybUNvbnRlbnRDbGlja2VkLm5leHQoZmlsZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmZpbGVDbGlja2VkKGZpbGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZG93bmxvYWRDb250ZW50KGZpbGU6IGFueSB8IFJlbGF0ZWRDb250ZW50UmVwcmVzZW50YXRpb24pOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaXNUZW1wb3JhcnlGaWxlKGZpbGUpKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRTZXJ2aWNlLmRvd25sb2FkQmxvYigoPFJlbGF0ZWRDb250ZW50UmVwcmVzZW50YXRpb24+IGZpbGUpLmNvbnRlbnRCbG9iLCBmaWxlLm5hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzQ29udGVudFNlcnZpY2UuZ2V0RmlsZVJhd0NvbnRlbnQoKDxhbnk+IGZpbGUpLmlkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGJsb2I6IEJsb2IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZW50U2VydmljZS5kb3dubG9hZEJsb2IoYmxvYiwgKDxhbnk+IGZpbGUpLm5hbWUpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcignSW1wb3NzaWJsZSByZXRyaWV2ZSBjb250ZW50IGZvciBkb3dubG9hZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvcGVuU2VsZWN0RGlhbG9nKHJlcG9zaXRvcnkpIHtcbiAgICAgICAgY29uc3QgYWNjb3VudElkZW50aWZpZXIgPSAnYWxmcmVzY28tJyArIHJlcG9zaXRvcnkuaWQgKyAnLScgKyByZXBvc2l0b3J5Lm5hbWU7XG4gICAgICAgIGxldCBjdXJyZW50RUNNSG9zdCA9IHRoaXMuZ2V0RG9tYWluSG9zdCh0aGlzLmFwcENvbmZpZ1NlcnZpY2UuZ2V0KEFwcENvbmZpZ1ZhbHVlcy5FQ01IT1NUKSk7XG4gICAgICAgIGxldCBjaG9zZW5SZXBvc2l0b3J5SG9zdCA9IHRoaXMuZ2V0RG9tYWluSG9zdChyZXBvc2l0b3J5LnJlcG9zaXRvcnlVcmwpO1xuICAgICAgICBpZiAoY2hvc2VuUmVwb3NpdG9yeUhvc3QgIT09IGN1cnJlbnRFQ01Ib3N0KSB7XG4gICAgICAgICAgICBsZXQgZm9ybWF0dGVkUmVwb3NpdG9yeUhvc3QgPSByZXBvc2l0b3J5LnJlcG9zaXRvcnlVcmwucmVwbGFjZSgnL2FsZnJlc2NvJywgJycpO1xuICAgICAgICAgICAgdGhpcy5hdHRhY2hEaWFsb2dTZXJ2aWNlLm9wZW5Mb2dpbihmb3JtYXR0ZWRSZXBvc2l0b3J5SG9zdCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChzZWxlY3Rpb25zOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25zLmZvckVhY2goKG5vZGUpID0+IG5vZGUuaXNFeHRlcm5hbCA9IHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBGaWxlc0xpc3QucHVzaCguLi5zZWxlY3Rpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlRnJvbUNTKHNlbGVjdGlvbnMsIGFjY291bnRJZGVudGlmaWVyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudERpYWxvZy5vcGVuRmlsZUJyb3dzZURpYWxvZ0J5U2l0ZSgpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoc2VsZWN0aW9uczogTm9kZVtdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcEZpbGVzTGlzdC5wdXNoKC4uLnNlbGVjdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGVGcm9tQ1Moc2VsZWN0aW9ucywgYWNjb3VudElkZW50aWZpZXIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGxvYWRGaWxlRnJvbUNTKGZpbGVOb2RlTGlzdDogYW55W10sIGFjY291bnRJZDogc3RyaW5nLCBzaXRlSWQ/OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZmlsZXNTYXZlZCA9IFtdO1xuICAgICAgICBmcm9tKGZpbGVOb2RlTGlzdCkucGlwZShcbiAgICAgICAgICAgIG1lcmdlTWFwKChub2RlKSA9PlxuICAgICAgICAgICAgICAgIHppcChcbiAgICAgICAgICAgICAgICAgICAgb2Yobm9kZS5jb250ZW50Lm1pbWVUeXBlKSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpdml0aUNvbnRlbnRTZXJ2aWNlLmFwcGx5QWxmcmVzY29Ob2RlKG5vZGUsIHNpdGVJZCwgYWNjb3VudElkKSxcbiAgICAgICAgICAgICAgICAgICAgb2Yobm9kZS5pc0V4dGVybmFsKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoW21pbWVUeXBlLCByZXMsIGlzRXh0ZXJuYWxdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5taW1lVHlwZSA9IG1pbWVUeXBlO1xuICAgICAgICAgICAgICAgICAgICByZXMuaXNFeHRlcm5hbCA9IGlzRXh0ZXJuYWw7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzU2F2ZWQucHVzaChyZXMpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC52YWx1ZSA9IGZpbGVzU2F2ZWQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQuanNvbi52YWx1ZSA9IGZpbGVzU2F2ZWQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFzRmlsZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXREb21haW5Ib3N0KHVybFRvQ2hlY2spIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHVybFRvQ2hlY2subWF0Y2goJ14oPzpodHRwcz86XFwvXFwvKT8oPzpbXkBcXC9cXG5dK0ApPyg/Ond3d1xcLik/KFteOlxcLz9cXG5dKyknKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdFsxXTtcbiAgICB9XG5cbn1cbiJdfQ==