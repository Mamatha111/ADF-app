/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { AlfrescoApiService, LogService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { from, forkJoin, throwError, of } from 'rxjs';
import { map, catchError, switchMap, flatMap, filter } from 'rxjs/operators';
import { TaskQueryRequestRepresentationModel } from '../models/filter.model';
import { Form } from '../models/form.model';
import { TaskDetailsModel } from '../models/task-details.model';
import { TaskListModel } from '../models/task-list.model';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class TaskListService {
    /**
     * @param {?} apiService
     * @param {?} logService
     */
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    /**
     * Gets all the filters in the list that belong to a task.
     * @param {?} taskId ID of the target task
     * @param {?} filterList List of filters to search through
     * @return {?} Filters belonging to the task
     */
    getFilterForTaskById(taskId, filterList) {
        return from(filterList)
            .pipe(flatMap((data) => this.isTaskRelatedToFilter(taskId, data)), filter((data) => data != null));
    }
    /**
     * Gets the search query for a task based on the supplied filter.
     * @private
     * @param {?} filterModel
     * @return {?} The search query
     */
    generateTaskRequestNodeFromFilter(filterModel) {
        /** @type {?} */
        let requestNode = {
            appDefinitionId: filterModel.appId,
            assignment: filterModel.filter.assignment,
            state: filterModel.filter.state,
            sort: filterModel.filter.sort
        };
        return new TaskQueryRequestRepresentationModel(requestNode);
    }
    /**
     * Checks if a taskId is filtered with the given filter.
     * @param {?} taskId ID of the target task
     * @param {?} filterModel The filter you want to check
     * @return {?} The filter if it is related or null otherwise
     */
    isTaskRelatedToFilter(taskId, filterModel) {
        /** @type {?} */
        let requestNodeForFilter = this.generateTaskRequestNodeFromFilter(filterModel);
        return from(this.callApiTasksFiltered(requestNodeForFilter))
            .pipe(map((res) => {
            return res.data.find((element) => element.id === taskId) ? filterModel : null;
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Gets all the tasks matching the supplied query.
     * @param {?} requestNode Query to search for tasks
     * @return {?} List of tasks
     */
    getTasks(requestNode) {
        return from(this.callApiTasksFiltered(requestNode))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * Gets tasks matching a query and state value.
     * @param {?} requestNode Query to search for tasks
     * @param {?=} state Task state. Can be "open" or "completed".
     * @return {?} List of tasks
     */
    findTasksByState(requestNode, state) {
        if (state) {
            requestNode.state = state;
        }
        return this.getTasks(requestNode)
            .pipe(catchError(() => of(new TaskListModel())));
    }
    /**
     * Gets all tasks matching a query and state value.
     * @param {?} requestNode Query to search for tasks.
     * @param {?=} state Task state. Can be "open" or "completed".
     * @return {?} List of tasks
     */
    findAllTaskByState(requestNode, state) {
        if (state) {
            requestNode.state = state;
        }
        return this.getTotalTasks(requestNode)
            .pipe(switchMap((res) => {
            requestNode.size = res.total;
            return this.getTasks(requestNode);
        }));
    }
    /**
     * Gets all tasks matching the supplied query but ignoring the task state.
     * @param {?} requestNode Query to search for tasks
     * @return {?} List of tasks
     */
    findAllTasksWithoutState(requestNode) {
        return forkJoin(this.findTasksByState(requestNode, 'open'), this.findAllTaskByState(requestNode, 'completed'), (activeTasks, completedTasks) => {
            /** @type {?} */
            const tasks = Object.assign({}, activeTasks);
            tasks.total += completedTasks.total;
            tasks.data = tasks.data.concat(completedTasks.data);
            return tasks;
        });
    }
    /**
     * Gets details for a task.
     * @param {?} taskId ID of the target task.
     * @return {?} Task details
     */
    getTaskDetails(taskId) {
        return from(this.callApiTaskDetails(taskId))
            .pipe(map((details) => {
            return new TaskDetailsModel(details);
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Gets the checklist for a task.
     * @param {?} id ID of the target task
     * @return {?} Array of checklist task details
     */
    getTaskChecklist(id) {
        return from(this.callApiTaskChecklist(id))
            .pipe(map((response) => {
            /** @type {?} */
            const checklists = [];
            response.data.forEach((checklist) => {
                checklists.push(new TaskDetailsModel(checklist));
            });
            return checklists;
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Gets all available reusable forms.
     * @return {?} Array of form details
     */
    getFormList() {
        /** @type {?} */
        let opts = {
            'filter': 'myReusableForms',
            // String | filter
            'sort': 'modifiedDesc',
            // String | sort
            'modelType': 2 // Integer | modelType
        };
        return from(this.apiService.getInstance().activiti.modelsApi.getModels(opts))
            .pipe(map((response) => {
            /** @type {?} */
            let forms = [];
            response.data.forEach((form) => {
                forms.push(new Form(form.id, form.name));
            });
            return forms;
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Attaches a form to a task.
     * @param {?} taskId ID of the target task
     * @param {?} formId ID of the form to add
     * @return {?} Null response notifying when the operation is complete
     */
    attachFormToATask(taskId, formId) {
        return from(this.apiService.taskApi.attachForm(taskId, { 'formId': formId }))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * Adds a subtask (ie, a checklist task) to a parent task.
     * @param {?} task The task to add
     * @return {?} The subtask that was added
     */
    addTask(task) {
        return from(this.callApiAddTask(task))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Deletes a subtask (ie, a checklist task) from a parent task.
     * @param {?} taskId The task to delete
     * @return {?} Null response notifying when the operation is complete
     */
    deleteTask(taskId) {
        return from(this.callApiDeleteTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * Deletes a form from a task.
     * @param {?} taskId Task id related to form
     * @return {?} Null response notifying when the operation is complete
     */
    deleteForm(taskId) {
        return from(this.callApiDeleteForm(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * Gives completed status to a task.
     * @param {?} taskId ID of the target task
     * @return {?} Null response notifying when the operation is complete
     */
    completeTask(taskId) {
        return from(this.apiService.taskApi.completeTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * Gets the total number of the tasks found by a query.
     * @param {?} requestNode Query to search for tasks
     * @return {?} Number of tasks
     */
    getTotalTasks(requestNode) {
        requestNode.size = 0;
        return from(this.callApiTasksFiltered(requestNode))
            .pipe(map((res) => {
            return res;
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Creates a new standalone task.
     * @param {?} task Details of the new task
     * @return {?} Details of the newly created task
     */
    createNewTask(task) {
        return from(this.callApiCreateTask(task))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Assigns a task to a user or group.
     * @param {?} taskId The task to assign
     * @param {?} requestNode User or group to assign the task to
     * @return {?} Details of the assigned task
     */
    assignTask(taskId, requestNode) {
        /** @type {?} */
        let assignee = { assignee: requestNode.id };
        return from(this.callApiAssignTask(taskId, assignee))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Assigns a task to a user.
     * @param {?} taskId ID of the task to assign
     * @param {?} userId ID of the user to assign the task to
     * @return {?} Details of the assigned task
     */
    assignTaskByUserId(taskId, userId) {
        /** @type {?} */
        const assignee = (/** @type {?} */ ({ assignee: userId }));
        return from(this.callApiAssignTask(taskId, assignee))
            .pipe(map((response) => {
            return new TaskDetailsModel(response);
        }), catchError((err) => this.handleError(err)));
    }
    /**
     * Claims a task for the current user.
     * @param {?} taskId ID of the task to claim
     * @return {?} Details of the claimed task
     */
    claimTask(taskId) {
        return from(this.apiService.taskApi.claimTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * Un-claims a task for the current user.
     * @param {?} taskId ID of the task to unclaim
     * @return {?} Null response notifying when the operation is complete
     */
    unclaimTask(taskId) {
        return from(this.apiService.taskApi.unclaimTask(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * Updates the details (name, description, due date) for a task.
     * @param {?} taskId ID of the task to update
     * @param {?} updated Data to update the task (as a `TaskUpdateRepresentation` instance).
     * @return {?} Updated task details
     */
    updateTask(taskId, updated) {
        return from(this.apiService.taskApi.updateTask(taskId, updated))
            .pipe(map((result) => (/** @type {?} */ (result))), catchError((err) => this.handleError(err)));
    }
    /**
     * Fetches the Task Audit information in PDF format.
     * @param {?} taskId ID of the target task
     * @return {?} Binary PDF data
     */
    fetchTaskAuditPdfById(taskId) {
        return from(this.apiService.taskApi.getTaskAuditPdf(taskId))
            .pipe(map((data) => (/** @type {?} */ (data))), catchError((err) => this.handleError(err)));
    }
    /**
     * Fetch the Task Audit information in JSON format
     * @param {?} taskId ID of the target task
     * @return {?} JSON data
     */
    fetchTaskAuditJsonById(taskId) {
        return from(this.apiService.taskApi.getTaskAuditJson(taskId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    /**
     * @private
     * @param {?} requestNode
     * @return {?}
     */
    callApiTasksFiltered(requestNode) {
        return this.apiService.taskApi.listTasks(requestNode);
    }
    /**
     * @private
     * @param {?} taskId
     * @return {?}
     */
    callApiTaskDetails(taskId) {
        return this.apiService.taskApi.getTask(taskId);
    }
    /**
     * @private
     * @param {?} task
     * @return {?}
     */
    callApiAddTask(task) {
        return this.apiService.taskApi.addSubtask(task.parentTaskId, task);
    }
    /**
     * @private
     * @param {?} taskId
     * @return {?}
     */
    callApiDeleteTask(taskId) {
        return this.apiService.taskApi.deleteTask(taskId);
    }
    /**
     * @private
     * @param {?} taskId
     * @return {?}
     */
    callApiDeleteForm(taskId) {
        return this.apiService.taskApi.removeForm(taskId);
    }
    /**
     * @private
     * @param {?} taskId
     * @return {?}
     */
    callApiTaskChecklist(taskId) {
        return this.apiService.taskApi.getChecklist(taskId);
    }
    /**
     * @private
     * @param {?} task
     * @return {?}
     */
    callApiCreateTask(task) {
        return this.apiService.taskApi.createNewTask(task);
    }
    /**
     * @private
     * @param {?} taskId
     * @param {?} requestNode
     * @return {?}
     */
    callApiAssignTask(taskId, requestNode) {
        return this.apiService.taskApi.assignTask(taskId, requestNode);
    }
    /**
     * @private
     * @param {?} error
     * @return {?}
     */
    handleError(error) {
        this.logService.error(error);
        return throwError(error || 'Server error');
    }
}
TaskListService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TaskListService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
/** @nocollapse */ TaskListService.ngInjectableDef = i0.defineInjectable({ factory: function TaskListService_Factory() { return new TaskListService(i0.inject(i1.AlfrescoApiService), i0.inject(i1.LogService)); }, token: TaskListService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TaskListService.prototype.apiService;
    /**
     * @type {?}
     * @private
     */
    TaskListService.prototype.logService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFza2xpc3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtcHJvY2Vzcy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInRhc2stbGlzdC9zZXJ2aWNlcy90YXNrbGlzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RSxPQUFPLEVBQTZCLG1DQUFtQyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDeEcsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7O0FBUzFELE1BQU0sT0FBTyxlQUFlOzs7OztJQUV4QixZQUFvQixVQUE4QixFQUM5QixVQUFzQjtRQUR0QixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5QixlQUFVLEdBQVYsVUFBVSxDQUFZO0lBQzFDLENBQUM7Ozs7Ozs7SUFRRCxvQkFBb0IsQ0FBQyxNQUFjLEVBQUUsVUFBdUM7UUFDeEUsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO2FBQ2xCLElBQUksQ0FDRCxPQUFPLENBQUMsQ0FBQyxJQUErQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQ3RGLE1BQU0sQ0FBQyxDQUFDLElBQStCLEVBQUUsRUFBRSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FDNUQsQ0FBQztJQUNWLENBQUM7Ozs7Ozs7SUFPTyxpQ0FBaUMsQ0FBQyxXQUFzQzs7WUFDeEUsV0FBVyxHQUFHO1lBQ2QsZUFBZSxFQUFFLFdBQVcsQ0FBQyxLQUFLO1lBQ2xDLFVBQVUsRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFDekMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSztZQUMvQixJQUFJLEVBQUUsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJO1NBQ2hDO1FBQ0QsT0FBTyxJQUFJLG1DQUFtQyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7Ozs7Ozs7SUFRRCxxQkFBcUIsQ0FBQyxNQUFjLEVBQUUsV0FBc0M7O1lBQ3BFLG9CQUFvQixHQUFHLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxXQUFXLENBQUM7UUFDOUUsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLG9CQUFvQixDQUFDLENBQUM7YUFDdkQsSUFBSSxDQUNELEdBQUcsQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFO1lBQ2IsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDbEYsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzdDLENBQUM7SUFDVixDQUFDOzs7Ozs7SUFPRCxRQUFRLENBQUMsV0FBZ0Q7UUFDckQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQzlDLElBQUksQ0FDRCxVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztJQUNWLENBQUM7Ozs7Ozs7SUFRRCxnQkFBZ0IsQ0FBQyxXQUFnRCxFQUFFLEtBQWM7UUFDN0UsSUFBSSxLQUFLLEVBQUU7WUFDUCxXQUFXLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztTQUM3QjtRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7YUFDNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxhQUFhLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6RCxDQUFDOzs7Ozs7O0lBUUQsa0JBQWtCLENBQUMsV0FBZ0QsRUFBRSxLQUFjO1FBQy9FLElBQUksS0FBSyxFQUFFO1lBQ1AsV0FBVyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7U0FDN0I7UUFDRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDO2FBQ2pDLElBQUksQ0FDRCxTQUFTLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRTtZQUNuQixXQUFXLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFDN0IsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDVixDQUFDOzs7Ozs7SUFPRCx3QkFBd0IsQ0FBQyxXQUFnRDtRQUNyRSxPQUFPLFFBQVEsQ0FDWCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxFQUMxQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxFQUNqRCxDQUFDLFdBQTBCLEVBQUUsY0FBNkIsRUFBRSxFQUFFOztrQkFDcEQsS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQztZQUM1QyxLQUFLLENBQUMsS0FBSyxJQUFJLGNBQWMsQ0FBQyxLQUFLLENBQUM7WUFDcEMsS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDcEQsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQyxDQUNKLENBQUM7SUFDTixDQUFDOzs7Ozs7SUFPRCxjQUFjLENBQUMsTUFBYztRQUN6QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDdkMsSUFBSSxDQUNELEdBQUcsQ0FBQyxDQUFDLE9BQVksRUFBRSxFQUFFO1lBQ2pCLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztJQUNWLENBQUM7Ozs7OztJQU9ELGdCQUFnQixDQUFDLEVBQVU7UUFDdkIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ3JDLElBQUksQ0FDRCxHQUFHLENBQUMsQ0FBQyxRQUFhLEVBQUUsRUFBRTs7a0JBQ1osVUFBVSxHQUF1QixFQUFFO1lBQ3pDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7Z0JBQ2hDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3JELENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxVQUFVLENBQUM7UUFDdEIsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzdDLENBQUM7SUFDVixDQUFDOzs7OztJQU1ELFdBQVc7O1lBQ0gsSUFBSSxHQUFHO1lBQ1AsUUFBUSxFQUFFLGlCQUFpQjs7WUFDM0IsTUFBTSxFQUFFLGNBQWM7O1lBQ3RCLFdBQVcsRUFBRSxDQUFDLENBQUMsc0JBQXNCO1NBQ3hDO1FBRUQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN4RSxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7O2dCQUNkLEtBQUssR0FBVyxFQUFFO1lBQ3RCLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQzNCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUM3QyxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO0lBQ1YsQ0FBQzs7Ozs7OztJQVFELGlCQUFpQixDQUFDLE1BQWMsRUFBRSxNQUFjO1FBQzVDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQzthQUN4RSxJQUFJLENBQ0QsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzdDLENBQUM7SUFDVixDQUFDOzs7Ozs7SUFPRCxPQUFPLENBQUMsSUFBc0I7UUFDMUIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNqQyxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsUUFBMEIsRUFBRSxFQUFFO1lBQy9CLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztJQUNWLENBQUM7Ozs7OztJQU9ELFVBQVUsQ0FBQyxNQUFjO1FBQ3JCLE9BQU8sSUFBSSxDQUFtQixJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDeEQsSUFBSSxDQUNELFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO0lBQ1YsQ0FBQzs7Ozs7O0lBT0QsVUFBVSxDQUFDLE1BQWM7UUFDckIsT0FBTyxJQUFJLENBQW1CLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUN4RCxJQUFJLENBQ0QsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzdDLENBQUM7SUFDVixDQUFDOzs7Ozs7SUFPRCxZQUFZLENBQUMsTUFBYztRQUN2QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDcEQsSUFBSSxDQUNELFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO0lBQ1YsQ0FBQzs7Ozs7O0lBT00sYUFBYSxDQUFDLFdBQWdEO1FBQ2pFLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUM5QyxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUU7WUFDYixPQUFPLEdBQUcsQ0FBQztRQUNmLENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO0lBQ1YsQ0FBQzs7Ozs7O0lBT0QsYUFBYSxDQUFDLElBQXNCO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNwQyxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsUUFBMEIsRUFBRSxFQUFFO1lBQy9CLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztJQUNWLENBQUM7Ozs7Ozs7SUFRRCxVQUFVLENBQUMsTUFBYyxFQUFFLFdBQWdCOztZQUNuQyxRQUFRLEdBQUcsRUFBRSxRQUFRLEVBQUUsV0FBVyxDQUFDLEVBQUUsRUFBRTtRQUMzQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQ2hELElBQUksQ0FDRCxHQUFHLENBQUMsQ0FBQyxRQUEwQixFQUFFLEVBQUU7WUFDL0IsT0FBTyxJQUFJLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO0lBQ1YsQ0FBQzs7Ozs7OztJQVFELGtCQUFrQixDQUFDLE1BQWMsRUFBRSxNQUFjOztjQUN2QyxRQUFRLEdBQUcsbUJBQW1DLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxFQUFBO1FBQ3hFLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDaEQsSUFBSSxDQUNELEdBQUcsQ0FBQyxDQUFDLFFBQTBCLEVBQUUsRUFBRTtZQUMvQixPQUFPLElBQUksZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzdDLENBQUM7SUFDVixDQUFDOzs7Ozs7SUFPRCxTQUFTLENBQUMsTUFBYztRQUNwQixPQUFPLElBQUksQ0FBbUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ25FLElBQUksQ0FDRCxVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztJQUNWLENBQUM7Ozs7OztJQU9ELFdBQVcsQ0FBQyxNQUFjO1FBQ3RCLE9BQU8sSUFBSSxDQUFtQixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDckUsSUFBSSxDQUNELFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO0lBQ1YsQ0FBQzs7Ozs7OztJQVFELFVBQVUsQ0FBQyxNQUFXLEVBQUUsT0FBTztRQUMzQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQzNELElBQUksQ0FDRCxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLG1CQUFtQixNQUFNLEVBQUEsQ0FBQyxFQUMxQyxVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztJQUNWLENBQUM7Ozs7OztJQU9ELHFCQUFxQixDQUFDLE1BQWM7UUFDaEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3ZELElBQUksQ0FDRCxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLG1CQUFPLElBQUksRUFBQSxDQUFDLEVBQzFCLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO0lBQ1YsQ0FBQzs7Ozs7O0lBT0Qsc0JBQXNCLENBQUMsTUFBYztRQUNqQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUN4RCxJQUFJLENBQ0QsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzdDLENBQUM7SUFDVixDQUFDOzs7Ozs7SUFFTyxvQkFBb0IsQ0FBQyxXQUFvQztRQUM3RCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMxRCxDQUFDOzs7Ozs7SUFFTyxrQkFBa0IsQ0FBQyxNQUFjO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25ELENBQUM7Ozs7OztJQUVPLGNBQWMsQ0FBQyxJQUFzQjtRQUN6QyxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7Ozs7OztJQUVPLGlCQUFpQixDQUFDLE1BQWM7UUFDcEMsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEQsQ0FBQzs7Ozs7O0lBRU8saUJBQWlCLENBQUMsTUFBYztRQUNwQyxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN0RCxDQUFDOzs7Ozs7SUFFTyxvQkFBb0IsQ0FBQyxNQUFjO1FBQ3ZDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hELENBQUM7Ozs7OztJQUVPLGlCQUFpQixDQUFDLElBQXNCO1FBQzVDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZELENBQUM7Ozs7Ozs7SUFFTyxpQkFBaUIsQ0FBQyxNQUFjLEVBQUUsV0FBNkM7UUFDbkYsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ25FLENBQUM7Ozs7OztJQUVPLFdBQVcsQ0FBQyxLQUFVO1FBQzFCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLE9BQU8sVUFBVSxDQUFDLEtBQUssSUFBSSxjQUFjLENBQUMsQ0FBQztJQUMvQyxDQUFDOzs7WUFuWkosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7O1lBZlEsa0JBQWtCO1lBQUUsVUFBVTs7Ozs7Ozs7SUFrQnZCLHFDQUFzQzs7Ozs7SUFDdEMscUNBQThCIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBMb2dTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIGZvcmtKb2luLCB0aHJvd0Vycm9yLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yLCBzd2l0Y2hNYXAsIGZsYXRNYXAsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwsIFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2ZpbHRlci5tb2RlbCc7XG5pbXBvcnQgeyBGb3JtIH0gZnJvbSAnLi4vbW9kZWxzL2Zvcm0ubW9kZWwnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNNb2RlbCB9IGZyb20gJy4uL21vZGVscy90YXNrLWRldGFpbHMubW9kZWwnO1xuaW1wb3J0IHsgVGFza0xpc3RNb2RlbCB9IGZyb20gJy4uL21vZGVscy90YXNrLWxpc3QubW9kZWwnO1xuaW1wb3J0IHtcbiAgICBUYXNrUXVlcnlSZXByZXNlbnRhdGlvbixcbiAgICBBc3NpZ25lZUlkZW50aWZpZXJSZXByZXNlbnRhdGlvblxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUYXNrTGlzdFNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgdGhlIGZpbHRlcnMgaW4gdGhlIGxpc3QgdGhhdCBiZWxvbmcgdG8gYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHBhcmFtIGZpbHRlckxpc3QgTGlzdCBvZiBmaWx0ZXJzIHRvIHNlYXJjaCB0aHJvdWdoXG4gICAgICogQHJldHVybnMgRmlsdGVycyBiZWxvbmdpbmcgdG8gdGhlIHRhc2tcbiAgICAgKi9cbiAgICBnZXRGaWx0ZXJGb3JUYXNrQnlJZCh0YXNrSWQ6IHN0cmluZywgZmlsdGVyTGlzdDogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbFtdKTogT2JzZXJ2YWJsZTxGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKGZpbHRlckxpc3QpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBmbGF0TWFwKChkYXRhOiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsKSA9PiB0aGlzLmlzVGFza1JlbGF0ZWRUb0ZpbHRlcih0YXNrSWQsIGRhdGEpKSxcbiAgICAgICAgICAgICAgICBmaWx0ZXIoKGRhdGE6IEZpbHRlclJlcHJlc2VudGF0aW9uTW9kZWwpID0+IGRhdGEgIT0gbnVsbClcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgc2VhcmNoIHF1ZXJ5IGZvciBhIHRhc2sgYmFzZWQgb24gdGhlIHN1cHBsaWVkIGZpbHRlci5cbiAgICAgKiBAcGFyYW0gZmlsdGVyIFRoZSBmaWx0ZXIgdG8gdXNlXG4gICAgICogQHJldHVybnMgVGhlIHNlYXJjaCBxdWVyeVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2VuZXJhdGVUYXNrUmVxdWVzdE5vZGVGcm9tRmlsdGVyKGZpbHRlck1vZGVsOiBGaWx0ZXJSZXByZXNlbnRhdGlvbk1vZGVsKTogVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwge1xuICAgICAgICBsZXQgcmVxdWVzdE5vZGUgPSB7XG4gICAgICAgICAgICBhcHBEZWZpbml0aW9uSWQ6IGZpbHRlck1vZGVsLmFwcElkLFxuICAgICAgICAgICAgYXNzaWdubWVudDogZmlsdGVyTW9kZWwuZmlsdGVyLmFzc2lnbm1lbnQsXG4gICAgICAgICAgICBzdGF0ZTogZmlsdGVyTW9kZWwuZmlsdGVyLnN0YXRlLFxuICAgICAgICAgICAgc29ydDogZmlsdGVyTW9kZWwuZmlsdGVyLnNvcnRcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIG5ldyBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbChyZXF1ZXN0Tm9kZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIGEgdGFza0lkIGlzIGZpbHRlcmVkIHdpdGggdGhlIGdpdmVuIGZpbHRlci5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEBwYXJhbSBmaWx0ZXJNb2RlbCBUaGUgZmlsdGVyIHlvdSB3YW50IHRvIGNoZWNrXG4gICAgICogQHJldHVybnMgVGhlIGZpbHRlciBpZiBpdCBpcyByZWxhdGVkIG9yIG51bGwgb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaXNUYXNrUmVsYXRlZFRvRmlsdGVyKHRhc2tJZDogc3RyaW5nLCBmaWx0ZXJNb2RlbDogRmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8RmlsdGVyUmVwcmVzZW50YXRpb25Nb2RlbD4ge1xuICAgICAgICBsZXQgcmVxdWVzdE5vZGVGb3JGaWx0ZXIgPSB0aGlzLmdlbmVyYXRlVGFza1JlcXVlc3ROb2RlRnJvbUZpbHRlcihmaWx0ZXJNb2RlbCk7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVRhc2tzRmlsdGVyZWQocmVxdWVzdE5vZGVGb3JGaWx0ZXIpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmRhdGEuZmluZCgoZWxlbWVudCkgPT4gZWxlbWVudC5pZCA9PT0gdGFza0lkKSA/IGZpbHRlck1vZGVsIDogbnVsbDtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgdGhlIHRhc2tzIG1hdGNoaW5nIHRoZSBzdXBwbGllZCBxdWVyeS5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgUXVlcnkgdG8gc2VhcmNoIGZvciB0YXNrc1xuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgdGFza3NcbiAgICAgKi9cbiAgICBnZXRUYXNrcyhyZXF1ZXN0Tm9kZTogVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwpOiBPYnNlcnZhYmxlPFRhc2tMaXN0TW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpVGFza3NGaWx0ZXJlZChyZXF1ZXN0Tm9kZSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0YXNrcyBtYXRjaGluZyBhIHF1ZXJ5IGFuZCBzdGF0ZSB2YWx1ZS5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgUXVlcnkgdG8gc2VhcmNoIGZvciB0YXNrc1xuICAgICAqIEBwYXJhbSBzdGF0ZSBUYXNrIHN0YXRlLiBDYW4gYmUgXCJvcGVuXCIgb3IgXCJjb21wbGV0ZWRcIi5cbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHRhc2tzXG4gICAgICovXG4gICAgZmluZFRhc2tzQnlTdGF0ZShyZXF1ZXN0Tm9kZTogVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwsIHN0YXRlPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrTGlzdE1vZGVsPiB7XG4gICAgICAgIGlmIChzdGF0ZSkge1xuICAgICAgICAgICAgcmVxdWVzdE5vZGUuc3RhdGUgPSBzdGF0ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrcyhyZXF1ZXN0Tm9kZSlcbiAgICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IoKCkgPT4gb2YobmV3IFRhc2tMaXN0TW9kZWwoKSkpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0YXNrcyBtYXRjaGluZyBhIHF1ZXJ5IGFuZCBzdGF0ZSB2YWx1ZS5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgUXVlcnkgdG8gc2VhcmNoIGZvciB0YXNrcy5cbiAgICAgKiBAcGFyYW0gc3RhdGUgVGFzayBzdGF0ZS4gQ2FuIGJlIFwib3BlblwiIG9yIFwiY29tcGxldGVkXCIuXG4gICAgICogQHJldHVybnMgTGlzdCBvZiB0YXNrc1xuICAgICAqL1xuICAgIGZpbmRBbGxUYXNrQnlTdGF0ZShyZXF1ZXN0Tm9kZTogVGFza1F1ZXJ5UmVxdWVzdFJlcHJlc2VudGF0aW9uTW9kZWwsIHN0YXRlPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrTGlzdE1vZGVsPiB7XG4gICAgICAgIGlmIChzdGF0ZSkge1xuICAgICAgICAgICAgcmVxdWVzdE5vZGUuc3RhdGUgPSBzdGF0ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5nZXRUb3RhbFRhc2tzKHJlcXVlc3ROb2RlKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChyZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0Tm9kZS5zaXplID0gcmVzLnRvdGFsO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXNrcyhyZXF1ZXN0Tm9kZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgdGFza3MgbWF0Y2hpbmcgdGhlIHN1cHBsaWVkIHF1ZXJ5IGJ1dCBpZ25vcmluZyB0aGUgdGFzayBzdGF0ZS5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgUXVlcnkgdG8gc2VhcmNoIGZvciB0YXNrc1xuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgdGFza3NcbiAgICAgKi9cbiAgICBmaW5kQWxsVGFza3NXaXRob3V0U3RhdGUocmVxdWVzdE5vZGU6IFRhc2tRdWVyeVJlcXVlc3RSZXByZXNlbnRhdGlvbk1vZGVsKTogT2JzZXJ2YWJsZTxUYXNrTGlzdE1vZGVsPiB7XG4gICAgICAgIHJldHVybiBmb3JrSm9pbihcbiAgICAgICAgICAgIHRoaXMuZmluZFRhc2tzQnlTdGF0ZShyZXF1ZXN0Tm9kZSwgJ29wZW4nKSxcbiAgICAgICAgICAgIHRoaXMuZmluZEFsbFRhc2tCeVN0YXRlKHJlcXVlc3ROb2RlLCAnY29tcGxldGVkJyksXG4gICAgICAgICAgICAoYWN0aXZlVGFza3M6IFRhc2tMaXN0TW9kZWwsIGNvbXBsZXRlZFRhc2tzOiBUYXNrTGlzdE1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGFza3MgPSBPYmplY3QuYXNzaWduKHt9LCBhY3RpdmVUYXNrcyk7XG4gICAgICAgICAgICAgICAgdGFza3MudG90YWwgKz0gY29tcGxldGVkVGFza3MudG90YWw7XG4gICAgICAgICAgICAgICAgdGFza3MuZGF0YSA9IHRhc2tzLmRhdGEuY29uY2F0KGNvbXBsZXRlZFRhc2tzLmRhdGEpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0YXNrcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGRldGFpbHMgZm9yIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFzay5cbiAgICAgKiBAcmV0dXJucyBUYXNrIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRUYXNrRGV0YWlscyh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlUYXNrRGV0YWlscyh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChkZXRhaWxzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYXNrRGV0YWlsc01vZGVsKGRldGFpbHMpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBjaGVja2xpc3QgZm9yIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gaWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgY2hlY2tsaXN0IHRhc2sgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFRhc2tDaGVja2xpc3QoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVRhc2tDaGVja2xpc3QoaWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoZWNrbGlzdHM6IFRhc2tEZXRhaWxzTW9kZWxbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZvckVhY2goKGNoZWNrbGlzdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tsaXN0cy5wdXNoKG5ldyBUYXNrRGV0YWlsc01vZGVsKGNoZWNrbGlzdCkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoZWNrbGlzdHM7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIGF2YWlsYWJsZSByZXVzYWJsZSBmb3Jtcy5cbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBmb3JtIGRldGFpbHNcbiAgICAgKi9cbiAgICBnZXRGb3JtTGlzdCgpOiBPYnNlcnZhYmxlPEZvcm1bXT4ge1xuICAgICAgICBsZXQgb3B0cyA9IHtcbiAgICAgICAgICAgICdmaWx0ZXInOiAnbXlSZXVzYWJsZUZvcm1zJywgLy8gU3RyaW5nIHwgZmlsdGVyXG4gICAgICAgICAgICAnc29ydCc6ICdtb2RpZmllZERlc2MnLCAvLyBTdHJpbmcgfCBzb3J0XG4gICAgICAgICAgICAnbW9kZWxUeXBlJzogMiAvLyBJbnRlZ2VyIHwgbW9kZWxUeXBlXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZm9ybXM6IEZvcm1bXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZvckVhY2goKGZvcm0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1zLnB1c2gobmV3IEZvcm0oZm9ybS5pZCwgZm9ybS5uYW1lKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm9ybXM7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGFjaGVzIGEgZm9ybSB0byBhIHRhc2suXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFyZ2V0IHRhc2tcbiAgICAgKiBAcGFyYW0gZm9ybUlkIElEIG9mIHRoZSBmb3JtIHRvIGFkZFxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGF0dGFjaEZvcm1Ub0FUYXNrKHRhc2tJZDogc3RyaW5nLCBmb3JtSWQ6IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuYXBpU2VydmljZS50YXNrQXBpLmF0dGFjaEZvcm0odGFza0lkLCB7ICdmb3JtSWQnOiBmb3JtSWQgfSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIHN1YnRhc2sgKGllLCBhIGNoZWNrbGlzdCB0YXNrKSB0byBhIHBhcmVudCB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrIFRoZSB0YXNrIHRvIGFkZFxuICAgICAqIEByZXR1cm5zIFRoZSBzdWJ0YXNrIHRoYXQgd2FzIGFkZGVkXG4gICAgICovXG4gICAgYWRkVGFzayh0YXNrOiBUYXNrRGV0YWlsc01vZGVsKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaUFkZFRhc2sodGFzaykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBUYXNrRGV0YWlsc01vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYSBzdWJ0YXNrIChpZSwgYSBjaGVja2xpc3QgdGFzaykgZnJvbSBhIHBhcmVudCB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGhlIHRhc2sgdG8gZGVsZXRlXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgZGVsZXRlVGFzayh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbTxUYXNrRGV0YWlsc01vZGVsPih0aGlzLmNhbGxBcGlEZWxldGVUYXNrKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVsZXRlcyBhIGZvcm0gZnJvbSBhIHRhc2suXG4gICAgICogQHBhcmFtIHRhc2tJZCBUYXNrIGlkIHJlbGF0ZWQgdG8gZm9ybVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGRlbGV0ZUZvcm0odGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb208VGFza0RldGFpbHNNb2RlbD4odGhpcy5jYWxsQXBpRGVsZXRlRm9ybSh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdpdmVzIGNvbXBsZXRlZCBzdGF0dXMgdG8gYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgY29tcGxldGVUYXNrKHRhc2tJZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuYXBpU2VydmljZS50YXNrQXBpLmNvbXBsZXRlVGFzayh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHRvdGFsIG51bWJlciBvZiB0aGUgdGFza3MgZm91bmQgYnkgYSBxdWVyeS5cbiAgICAgKiBAcGFyYW0gcmVxdWVzdE5vZGUgUXVlcnkgdG8gc2VhcmNoIGZvciB0YXNrc1xuICAgICAqIEByZXR1cm5zIE51bWJlciBvZiB0YXNrc1xuICAgICAqL1xuICAgIHB1YmxpYyBnZXRUb3RhbFRhc2tzKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXF1ZXN0UmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJlcXVlc3ROb2RlLnNpemUgPSAwO1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmNhbGxBcGlUYXNrc0ZpbHRlcmVkKHJlcXVlc3ROb2RlKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhIG5ldyBzdGFuZGFsb25lIHRhc2suXG4gICAgICogQHBhcmFtIHRhc2sgRGV0YWlscyBvZiB0aGUgbmV3IHRhc2tcbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBuZXdseSBjcmVhdGVkIHRhc2tcbiAgICAgKi9cbiAgICBjcmVhdGVOZXdUYXNrKHRhc2s6IFRhc2tEZXRhaWxzTW9kZWwpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpQ3JlYXRlVGFzayh0YXNrKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IFRhc2tEZXRhaWxzTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYXNrRGV0YWlsc01vZGVsKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXNzaWducyBhIHRhc2sgdG8gYSB1c2VyIG9yIGdyb3VwLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGhlIHRhc2sgdG8gYXNzaWduXG4gICAgICogQHBhcmFtIHJlcXVlc3ROb2RlIFVzZXIgb3IgZ3JvdXAgdG8gYXNzaWduIHRoZSB0YXNrIHRvXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgYXNzaWduZWQgdGFza1xuICAgICAqL1xuICAgIGFzc2lnblRhc2sodGFza0lkOiBzdHJpbmcsIHJlcXVlc3ROb2RlOiBhbnkpOiBPYnNlcnZhYmxlPFRhc2tEZXRhaWxzTW9kZWw+IHtcbiAgICAgICAgbGV0IGFzc2lnbmVlID0geyBhc3NpZ25lZTogcmVxdWVzdE5vZGUuaWQgfTtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpQXNzaWduVGFzayh0YXNrSWQsIGFzc2lnbmVlKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IFRhc2tEZXRhaWxzTW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYXNrRGV0YWlsc01vZGVsKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXNzaWducyBhIHRhc2sgdG8gYSB1c2VyLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gYXNzaWduXG4gICAgICogQHBhcmFtIHVzZXJJZCBJRCBvZiB0aGUgdXNlciB0byBhc3NpZ24gdGhlIHRhc2sgdG9cbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBhc3NpZ25lZCB0YXNrXG4gICAgICovXG4gICAgYXNzaWduVGFza0J5VXNlcklkKHRhc2tJZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICBjb25zdCBhc3NpZ25lZSA9IDxBc3NpZ25lZUlkZW50aWZpZXJSZXByZXNlbnRhdGlvbj4geyBhc3NpZ25lZTogdXNlcklkIH07XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaUFzc2lnblRhc2sodGFza0lkLCBhc3NpZ25lZSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBUYXNrRGV0YWlsc01vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGFza0RldGFpbHNNb2RlbChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsYWltcyBhIHRhc2sgZm9yIHRoZSBjdXJyZW50IHVzZXIuXG4gICAgICogQHBhcmFtIHRhc2tJZCBJRCBvZiB0aGUgdGFzayB0byBjbGFpbVxuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGNsYWltZWQgdGFza1xuICAgICAqL1xuICAgIGNsYWltVGFzayh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbTxUYXNrRGV0YWlsc01vZGVsPih0aGlzLmFwaVNlcnZpY2UudGFza0FwaS5jbGFpbVRhc2sodGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVbi1jbGFpbXMgYSB0YXNrIGZvciB0aGUgY3VycmVudCB1c2VyLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gdW5jbGFpbVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIHVuY2xhaW1UYXNrKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tPFRhc2tEZXRhaWxzTW9kZWw+KHRoaXMuYXBpU2VydmljZS50YXNrQXBpLnVuY2xhaW1UYXNrKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgZGV0YWlscyAobmFtZSwgZGVzY3JpcHRpb24sIGR1ZSBkYXRlKSBmb3IgYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhc2sgdG8gdXBkYXRlXG4gICAgICogQHBhcmFtIHVwZGF0ZWQgRGF0YSB0byB1cGRhdGUgdGhlIHRhc2sgKGFzIGEgYFRhc2tVcGRhdGVSZXByZXNlbnRhdGlvbmAgaW5zdGFuY2UpLlxuICAgICAqIEByZXR1cm5zIFVwZGF0ZWQgdGFzayBkZXRhaWxzXG4gICAgICovXG4gICAgdXBkYXRlVGFzayh0YXNrSWQ6IGFueSwgdXBkYXRlZCk6IE9ic2VydmFibGU8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmFwaVNlcnZpY2UudGFza0FwaS51cGRhdGVUYXNrKHRhc2tJZCwgdXBkYXRlZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3VsdCkgPT4gPFRhc2tEZXRhaWxzTW9kZWw+IHJlc3VsdCksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZldGNoZXMgdGhlIFRhc2sgQXVkaXQgaW5mb3JtYXRpb24gaW4gUERGIGZvcm1hdC5cbiAgICAgKiBAcGFyYW0gdGFza0lkIElEIG9mIHRoZSB0YXJnZXQgdGFza1xuICAgICAqIEByZXR1cm5zIEJpbmFyeSBQREYgZGF0YVxuICAgICAqL1xuICAgIGZldGNoVGFza0F1ZGl0UGRmQnlJZCh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8QmxvYj4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmFwaVNlcnZpY2UudGFza0FwaS5nZXRUYXNrQXVkaXRQZGYodGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoZGF0YSkgPT4gPEJsb2I+IGRhdGEpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGZXRjaCB0aGUgVGFzayBBdWRpdCBpbmZvcm1hdGlvbiBpbiBKU09OIGZvcm1hdFxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgSlNPTiBkYXRhXG4gICAgICovXG4gICAgZmV0Y2hUYXNrQXVkaXRKc29uQnlJZCh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuYXBpU2VydmljZS50YXNrQXBpLmdldFRhc2tBdWRpdEpzb24odGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlUYXNrc0ZpbHRlcmVkKHJlcXVlc3ROb2RlOiBUYXNrUXVlcnlSZXByZXNlbnRhdGlvbik6IFByb21pc2U8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLnRhc2tBcGkubGlzdFRhc2tzKHJlcXVlc3ROb2RlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGxBcGlUYXNrRGV0YWlscyh0YXNrSWQ6IHN0cmluZyk6IFByb21pc2U8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLnRhc2tBcGkuZ2V0VGFzayh0YXNrSWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUFkZFRhc2sodGFzazogVGFza0RldGFpbHNNb2RlbCk6IFByb21pc2U8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLnRhc2tBcGkuYWRkU3VidGFzayh0YXNrLnBhcmVudFRhc2tJZCwgdGFzayk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpRGVsZXRlVGFzayh0YXNrSWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UudGFza0FwaS5kZWxldGVUYXNrKHRhc2tJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpRGVsZXRlRm9ybSh0YXNrSWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UudGFza0FwaS5yZW1vdmVGb3JtKHRhc2tJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpVGFza0NoZWNrbGlzdCh0YXNrSWQ6IHN0cmluZyk6IFByb21pc2U8VGFza0xpc3RNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLnRhc2tBcGkuZ2V0Q2hlY2tsaXN0KHRhc2tJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxsQXBpQ3JlYXRlVGFzayh0YXNrOiBUYXNrRGV0YWlsc01vZGVsKTogUHJvbWlzZTxUYXNrRGV0YWlsc01vZGVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UudGFza0FwaS5jcmVhdGVOZXdUYXNrKHRhc2spO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsbEFwaUFzc2lnblRhc2sodGFza0lkOiBzdHJpbmcsIHJlcXVlc3ROb2RlOiBBc3NpZ25lZUlkZW50aWZpZXJSZXByZXNlbnRhdGlvbik6IFByb21pc2U8VGFza0RldGFpbHNNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLnRhc2tBcGkuYXNzaWduVGFzayh0YXNrSWQsIHJlcXVlc3ROb2RlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpIHtcbiAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cblxufVxuIl19