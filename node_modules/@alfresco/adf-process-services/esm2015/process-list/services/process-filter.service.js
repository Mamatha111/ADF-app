/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { AlfrescoApiService } from '@alfresco/adf-core';
import { Injectable } from '@angular/core';
import { Observable, from, forkJoin, throwError } from 'rxjs';
import { FilterProcessRepresentationModel } from '../models/filter-process.model';
import { map, catchError } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class ProcessFilterService {
    /**
     * @param {?} alfrescoApiService
     */
    constructor(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
    }
    /**
     * Gets all filters defined for a Process App.
     * @param {?} appId ID of the target app
     * @return {?} Array of filter details
     */
    getProcessFilters(appId) {
        return from(this.callApiProcessFilters(appId))
            .pipe(map((response) => {
            /** @type {?} */
            let filters = [];
            response.data.forEach((filter) => {
                /** @type {?} */
                let filterModel = new FilterProcessRepresentationModel(filter);
                filters.push(filterModel);
            });
            return filters;
        }), catchError((err) => this.handleProcessError(err)));
    }
    /**
     * Retrieves the process filter by ID.
     * @param {?} filterId ID of the filter
     * @param {?=} appId ID of the target app
     * @return {?} Details of the filter
     */
    getProcessFilterById(filterId, appId) {
        return from(this.callApiProcessFilters(appId))
            .pipe(map((response) => {
            return response.data.find((filter) => filter.id === filterId);
        }), catchError((err) => this.handleProcessError(err)));
    }
    /**
     * Retrieves the process filter by name.
     * @param {?} filterName Name of the filter
     * @param {?=} appId ID of the target app
     * @return {?} Details of the filter
     */
    getProcessFilterByName(filterName, appId) {
        return from(this.callApiProcessFilters(appId))
            .pipe(map((response) => {
            return response.data.find((filter) => filter.name === filterName);
        }), catchError((err) => this.handleProcessError(err)));
    }
    /**
     * Creates and returns the default filters for an app.
     * @param {?} appId ID of the target app
     * @return {?} Default filters just created
     */
    createDefaultFilters(appId) {
        /** @type {?} */
        let runningFilter = this.getRunningFilterInstance(appId);
        /** @type {?} */
        let runningObservable = this.addProcessFilter(runningFilter);
        /** @type {?} */
        let completedFilter = this.getCompletedFilterInstance(appId);
        /** @type {?} */
        let completedObservable = this.addProcessFilter(completedFilter);
        /** @type {?} */
        let allFilter = this.getAllFilterInstance(appId);
        /** @type {?} */
        let allObservable = this.addProcessFilter(allFilter);
        return new Observable((observer) => {
            forkJoin(runningObservable, completedObservable, allObservable).subscribe((res) => {
                /** @type {?} */
                let filters = [];
                res.forEach((filter) => {
                    if (filter.name === runningFilter.name) {
                        runningFilter.id = filter.id;
                        filters.push(runningFilter);
                    }
                    else if (filter.name === completedFilter.name) {
                        completedFilter.id = filter.id;
                        filters.push(completedFilter);
                    }
                    else if (filter.name === allFilter.name) {
                        allFilter.id = filter.id;
                        filters.push(allFilter);
                    }
                });
                observer.next(filters);
                observer.complete();
            }, (err) => {
                this.handleProcessError(err);
            });
        });
    }
    /**
     * Creates and returns a filter that matches "running" process instances.
     * @param {?} appId ID of the target app
     * @return {?} Filter just created
     */
    getRunningFilterInstance(appId) {
        return new FilterProcessRepresentationModel({
            'name': 'Running',
            'appId': appId,
            'recent': true,
            'icon': 'glyphicon-random',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'running' }
        });
    }
    /**
     * Returns a static Completed filter instance.
     * @private
     * @param {?} appId ID of the target app
     * @return {?} Details of the filter
     */
    getCompletedFilterInstance(appId) {
        return new FilterProcessRepresentationModel({
            'name': 'Completed',
            'appId': appId,
            'recent': false,
            'icon': 'glyphicon-ok-sign',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'completed' }
        });
    }
    /**
     * Returns a static All filter instance.
     * @private
     * @param {?} appId ID of the target app
     * @return {?} Details of the filter
     */
    getAllFilterInstance(appId) {
        return new FilterProcessRepresentationModel({
            'name': 'All',
            'appId': appId,
            'recent': true,
            'icon': 'glyphicon-th',
            'filter': { 'sort': 'created-desc', 'name': '', 'state': 'all' }
        });
    }
    /**
     * Adds a filter.
     * @param {?} filter The filter to add
     * @return {?} The filter just added
     */
    addProcessFilter(filter) {
        return from(this.alfrescoApiService.getInstance().activiti.userFiltersApi.createUserProcessInstanceFilter(filter))
            .pipe(map((response) => {
            return response;
        }), catchError((err) => this.handleProcessError(err)));
    }
    /**
     * Calls `getUserProcessInstanceFilters` from the Alfresco JS API.
     * @param {?=} appId ID of the target app
     * @return {?} List of filter details
     */
    callApiProcessFilters(appId) {
        if (appId) {
            return this.alfrescoApiService.getInstance().activiti.userFiltersApi.getUserProcessInstanceFilters({ appId: appId });
        }
        else {
            return this.alfrescoApiService.getInstance().activiti.userFiltersApi.getUserProcessInstanceFilters();
        }
    }
    /**
     * @private
     * @param {?} error
     * @return {?}
     */
    handleProcessError(error) {
        return throwError(error || 'Server error');
    }
}
ProcessFilterService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ProcessFilterService.ctorParameters = () => [
    { type: AlfrescoApiService }
];
/** @nocollapse */ ProcessFilterService.ngInjectableDef = i0.defineInjectable({ factory: function ProcessFilterService_Factory() { return new ProcessFilterService(i0.inject(i1.AlfrescoApiService)); }, token: ProcessFilterService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    ProcessFilterService.prototype.alfrescoApiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1maWx0ZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtcHJvY2Vzcy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInByb2Nlc3MtbGlzdC9zZXJ2aWNlcy9wcm9jZXNzLWZpbHRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RCxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNsRixPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFLakQsTUFBTSxPQUFPLG9CQUFvQjs7OztJQUU3QixZQUFvQixrQkFBc0M7UUFBdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUMxRCxDQUFDOzs7Ozs7SUFPRCxpQkFBaUIsQ0FBQyxLQUFhO1FBQzNCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN6QyxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7O2dCQUNkLE9BQU8sR0FBdUMsRUFBRTtZQUNwRCxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQXdDLEVBQUUsRUFBRTs7b0JBQzNELFdBQVcsR0FBRyxJQUFJLGdDQUFnQyxDQUFDLE1BQU0sQ0FBQztnQkFDOUQsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUM5QixDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sT0FBTyxDQUFDO1FBQ25CLENBQUMs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RUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFO1NBQ25FLENBQUMsQ0FBQztJQUNQLENBQUM7Ozs7OztJQU9ELGdCQUFnQixDQUFDLE1BQXdDO1FBQ3JELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLCtCQUErQixDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQzdHLElBQUksQ0FDRCxHQUFHLENBQUMsQ0FBQyxRQUEwQyxFQUFFLEVBQUU7WUFDL0MsT0FBTyxRQUFRLENBQUM7UUFDcEIsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDcEQsQ0FBQztJQUNWLENBQUM7Ozs7OztJQU9ELHFCQUFxQixDQUFDLEtBQWM7UUFDaEMsSUFBSSxLQUFLLEVBQUU7WUFDUCxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLDZCQUE2QixDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDeEg7YUFBTTtZQUNILE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsNkJBQTZCLEVBQUUsQ0FBQztTQUN4RztJQUNMLENBQUM7Ozs7OztJQUVPLGtCQUFrQixDQUFDLEtBQVU7UUFDakMsT0FBTyxVQUFVLENBQUMsS0FBSyxJQUFJLGNBQWMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7OztZQW5MSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7Ozs7WUFSUSxrQkFBa0I7Ozs7Ozs7O0lBV1gsa0RBQThDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIGZvcmtKb2luLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCB9IGZyb20gJy4uL21vZGVscy9maWx0ZXItcHJvY2Vzcy5tb2RlbCc7XG5pbXBvcnQgeyBtYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUHJvY2Vzc0ZpbHRlclNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhbGZyZXNjb0FwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIGZpbHRlcnMgZGVmaW5lZCBmb3IgYSBQcm9jZXNzIEFwcC5cbiAgICAgKiBAcGFyYW0gYXBwSWQgSUQgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBmaWx0ZXIgZGV0YWlsc1xuICAgICAqL1xuICAgIGdldFByb2Nlc3NGaWx0ZXJzKGFwcElkOiBudW1iZXIpOiBPYnNlcnZhYmxlPEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsW10+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpUHJvY2Vzc0ZpbHRlcnMoYXBwSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWx0ZXJzOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbFtdID0gW107XG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZm9yRWFjaCgoZmlsdGVyOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbHRlck1vZGVsID0gbmV3IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsKGZpbHRlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJzLnB1c2goZmlsdGVyTW9kZWwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlcnM7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZXMgdGhlIHByb2Nlc3MgZmlsdGVyIGJ5IElELlxuICAgICAqIEBwYXJhbSBmaWx0ZXJJZCBJRCBvZiB0aGUgZmlsdGVyXG4gICAgICogQHBhcmFtIGFwcElkIElEIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgZmlsdGVyXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0ZpbHRlckJ5SWQoZmlsdGVySWQ6IG51bWJlciwgYXBwSWQ/OiBudW1iZXIpOiBPYnNlcnZhYmxlPEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuY2FsbEFwaVByb2Nlc3NGaWx0ZXJzKGFwcElkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5maW5kKChmaWx0ZXIpID0+IGZpbHRlci5pZCA9PT0gZmlsdGVySWQpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIHRoZSBwcm9jZXNzIGZpbHRlciBieSBuYW1lLlxuICAgICAqIEBwYXJhbSBmaWx0ZXJOYW1lIE5hbWUgb2YgdGhlIGZpbHRlclxuICAgICAqIEBwYXJhbSBhcHBJZCBJRCBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGZpbHRlclxuICAgICAqL1xuICAgIGdldFByb2Nlc3NGaWx0ZXJCeU5hbWUoZmlsdGVyTmFtZTogc3RyaW5nLCBhcHBJZD86IG51bWJlcik6IE9ic2VydmFibGU8RmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5jYWxsQXBpUHJvY2Vzc0ZpbHRlcnMoYXBwSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmZpbmQoKGZpbHRlcikgPT4gZmlsdGVyLm5hbWUgPT09IGZpbHRlck5hbWUpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVQcm9jZXNzRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBhbmQgcmV0dXJucyB0aGUgZGVmYXVsdCBmaWx0ZXJzIGZvciBhbiBhcHAuXG4gICAgICogQHBhcmFtIGFwcElkIElEIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgRGVmYXVsdCBmaWx0ZXJzIGp1c3QgY3JlYXRlZFxuICAgICAqL1xuICAgIHB1YmxpYyBjcmVhdGVEZWZhdWx0RmlsdGVycyhhcHBJZDogbnVtYmVyKTogT2JzZXJ2YWJsZTxGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbFtdPiB7XG4gICAgICAgIGxldCBydW5uaW5nRmlsdGVyID0gdGhpcy5nZXRSdW5uaW5nRmlsdGVySW5zdGFuY2UoYXBwSWQpO1xuICAgICAgICBsZXQgcnVubmluZ09ic2VydmFibGUgPSB0aGlzLmFkZFByb2Nlc3NGaWx0ZXIocnVubmluZ0ZpbHRlcik7XG5cbiAgICAgICAgbGV0IGNvbXBsZXRlZEZpbHRlciA9IHRoaXMuZ2V0Q29tcGxldGVkRmlsdGVySW5zdGFuY2UoYXBwSWQpO1xuICAgICAgICBsZXQgY29tcGxldGVkT2JzZXJ2YWJsZSA9IHRoaXMuYWRkUHJvY2Vzc0ZpbHRlcihjb21wbGV0ZWRGaWx0ZXIpO1xuXG4gICAgICAgIGxldCBhbGxGaWx0ZXIgPSB0aGlzLmdldEFsbEZpbHRlckluc3RhbmNlKGFwcElkKTtcbiAgICAgICAgbGV0IGFsbE9ic2VydmFibGUgPSB0aGlzLmFkZFByb2Nlc3NGaWx0ZXIoYWxsRmlsdGVyKTtcblxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyKSA9PiB7XG4gICAgICAgICAgICBmb3JrSm9pbihcbiAgICAgICAgICAgICAgICBydW5uaW5nT2JzZXJ2YWJsZSxcbiAgICAgICAgICAgICAgICBjb21wbGV0ZWRPYnNlcnZhYmxlLFxuICAgICAgICAgICAgICAgIGFsbE9ic2VydmFibGVcbiAgICAgICAgICAgICkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbHRlcnM6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsW10gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgcmVzLmZvckVhY2goKGZpbHRlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlci5uYW1lID09PSBydW5uaW5nRmlsdGVyLm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5uaW5nRmlsdGVyLmlkID0gZmlsdGVyLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcnMucHVzaChydW5uaW5nRmlsdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLm5hbWUgPT09IGNvbXBsZXRlZEZpbHRlci5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVkRmlsdGVyLmlkID0gZmlsdGVyLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcnMucHVzaChjb21wbGV0ZWRGaWx0ZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXIubmFtZSA9PT0gYWxsRmlsdGVyLm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxGaWx0ZXIuaWQgPSBmaWx0ZXIuaWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKGFsbEZpbHRlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGZpbHRlcnMpO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycjogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUHJvY2Vzc0Vycm9yKGVycik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgYSBmaWx0ZXIgdGhhdCBtYXRjaGVzIFwicnVubmluZ1wiIHByb2Nlc3MgaW5zdGFuY2VzLlxuICAgICAqIEBwYXJhbSBhcHBJZCBJRCBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIEZpbHRlciBqdXN0IGNyZWF0ZWRcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0UnVubmluZ0ZpbHRlckluc3RhbmNlKGFwcElkOiBudW1iZXIpOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCB7XG4gICAgICAgIHJldHVybiBuZXcgRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwoe1xuICAgICAgICAgICAgJ25hbWUnOiAnUnVubmluZycsXG4gICAgICAgICAgICAnYXBwSWQnOiBhcHBJZCxcbiAgICAgICAgICAgICdyZWNlbnQnOiB0cnVlLFxuICAgICAgICAgICAgJ2ljb24nOiAnZ2x5cGhpY29uLXJhbmRvbScsXG4gICAgICAgICAgICAnZmlsdGVyJzogeyAnc29ydCc6ICdjcmVhdGVkLWRlc2MnLCAnbmFtZSc6ICcnLCAnc3RhdGUnOiAncnVubmluZycgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGEgc3RhdGljIENvbXBsZXRlZCBmaWx0ZXIgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIGFwcElkIElEIG9mIHRoZSB0YXJnZXQgYXBwXG4gICAgICogQHJldHVybnMgRGV0YWlscyBvZiB0aGUgZmlsdGVyXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRDb21wbGV0ZWRGaWx0ZXJJbnN0YW5jZShhcHBJZDogbnVtYmVyKTogRmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWwge1xuICAgICAgICByZXR1cm4gbmV3IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsKHtcbiAgICAgICAgICAgICduYW1lJzogJ0NvbXBsZXRlZCcsXG4gICAgICAgICAgICAnYXBwSWQnOiBhcHBJZCxcbiAgICAgICAgICAgICdyZWNlbnQnOiBmYWxzZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi1vay1zaWduJyxcbiAgICAgICAgICAgICdmaWx0ZXInOiB7ICdzb3J0JzogJ2NyZWF0ZWQtZGVzYycsICduYW1lJzogJycsICdzdGF0ZSc6ICdjb21wbGV0ZWQnIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyBhIHN0YXRpYyBBbGwgZmlsdGVyIGluc3RhbmNlLlxuICAgICAqIEBwYXJhbSBhcHBJZCBJRCBvZiB0aGUgdGFyZ2V0IGFwcFxuICAgICAqIEByZXR1cm5zIERldGFpbHMgb2YgdGhlIGZpbHRlclxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0QWxsRmlsdGVySW5zdGFuY2UoYXBwSWQ6IG51bWJlcik6IEZpbHRlclByb2Nlc3NSZXByZXNlbnRhdGlvbk1vZGVsIHtcbiAgICAgICAgcmV0dXJuIG5ldyBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCh7XG4gICAgICAgICAgICAnbmFtZSc6ICdBbGwnLFxuICAgICAgICAgICAgJ2FwcElkJzogYXBwSWQsXG4gICAgICAgICAgICAncmVjZW50JzogdHJ1ZSxcbiAgICAgICAgICAgICdpY29uJzogJ2dseXBoaWNvbi10aCcsXG4gICAgICAgICAgICAnZmlsdGVyJzogeyAnc29ydCc6ICdjcmVhdGVkLWRlc2MnLCAnbmFtZSc6ICcnLCAnc3RhdGUnOiAnYWxsJyB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBmaWx0ZXIuXG4gICAgICogQHBhcmFtIGZpbHRlciBUaGUgZmlsdGVyIHRvIGFkZFxuICAgICAqIEByZXR1cm5zIFRoZSBmaWx0ZXIganVzdCBhZGRlZFxuICAgICAqL1xuICAgIGFkZFByb2Nlc3NGaWx0ZXIoZmlsdGVyOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCk6IE9ic2VydmFibGU8RmlsdGVyUHJvY2Vzc1JlcHJlc2VudGF0aW9uTW9kZWw+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS51c2VyRmlsdGVyc0FwaS5jcmVhdGVVc2VyUHJvY2Vzc0luc3RhbmNlRmlsdGVyKGZpbHRlcikpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBGaWx0ZXJQcm9jZXNzUmVwcmVzZW50YXRpb25Nb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZVByb2Nlc3NFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyBgZ2V0VXNlclByb2Nlc3NJbnN0YW5jZUZpbHRlcnNgIGZyb20gdGhlIEFsZnJlc2NvIEpTIEFQSS5cbiAgICAgKiBAcGFyYW0gYXBwSWQgSUQgb2YgdGhlIHRhcmdldCBhcHBcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIGZpbHRlciBkZXRhaWxzXG4gICAgICovXG4gICAgY2FsbEFwaVByb2Nlc3NGaWx0ZXJzKGFwcElkPzogbnVtYmVyKSB7XG4gICAgICAgIGlmIChhcHBJZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkudXNlckZpbHRlcnNBcGkuZ2V0VXNlclByb2Nlc3NJbnN0YW5jZUZpbHRlcnMoeyBhcHBJZDogYXBwSWQgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS51c2VyRmlsdGVyc0FwaS5nZXRVc2VyUHJvY2Vzc0luc3RhbmNlRmlsdGVycygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVQcm9jZXNzRXJyb3IoZXJyb3I6IGFueSkge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvciB8fCAnU2VydmVyIGVycm9yJyk7XG4gICAgfVxufVxuIl19