/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { LogService } from '@alfresco/adf-core';
import { DatePipe } from '@angular/common';
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { ProcessService } from './../services/process.service';
import { ProcessInstanceHeaderComponent } from './process-instance-header.component';
import { ProcessInstanceTasksComponent } from './process-instance-tasks.component';
export class ProcessInstanceDetailsComponent {
    /**
     * Constructor
     * @param {?} activitiProcess   Process service
     * @param {?} logService
     */
    constructor(activitiProcess, logService) {
        this.activitiProcess = activitiProcess;
        this.logService = logService;
        /**
         * Toggles whether to show or hide the title.
         */
        this.showTitle = true;
        /**
         * Toggles whether to show or hide the refresh button.
         */
        this.showRefreshButton = true;
        /**
         * Emitted when the current process is cancelled by the user from within the component.
         */
        this.processCancelled = new EventEmitter();
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
        /**
         * Emitted when a task is clicked.
         */
        this.taskClick = new EventEmitter();
        /**
         * Emitted when the "show diagram" button is clicked.
         */
        this.showProcessDiagram = new EventEmitter();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        /** @type {?} */
        let processInstanceId = changes['processInstanceId'];
        if (processInstanceId && !processInstanceId.currentValue) {
            this.reset();
            return;
        }
        if (processInstanceId && processInstanceId.currentValue) {
            this.load(processInstanceId.currentValue);
            return;
        }
    }
    /**
     * Reset the task detail
     * @return {?}
     */
    reset() {
        this.processInstanceDetails = null;
    }
    /**
     * @param {?} processId
     * @return {?}
     */
    load(processId) {
        if (processId) {
            this.activitiProcess.getProcess(processId).subscribe((res) => {
                this.processInstanceDetails = res;
            });
        }
    }
    /**
     * @return {?}
     */
    isRunning() {
        return this.processInstanceDetails && !this.processInstanceDetails.ended;
    }
    /**
     * @return {?}
     */
    cancelProcess() {
        this.activitiProcess.cancelProcess(this.processInstanceId).subscribe((data) => {
            this.processCancelled.emit(data);
        }, (err) => {
            this.error.emit(err);
        });
    }
    // bubbles (taskClick) event
    /**
     * @param {?} event
     * @return {?}
     */
    onTaskClicked(event) {
        this.taskClick.emit(event);
    }
    /**
     * @param {?} dateFormat
     * @return {?}
     */
    getProcessNameOrDescription(dateFormat) {
        /** @type {?} */
        let name = '';
        if (this.processInstanceDetails) {
            name = this.processInstanceDetails.name ||
                this.processInstanceDetails.processDefinitionName + ' - ' + this.getFormatDate(this.processInstanceDetails.started, dateFormat);
        }
        return name;
    }
    /**
     * @param {?} value
     * @param {?} format
     * @return {?}
     */
    getFormatDate(value, format) {
        /** @type {?} */
        let datePipe = new DatePipe('en-US');
        try {
            return datePipe.transform(value, format);
        }
        catch (err) {
            this.logService.error(`ProcessListInstanceHeader: error parsing date ${value} to format ${format}`);
        }
    }
    /**
     * @param {?} processInstanceId
     * @return {?}
     */
    onShowProcessDiagram(processInstanceId) {
        this.showProcessDiagram.emit({ value: this.processInstanceId });
    }
}
ProcessInstanceDetailsComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-process-instance-details',
                template: "<div *ngIf=\"!processInstanceDetails\">{{ 'ADF_PROCESS_LIST.DETAILS.MESSAGES.NONE'|translate }}</div>\n<mat-card *ngIf=\"processInstanceDetails\">\n    <mat-card-header>\n        <mat-card-title>{{ getProcessNameOrDescription('medium') }}</mat-card-title>\n    </mat-card-header>\n    <mat-card-content>\n        <adf-process-instance-header\n            #processInstanceHeader\n            [processInstance]=\"processInstanceDetails\"\n            (showProcessDiagram)=\"onShowProcessDiagram($event)\">\n        </adf-process-instance-header>\n\n        <button class=\"adf-in-medias-res-button\" mat-button id=\"show-diagram-button\" type=\"button\" mat-button mat-raised-button [disabled]=\"!isRunning()\" (click)=\"onShowProcessDiagram(processInstanceId)\">{{ 'ADF_PROCESS_LIST.DETAILS.BUTTON.SHOW_DIAGRAM' | translate }}</button>\n\n        <mat-card>\n            <mat-card-content>\n                <adf-process-instance-tasks\n                    #processInstanceTasks\n                    [processInstanceDetails]=\"processInstanceDetails\"\n                    (taskClick)=\"onTaskClicked($event)\">\n                </adf-process-instance-tasks>\n            </mat-card-content>\n        </mat-card>\n\n        <div data-automation-id=\"header-status\" *ngIf=\"isRunning()\" class=\"adf-in-medias-res-button\">\n            <button mat-button type=\"button\" (click)=\"cancelProcess()\">{{ 'ADF_PROCESS_LIST.DETAILS.BUTTON.CANCEL' | translate }}</button>\n        </div>\n\n        <mat-card>\n            <mat-card-content>\n                <adf-process-instance-comments #activitiComments\n                    [readOnly]=\"false\"\n                    [processInstanceId]=\"processInstanceDetails.id\">\n                </adf-process-instance-comments>\n            </mat-card-content>\n        </mat-card>\n\n    </mat-card-content>\n</mat-card>\n",
                styles: [":host{width:100%}.activiti-process-container{width:100%;min-height:100px;overflow:visible;padding:10px}.adf-comments-dialog{position:fixed;top:50%;-webkit-transform:translate(0,-50%);transform:translate(0,-50%);width:40%}.adf-in-medias-res-button{margin:16px 0}"]
            }] }
];
/** @nocollapse */
ProcessInstanceDetailsComponent.ctorParameters = () => [
    { type: ProcessService },
    { type: LogService }
];
ProcessInstanceDetailsComponent.propDecorators = {
    processInstanceId: [{ type: Input }],
    processInstanceHeader: [{ type: ViewChild, args: ['processInstanceHeader',] }],
    tasksList: [{ type: ViewChild, args: ['processInstanceTasks',] }],
    showTitle: [{ type: Input }],
    showRefreshButton: [{ type: Input }],
    processCancelled: [{ type: Output }],
    error: [{ type: Output }],
    taskClick: [{ type: Output }],
    showProcessDiagram: [{ type: Output }]
};
if (false) {
    /**
     * (required) The numeric ID of the process instance to display.
     * @type {?}
     */
    ProcessInstanceDetailsComponent.prototype.processInstanceId;
    /** @type {?} */
    ProcessInstanceDetailsComponent.prototype.processInstanceHeader;
    /** @type {?} */
    ProcessInstanceDetailsComponent.prototype.tasksList;
    /**
     * Toggles whether to show or hide the title.
     * @type {?}
     */
    ProcessInstanceDetailsComponent.prototype.showTitle;
    /**
     * Toggles whether to show or hide the refresh button.
     * @type {?}
     */
    ProcessInstanceDetailsComponent.prototype.showRefreshButton;
    /**
     * Emitted when the current process is cancelled by the user from within the component.
     * @type {?}
     */
    ProcessInstanceDetailsComponent.prototype.processCancelled;
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    ProcessInstanceDetailsComponent.prototype.error;
    /**
     * Emitted when a task is clicked.
     * @type {?}
     */
    ProcessInstanceDetailsComponent.prototype.taskClick;
    /** @type {?} */
    ProcessInstanceDetailsComponent.prototype.processInstanceDetails;
    /**
     * Emitted when the "show diagram" button is clicked.
     * @type {?}
     */
    ProcessInstanceDetailsComponent.prototype.showProcessDiagram;
    /**
     * @type {?}
     * @private
     */
    ProcessInstanceDetailsComponent.prototype.activitiProcess;
    /**
     * @type {?}
     * @private
     */
    ProcessInstanceDetailsComponent.prototype.logService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1pbnN0YW5jZS1kZXRhaWxzLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtcHJvY2Vzcy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInByb2Nlc3MtbGlzdC9jb21wb25lbnRzL3Byb2Nlc3MtaW5zdGFuY2UtZGV0YWlscy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQWEsTUFBTSxFQUFpQixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJNUcsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQy9ELE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBT25GLE1BQU0sT0FBTywrQkFBK0I7Ozs7OztJQTJDeEMsWUFBb0IsZUFBK0IsRUFDL0IsVUFBc0I7UUFEdEIsb0JBQWUsR0FBZixlQUFlLENBQWdCO1FBQy9CLGVBQVUsR0FBVixVQUFVLENBQVk7Ozs7UUE5QjFDLGNBQVMsR0FBWSxJQUFJLENBQUM7Ozs7UUFJMUIsc0JBQWlCLEdBQVksSUFBSSxDQUFDOzs7O1FBSWxDLHFCQUFnQixHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDOzs7O1FBSTlELFVBQUssR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQzs7OztRQUluRCxjQUFTLEdBQW1DLElBQUksWUFBWSxFQUFvQixDQUFDOzs7O1FBTWpGLHVCQUFrQixHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO0lBU2hFLENBQUM7Ozs7O0lBRUQsV0FBVyxDQUFD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LEtBQUs7Z0NBSUwsS0FBSzsrQkFJTCxNQUFNO29CQUlOLE1BQU07d0JBSU4sTUFBTTtpQ0FNTixNQUFNOzs7Ozs7O0lBaENQLDREQUMwQjs7SUFFMUIsZ0VBQ3NEOztJQUV0RCxvREFDeUM7Ozs7O0lBR3pDLG9EQUMwQjs7Ozs7SUFHMUIsNERBQ2tDOzs7OztJQUdsQywyREFDOEQ7Ozs7O0lBRzlELGdEQUNtRDs7Ozs7SUFHbkQsb0RBQ2lGOztJQUVqRixpRUFBd0M7Ozs7O0lBR3hDLDZEQUNnRTs7Ozs7SUFPcEQsMERBQXVDOzs7OztJQUN2QyxxREFBOEIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7IERhdGVQaXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25DaGFuZ2VzLCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGFza0RldGFpbHNFdmVudCB9IGZyb20gJy4uLy4uL3Rhc2stbGlzdCc7XG5cbmltcG9ydCB7IFByb2Nlc3NJbnN0YW5jZSB9IGZyb20gJy4uL21vZGVscy9wcm9jZXNzLWluc3RhbmNlLm1vZGVsJztcbmltcG9ydCB7IFByb2Nlc3NTZXJ2aWNlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy9wcm9jZXNzLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJvY2Vzc0luc3RhbmNlSGVhZGVyQ29tcG9uZW50IH0gZnJvbSAnLi9wcm9jZXNzLWluc3RhbmNlLWhlYWRlci5jb21wb25lbnQnO1xuaW1wb3J0IHsgUHJvY2Vzc0luc3RhbmNlVGFza3NDb21wb25lbnQgfSBmcm9tICcuL3Byb2Nlc3MtaW5zdGFuY2UtdGFza3MuY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhZGYtcHJvY2Vzcy1pbnN0YW5jZS1kZXRhaWxzJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vcHJvY2Vzcy1pbnN0YW5jZS1kZXRhaWxzLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9wcm9jZXNzLWluc3RhbmNlLWRldGFpbHMuY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIFByb2Nlc3NJbnN0YW5jZURldGFpbHNDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuXG4gICAgLyoqIChyZXF1aXJlZCkgVGhlIG51bWVyaWMgSUQgb2YgdGhlIHByb2Nlc3MgaW5zdGFuY2UgdG8gZGlzcGxheS4gKi9cbiAgICBASW5wdXQoKVxuICAgIHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmc7XG5cbiAgICBAVmlld0NoaWxkKCdwcm9jZXNzSW5zdGFuY2VIZWFkZXInKVxuICAgIHByb2Nlc3NJbnN0YW5jZUhlYWRlcjogUHJvY2Vzc0luc3RhbmNlSGVhZGVyQ29tcG9uZW50O1xuXG4gICAgQFZpZXdDaGlsZCgncHJvY2Vzc0luc3RhbmNlVGFza3MnKVxuICAgIHRhc2tzTGlzdDogUHJvY2Vzc0luc3RhbmNlVGFza3NDb21wb25lbnQ7XG5cbiAgICAvKiogVG9nZ2xlcyB3aGV0aGVyIHRvIHNob3cgb3IgaGlkZSB0aGUgdGl0bGUuICovXG4gICAgQElucHV0KClcbiAgICBzaG93VGl0bGU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgLyoqIFRvZ2dsZXMgd2hldGhlciB0byBzaG93IG9yIGhpZGUgdGhlIHJlZnJlc2ggYnV0dG9uLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgc2hvd1JlZnJlc2hCdXR0b246IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgY3VycmVudCBwcm9jZXNzIGlzIGNhbmNlbGxlZCBieSB0aGUgdXNlciBmcm9tIHdpdGhpbiB0aGUgY29tcG9uZW50LiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIHByb2Nlc3NDYW5jZWxsZWQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3Vycy4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBlcnJvcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gYSB0YXNrIGlzIGNsaWNrZWQuICovXG4gICAgQE91dHB1dCgpXG4gICAgdGFza0NsaWNrOiBFdmVudEVtaXR0ZXI8VGFza0RldGFpbHNFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyPFRhc2tEZXRhaWxzRXZlbnQ+KCk7XG5cbiAgICBwcm9jZXNzSW5zdGFuY2VEZXRhaWxzOiBQcm9jZXNzSW5zdGFuY2U7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIHRoZSBcInNob3cgZGlhZ3JhbVwiIGJ1dHRvbiBpcyBjbGlja2VkLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIHNob3dQcm9jZXNzRGlhZ3JhbTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIC8qKlxuICAgICAqIENvbnN0cnVjdG9yXG4gICAgICogQHBhcmFtIHRyYW5zbGF0ZSBUcmFuc2xhdGlvbiBzZXJ2aWNlXG4gICAgICogQHBhcmFtIGFjdGl2aXRpUHJvY2VzcyAgIFByb2Nlc3Mgc2VydmljZVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYWN0aXZpdGlQcm9jZXNzOiBQcm9jZXNzU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UpIHtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIGxldCBwcm9jZXNzSW5zdGFuY2VJZCA9IGNoYW5nZXNbJ3Byb2Nlc3NJbnN0YW5jZUlkJ107XG4gICAgICAgIGlmIChwcm9jZXNzSW5zdGFuY2VJZCAmJiAhcHJvY2Vzc0luc3RhbmNlSWQuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb2Nlc3NJbnN0YW5jZUlkICYmIHByb2Nlc3NJbnN0YW5jZUlkLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgdGhpcy5sb2FkKHByb2Nlc3NJbnN0YW5jZUlkLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXNldCB0aGUgdGFzayBkZXRhaWxcbiAgICAgKi9cbiAgICByZXNldCgpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzSW5zdGFuY2VEZXRhaWxzID0gbnVsbDtcbiAgICB9XG5cbiAgICBsb2FkKHByb2Nlc3NJZDogc3RyaW5nKSB7XG4gICAgICAgIGlmIChwcm9jZXNzSWQpIHtcbiAgICAgICAgICAgIHRoaXMuYWN0aXZpdGlQcm9jZXNzLmdldFByb2Nlc3MocHJvY2Vzc0lkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKHJlczogUHJvY2Vzc0luc3RhbmNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0luc3RhbmNlRGV0YWlscyA9IHJlcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNSdW5uaW5nKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9jZXNzSW5zdGFuY2VEZXRhaWxzICYmICF0aGlzLnByb2Nlc3NJbnN0YW5jZURldGFpbHMuZW5kZWQ7XG4gICAgfVxuXG4gICAgY2FuY2VsUHJvY2VzcygpIHtcbiAgICAgICAgdGhpcy5hY3Rpdml0aVByb2Nlc3MuY2FuY2VsUHJvY2Vzcyh0aGlzLnByb2Nlc3NJbnN0YW5jZUlkKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0NhbmNlbGxlZC5lbWl0KGRhdGEpO1xuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gYnViYmxlcyAodGFza0NsaWNrKSBldmVudFxuICAgIG9uVGFza0NsaWNrZWQoZXZlbnQ6IFRhc2tEZXRhaWxzRXZlbnQpIHtcbiAgICAgICAgdGhpcy50YXNrQ2xpY2suZW1pdChldmVudCk7XG4gICAgfVxuXG4gICAgZ2V0UHJvY2Vzc05hbWVPckRlc2NyaXB0aW9uKGRhdGVGb3JtYXQpOiBzdHJpbmcge1xuICAgICAgICBsZXQgbmFtZSA9ICcnO1xuICAgICAgICBpZiAodGhpcy5wcm9jZXNzSW5zdGFuY2VEZXRhaWxzKSB7XG4gICAgICAgICAgICBuYW1lID0gdGhpcy5wcm9jZXNzSW5zdGFuY2VEZXRhaWxzLm5hbWUgfHxcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NJbnN0YW5jZURldGFpbHMucHJvY2Vzc0RlZmluaXRpb25OYW1lICsgJyAtICcgKyB0aGlzLmdldEZvcm1hdERhdGUodGhpcy5wcm9jZXNzSW5zdGFuY2VEZXRhaWxzLnN0YXJ0ZWQsIGRhdGVGb3JtYXQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuYW1lO1xuICAgIH1cblxuICAgIGdldEZvcm1hdERhdGUodmFsdWUsIGZvcm1hdDogc3RyaW5nKSB7XG4gICAgICAgIGxldCBkYXRlUGlwZSA9IG5ldyBEYXRlUGlwZSgnZW4tVVMnKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBkYXRlUGlwZS50cmFuc2Zvcm0odmFsdWUsIGZvcm1hdCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGBQcm9jZXNzTGlzdEluc3RhbmNlSGVhZGVyOiBlcnJvciBwYXJzaW5nIGRhdGUgJHt2YWx1ZX0gdG8gZm9ybWF0ICR7Zm9ybWF0fWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25TaG93UHJvY2Vzc0RpYWdyYW0ocHJvY2Vzc0luc3RhbmNlSWQ6IGFueSkge1xuICAgICAgICB0aGlzLnNob3dQcm9jZXNzRGlhZ3JhbS5lbWl0KHt2YWx1ZTogdGhpcy5wcm9jZXNzSW5zdGFuY2VJZH0pO1xuICAgIH1cblxufVxuIl19