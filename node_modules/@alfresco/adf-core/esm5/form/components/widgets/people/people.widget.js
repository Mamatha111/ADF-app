/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector  */
import { PeopleProcessService } from '../../../../services/people-process.service';
import { Component, ElementRef, EventEmitter, Output, ViewChild, ViewEncapsulation } from '@angular/core';
import { FormService } from '../../../services/form.service';
import { baseHost, WidgetComponent } from './../widget.component';
import { FormControl } from '@angular/forms';
import { of } from 'rxjs';
import { catchError, distinctUntilChanged, map, switchMap, tap } from 'rxjs/operators';
var PeopleWidgetComponent = /** @class */ (function (_super) {
    tslib_1.__extends(PeopleWidgetComponent, _super);
    function PeopleWidgetComponent(formService, peopleProcessService) {
        var _this = _super.call(this, formService) || this;
        _this.formService = formService;
        _this.peopleProcessService = peopleProcessService;
        _this.searchTerm = new FormControl();
        _this.errorMsg = '';
        _this.searchTerms$ = _this.searchTerm.valueChanges;
        _this.users$ = _this.searchTerms$.pipe(tap(function () {
            _this.errorMsg = '';
        }), distinctUntilChanged(), switchMap(function (searchTerm) {
            /** @type {?} */
            var value = searchTerm.email ? _this.getDisplayName(searchTerm) : searchTerm;
            return _this.formService.getWorkflowUsers(value, _this.groupId)
                .pipe(catchError(function (err) {
                _this.errorMsg = err.message;
                return of();
            }));
        }), map(function (list) {
            /** @type {?} */
            var value = _this.searchTerm.value.email ? _this.getDisplayName(_this.searchTerm.value) : _this.searchTerm.value;
            _this.checkUserAndValidateForm(list, value);
            return list;
        }));
        _this.peopleSelected = new EventEmitter();
        return _this;
    }
    /**
     * @return {?}
     */
    PeopleWidgetComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        if (this.field) {
            if (this.field.value) {
                this.searchTerm.setValue(this.field.value);
            }
            if (this.field.readOnly) {
                this.searchTerm.disable();
            }
            /** @type {?} */
            var params = this.field.params;
            if (params && params.restrictWithGroup) {
                /** @type {?} */
                var restrictWithGroup = (/** @type {?} */ (params.restrictWithGroup));
                this.groupId = restrictWithGroup.id;
            }
        }
    };
    /**
     * @param {?} list
     * @param {?} value
     * @return {?}
     */
    PeopleWidgetComponent.prototype.checkUserAndValidateForm = /**
     * @param {?} list
     * @param {?} value
     * @return {?}
     */
    function (list, value) {
        /** @type {?} */
        var isValidUser = this.isValidUser(list, value);
        if (isValidUser || value === '') {
            this.field.validationSummary.message = '';
            this.field.validate();
            this.field.form.validateForm();
        }
        else {
            this.field.validationSummary.message = 'FORM.FIELD.VALIDATOR.INVALID_VALUE';
            this.field.markAsInvalid();
            this.field.form.markAsInvalid();
        }
    };
    /**
     * @param {?} users
     * @param {?} name
     * @return {?}
     */
    PeopleWidgetComponent.prototype.isValidUser = /**
     * @param {?} users
     * @param {?} name
     * @return {?}
     */
    function (users, name) {
        var _this = this;
        if (users) {
            return users.find(function (user) {
                /** @type {?} */
                var selectedUser = _this.getDisplayName(user).toLocaleLowerCase() === name.toLocaleLowerCase();
                if (selectedUser) {
                    _this.peopleSelected.emit(user && user.id || undefined);
                }
                return selectedUser;
            });
        }
    };
    /**
     * @param {?} model
     * @return {?}
     */
    PeopleWidgetComponent.prototype.getDisplayName = /**
     * @param {?} model
     * @return {?}
     */
    function (model) {
        if (model) {
            /** @type {?} */
            var displayName = (model.firstName || '') + " " + (model.lastName || '');
            return displayName.trim();
        }
        return '';
    };
    /**
     * @param {?} item
     * @return {?}
     */
    PeopleWidgetComponent.prototype.onItemSelect = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        if (item) {
            this.field.value = item;
        }
    };
    PeopleWidgetComponent.decorators = [
        { type: Component, args: [{
                    selector: 'people-widget',
                    template: "<div class=\"adf-people-widget {{field.className}}\"\n     [class.adf-invalid]=\"!field.isValid\"\n     [class.adf-readonly]=\"field.readOnly\"\n     id=\"people-widget-content\">\n    <mat-form-field>\n        <label class=\"adf-label\" [attr.for]=\"field.id\">{{field.name}}<span *ngIf=\"isRequired()\">*</span></label>\n        <input #inputValue\n               matInput\n               class=\"adf-input\"\n               data-automation-id=\"adf-people-search-input\"\n               type=\"text\"\n               [id]=\"field.id\"\n               [formControl]=\"searchTerm\"\n               placeholder=\"{{field.placeholder}}\"\n               [matAutocomplete]=\"auto\">\n        <mat-autocomplete class=\"adf-people-widget-list\"\n                          #auto=\"matAutocomplete\"\n                          (optionSelected)=\"onItemSelect($event.option.value)\"\n                          [displayWith]=\"getDisplayName\">\n            <mat-option *ngFor=\"let user of users$ | async; let i = index\" [value]=\"user\">\n                <div class=\"adf-people-widget-row\" id=\"adf-people-widget-user-{{i}}\">\n                    <div [outerHTML]=\"user | usernameInitials:'adf-people-widget-pic'\"></div>\n                    <div *ngIf=\"user.pictureId\" class=\"adf-people-widget-image-row\">\n                        <img id=\"adf-people-widget-pic-{{i}}\" class=\"adf-people-widget-image\"\n                             [src]=\"peopleProcessService.getUserImage(user)\"/>\n                    </div>\n                    <span class=\"adf-people-label-name\">{{getDisplayName(user)}}</span>\n                </div>\n            </mat-option>\n        </mat-autocomplete>\n    </mat-form-field>\n    <error-widget [error]=\"field.validationSummary\"></error-widget>\n    <error-widget *ngIf=\"isInvalidFieldRequired()\" required=\"{{ 'FORM.FIELD.REQUIRED' | translate }}\"></error-widget>\n</div>\n",
                    host: baseHost,
                    encapsulation: ViewEncapsulation.None,
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    PeopleWidgetComponent.ctorParameters = function () { return [
        { type: FormService },
        { type: PeopleProcessService }
    ]; };
    PeopleWidgetComponent.propDecorators = {
        input: [{ type: ViewChild, args: ['inputValue',] }],
        peopleSelected: [{ type: Output }]
    };
    return PeopleWidgetComponent;
}(WidgetComponent));
export { PeopleWidgetComponent };
if (false) {
    /** @type {?} */
    PeopleWidgetComponent.prototype.input;
    /** @type {?} */
    PeopleWidgetComponent.prototype.peopleSelected;
    /** @type {?} */
    PeopleWidgetComponent.prototype.groupId;
    /** @type {?} */
    PeopleWidgetComponent.prototype.value;
    /** @type {?} */
    PeopleWidgetComponent.prototype.searchTerm;
    /** @type {?} */
    PeopleWidgetComponent.prototype.errorMsg;
    /** @type {?} */
    PeopleWidgetComponent.prototype.searchTerms$;
    /** @type {?} */
    PeopleWidgetComponent.prototype.users$;
    /** @type {?} */
    PeopleWidgetComponent.prototype.formService;
    /** @type {?} */
    PeopleWidgetComponent.prototype.peopleProcessService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVvcGxlLndpZGdldC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29yZS8iLCJzb3VyY2VzIjpbImZvcm0vY29tcG9uZW50cy93aWRnZXRzL3Blb3BsZS9wZW9wbGUud2lkZ2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFtQkEsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFFbkYsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEgsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRTdELE9BQU8sRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUNILFVBQVUsRUFDVixvQkFBb0IsRUFDcEIsR0FBRyxFQUNILFNBQVMsRUFDVCxHQUFHLEVBQ04sTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QjtJQU8yQyxpREFBZTtJQXFDdEQsK0JBQW1CLFdBQXdCLEVBQVMsb0JBQTBDO1FBQTlGLFlBQ0ksa0JBQU0sV0FBVyxDQUFDLFNBRXJCO1FBSGtCLGlCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQVMsMEJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQTFCOUYsZ0JBQVUsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQy9CLGNBQVEsR0FBRyxFQUFFLENBQUM7UUFDZCxrQkFBWSxHQUFvQixLQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQztRQUU3RCxZQUFNLEdBQUcsS0FBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQzNCLEdBQUcsQ0FBQztZ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L0IseUNBQWM7O0lBQ2QsNkNBQTZEOztJQUU3RCx1Q0FvQkU7O0lBRVUsNENBQStCOztJQUFFLHFEQUFpRCIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8qIHRzbGludDpkaXNhYmxlOmNvbXBvbmVudC1zZWxlY3RvciAgKi9cblxuaW1wb3J0IHsgUGVvcGxlUHJvY2Vzc1NlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi9zZXJ2aWNlcy9wZW9wbGUtcHJvY2Vzcy5zZXJ2aWNlJztcbmltcG9ydCB7IFVzZXJQcm9jZXNzTW9kZWwgfSBmcm9tICcuLi8uLi8uLi8uLi9tb2RlbHMnO1xuaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGQsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2Zvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBHcm91cE1vZGVsIH0gZnJvbSAnLi4vY29yZS9ncm91cC5tb2RlbCc7XG5pbXBvcnQgeyBiYXNlSG9zdCwgV2lkZ2V0Q29tcG9uZW50IH0gZnJvbSAnLi8uLi93aWRnZXQuY29tcG9uZW50JztcbmltcG9ydCB7IEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gICAgY2F0Y2hFcnJvcixcbiAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgICBtYXAsXG4gICAgc3dpdGNoTWFwLFxuICAgIHRhcFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAncGVvcGxlLXdpZGdldCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3Blb3BsZS53aWRnZXQuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vcGVvcGxlLndpZGdldC5zY3NzJ10sXG4gICAgaG9zdDogYmFzZUhvc3QsXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBQZW9wbGVXaWRnZXRDb21wb25lbnQgZXh0ZW5kcyBXaWRnZXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gICAgQFZpZXdDaGlsZCgnaW5wdXRWYWx1ZScpXG4gICAgaW5wdXQ6IEVsZW1lbnRSZWY7XG5cbiAgICBAT3V0cHV0KClcbiAgICBwZW9wbGVTZWxlY3RlZDogRXZlbnRFbWl0dGVyPG51bWJlcj47XG5cbiAgICBncm91cElkOiBzdHJpbmc7XG4gICAgdmFsdWU6IGFueTtcblxuICAgIHNlYXJjaFRlcm0gPSBuZXcgRm9ybUNvbnRyb2woKTtcbiAgICBlcnJvck1zZyA9ICcnO1xuICAgIHNlYXJjaFRlcm1zJDogT2JzZXJ2YWJsZTxhbnk+ID0gdGhpcy5zZWFyY2hUZXJtLnZhbHVlQ2hhbmdlcztcblxuICAgIHVzZXJzJCA9IHRoaXMuc2VhcmNoVGVybXMkLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVycm9yTXNnID0gJyc7XG4gICAgICAgIH0pLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICBzd2l0Y2hNYXAoKHNlYXJjaFRlcm0pID0+IHtcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHNlYXJjaFRlcm0uZW1haWwgPyB0aGlzLmdldERpc3BsYXlOYW1lKHNlYXJjaFRlcm0pIDogc2VhcmNoVGVybTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1TZXJ2aWNlLmdldFdvcmtmbG93VXNlcnModmFsdWUsIHRoaXMuZ3JvdXBJZClcbiAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yTXNnID0gZXJyLm1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9KSxcbiAgICAgICAgbWFwKChsaXN0OiBVc2VyUHJvY2Vzc01vZGVsW10pID0+IHtcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuc2VhcmNoVGVybS52YWx1ZS5lbWFpbCA/IHRoaXMuZ2V0RGlzcGxheU5hbWUodGhpcy5zZWFyY2hUZXJtLnZhbHVlKSA6IHRoaXMuc2VhcmNoVGVybS52YWx1ZTtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tVc2VyQW5kVmFsaWRhdGVGb3JtKGxpc3QsIHZhbHVlKTtcbiAgICAgICAgICAgIHJldHVybiBsaXN0O1xuICAgICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgZm9ybVNlcnZpY2U6IEZvcm1TZXJ2aWNlLCBwdWJsaWMgcGVvcGxlUHJvY2Vzc1NlcnZpY2U6IFBlb3BsZVByb2Nlc3NTZXJ2aWNlKSB7XG4gICAgICAgIHN1cGVyKGZvcm1TZXJ2aWNlKTtcbiAgICAgICAgdGhpcy5wZW9wbGVTZWxlY3RlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZmllbGQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWFyY2hUZXJtLnNldFZhbHVlKHRoaXMuZmllbGQudmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuZmllbGQucmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaFRlcm0uZGlzYWJsZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IHBhcmFtcyA9IHRoaXMuZmllbGQucGFyYW1zO1xuICAgICAgICAgICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMucmVzdHJpY3RXaXRoR3JvdXApIHtcbiAgICAgICAgICAgICAgICBsZXQgcmVzdHJpY3RXaXRoR3JvdXAgPSA8R3JvdXBNb2RlbD4gcGFyYW1zLnJlc3RyaWN0V2l0aEdyb3VwO1xuICAgICAgICAgICAgICAgIHRoaXMuZ3JvdXBJZCA9IHJlc3RyaWN0V2l0aEdyb3VwLmlkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2hlY2tVc2VyQW5kVmFsaWRhdGVGb3JtKGxpc3QsIHZhbHVlKSB7XG4gICAgICAgIGNvbnN0IGlzVmFsaWRVc2VyID0gdGhpcy5pc1ZhbGlkVXNlcihsaXN0LCB2YWx1ZSk7XG4gICAgICAgIGlmIChpc1ZhbGlkVXNlciB8fCB2YWx1ZSA9PT0gJycpIHtcbiAgICAgICAgICAgIHRoaXMuZmllbGQudmFsaWRhdGlvblN1bW1hcnkubWVzc2FnZSA9ICcnO1xuICAgICAgICAgICAgdGhpcy5maWVsZC52YWxpZGF0ZSgpO1xuICAgICAgICAgICAgdGhpcy5maWVsZC5mb3JtLnZhbGlkYXRlRm9ybSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5maWVsZC52YWxpZGF0aW9uU3VtbWFyeS5tZXNzYWdlID0gJ0ZPUk0uRklFTEQuVkFMSURBVE9SLklOVkFMSURfVkFMVUUnO1xuICAgICAgICAgICAgdGhpcy5maWVsZC5tYXJrQXNJbnZhbGlkKCk7XG4gICAgICAgICAgICB0aGlzLmZpZWxkLmZvcm0ubWFya0FzSW52YWxpZCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNWYWxpZFVzZXIodXNlcnM6IFVzZXJQcm9jZXNzTW9kZWxbXSwgbmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGlmICh1c2Vycykge1xuICAgICAgICAgICAgcmV0dXJuIHVzZXJzLmZpbmQoKHVzZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RlZFVzZXIgPSB0aGlzLmdldERpc3BsYXlOYW1lKHVzZXIpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb2NhbGVMb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRVc2VyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGVvcGxlU2VsZWN0ZWQuZW1pdCh1c2VyICYmIHVzZXIuaWQgfHwgdW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdGVkVXNlcjtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0RGlzcGxheU5hbWUobW9kZWw6IFVzZXJQcm9jZXNzTW9kZWwpIHtcbiAgICAgICAgaWYgKG1vZGVsKSB7XG4gICAgICAgICAgICBsZXQgZGlzcGxheU5hbWUgPSBgJHttb2RlbC5maXJzdE5hbWUgfHwgJyd9ICR7bW9kZWwubGFzdE5hbWUgfHwgJyd9YDtcbiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZS50cmltKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIG9uSXRlbVNlbGVjdChpdGVtOiBVc2VyUHJvY2Vzc01vZGVsKSB7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlID0gaXRlbTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==