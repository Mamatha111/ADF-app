/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector  */
import moment from 'moment-es6';
import { ValidateDynamicTableRowEvent } from '../../../events/validate-dynamic-table-row.event';
import { FormWidgetModel } from './../core/form-widget.model';
import { DateCellValidator } from './date-cell-validator-model';
import { DynamicRowValidationSummary } from './dynamic-row-validation-summary.model';
import { NumberCellValidator } from './number-cell-validator.model';
import { RequiredCellValidator } from './required-cell-validator.model';
var DynamicTableModel = /** @class */ (function (_super) {
    tslib_1.__extends(DynamicTableModel, _super);
    function DynamicTableModel(field, formService) {
        var _this = _super.call(this, field.form, field.json) || this;
        _this.formService = formService;
        _this.columns = [];
        _this.visibleColumns = [];
        _this.rows = [];
        _this._validators = [];
        _this.field = field;
        if (field.json) {
            /** @type {?} */
            var columns = _this.getColumns(field);
            if (columns) {
                _this.columns = columns;
                _this.visibleColumns = _this.columns.filter(function (col) { return col.visible; });
            }
            if (field.json.value) {
                _this.rows = field.json.value.map(function (obj) { return (/** @type {?} */ ({ selected: false, value: obj })); });
            }
        }
        _this._validators = [
            new RequiredCellValidator(),
            new DateCellValidator(),
            new NumberCellValidator()
        ];
        return _this;
    }
    Object.defineProperty(DynamicTableModel.prototype, "selectedRow", {
        get: /**
         * @return {?}
         */
        function () {
            return this._selectedRow;
        },
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            if (this._selectedRow && this._selectedRow === value) {
                this._selectedRow.selected = false;
                this._selectedRow = null;
                return;
            }
            this.rows.forEach(function (row) { return row.selected = false; });
            this._selectedRow = value;
            if (value) {
                this._selectedRow.selected = true;
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} field
     * @return {?}
     */
    DynamicTableModel.prototype.getColumns = /**
     * @private
     * @param {?} field
     * @return {?}
     */
    function (field) {
        if (field && field.json) {
            /** @type {?} */
            var definitions = field.json.columnDefinitions;
            if (!definitions && field.json.params && field.json.params.field) {
                definitions = field.json.params.field.columnDefinitions;
            }
            if (definitions) {
                return definitions.map(function (obj) { return (/** @type {?} */ (obj)); });
            }
        }
        return null;
    };
    /**
     * @return {?}
     */
    DynamicTableModel.prototype.flushValue = /**
     * @return {?}
     */
    function () {
        if (this.field) {
            this.field.value = this.rows.map(function (r) { return r.value; });
            this.field.updateForm();
        }
    };
    /**
     * @param {?} row
     * @param {?} offset
     * @return {?}
     */
    DynamicTableModel.prototype.moveRow = /**
     * @param {?} row
     * @param {?} offset
     * @return {?}
     */
    function (row, offset) {
        /** @type {?} */
        var oldIndex = this.rows.indexOf(row);
        if (oldIndex > -1) {
            /** @type {?} */
            var newIndex = (oldIndex + offset);
            if (newIndex < 0) {
                newIndex = 0;
            }
            else if (newIndex >= this.rows.length) {
                newIndex = this.rows.length;
            }
            /** @type {?} */
            var arr = this.rows.slice();
            arr.splice(oldIndex, 1);
            arr.splice(newIndex, 0, row);
            this.rows = arr;
            this.flushValue();
        }
    };
    /**
     * @param {?} row
     * @return {?}
     */
    DynamicTableModel.prototype.deleteRow = /**
     * @param {?} row
     * @return {?}
     */
    function (row) {
        if (row) {
            if (this.selectedRow === row) {
                this.selectedRow = null;
            }
            /** @type {?} */
            var idx = this.rows.indexOf(row);
            if (idx > -1) {
                this.rows.splice(idx, 1);
                this.flushValue();
            }
        }
    };
    /**
     * @param {?} row
     * @return {?}
     */
    DynamicTableModel.prototype.addRow = /**
     * @param {?} row
     * @return {?}
     */
    function (row) {
        if (row) {
            this.rows.push(row);
            // this.selectedRow = row;
        }
    };
    /**
     * @param {?} row
     * @return {?}
     */
    DynamicTableModel.prototype.validateRow = /**
     * @param {?} row
     * @return {?}
     */
    function (row) {
        var e_1, _a, e_2, _b;
        /** @type {?} */
        var summary = new DynamicRowValidationSummary({
            isValid: true,
            message: null
        });
        /** @type {?} */
        var event = new ValidateDynamicTableRowEvent(this.form, this.field, row, summary);
        this.formService.validateDynamicTableRow.next(event);
        if (event.defaultPrevented || !summary.isValid) {
            return summary;
        }
        if (row) {
            try {
                for (var _c = tslib_1.__values(this.columns), _d = _c.next(); !_d.done; _d = _c.next()) {
                    var col = _d.value;
                    try {
                        for (var _e = tslib_1.__values(this._validators), _f = _e.next(); !_f.done; _f = _e.next()) {
                            var validator = _f.value;
                            if (!validator.validate(row, col, summary)) {
                                return summary;
                            }
                        }
                    }
                    catch (e_2_1) { e_2 = { error: e_2_1 }; }
                    finally {
                        try {
                            if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
                        }
                        finally { if (e_2) throw e_2.error; }
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        return summary;
    };
    /**
     * @param {?} row
     * @param {?} column
     * @return {?}
     */
    DynamicTableModel.prototype.getCellValue = /**
     * @param {?} row
     * @param {?} column
     * @return {?}
     */
    function (row, column) {
        /** @type {?} */
        var rowValue = row.value[column.id];
        if (column.type === 'Dropdown') {
            if (rowValue) {
                return rowValue.name;
            }
        }
        if (column.type === 'Boolean') {
            return rowValue ? true : false;
        }
        if (column.type === 'Date') {
            if (rowValue) {
                return moment(rowValue.split('T')[0], 'YYYY-MM-DD').format('DD-MM-YYYY');
            }
        }
        return rowValue || '';
    };
    /**
     * @param {?} column
     * @return {?}
     */
    DynamicTableModel.prototype.getDisplayText = /**
     * @param {?} column
     * @return {?}
     */
    function (column) {
        /** @type {?} */
        var columnName = column.name;
        if (column.type === 'Amount') {
            /** @type {?} */
            var currency = column.amountCurrency || '$';
            columnName = column.name + " (" + currency + ")";
        }
        return columnName;
    };
    return DynamicTableModel;
}(FormWidgetModel));
export { DynamicTableModel };
if (false) {
    /** @type {?} */
    DynamicTableModel.prototype.field;
    /** @type {?} */
    DynamicTableModel.prototype.columns;
    /** @type {?} */
    DynamicTableModel.prototype.visibleColumns;
    /** @type {?} */
    DynamicTableModel.prototype.rows;
    /**
     * @type {?}
     * @private
     */
    DynamicTableModel.prototype._selectedRow;
    /**
     * @type {?}
     * @private
     */
    DynamicTableModel.prototype._validators;
    /**
     * @type {?}
     * @private
     */
    DynamicTableModel.prototype.formService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy10YWJsZS53aWRnZXQubW9kZWwuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJmb3JtL2NvbXBvbmVudHMvd2lkZ2V0cy9keW5hbWljLXRhYmxlL2R5bmFtaWMtdGFibGUud2lkZ2V0Lm1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFtQkEsT0FBTyxNQUFNLE1BQU0sWUFBWSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBR2hHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUdyRixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUV4RTtJQUF1Qyw2Q0FBZTtJQThCbEQsMkJBQVksS0FBcUIsRUFBVSxXQUF3QjtRQUFuRSxZQUNJLGtCQUFNLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxTQW9CaEM7UUFyQjBDLGlCQUFXLEdBQVgsV0FBVyxDQUFhO1FBM0JuRSxhQUFPLEdBQXlCLEVBQUUsQ0FBQztRQUNuQyxvQkFBYyxHQUF5QixFQUFFLENBQUM7UUFDMUMsVUFBSSxHQUFzQixFQUFFLENBQUM7UUFHckIsaUJBQVcsR0FBb0IsRUFBRSxDQUFDO1FBd0J0QyxLQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7O2dCQUNOLE9BQU8sR0FBRyxLQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztZQUN0QyxJQUFJLE9BQU8s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YUFDeEI7U0FDSjtRQUVELElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7WUFDM0IsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1NBQ2xDO1FBRUQsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUN4QixJQUFJLFFBQVEsRUFBRTtnQkFDVixPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUM1RTtTQUNKO1FBRUQsT0FBTyxRQUFRLElBQUksRUFBRSxDQUFDO0lBQzFCLENBQUM7Ozs7O0lBRUQsMENBQWM7Ozs7SUFBZCxVQUFlLE1BQTBCOztZQUNqQyxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUk7UUFDNUIsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTs7Z0JBQ3RCLFFBQVEsR0FBRyxNQUFNLENBQUMsY0FBYyxJQUFJLEdBQUc7WUFDM0MsVUFBVSxHQUFNLE1BQU0sQ0FBQyxJQUFJLFVBQUssUUFBUSxNQUFHLENBQUM7U0FDL0M7UUFDRCxPQUFPLFVBQVUsQ0FBQztJQUN0QixDQUFDO0lBQ0wsd0JBQUM7QUFBRCxDQUFDLEFBMUtELENBQXVDLGVBQWUsR0EwS3JEOzs7O0lBeEtHLGtDQUFzQjs7SUFDdEIsb0NBQW1DOztJQUNuQywyQ0FBMEM7O0lBQzFDLGlDQUE2Qjs7Ozs7SUFFN0IseUNBQXNDOzs7OztJQUN0Qyx3Q0FBMEM7Ozs7O0lBc0JQLHdDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbiAvKiB0c2xpbnQ6ZGlzYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgICovXG5cbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50LWVzNic7XG5pbXBvcnQgeyBWYWxpZGF0ZUR5bmFtaWNUYWJsZVJvd0V2ZW50IH0gZnJvbSAnLi4vLi4vLi4vZXZlbnRzL3ZhbGlkYXRlLWR5bmFtaWMtdGFibGUtcm93LmV2ZW50JztcbmltcG9ydCB7IEZvcm1TZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi8uLi9zZXJ2aWNlcy9mb3JtLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUZpZWxkTW9kZWwgfSBmcm9tICcuLy4uL2NvcmUvZm9ybS1maWVsZC5tb2RlbCc7XG5pbXBvcnQgeyBGb3JtV2lkZ2V0TW9kZWwgfSBmcm9tICcuLy4uL2NvcmUvZm9ybS13aWRnZXQubW9kZWwnO1xuaW1wb3J0IHsgQ2VsbFZhbGlkYXRvciB9IGZyb20gJy4vY2VsbC12YWxpZGF0b3IubW9kZWwnO1xuaW1wb3J0IHsgRGF0ZUNlbGxWYWxpZGF0b3IgfSBmcm9tICcuL2RhdGUtY2VsbC12YWxpZGF0b3ItbW9kZWwnO1xuaW1wb3J0IHsgRHluYW1pY1Jvd1ZhbGlkYXRpb25TdW1tYXJ5IH0gZnJvbSAnLi9keW5hbWljLXJvdy12YWxpZGF0aW9uLXN1bW1hcnkubW9kZWwnO1xuaW1wb3J0IHsgRHluYW1pY1RhYmxlQ29sdW1uIH0gZnJvbSAnLi9keW5hbWljLXRhYmxlLWNvbHVtbi5tb2RlbCc7XG5pbXBvcnQgeyBEeW5hbWljVGFibGVSb3cgfSBmcm9tICcuL2R5bmFtaWMtdGFibGUtcm93Lm1vZGVsJztcbmltcG9ydCB7IE51bWJlckNlbGxWYWxpZGF0b3IgfSBmcm9tICcuL251bWJlci1jZWxsLXZhbGlkYXRvci5tb2RlbCc7XG5pbXBvcnQgeyBSZXF1aXJlZENlbGxWYWxpZGF0b3IgfSBmcm9tICcuL3JlcXVpcmVkLWNlbGwtdmFsaWRhdG9yLm1vZGVsJztcblxuZXhwb3J0IGNsYXNzIER5bmFtaWNUYWJsZU1vZGVsIGV4dGVuZHMgRm9ybVdpZGdldE1vZGVsIHtcblxuICAgIGZpZWxkOiBGb3JtRmllbGRNb2RlbDtcbiAgICBjb2x1bW5zOiBEeW5hbWljVGFibGVDb2x1bW5bXSA9IFtdO1xuICAgIHZpc2libGVDb2x1bW5zOiBEeW5hbWljVGFibGVDb2x1bW5bXSA9IFtdO1xuICAgIHJvd3M6IER5bmFtaWNUYWJsZVJvd1tdID0gW107XG5cbiAgICBwcml2YXRlIF9zZWxlY3RlZFJvdzogRHluYW1pY1RhYmxlUm93O1xuICAgIHByaXZhdGUgX3ZhbGlkYXRvcnM6IENlbGxWYWxpZGF0b3JbXSA9IFtdO1xuXG4gICAgZ2V0IHNlbGVjdGVkUm93KCk6IER5bmFtaWNUYWJsZVJvdyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zZWxlY3RlZFJvdztcbiAgICB9XG5cbiAgICBzZXQgc2VsZWN0ZWRSb3codmFsdWU6IER5bmFtaWNUYWJsZVJvdykge1xuICAgICAgICBpZiAodGhpcy5fc2VsZWN0ZWRSb3cgJiYgdGhpcy5fc2VsZWN0ZWRSb3cgPT09IHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLl9zZWxlY3RlZFJvdy5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5fc2VsZWN0ZWRSb3cgPSBudWxsO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yb3dzLmZvckVhY2goKHJvdykgPT4gcm93LnNlbGVjdGVkID0gZmFsc2UpO1xuXG4gICAgICAgIHRoaXMuX3NlbGVjdGVkUm93ID0gdmFsdWU7XG5cbiAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLl9zZWxlY3RlZFJvdy5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihmaWVsZDogRm9ybUZpZWxkTW9kZWwsIHByaXZhdGUgZm9ybVNlcnZpY2U6IEZvcm1TZXJ2aWNlKSB7XG4gICAgICAgIHN1cGVyKGZpZWxkLmZvcm0sIGZpZWxkLmpzb24pO1xuICAgICAgICB0aGlzLmZpZWxkID0gZmllbGQ7XG5cbiAgICAgICAgaWYgKGZpZWxkLmpzb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbHVtbnMgPSB0aGlzLmdldENvbHVtbnMoZmllbGQpO1xuICAgICAgICAgICAgaWYgKGNvbHVtbnMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbnMgPSBjb2x1bW5zO1xuICAgICAgICAgICAgICAgIHRoaXMudmlzaWJsZUNvbHVtbnMgPSB0aGlzLmNvbHVtbnMuZmlsdGVyKChjb2wpID0+IGNvbC52aXNpYmxlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGZpZWxkLmpzb24udmFsdWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJvd3MgPSBmaWVsZC5qc29uLnZhbHVlLm1hcCgob2JqKSA9PiA8RHluYW1pY1RhYmxlUm93PiB7c2VsZWN0ZWQ6IGZhbHNlLCB2YWx1ZTogb2JqfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl92YWxpZGF0b3JzID0gW1xuICAgICAgICAgICAgbmV3IFJlcXVpcmVkQ2VsbFZhbGlkYXRvcigpLFxuICAgICAgICAgICAgbmV3IERhdGVDZWxsVmFsaWRhdG9yKCksXG4gICAgICAgICAgICBuZXcgTnVtYmVyQ2VsbFZhbGlkYXRvcigpXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb2x1bW5zKGZpZWxkOiBGb3JtRmllbGRNb2RlbCk6IER5bmFtaWNUYWJsZUNvbHVtbltdIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGZpZWxkLmpzb24pIHtcbiAgICAgICAgICAgIGxldCBkZWZpbml0aW9ucyA9IGZpZWxkLmpzb24uY29sdW1uRGVmaW5pdGlvbnM7XG4gICAgICAgICAgICBpZiAoIWRlZmluaXRpb25zICYmIGZpZWxkLmpzb24ucGFyYW1zICYmIGZpZWxkLmpzb24ucGFyYW1zLmZpZWxkKSB7XG4gICAgICAgICAgICAgICAgZGVmaW5pdGlvbnMgPSBmaWVsZC5qc29uLnBhcmFtcy5maWVsZC5jb2x1bW5EZWZpbml0aW9ucztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRlZmluaXRpb25zKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlZmluaXRpb25zLm1hcCgob2JqKSA9PiA8RHluYW1pY1RhYmxlQ29sdW1uPiBvYmopO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGZsdXNoVmFsdWUoKSB7XG4gICAgICAgIGlmICh0aGlzLmZpZWxkKSB7XG4gICAgICAgICAgICB0aGlzLmZpZWxkLnZhbHVlID0gdGhpcy5yb3dzLm1hcCgocikgPT4gci52YWx1ZSk7XG4gICAgICAgICAgICB0aGlzLmZpZWxkLnVwZGF0ZUZvcm0oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG1vdmVSb3cocm93OiBEeW5hbWljVGFibGVSb3csIG9mZnNldDogbnVtYmVyKSB7XG4gICAgICAgIGxldCBvbGRJbmRleCA9IHRoaXMucm93cy5pbmRleE9mKHJvdyk7XG4gICAgICAgIGlmIChvbGRJbmRleCA+IC0xKSB7XG4gICAgICAgICAgICBsZXQgbmV3SW5kZXggPSAob2xkSW5kZXggKyBvZmZzZXQpO1xuXG4gICAgICAgICAgICBpZiAobmV3SW5kZXggPCAwKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSAwO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChuZXdJbmRleCA+PSB0aGlzLnJvd3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSB0aGlzLnJvd3MubGVuZ3RoO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgYXJyID0gdGhpcy5yb3dzLnNsaWNlKCk7XG4gICAgICAgICAgICBhcnIuc3BsaWNlKG9sZEluZGV4LCAxKTtcbiAgICAgICAgICAgIGFyci5zcGxpY2UobmV3SW5kZXgsIDAsIHJvdyk7XG4gICAgICAgICAgICB0aGlzLnJvd3MgPSBhcnI7XG5cbiAgICAgICAgICAgIHRoaXMuZmx1c2hWYWx1ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZGVsZXRlUm93KHJvdzogRHluYW1pY1RhYmxlUm93KSB7XG4gICAgICAgIGlmIChyb3cpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGVkUm93ID09PSByb3cpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkUm93ID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBpZHggPSB0aGlzLnJvd3MuaW5kZXhPZihyb3cpO1xuICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3dzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuZmx1c2hWYWx1ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWRkUm93KHJvdzogRHluYW1pY1RhYmxlUm93KSB7XG4gICAgICAgIGlmIChyb3cpIHtcbiAgICAgICAgICAgIHRoaXMucm93cy5wdXNoKHJvdyk7XG4gICAgICAgICAgICAvLyB0aGlzLnNlbGVjdGVkUm93ID0gcm93O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdmFsaWRhdGVSb3cocm93OiBEeW5hbWljVGFibGVSb3cpOiBEeW5hbWljUm93VmFsaWRhdGlvblN1bW1hcnkge1xuICAgICAgICBjb25zdCBzdW1tYXJ5ID0gbmV3IER5bmFtaWNSb3dWYWxpZGF0aW9uU3VtbWFyeSgge1xuICAgICAgICAgICAgaXNWYWxpZDogdHJ1ZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IG51bGxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgVmFsaWRhdGVEeW5hbWljVGFibGVSb3dFdmVudCh0aGlzLmZvcm0sIHRoaXMuZmllbGQsIHJvdywgc3VtbWFyeSk7XG4gICAgICAgIHRoaXMuZm9ybVNlcnZpY2UudmFsaWRhdGVEeW5hbWljVGFibGVSb3cubmV4dChldmVudCk7XG5cbiAgICAgICAgaWYgKGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgfHwgIXN1bW1hcnkuaXNWYWxpZCkge1xuICAgICAgICAgICAgcmV0dXJuIHN1bW1hcnk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocm93KSB7XG4gICAgICAgICAgICBmb3IgKGxldCBjb2wgb2YgdGhpcy5jb2x1bW5zKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgdmFsaWRhdG9yIG9mIHRoaXMuX3ZhbGlkYXRvcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0b3IudmFsaWRhdGUocm93LCBjb2wsIHN1bW1hcnkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3VtbWFyeTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzdW1tYXJ5O1xuICAgIH1cblxuICAgIGdldENlbGxWYWx1ZShyb3c6IER5bmFtaWNUYWJsZVJvdywgY29sdW1uOiBEeW5hbWljVGFibGVDb2x1bW4pOiBhbnkge1xuICAgICAgICBsZXQgcm93VmFsdWUgPSByb3cudmFsdWVbY29sdW1uLmlkXTtcblxuICAgICAgICBpZiAoY29sdW1uLnR5cGUgPT09ICdEcm9wZG93bicpIHtcbiAgICAgICAgICAgIGlmIChyb3dWYWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByb3dWYWx1ZS5uYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbHVtbi50eXBlID09PSAnQm9vbGVhbicpIHtcbiAgICAgICAgICAgIHJldHVybiByb3dWYWx1ZSA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb2x1bW4udHlwZSA9PT0gJ0RhdGUnKSB7XG4gICAgICAgICAgICBpZiAocm93VmFsdWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9tZW50KHJvd1ZhbHVlLnNwbGl0KCdUJylbMF0sICdZWVlZLU1NLUREJykuZm9ybWF0KCdERC1NTS1ZWVlZJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcm93VmFsdWUgfHwgJyc7XG4gICAgfVxuXG4gICAgZ2V0RGlzcGxheVRleHQoY29sdW1uOiBEeW5hbWljVGFibGVDb2x1bW4pOiBzdHJpbmcge1xuICAgICAgICBsZXQgY29sdW1uTmFtZSA9IGNvbHVtbi5uYW1lO1xuICAgICAgICBpZiAoY29sdW1uLnR5cGUgPT09ICdBbW91bnQnKSB7XG4gICAgICAgICAgICBsZXQgY3VycmVuY3kgPSBjb2x1bW4uYW1vdW50Q3VycmVuY3kgfHwgJyQnO1xuICAgICAgICAgICAgY29sdW1uTmFtZSA9IGAke2NvbHVtbi5uYW1lfSAoJHtjdXJyZW5jeX0pYDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29sdW1uTmFtZTtcbiAgICB9XG59XG4iXX0=