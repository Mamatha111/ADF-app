/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector  */
import { FormFieldEvent } from './../../../events/form-field.event';
import { ValidateFormFieldEvent } from './../../../events/validate-form-field.event';
import { ValidateFormEvent } from './../../../events/validate-form.event';
import { ContainerModel } from './container.model';
import { FormFieldTypes } from './form-field-types';
import { FormFieldModel } from './form-field.model';
import { FormOutcomeModel } from './form-outcome.model';
import { TabModel } from './tab.model';
import { FORM_FIELD_VALIDATORS } from './form-field-validator';
var FormModel = /** @class */ (function () {
    function FormModel(json, formValues, readOnly, formService) {
        if (readOnly === void 0) { readOnly = false; }
        var _this = this;
        this.formService = formService;
        this.taskName = FormModel.UNSET_TASK_NAME;
        this._isValid = true;
        this.readOnly = false;
        this.tabs = [];
        /**
         * Stores root containers
         */
        this.fields = [];
        this.outcomes = [];
        this.customFieldTemplates = {};
        this.fieldValidators = tslib_1.__spread(FORM_FIELD_VALIDATORS);
        this.values = {};
        this.readOnly = readOnly;
        if (json) {
            this.json = json;
            this.id = json.id;
            this.name = json.name;
            this.taskId = json.taskId;
            this.taskName = json.taskName || json.name || FormModel.UNSET_TASK_NAME;
            this.processDefinitionId = json.processDefinitionId;
            this.customFieldTemplates = json.customFieldTemplates || {};
            this.selectedOutcome = json.selectedOutcome || {};
            this.className = json.className || '';
            /** @type {?} */
            var tabCache_1 = {};
            this.processVariables = json.processVariables;
            this.tabs = (json.tabs || []).map(function (t) {
                /** @type {?} */
                var model = new TabModel(_this, t);
                tabCache_1[model.id] = model;
                return model;
            });
            this.fields = this.parseRootFields(json);
            if (formValues) {
                this.loadData(formValues);
            }
            for (var i = 0; i < this.fields.length; i++) {
                /** @type {?} */
                var field = this.fields[i];
                if (field.tab) {
                    /** @type {?} */
                    var tab = tabCache_1[field.tab];
                    if (tab) {
                        tab.fields.push(field);
                    }
                }
            }
            if (json.fields) {
                /** @type {?} */
                var saveOutcome = new FormOutcomeModel(this, {
                    id: FormModel.SAVE_OUTCOME,
                    name: 'SAVE',
                    isSystem: true
                });
                /** @type {?} */
                var completeOutcome = new FormOutcomeModel(this, {
                    id: FormModel.COMPLETE_OUTCOME,
                    name: 'COMPLETE',
                    isSystem: true
                });
                /** @type {?} */
                var startProcessOutcome = new FormOutcomeModel(this, {
                    id: FormModel.START_PROCESS_OUTCOME,
                    name: 'START PROCESS',
                    isSystem: true
                });
                /** @type {?} */
                var customOutcomes = (json.outcomes || []).map(function (obj) { return new FormOutcomeModel(_this, obj); });
                this.outcomes = [saveOutcome].concat(customOutcomes.length > 0 ? customOutcomes : [completeOutcome, startProcessOutcome]);
            }
        }
        this.validateForm();
    }
    Object.defineProperty(FormModel.prototype, "isValid", {
        get: /**
         * @return {?}
         */
        function () {
            return this._isValid;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    FormModel.prototype.hasTabs = /**
     * @return {?}
     */
    function () {
        return this.tabs && this.tabs.length > 0;
    };
    /**
     * @return {?}
     */
    FormModel.prototype.hasFields = /**
     * @return {?}
     */
    function () {
        return this.fields && this.fields.length > 0;
    };
    /**
     * @return {?}
     */
    FormModel.prototype.hasOutcomes = /**
     * @return {?}
     */
    function () {
        return this.outcomes && this.outcomes.length > 0;
    };
    /**
     * @param {?} field
     * @return {?}
     */
    FormModel.prototype.onFormFieldChanged = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        this.validateField(field);
        if (this.formService) {
            this.formService.formFieldValueChanged.next(new FormFieldEvent(this, field));
        }
    };
    /**
     * @param {?} fieldId
     * @return {?}
     */
    FormModel.prototype.getFieldById = /**
     * @param {?} fieldId
     * @return {?}
     */
    function (fieldId) {
        return this.getFormFields().find(function (field) { return field.id === fieldId; });
    };
    // TODO: consider evaluating and caching once the form is loaded
    // TODO: consider evaluating and caching once the form is loaded
    /**
     * @return {?}
     */
    FormModel.prototype.getFormFields = 
    // TODO: consider evaluating and caching once the form is loaded
    /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var formFieldModel = [];
        for (var i = 0; i < this.fields.length; i++) {
            /** @type {?} */
            var field = this.fields[i];
            if (field instanceof ContainerModel) {
                /** @type {?} */
                var container = (/** @type {?} */ (field));
                formFieldModel.push(container.field);
                container.field.columns.forEach(function (column) {
                    formFieldModel.push.apply(formFieldModel, tslib_1.__spread(column.fields));
                });
            }
        }
        return formFieldModel;
    };
    /**
     * @return {?}
     */
    FormModel.prototype.markAsInvalid = /**
     * @return {?}
     */
    function () {
        this._isValid = false;
    };
    /**
     * Validates entire form and all form fields.
     *
     * @memberof FormModel
     */
    /**
     * Validates entire form and all form fields.
     *
     * \@memberof FormModel
     * @return {?}
     */
    FormModel.prototype.validateForm = /**
     * Validates entire form and all form fields.
     *
     * \@memberof FormModel
     * @return {?}
     */
    function () {
        /** @type {?} */
        var validateFormEvent = new ValidateFormEvent(this);
        /** @type {?} */
        var errorsField = [];
        /** @type {?} */
        var fields = this.getFormFields();
        for (var i = 0; i < fields.length; i++) {
            if (!fields[i].validate()) {
                errorsField.push(fields[i]);
            }
        }
        this._isValid = errorsField.length > 0 ? false : true;
        if (this.formService) {
            validateFormEvent.isValid = this._isValid;
            validateFormEvent.errorsField = errorsField;
            this.formService.validateForm.next(validateFormEvent);
        }
    };
    /**
     * Validates a specific form field, triggers form validation.
     *
     * @param field Form field to validate.
     * @memberof FormModel
     */
    /**
     * Validates a specific form field, triggers form validation.
     *
     * \@memberof FormModel
     * @param {?} field Form field to validate.
     * @return {?}
     */
    FormModel.prototype.validateField = /**
     * Validates a specific form field, triggers form validation.
     *
     * \@memberof FormModel
     * @param {?} field Form field to validate.
     * @return {?}
     */
    function (field) {
        if (!field) {
            return;
        }
        /** @type {?} */
        var validateFieldEvent = new ValidateFormFieldEvent(this, field);
        if (this.formService) {
            this.formService.validateFormField.next(validateFieldEvent);
        }
        if (!validateFieldEvent.isValid) {
            this._isValid = false;
            return;
        }
        if (validateFieldEvent.defaultPrevented) {
            return;
        }
        if (!field.validate()) {
            this._isValid = false;
        }
        this.validateForm();
    };
    // Activiti supports 3 types of root fields: container|group|dynamic-table
    // Activiti supports 3 types of root fields: container|group|dynamic-table
    /**
     * @private
     * @param {?} json
     * @return {?}
     */
    FormModel.prototype.parseRootFields = 
    // Activiti supports 3 types of root fields: container|group|dynamic-table
    /**
     * @private
     * @param {?} json
     * @return {?}
     */
    function (json) {
        var e_1, _a;
        /** @type {?} */
        var fields = [];
        if (json.fields) {
            fields = json.fields;
        }
        else if (json.formDefinition && json.formDefinition.fields) {
            fields = json.formDefinition.fields;
        }
        /** @type {?} */
        var formWidgetModel = [];
        try {
            for (var fields_1 = tslib_1.__values(fields), fields_1_1 = fields_1.next(); !fields_1_1.done; fields_1_1 = fields_1.next()) {
                var field = fields_1_1.value;
                if (field.type === FormFieldTypes.DISPLAY_VALUE) {
                    // workaround for dynamic table on a completed/readonly form
                    if (field.params) {
                        /** @type {?} */
                        var originalField = field.params['field'];
                        if (originalField.type === FormFieldTypes.DYNAMIC_TABLE) {
                            formWidgetModel.push(new ContainerModel(new FormFieldModel(this, field)));
                        }
                    }
                }
                else {
                    formWidgetModel.push(new ContainerModel(new FormFieldModel(this, field)));
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (fields_1_1 && !fields_1_1.done && (_a = fields_1.return)) _a.call(fields_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return formWidgetModel;
    };
    // Loads external data and overrides field values
    // Typically used when form definition and form data coming from different sources
    // Loads external data and overrides field values
    // Typically used when form definition and form data coming from different sources
    /**
     * @private
     * @param {?} formValues
     * @return {?}
     */
    FormModel.prototype.loadData = 
    // Loads external data and overrides field values
    // Typically used when form definition and form data coming from different sources
    /**
     * @private
     * @param {?} formValues
     * @return {?}
     */
    function (formValues) {
        var e_2, _a;
        try {
            for (var _b = tslib_1.__values(this.getFormFields()), _c = _b.next(); !_c.done; _c = _b.next()) {
                var field = _c.value;
                if (formValues[field.id]) {
                    field.json.value = formValues[field.id];
                    field.value = field.parseValue(field.json);
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
    };
    FormModel.UNSET_TASK_NAME = 'Nameless task';
    FormModel.SAVE_OUTCOME = '$save';
    FormModel.COMPLETE_OUTCOME = '$complete';
    FormModel.START_PROCESS_OUTCOME = '$startProcess';
    return FormModel;
}());
export { FormModel };
if (false) {
    /** @type {?} */
    FormModel.UNSET_TASK_NAME;
    /** @type {?} */
    FormModel.SAVE_OUTCOME;
    /** @type {?} */
    FormModel.COMPLETE_OUTCOME;
    /** @type {?} */
    FormModel.START_PROCESS_OUTCOME;
    /** @type {?} */
    FormModel.prototype.id;
    /** @type {?} */
    FormModel.prototype.name;
    /** @type {?} */
    FormModel.prototype.taskId;
    /** @type {?} */
    FormModel.prototype.taskName;
    /** @type {?} */
    FormModel.prototype.processDefinitionId;
    /**
     * @type {?}
     * @private
     */
    FormModel.prototype._isValid;
    /** @type {?} */
    FormModel.prototype.className;
    /** @type {?} */
    FormModel.prototype.readOnly;
    /** @type {?} */
    FormModel.prototype.tabs;
    /**
     * Stores root containers
     * @type {?}
     */
    FormModel.prototype.fields;
    /** @type {?} */
    FormModel.prototype.outcomes;
    /** @type {?} */
    FormModel.prototype.customFieldTemplates;
    /** @type {?} */
    FormModel.prototype.fieldValidators;
    /** @type {?} */
    FormModel.prototype.selectedOutcome;
    /** @type {?} */
    FormModel.prototype.values;
    /** @type {?} */
    FormModel.prototype.processVariables;
    /** @type {?} */
    FormModel.prototype.json;
    /**
     * @type {?}
     * @protected
     */
    FormModel.prototype.formService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29yZS8iLCJzb3VyY2VzIjpbImZvcm0vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvZm9ybS5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbUJBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNwRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQUNyRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUUxRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUd4RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXZDLE9BQU8sRUFDSCxxQkFBcUIsRUFFeEIsTUFBTSx3QkFBd0IsQ0FBQztBQUVoQztJQTZDSSxtQkFBWSxJQUFVLEVBQUUsVUFBdUIsRUFBRSxRQUF5QixFQUFZLFdBQXlCO1FBQTlELHlCQUFBLEVBQUEsZ0JBQXlCO1FBQTFFLGlCQW1FQztRQW5FcUYsZ0JBQVcsR0FBWCxXQUFXLENBQWM7UUFuQ3RHLGFBQVEsR0FBVyxTQUFTLENBQUMsZUFBZSxDQUFDO1FBRTlDLGFBQVEsR0FBWSxJQUFJLENBQUM7UUFPakMsYUFBUSxHQUFZLEtBQUssQ0FBQztRQUMxQixTQUFJLEdBQWUsRUFBRSxDQUFDOzs7O1FBRXRCLFdBQU0sR0FBc0IsRUFBRSxDQUFDO1FBQy9CLGFBQVEsR0FBdUIsRUFBRSxDQUFDO1FBQ2xDLHlCQUFvQixHQUF1QixFQUFFLENBQUM7UUFDOUMs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QWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLyogdHNsaW50OmRpc2FibGU6Y29tcG9uZW50LXNlbGVjdG9yICAqL1xuXG5pbXBvcnQgeyBGb3JtRmllbGRFdmVudCB9IGZyb20gJy4vLi4vLi4vLi4vZXZlbnRzL2Zvcm0tZmllbGQuZXZlbnQnO1xuaW1wb3J0IHsgVmFsaWRhdGVGb3JtRmllbGRFdmVudCB9IGZyb20gJy4vLi4vLi4vLi4vZXZlbnRzL3ZhbGlkYXRlLWZvcm0tZmllbGQuZXZlbnQnO1xuaW1wb3J0IHsgVmFsaWRhdGVGb3JtRXZlbnQgfSBmcm9tICcuLy4uLy4uLy4uL2V2ZW50cy92YWxpZGF0ZS1mb3JtLmV2ZW50JztcbmltcG9ydCB7IEZvcm1TZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi8uLi9zZXJ2aWNlcy9mb3JtLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29udGFpbmVyTW9kZWwgfSBmcm9tICcuL2NvbnRhaW5lci5tb2RlbCc7XG5pbXBvcnQgeyBGb3JtRmllbGRUZW1wbGF0ZXMgfSBmcm9tICcuL2Zvcm0tZmllbGQtdGVtcGxhdGVzJztcbmltcG9ydCB7IEZvcm1GaWVsZFR5cGVzIH0gZnJvbSAnLi9mb3JtLWZpZWxkLXR5cGVzJztcbmltcG9ydCB7IEZvcm1GaWVsZE1vZGVsIH0gZnJvbSAnLi9mb3JtLWZpZWxkLm1vZGVsJztcbmltcG9ydCB7IEZvcm1PdXRjb21lTW9kZWwgfSBmcm9tICcuL2Zvcm0tb3V0Y29tZS5tb2RlbCc7XG5pbXBvcnQgeyBGb3JtVmFsdWVzIH0gZnJvbSAnLi9mb3JtLXZhbHVlcyc7XG5pbXBvcnQgeyBGb3JtV2lkZ2V0TW9kZWwsIEZvcm1XaWRnZXRNb2RlbENhY2hlIH0gZnJvbSAnLi9mb3JtLXdpZGdldC5tb2RlbCc7XG5pbXBvcnQgeyBUYWJNb2RlbCB9IGZyb20gJy4vdGFiLm1vZGVsJztcblxuaW1wb3J0IHtcbiAgICBGT1JNX0ZJRUxEX1ZBTElEQVRPUlMsXG4gICAgRm9ybUZpZWxkVmFsaWRhdG9yXG59IGZyb20gJy4vZm9ybS1maWVsZC12YWxpZGF0b3InO1xuXG5leHBvcnQgY2xhc3MgRm9ybU1vZGVsIHtcblxuICAgIHN0YXRpYyBVTlNFVF9UQVNLX05BTUU6IHN0cmluZyA9ICdOYW1lbGVzcyB0YXNrJztcbiAgICBzdGF0aWMgU0FWRV9PVVRDT01FOiBzdHJpbmcgPSAnJHNhdmUnO1xuICAgIHN0YXRpYyBDT01QTEVURV9PVVRDT01FOiBzdHJpbmcgPSAnJGNvbXBsZXRlJztcbiAgICBzdGF0aWMgU1RBUlRfUFJPQ0VTU19PVVRDT01FOiBzdHJpbmcgPSAnJHN0YXJ0UHJvY2Vzcyc7XG5cbiAgICByZWFkb25seSBpZDogbnVtYmVyO1xuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgICByZWFkb25seSB0YXNrSWQ6IHN0cmluZztcbiAgICByZWFkb25seSB0YXNrTmFtZTogc3RyaW5nID0gRm9ybU1vZGVsLlVOU0VUX1RBU0tfTkFNRTtcbiAgICBwcm9jZXNzRGVmaW5pdGlvbklkOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfaXNWYWxpZDogYm9vbGVhbiA9IHRydWU7XG5cbiAgICBnZXQgaXNWYWxpZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzVmFsaWQ7XG4gICAgfVxuXG4gICAgY2xhc3NOYW1lOiBzdHJpbmc7XG4gICAgcmVhZE9ubHk6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICB0YWJzOiBUYWJNb2RlbFtdID0gW107XG4gICAgLyoqIFN0b3JlcyByb290IGNvbnRhaW5lcnMgKi9cbiAgICBmaWVsZHM6IEZvcm1XaWRnZXRNb2RlbFtdID0gW107XG4gICAgb3V0Y29tZXM6IEZvcm1PdXRjb21lTW9kZWxbXSA9IFtdO1xuICAgIGN1c3RvbUZpZWxkVGVtcGxhdGVzOiBGb3JtRmllbGRUZW1wbGF0ZXMgPSB7fTtcbiAgICBmaWVsZFZhbGlkYXRvcnM6IEZvcm1GaWVsZFZhbGlkYXRvcltdID0gWy4uLkZPUk1fRklFTERfVkFMSURBVE9SU107XG4gICAgcmVhZG9ubHkgc2VsZWN0ZWRPdXRjb21lOiBzdHJpbmc7XG5cbiAgICB2YWx1ZXM6IEZvcm1WYWx1ZXMgPSB7fTtcbiAgICBwcm9jZXNzVmFyaWFibGVzOiBhbnk7XG5cbiAgICByZWFkb25seSBqc29uOiBhbnk7XG5cbiAgICBoYXNUYWJzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YWJzICYmIHRoaXMudGFicy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIGhhc0ZpZWxkcygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRzICYmIHRoaXMuZmllbGRzLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgaGFzT3V0Y29tZXMoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLm91dGNvbWVzICYmIHRoaXMub3V0Y29tZXMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihqc29uPzogYW55LCBmb3JtVmFsdWVzPzogRm9ybVZhbHVlcywgcmVhZE9ubHk6IGJvb2xlYW4gPSBmYWxzZSwgcHJvdGVjdGVkIGZvcm1TZXJ2aWNlPzogRm9ybVNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5yZWFkT25seSA9IHJlYWRPbmx5O1xuXG4gICAgICAgIGlmIChqc29uKSB7XG4gICAgICAgICAgICB0aGlzLmpzb24gPSBqc29uO1xuXG4gICAgICAgICAgICB0aGlzLmlkID0ganNvbi5pZDtcbiAgICAgICAgICAgIHRoaXMubmFtZSA9IGpzb24ubmFtZTtcbiAgICAgICAgICAgIHRoaXMudGFza0lkID0ganNvbi50YXNrSWQ7XG4gICAgICAgICAgICB0aGlzLnRhc2tOYW1lID0ganNvbi50YXNrTmFtZSB8fCBqc29uLm5hbWUgfHwgRm9ybU1vZGVsLlVOU0VUX1RBU0tfTkFNRTtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0RlZmluaXRpb25JZCA9IGpzb24ucHJvY2Vzc0RlZmluaXRpb25JZDtcbiAgICAgICAgICAgIHRoaXMuY3VzdG9tRmllbGRUZW1wbGF0ZXMgPSBqc29uLmN1c3RvbUZpZWxkVGVtcGxhdGVzIHx8IHt9O1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE91dGNvbWUgPSBqc29uLnNlbGVjdGVkT3V0Y29tZSB8fCB7fTtcbiAgICAgICAgICAgIHRoaXMuY2xhc3NOYW1lID0ganNvbi5jbGFzc05hbWUgfHwgJyc7XG5cbiAgICAgICAgICAgIGxldCB0YWJDYWNoZTogRm9ybVdpZGdldE1vZGVsQ2FjaGU8VGFiTW9kZWw+ID0ge307XG5cbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1ZhcmlhYmxlcyA9IGpzb24ucHJvY2Vzc1ZhcmlhYmxlcztcblxuICAgICAgICAgICAgdGhpcy50YWJzID0gKGpzb24udGFicyB8fCBbXSkubWFwKCh0KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IG1vZGVsID0gbmV3IFRhYk1vZGVsKHRoaXMsIHQpO1xuICAgICAgICAgICAgICAgIHRhYkNhY2hlW21vZGVsLmlkXSA9IG1vZGVsO1xuICAgICAgICAgICAgICAgIHJldHVybiBtb2RlbDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLmZpZWxkcyA9IHRoaXMucGFyc2VSb290RmllbGRzKGpzb24pO1xuXG4gICAgICAgICAgICBpZiAoZm9ybVZhbHVlcykge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZERhdGEoZm9ybVZhbHVlcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5maWVsZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgZmllbGQgPSB0aGlzLmZpZWxkc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQudGFiKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0YWIgPSB0YWJDYWNoZVtmaWVsZC50YWJdO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGFiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YWIuZmllbGRzLnB1c2goZmllbGQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoanNvbi5maWVsZHMpIHtcbiAgICAgICAgICAgICAgICBsZXQgc2F2ZU91dGNvbWUgPSBuZXcgRm9ybU91dGNvbWVNb2RlbCh0aGlzLCB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBGb3JtTW9kZWwuU0FWRV9PVVRDT01FLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnU0FWRScsXG4gICAgICAgICAgICAgICAgICAgIGlzU3lzdGVtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbGV0IGNvbXBsZXRlT3V0Y29tZSA9IG5ldyBGb3JtT3V0Y29tZU1vZGVsKHRoaXMsIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IEZvcm1Nb2RlbC5DT01QTEVURV9PVVRDT01FLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnQ09NUExFVEUnLFxuICAgICAgICAgICAgICAgICAgICBpc1N5c3RlbTogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGxldCBzdGFydFByb2Nlc3NPdXRjb21lID0gbmV3IEZvcm1PdXRjb21lTW9kZWwodGhpcywge1xuICAgICAgICAgICAgICAgICAgICBpZDogRm9ybU1vZGVsLlNUQVJUX1BST0NFU1NfT1VUQ09NRSxcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ1NUQVJUIFBST0NFU1MnLFxuICAgICAgICAgICAgICAgICAgICBpc1N5c3RlbTogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgbGV0IGN1c3RvbU91dGNvbWVzID0gKGpzb24ub3V0Y29tZXMgfHwgW10pLm1hcCgob2JqKSA9PiBuZXcgRm9ybU91dGNvbWVNb2RlbCh0aGlzLCBvYmopKTtcblxuICAgICAgICAgICAgICAgIHRoaXMub3V0Y29tZXMgPSBbc2F2ZU91dGNvbWVdLmNvbmNhdChcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tT3V0Y29tZXMubGVuZ3RoID4gMCA/IGN1c3RvbU91dGNvbWVzIDogW2NvbXBsZXRlT3V0Y29tZSwgc3RhcnRQcm9jZXNzT3V0Y29tZV1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZUZvcm0oKTtcbiAgICB9XG5cbiAgICBvbkZvcm1GaWVsZENoYW5nZWQoZmllbGQ6IEZvcm1GaWVsZE1vZGVsKSB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVGaWVsZChmaWVsZCk7XG4gICAgICAgIGlmICh0aGlzLmZvcm1TZXJ2aWNlKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLmZvcm1GaWVsZFZhbHVlQ2hhbmdlZC5uZXh0KG5ldyBGb3JtRmllbGRFdmVudCh0aGlzLCBmaWVsZCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0RmllbGRCeUlkKGZpZWxkSWQ6IHN0cmluZyk6IEZvcm1GaWVsZE1vZGVsIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Rm9ybUZpZWxkcygpLmZpbmQoKGZpZWxkKSA9PiBmaWVsZC5pZCA9PT0gZmllbGRJZCk7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogY29uc2lkZXIgZXZhbHVhdGluZyBhbmQgY2FjaGluZyBvbmNlIHRoZSBmb3JtIGlzIGxvYWRlZFxuICAgIGdldEZvcm1GaWVsZHMoKTogRm9ybUZpZWxkTW9kZWxbXSB7XG4gICAgICAgIGxldCBmb3JtRmllbGRNb2RlbDogRm9ybUZpZWxkTW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5maWVsZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGxldCBmaWVsZCA9IHRoaXMuZmllbGRzW2ldO1xuXG4gICAgICAgICAgICBpZiAoZmllbGQgaW5zdGFuY2VvZiBDb250YWluZXJNb2RlbCkge1xuICAgICAgICAgICAgICAgIGxldCBjb250YWluZXIgPSA8Q29udGFpbmVyTW9kZWw+IGZpZWxkO1xuICAgICAgICAgICAgICAgIGZvcm1GaWVsZE1vZGVsLnB1c2goY29udGFpbmVyLmZpZWxkKTtcblxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maWVsZC5jb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBmb3JtRmllbGRNb2RlbC5wdXNoKC4uLmNvbHVtbi5maWVsZHMpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZvcm1GaWVsZE1vZGVsO1xuICAgIH1cblxuICAgIG1hcmtBc0ludmFsaWQoKSB7XG4gICAgICAgIHRoaXMuX2lzVmFsaWQgPSBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgZW50aXJlIGZvcm0gYW5kIGFsbCBmb3JtIGZpZWxkcy5cbiAgICAgKlxuICAgICAqIEBtZW1iZXJvZiBGb3JtTW9kZWxcbiAgICAgKi9cbiAgICB2YWxpZGF0ZUZvcm0oKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRlRm9ybUV2ZW50OiBhbnkgPSBuZXcgVmFsaWRhdGVGb3JtRXZlbnQodGhpcyk7XG5cbiAgICAgICAgbGV0IGVycm9yc0ZpZWxkOiBGb3JtRmllbGRNb2RlbFtdID0gW107XG5cbiAgICAgICAgbGV0IGZpZWxkcyA9IHRoaXMuZ2V0Rm9ybUZpZWxkcygpO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpZWxkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYgKCFmaWVsZHNbaV0udmFsaWRhdGUoKSkge1xuICAgICAgICAgICAgICAgIGVycm9yc0ZpZWxkLnB1c2goZmllbGRzW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2lzVmFsaWQgPSBlcnJvcnNGaWVsZC5sZW5ndGggPiAwID8gZmFsc2UgOiB0cnVlO1xuXG4gICAgICAgIGlmICh0aGlzLmZvcm1TZXJ2aWNlKSB7XG4gICAgICAgICAgICB2YWxpZGF0ZUZvcm1FdmVudC5pc1ZhbGlkID0gdGhpcy5faXNWYWxpZDtcbiAgICAgICAgICAgIHZhbGlkYXRlRm9ybUV2ZW50LmVycm9yc0ZpZWxkID0gZXJyb3JzRmllbGQ7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLnZhbGlkYXRlRm9ybS5uZXh0KHZhbGlkYXRlRm9ybUV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGVzIGEgc3BlY2lmaWMgZm9ybSBmaWVsZCwgdHJpZ2dlcnMgZm9ybSB2YWxpZGF0aW9uLlxuICAgICAqXG4gICAgICogQHBhcmFtIGZpZWxkIEZvcm0gZmllbGQgdG8gdmFsaWRhdGUuXG4gICAgICogQG1lbWJlcm9mIEZvcm1Nb2RlbFxuICAgICAqL1xuICAgIHZhbGlkYXRlRmllbGQoZmllbGQ6IEZvcm1GaWVsZE1vZGVsKTogdm9pZCB7XG4gICAgICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHZhbGlkYXRlRmllbGRFdmVudCA9IG5ldyBWYWxpZGF0ZUZvcm1GaWVsZEV2ZW50KHRoaXMsIGZpZWxkKTtcblxuICAgICAgICBpZiAodGhpcy5mb3JtU2VydmljZSkge1xuICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZS52YWxpZGF0ZUZvcm1GaWVsZC5uZXh0KHZhbGlkYXRlRmllbGRFdmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXZhbGlkYXRlRmllbGRFdmVudC5pc1ZhbGlkKSB7XG4gICAgICAgICAgICB0aGlzLl9pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodmFsaWRhdGVGaWVsZEV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZmllbGQudmFsaWRhdGUoKSkge1xuICAgICAgICAgICAgdGhpcy5faXNWYWxpZCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZUZvcm0oKTtcbiAgICB9XG5cbiAgICAvLyBBY3Rpdml0aSBzdXBwb3J0cyAzIHR5cGVzIG9mIHJvb3QgZmllbGRzOiBjb250YWluZXJ8Z3JvdXB8ZHluYW1pYy10YWJsZVxuICAgIHByaXZhdGUgcGFyc2VSb290RmllbGRzKGpzb246IGFueSk6IEZvcm1XaWRnZXRNb2RlbFtdIHtcbiAgICAgICAgbGV0IGZpZWxkcyA9IFtdO1xuXG4gICAgICAgIGlmIChqc29uLmZpZWxkcykge1xuICAgICAgICAgICAgZmllbGRzID0ganNvbi5maWVsZHM7XG4gICAgICAgIH0gZWxzZSBpZiAoanNvbi5mb3JtRGVmaW5pdGlvbiAmJiBqc29uLmZvcm1EZWZpbml0aW9uLmZpZWxkcykge1xuICAgICAgICAgICAgZmllbGRzID0ganNvbi5mb3JtRGVmaW5pdGlvbi5maWVsZHM7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZm9ybVdpZGdldE1vZGVsOiBGb3JtV2lkZ2V0TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGZpZWxkIG9mIGZpZWxkcykge1xuICAgICAgICAgICAgaWYgKGZpZWxkLnR5cGUgPT09IEZvcm1GaWVsZFR5cGVzLkRJU1BMQVlfVkFMVUUpIHtcbiAgICAgICAgICAgICAgICAvLyB3b3JrYXJvdW5kIGZvciBkeW5hbWljIHRhYmxlIG9uIGEgY29tcGxldGVkL3JlYWRvbmx5IGZvcm1cbiAgICAgICAgICAgICAgICBpZiAoZmllbGQucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBvcmlnaW5hbEZpZWxkID0gZmllbGQucGFyYW1zWydmaWVsZCddO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3JpZ2luYWxGaWVsZC50eXBlID09PSBGb3JtRmllbGRUeXBlcy5EWU5BTUlDX1RBQkxFKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JtV2lkZ2V0TW9kZWwucHVzaChuZXcgQ29udGFpbmVyTW9kZWwobmV3IEZvcm1GaWVsZE1vZGVsKHRoaXMsIGZpZWxkKSkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmb3JtV2lkZ2V0TW9kZWwucHVzaChuZXcgQ29udGFpbmVyTW9kZWwobmV3IEZvcm1GaWVsZE1vZGVsKHRoaXMsIGZpZWxkKSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZvcm1XaWRnZXRNb2RlbDtcbiAgICB9XG5cbiAgICAvLyBMb2FkcyBleHRlcm5hbCBkYXRhIGFuZCBvdmVycmlkZXMgZmllbGQgdmFsdWVzXG4gICAgLy8gVHlwaWNhbGx5IHVzZWQgd2hlbiBmb3JtIGRlZmluaXRpb24gYW5kIGZvcm0gZGF0YSBjb21pbmcgZnJvbSBkaWZmZXJlbnQgc291cmNlc1xuICAgIHByaXZhdGUgbG9hZERhdGEoZm9ybVZhbHVlczogRm9ybVZhbHVlcykge1xuICAgICAgICBmb3IgKGxldCBmaWVsZCBvZiB0aGlzLmdldEZvcm1GaWVsZHMoKSkge1xuICAgICAgICAgICAgaWYgKGZvcm1WYWx1ZXNbZmllbGQuaWRdKSB7XG4gICAgICAgICAgICAgICAgZmllbGQuanNvbi52YWx1ZSA9IGZvcm1WYWx1ZXNbZmllbGQuaWRdO1xuICAgICAgICAgICAgICAgIGZpZWxkLnZhbHVlID0gZmllbGQucGFyc2VWYWx1ZShmaWVsZC5qc29uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==