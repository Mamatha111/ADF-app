/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild, ViewEncapsulation } from '@angular/core';
import { FormService } from './../services/form.service';
import { WidgetVisibilityService } from './../services/widget-visibility.service';
import { FormComponent } from './form.component';
import { FormOutcomeModel } from './widgets/core/index';
var StartFormComponent = /** @class */ (function (_super) {
    tslib_1.__extends(StartFormComponent, _super);
    function StartFormComponent(formService, visibilityService) {
        var _this = _super.call(this, formService, visibilityService, null, null) || this;
        /**
         * Should form outcome buttons be shown?
         */
        _this.showOutcomeButtons = true;
        /**
         * Should the refresh button be shown?
         */
        _this.showRefreshButton = true;
        /**
         * Is the form read-only (ie, can't be edited)?
         */
        _this.readOnlyForm = false;
        /**
         * Emitted when the user clicks one of the outcome buttons that completes the form.
         */
        _this.outcomeClick = new EventEmitter();
        /**
         * Emitted when a field of the form is clicked.
         */
        _this.formContentClicked = new EventEmitter();
        _this.outcomesContainer = null;
        _this.showTitle = false;
        return _this;
    }
    /**
     * @return {?}
     */
    StartFormComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.subscriptions.push(this.formService.formContentClicked.subscribe(function (content) {
            _this.formContentClicked.emit(content);
        }), this.formService.validateForm.subscribe(function (validateFormEvent) {
            if (validateFormEvent.errorsField.length > 0) {
                _this.formError.next(validateFormEvent.errorsField);
            }
        }));
    };
    /**
     * @return {?}
     */
    StartFormComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.subscriptions.forEach(function (subscription) { return subscription.unsubscribe(); });
        this.subscriptions = [];
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    StartFormComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var processDefinitionId = changes['processDefinitionId'];
        if (processDefinitionId && processDefinitionId.currentValue) {
            this.visibilityService.cleanProcessVariable();
            this.getStartFormDefinition(processDefinitionId.currentValue);
            return;
        }
        /** @type {?} */
        var processId = changes['processId'];
        if (processId && processId.currentValue) {
            this.visibilityService.cleanProcessVariable();
            this.loadStartForm(processId.currentValue);
            return;
        }
    };
    /**
     * @param {?} processId
     * @return {?}
     */
    StartFormComponent.prototype.loadStartForm = /**
     * @param {?} processId
     * @return {?}
     */
    function (processId) {
        var _this = this;
        this.formService.getProcessInstance(processId)
            .subscribe(function (instance) {
            _this.formService
                .getStartFormInstance(processId)
                .subscribe(function (form) {
                _this.formName = form.name;
                if (instance.variables) {
                    form.processVariables = instance.variables;
                }
                _this.form = _this.parseForm(form);
                _this.visibilityService.refreshVisibility(_this.form);
                _this.form.validateForm();
                _this.form.readOnly = _this.readOnlyForm;
                _this.onFormLoaded(_this.form);
            }, function (error) { return _this.handleError(error); });
        });
    };
    /**
     * @param {?} processId
     * @return {?}
     */
    StartFormComponent.prototype.getStartFormDefinition = /**
     * @param {?} processId
     * @return {?}
     */
    function (processId) {
        var _this = this;
        this.formService
            .getStartFormDefinition(processId)
            .subscribe(function (form) {
            _this.formName = form.processDefinitionName;
            _this.form = _this.parseForm(form);
            _this.visibilityService.refreshVisibility(_this.form);
            _this.form.validateForm();
            _this.form.readOnly = _this.readOnlyForm;
            _this.onFormLoaded(_this.form);
        }, function (error) { return _this.handleError(error); });
    };
    /** @override */
    /**
     * @override
     * @param {?} outcome
     * @param {?} isFormReadOnly
     * @return {?}
     */
    StartFormComponent.prototype.isOutcomeButtonVisible = /**
     * @override
     * @param {?} outcome
     * @param {?} isFormReadOnly
     * @return {?}
     */
    function (outcome, isFormReadOnly) {
        if (outcome && outcome.isSystem && (outcome.name === FormOutcomeModel.SAVE_ACTION ||
            outcome.name === FormOutcomeModel.COMPLETE_ACTION)) {
            return false;
        }
        else if (outcome && outcome.name === FormOutcomeModel.START_PROCESS_ACTION) {
            return true;
        }
        return _super.prototype.isOutcomeButtonVisible.call(this, outcome, isFormReadOnly);
    };
    /** @override */
    /**
     * @override
     * @return {?}
     */
    StartFormComponent.prototype.saveTaskForm = /**
     * @override
     * @return {?}
     */
    function () {
        // do nothing
    };
    /** @override */
    /**
     * @override
     * @return {?}
     */
    StartFormComponent.prototype.onRefreshClicked = /**
     * @override
     * @return {?}
     */
    function () {
        if (this.processDefinitionId) {
            this.visibilityService.cleanProcessVariable();
            this.getStartFormDefinition(this.processDefinitionId);
        }
        else if (this.processId) {
            this.visibilityService.cleanProcessVariable();
            this.loadStartForm(this.processId);
        }
    };
    /**
     * @param {?=} outcome
     * @return {?}
     */
    StartFormComponent.prototype.completeTaskForm = /**
     * @param {?=} outcome
     * @return {?}
     */
    function (outcome) {
        this.outcomeClick.emit(outcome);
    };
    StartFormComponent.decorators = [
        { type: Component, args: [{
                    selector: 'adf-start-form',
                    template: "<div class=\"adf-start-form-container\" *ngIf=\"hasForm()\">\n    <mat-card>\n        <mat-card-header>\n            <mat-card-title>\n                <h2 *ngIf=\"isTitleEnabled()\" class=\"mdl-card__title-text\">{{form.taskName}}</h2>\n            </mat-card-title>\n        </mat-card-header>\n        <mat-card-content>\n            <div *ngIf=\"form.hasTabs()\">\n                <tabs-widget [tabs]=\"form.tabs\" (formTabChanged)=\"checkVisibility($event);\"></tabs-widget>\n            </div>\n\n            <div *ngIf=\"!form.hasTabs() && form.hasFields()\">\n                <div *ngFor=\"let field of form.fields\">\n                    <adf-form-field [field]=\"field.field\"></adf-form-field>\n                </div>\n            </div>\n        </mat-card-content>\n        <mat-card-content class=\"adf-start-form-actions\" *ngIf=\"showOutcomeButtons && form.hasOutcomes()\"\n                          #outcomesContainer>\n            <ng-content select=\"[adf-form-custom-button], [form-custom-button]\"></ng-content>\n\n            <button *ngFor=\"let outcome of form.outcomes\"\n                    mat-button\n                    [attr.data-automation-id]=\"'adf-form-' + outcome.name  | lowercase\"\n                    [disabled]=\"!isOutcomeButtonEnabled(outcome)\"\n                    [class.mdl-button--colored]=\"!outcome.isSystem\"\n                    [class.adf-form-hide-button]=\"!isOutcomeButtonVisible(outcome, form.readOnly)\"\n                    (click)=\"onOutcomeClicked(outcome)\">\n                {{ outcome.name | uppercase | translate | uppercase }}\n            </button>\n        </mat-card-content>\n        <mat-card-actions *ngIf=\"showRefreshButton\">\n            <button mat-button\n                    (click)=\"onRefreshClicked()\">\n                <mat-icon>refresh</mat-icon>\n            </button>\n        </mat-card-actions>\n    </mat-card>\n</div>\n",
                    encapsulation: ViewEncapsulation.None,
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    StartFormComponent.ctorParameters = function () { return [
        { type: FormService },
        { type: WidgetVisibilityService }
    ]; };
    StartFormComponent.propDecorators = {
        processDefinitionId: [{ type: Input }],
        processId: [{ type: Input }],
        showOutcomeButtons: [{ type: Input }],
        showRefreshButton: [{ type: Input }],
        readOnlyForm: [{ type: Input }],
        outcomeClick: [{ type: Output }],
        formContentClicked: [{ type: Output }],
        outcomesContainer: [{ type: ViewChild, args: ['outcomesContainer', {},] }]
    };
    return StartFormComponent;
}(FormComponent));
export { StartFormComponent };
if (false) {
    /**
     * Definition ID of the process to start.
     * @type {?}
     */
    StartFormComponent.prototype.processDefinitionId;
    /**
     * Process ID of the process to start.
     * @type {?}
     */
    StartFormComponent.prototype.processId;
    /**
     * Should form outcome buttons be shown?
     * @type {?}
     */
    StartFormComponent.prototype.showOutcomeButtons;
    /**
     * Should the refresh button be shown?
     * @type {?}
     */
    StartFormComponent.prototype.showRefreshButton;
    /**
     * Is the form read-only (ie, can't be edited)?
     * @type {?}
     */
    StartFormComponent.prototype.readOnlyForm;
    /**
     * Emitted when the user clicks one of the outcome buttons that completes the form.
     * @type {?}
     */
    StartFormComponent.prototype.outcomeClick;
    /**
     * Emitted when a field of the form is clicked.
     * @type {?}
     */
    StartFormComponent.prototype.formContentClicked;
    /** @type {?} */
    StartFormComponent.prototype.outcomesContainer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJmb3JtL2NvbXBvbmVudHMvc3RhcnQtZm9ybS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFDSCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBR0wsTUFBTSxFQUVOLFNBQVMsRUFDVCxpQkFBaUIsRUFFcEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3pELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUd4RDtJQU13Qyw4Q0FBYTtJQWlDakQsNEJBQVksV0FBd0IsRUFDeEIsaUJBQTBDO1FBRHRELFlBRUksa0JBQU0sV0FBVyxFQUFFLGlCQUFpQixFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsU0FFcEQ7Ozs7UUF6QkQsd0JBQWtCLEdBQVksSUFBSSxDQUFDOzs7O1FBSW5DLHVCQUFpQixHQUFZLElBQUksQ0FBQzs7OztRQUlsQyxrQkFBWSxHQUFZLEtBQUssQ0FBQzs7OztRQUk5QixrQkFBWSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDOzs7O1FBSTFELHdCQUFrQixHQUFtQyxJQUFJLFlBQVksRUFBb0IsQ0FBQztRQUcxRix1QkFBaUIsR0FBZSxJQUFJLENBQUM7UUFLakMsS0FBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7O0lBQzNCLENBQUM7Ozs7SUFFRCxxQ0FBUTs7O0lBQVI7UUFBQSxpQkFXQztRQVZHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUNuQixJ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QyxtQkFBbUIsRUFBRTtZQUMxQixJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDekQ7YUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDOUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDdEM7SUFDTCxDQUFDOzs7OztJQUVELDZDQUFnQjs7OztJQUFoQixVQUFpQixPQUFnQjtRQUM3QixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwQyxDQUFDOztnQkFsSkosU0FBUyxTQUFDO29CQUNQLFFBQVEsRUFBRSxnQkFBZ0I7b0JBQzFCLGk0REFBMEM7b0JBRTFDLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJOztpQkFDeEM7Ozs7Z0JBWlEsV0FBVztnQkFDWCx1QkFBdUI7OztzQ0FlM0IsS0FBSzs0QkFJTCxLQUFLO3FDQUlMLEtBQUs7b0NBSUwsS0FBSzsrQkFJTCxLQUFLOytCQUlMLE1BQU07cUNBSU4sTUFBTTtvQ0FHTixTQUFTLFNBQUMsbUJBQW1CLEVBQUUsRUFBRTs7SUErR3RDLHlCQUFDO0NBQUEsQUFuSkQsQ0FNd0MsYUFBYSxHQTZJcEQ7U0E3SVksa0JBQWtCOzs7Ozs7SUFHM0IsaURBQzRCOzs7OztJQUc1Qix1Q0FDa0I7Ozs7O0lBR2xCLGdEQUNtQzs7Ozs7SUFHbkMsK0NBQ2tDOzs7OztJQUdsQywwQ0FDOEI7Ozs7O0lBRzlCLDBDQUMwRDs7Ozs7SUFHMUQsZ0RBQzBGOztJQUUxRiwrQ0FDcUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIENvbXBvbmVudCxcbiAgICBFbGVtZW50UmVmLFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBJbnB1dCxcbiAgICBPbkNoYW5nZXMsXG4gICAgT25Jbml0LFxuICAgIE91dHB1dCxcbiAgICBTaW1wbGVDaGFuZ2VzLFxuICAgIFZpZXdDaGlsZCxcbiAgICBWaWV3RW5jYXBzdWxhdGlvbixcbiAgICBPbkRlc3Ryb3lcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtU2VydmljZSB9IGZyb20gJy4vLi4vc2VydmljZXMvZm9ybS5zZXJ2aWNlJztcbmltcG9ydCB7IFdpZGdldFZpc2liaWxpdHlTZXJ2aWNlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy93aWRnZXQtdmlzaWJpbGl0eS5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1Db21wb25lbnQgfSBmcm9tICcuL2Zvcm0uY29tcG9uZW50JztcbmltcG9ydCB7IENvbnRlbnRMaW5rTW9kZWwgfSBmcm9tICcuL3dpZGdldHMvY29yZS9jb250ZW50LWxpbmsubW9kZWwnO1xuaW1wb3J0IHsgRm9ybU91dGNvbWVNb2RlbCB9IGZyb20gJy4vd2lkZ2V0cy9jb3JlL2luZGV4JztcbmltcG9ydCB7IFZhbGlkYXRlRm9ybUV2ZW50IH0gZnJvbSAnLi8uLi9ldmVudHMvdmFsaWRhdGUtZm9ybS5ldmVudCc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnYWRmLXN0YXJ0LWZvcm0nLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9zdGFydC1mb3JtLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9mb3JtLmNvbXBvbmVudC5zY3NzJ10sXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBTdGFydEZvcm1Db21wb25lbnQgZXh0ZW5kcyBGb3JtQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkluaXQsIE9uRGVzdHJveSB7XG5cbiAgICAvKiogRGVmaW5pdGlvbiBJRCBvZiB0aGUgcHJvY2VzcyB0byBzdGFydC4gKi9cbiAgICBASW5wdXQoKVxuICAgIHByb2Nlc3NEZWZpbml0aW9uSWQ6IHN0cmluZztcblxuICAgIC8qKiBQcm9jZXNzIElEIG9mIHRoZSBwcm9jZXNzIHRvIHN0YXJ0LiAqL1xuICAgIEBJbnB1dCgpXG4gICAgcHJvY2Vzc0lkOiBzdHJpbmc7XG5cbiAgICAvKiogU2hvdWxkIGZvcm0gb3V0Y29tZSBidXR0b25zIGJlIHNob3duPyAqL1xuICAgIEBJbnB1dCgpXG4gICAgc2hvd091dGNvbWVCdXR0b25zOiBib29sZWFuID0gdHJ1ZTtcblxuICAgIC8qKiBTaG91bGQgdGhlIHJlZnJlc2ggYnV0dG9uIGJlIHNob3duPyAqL1xuICAgIEBJbnB1dCgpXG4gICAgc2hvd1JlZnJlc2hCdXR0b246IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgLyoqIElzIHRoZSBmb3JtIHJlYWQtb25seSAoaWUsIGNhbid0IGJlIGVkaXRlZCk/ICovXG4gICAgQElucHV0KClcbiAgICByZWFkT25seUZvcm06IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIG9uZSBvZiB0aGUgb3V0Y29tZSBidXR0b25zIHRoYXQgY29tcGxldGVzIHRoZSBmb3JtLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIG91dGNvbWVDbGljazogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gYSBmaWVsZCBvZiB0aGUgZm9ybSBpcyBjbGlja2VkLiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIGZvcm1Db250ZW50Q2xpY2tlZDogRXZlbnRFbWl0dGVyPENvbnRlbnRMaW5rTW9kZWw+ID0gbmV3IEV2ZW50RW1pdHRlcjxDb250ZW50TGlua01vZGVsPigpO1xuXG4gICAgQFZpZXdDaGlsZCgnb3V0Y29tZXNDb250YWluZXInLCB7fSlcbiAgICBvdXRjb21lc0NvbnRhaW5lcjogRWxlbWVudFJlZiA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihmb3JtU2VydmljZTogRm9ybVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgdmlzaWJpbGl0eVNlcnZpY2U6IFdpZGdldFZpc2liaWxpdHlTZXJ2aWNlKSB7XG4gICAgICAgIHN1cGVyKGZvcm1TZXJ2aWNlLCB2aXNpYmlsaXR5U2VydmljZSwgbnVsbCwgbnVsbCk7XG4gICAgICAgIHRoaXMuc2hvd1RpdGxlID0gZmFsc2U7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKFxuICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZS5mb3JtQ29udGVudENsaWNrZWQuc3Vic2NyaWJlKChjb250ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtQ29udGVudENsaWNrZWQuZW1pdChjb250ZW50KTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZS52YWxpZGF0ZUZvcm0uc3Vic2NyaWJlKCh2YWxpZGF0ZUZvcm1FdmVudDogVmFsaWRhdGVGb3JtRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGVGb3JtRXZlbnQuZXJyb3JzRmllbGQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1FcnJvci5uZXh0KHZhbGlkYXRlRm9ybUV2ZW50LmVycm9yc0ZpZWxkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaCgoc3Vic2NyaXB0aW9uKSA9PiBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSk7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdO1xuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAgICAgbGV0IHByb2Nlc3NEZWZpbml0aW9uSWQgPSBjaGFuZ2VzWydwcm9jZXNzRGVmaW5pdGlvbklkJ107XG4gICAgICAgIGlmIChwcm9jZXNzRGVmaW5pdGlvbklkICYmIHByb2Nlc3NEZWZpbml0aW9uSWQuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLmNsZWFuUHJvY2Vzc1ZhcmlhYmxlKCk7XG4gICAgICAgICAgICB0aGlzLmdldFN0YXJ0Rm9ybURlZmluaXRpb24ocHJvY2Vzc0RlZmluaXRpb25JZC5jdXJyZW50VmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHByb2Nlc3NJZCA9IGNoYW5nZXNbJ3Byb2Nlc3NJZCddO1xuICAgICAgICBpZiAocHJvY2Vzc0lkICYmIHByb2Nlc3NJZC5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJpbGl0eVNlcnZpY2UuY2xlYW5Qcm9jZXNzVmFyaWFibGUoKTtcbiAgICAgICAgICAgIHRoaXMubG9hZFN0YXJ0Rm9ybShwcm9jZXNzSWQuY3VycmVudFZhbHVlKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxvYWRTdGFydEZvcm0ocHJvY2Vzc0lkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5mb3JtU2VydmljZS5nZXRQcm9jZXNzSW5zdGFuY2UocHJvY2Vzc0lkKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoaW5zdGFuY2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2VcbiAgICAgICAgICAgICAgICAgICAgLmdldFN0YXJ0Rm9ybUluc3RhbmNlKHByb2Nlc3NJZClcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgICAgIChmb3JtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtTmFtZSA9IGZvcm0ubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UudmFyaWFibGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0ucHJvY2Vzc1ZhcmlhYmxlcyA9IGluc3RhbmNlLnZhcmlhYmxlcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtID0gdGhpcy5wYXJzZUZvcm0oZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52aXNpYmlsaXR5U2VydmljZS5yZWZyZXNoVmlzaWJpbGl0eSh0aGlzLmZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybS52YWxpZGF0ZUZvcm0oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm0ucmVhZE9ubHkgPSB0aGlzLnJlYWRPbmx5Rm9ybTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uRm9ybUxvYWRlZCh0aGlzLmZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIChlcnJvcikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnJvcilcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldFN0YXJ0Rm9ybURlZmluaXRpb24ocHJvY2Vzc0lkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5mb3JtU2VydmljZVxuICAgICAgICAgICAgLmdldFN0YXJ0Rm9ybURlZmluaXRpb24ocHJvY2Vzc0lkKVxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoZm9ybSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1OYW1lID0gZm9ybS5wcm9jZXNzRGVmaW5pdGlvbk5hbWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybSA9IHRoaXMucGFyc2VGb3JtKGZvcm0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc2liaWxpdHlTZXJ2aWNlLnJlZnJlc2hWaXNpYmlsaXR5KHRoaXMuZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybS52YWxpZGF0ZUZvcm0oKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtLnJlYWRPbmx5ID0gdGhpcy5yZWFkT25seUZvcm07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25Gb3JtTG9hZGVkKHRoaXMuZm9ybSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKiBAb3ZlcnJpZGUgKi9cbiAgICBpc091dGNvbWVCdXR0b25WaXNpYmxlKG91dGNvbWU6IEZvcm1PdXRjb21lTW9kZWwsIGlzRm9ybVJlYWRPbmx5OiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChvdXRjb21lICYmIG91dGNvbWUuaXNTeXN0ZW0gJiYgKG91dGNvbWUubmFtZSA9PT0gRm9ybU91dGNvbWVNb2RlbC5TQVZFX0FDVElPTiB8fFxuICAgICAgICAgICAgb3V0Y29tZS5uYW1lID09PSBGb3JtT3V0Y29tZU1vZGVsLkNPTVBMRVRFX0FDVElPTikpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIGlmIChvdXRjb21lICYmIG91dGNvbWUubmFtZSA9PT0gRm9ybU91dGNvbWVNb2RlbC5TVEFSVF9QUk9DRVNTX0FDVElPTikge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN1cGVyLmlzT3V0Y29tZUJ1dHRvblZpc2libGUob3V0Y29tZSwgaXNGb3JtUmVhZE9ubHkpO1xuICAgIH1cblxuICAgIC8qKiBAb3ZlcnJpZGUgKi9cbiAgICBzYXZlVGFza0Zvcm0oKSB7XG4gICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG5cbiAgICAvKiogQG92ZXJyaWRlICovXG4gICAgb25SZWZyZXNoQ2xpY2tlZCgpIHtcbiAgICAgICAgaWYgKHRoaXMucHJvY2Vzc0RlZmluaXRpb25JZCkge1xuICAgICAgICAgICAgdGhpcy52aXNpYmlsaXR5U2VydmljZS5jbGVhblByb2Nlc3NWYXJpYWJsZSgpO1xuICAgICAgICAgICAgdGhpcy5nZXRTdGFydEZvcm1EZWZpbml0aW9uKHRoaXMucHJvY2Vzc0RlZmluaXRpb25JZCk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5wcm9jZXNzSWQpIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJpbGl0eVNlcnZpY2UuY2xlYW5Qcm9jZXNzVmFyaWFibGUoKTtcbiAgICAgICAgICAgIHRoaXMubG9hZFN0YXJ0Rm9ybSh0aGlzLnByb2Nlc3NJZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wbGV0ZVRhc2tGb3JtKG91dGNvbWU/OiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5vdXRjb21lQ2xpY2suZW1pdChvdXRjb21lKTtcbiAgICB9XG59XG4iXX0=