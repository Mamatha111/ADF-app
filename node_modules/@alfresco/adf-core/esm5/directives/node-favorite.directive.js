/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:no-input-rename  */
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { from, forkJoin, of } from 'rxjs';
import { AlfrescoApiService } from '../services/alfresco-api.service';
import { catchError, map } from 'rxjs/operators';
var NodeFavoriteDirective = /** @class */ (function () {
    function NodeFavoriteDirective(alfrescoApiService) {
        this.alfrescoApiService = alfrescoApiService;
        this.favorites = [];
        /**
         * Array of nodes to toggle as favorites.
         */
        this.selection = [];
        /**
         * Emitted when the favorite setting is complete.
         */
        this.toggle = new EventEmitter();
        /**
         * Emitted when the favorite setting fails.
         */
        this.error = new EventEmitter();
    }
    /**
     * @return {?}
     */
    NodeFavoriteDirective.prototype.onClick = /**
     * @return {?}
     */
    function () {
        this.toggleFavorite();
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    NodeFavoriteDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (!changes.selection.currentValue.length) {
            this.favorites = [];
            return;
        }
        this.markFavoritesNodes(changes.selection.currentValue);
    };
    /**
     * @return {?}
     */
    NodeFavoriteDirective.prototype.toggleFavorite = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.favorites.length) {
            return;
        }
        /** @type {?} */
        var every = this.favorites.every(function (selected) { return selected.entry.isFavorite; });
        if (every) {
            /** @type {?} */
            var batch = this.favorites.map(function (selected) {
                // shared files have nodeId
                /** @type {?} */
                var id = ((/** @type {?} */ (selected))).entry.nodeId || selected.entry.id;
                return from(_this.alfrescoApiService.favoritesApi.removeFavoriteSite('-me-', id));
            });
            forkJoin(batch).subscribe(function () {
                _this.favorites.map(function (selected) { return selected.entry.isFavorite = false; });
                _this.toggle.emit();
            }, function (error) { return _this.error.emit(error); });
        }
        if (!every) {
            /** @type {?} */
            var notFavorite_1 = this.favorites.filter(function (node) { return !node.entry.isFavorite; });
            /** @type {?} */
            var body = notFavorite_1.map(function (node) { return _this.createFavoriteBody(node); });
            from(this.alfrescoApiService.favoritesApi.addFavorite('-me-', (/** @type {?} */ (body))))
                .subscribe(function () {
                notFavorite_1.map(function (selected) { return selected.entry.isFavorite = true; });
                _this.toggle.emit();
            }, function (error) { return _this.error.emit(error); });
        }
    };
    /**
     * @param {?} selection
     * @return {?}
     */
    NodeFavoriteDirective.prototype.markFavoritesNodes = /**
     * @param {?} selection
     * @return {?}
     */
    function (selection) {
        var _this = this;
        if (selection.length <= this.favorites.length) {
            /** @type {?} */
            var newFavorites = this.reduce(this.favorites, selection);
            this.favorites = newFavorites;
        }
        /** @type {?} */
        var result = this.diff(selection, this.favorites);
        /** @type {?} */
        var batch = this.getProcessBatch(result);
        forkJoin(batch).subscribe(function (data) {
            var _a;
            (_a = _this.favorites).push.apply(_a, tslib_1.__spread(data));
        });
    };
    /**
     * @return {?}
     */
    NodeFavoriteDirective.prototype.hasFavorites = /**
     * @return {?}
     */
    function () {
        if (this.favorites && !this.favorites.length) {
            return false;
        }
        return this.favorites.every(function (selected) { return selected.entry.isFavorite; });
    };
    /**
     * @private
     * @param {?} selection
     * @return {?}
     */
    NodeFavoriteDirective.prototype.getProcessBatch = /**
     * @private
     * @param {?} selection
     * @return {?}
     */
    function (selection) {
        var _this = this;
        return selection.map(function (selected) { return _this.getFavorite(selected); });
    };
    /**
     * @private
     * @param {?} selected
     * @return {?}
     */
    NodeFavoriteDirective.prototype.getFavorite = /**
     * @private
     * @param {?} selected
     * @return {?}
     */
    function (selected) {
        /** @type {?} */
        var node = selected.entry;
        // ACS 6.x with 'isFavorite' include
        if (node && node.hasOwnProperty('isFavorite')) {
            return of(selected);
        }
        // ACS 5.x and 6.x without 'isFavorite' include
        var _a = (/** @type {?} */ (node)), name = _a.name, isFile = _a.isFile, isFolder = _a.isFolder;
        /** @type {?} */
        var id = ((/** @type {?} */ (node))).nodeId || node.id;
        /** @type {?} */
        var promise = this.alfrescoApiService.favoritesApi.getFavorite('-me-', id);
        return from(promise).pipe(map(function () { return ({
            entry: {
                id: id,
                isFolder: isFolder,
                isFile: isFile,
                name: name,
                isFavorite: true
            }
        }); }), catchError(function () {
            return of({
                entry: {
                    id: id,
                    isFolder: isFolder,
                    isFile: isFile,
                    name: name,
                    isFavorite: false
                }
            });
        }));
    };
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    NodeFavoriteDirective.prototype.createFavoriteBody = /**
     * @private
     * @param {?} node
     * @return {?}
     */
    function (node) {
        var _a;
        /** @type {?} */
        var type = this.getNodeType(node);
        // shared files have nodeId
        /** @type {?} */
        var id = node.entry.nodeId || node.entry.id;
        return {
            target: (_a = {},
                _a[type] = {
                    guid: id
                },
                _a)
        };
    };
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    NodeFavoriteDirective.prototype.getNodeType = /**
     * @private
     * @param {?} node
     * @return {?}
     */
    function (node) {
        // shared could only be files
        if (!node.entry.isFile && !node.entry.isFolder) {
            return 'file';
        }
        return node.entry.isFile ? 'file' : 'folder';
    };
    /**
     * @private
     * @param {?} list
     * @param {?} patch
     * @return {?}
     */
    NodeFavoriteDirective.prototype.diff = /**
     * @private
     * @param {?} list
     * @param {?} patch
     * @return {?}
     */
    function (list, patch) {
        /** @type {?} */
        var ids = patch.map(function (item) { return item.entry.id; });
        return list.filter(function (item) { return ids.includes(item.entry.id) ? null : item; });
    };
    /**
     * @private
     * @param {?} patch
     * @param {?} comparator
     * @return {?}
     */
    NodeFavoriteDirective.prototype.reduce = /**
     * @private
     * @param {?} patch
     * @param {?} comparator
     * @return {?}
     */
    function (patch, comparator) {
        /** @type {?} */
        var ids = comparator.map(function (item) { return item.entry.id; });
        return patch.filter(function (item) { return ids.includes(item.entry.id) ? item : null; });
    };
    NodeFavoriteDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[adf-node-favorite]',
                    exportAs: 'adfFavorite'
                },] }
    ];
    /** @nocollapse */
    NodeFavoriteDirective.ctorParameters = function () { return [
        { type: AlfrescoApiService }
    ]; };
    NodeFavoriteDirective.propDecorators = {
        selection: [{ type: Input, args: ['adf-node-favorite',] }],
        toggle: [{ type: Output }],
        error: [{ type: Output }],
        onClick: [{ type: HostListener, args: ['click',] }]
    };
    return NodeFavoriteDirective;
}());
export { NodeFavoriteDirective };
if (false) {
    /** @type {?} */
    NodeFavoriteDirective.prototype.favorites;
    /**
     * Array of nodes to toggle as favorites.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.selection;
    /**
     * Emitted when the favorite setting is complete.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.toggle;
    /**
     * Emitted when the favorite setting fails.
     * @type {?}
     */
    NodeFavoriteDirective.prototype.error;
    /**
     * @type {?}
     * @private
     */
    NodeFavoriteDirective.prototype.alfrescoApiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1mYXZvcml0ZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvcmUvIiwic291cmNlcyI6WyJkaXJlY3RpdmVzL25vZGUtZmF2b3JpdGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFtQkEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFaEcsT0FBTyxFQUFjLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakQ7SUFzQkksK0JBQW9CLGtCQUFzQztRQUF0Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBakIxRCxjQUFTLEdBQVUsRUFBRSxDQUFDOzs7O1FBSXRCLGNBQVMsR0FBZ0IsRUFBRSxDQUFDOzs7O1FBR2xCLFdBQU0sR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQzs7OztRQUcvQyxVQUFLLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7SUFReEQsQ0FBQzs7OztJQUxELHVDQUFPOzs7SUFEUDtRQUVJLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDOzs7OztJQUtELDJDQUFXOzs7O0lBQVgsVUFBWSxPQUFPO1FBQ2YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRTtZQUN4QyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztZQUVwQixPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM1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dGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpuby1pbnB1dC1yZW5hbWUgICovXG5cbmltcG9ydCB7IERpcmVjdGl2ZSwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIElucHV0LCBPbkNoYW5nZXMsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRmF2b3JpdGVCb2R5LCBOb2RlRW50cnksIFNoYXJlZExpbmtFbnRyeSwgTm9kZSwgU2hhcmVkTGluayB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgZm9ya0pvaW4sIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnW2FkZi1ub2RlLWZhdm9yaXRlXScsXG4gICAgZXhwb3J0QXM6ICdhZGZGYXZvcml0ZSdcbn0pXG5leHBvcnQgY2xhc3MgTm9kZUZhdm9yaXRlRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgICBmYXZvcml0ZXM6IGFueVtdID0gW107XG5cbiAgICAvKiogQXJyYXkgb2Ygbm9kZXMgdG8gdG9nZ2xlIGFzIGZhdm9yaXRlcy4gKi9cbiAgICBASW5wdXQoJ2FkZi1ub2RlLWZhdm9yaXRlJylcbiAgICBzZWxlY3Rpb246IE5vZGVFbnRyeVtdID0gW107XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIHRoZSBmYXZvcml0ZSBzZXR0aW5nIGlzIGNvbXBsZXRlLiAqL1xuICAgIEBPdXRwdXQoKSB0b2dnbGU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgZmF2b3JpdGUgc2V0dGluZyBmYWlscy4gKi9cbiAgICBAT3V0cHV0KCkgZXJyb3I6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxuICAgIG9uQ2xpY2soKSB7XG4gICAgICAgIHRoaXMudG9nZ2xlRmF2b3JpdGUoKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlcykge1xuICAgICAgICBpZiAoIWNoYW5nZXMuc2VsZWN0aW9uLmN1cnJlbnRWYWx1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuZmF2b3JpdGVzID0gW107XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWFya0Zhdm9yaXRlc05vZGVzKGNoYW5nZXMuc2VsZWN0aW9uLmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuXG4gICAgdG9nZ2xlRmF2b3JpdGUoKSB7XG4gICAgICAgIGlmICghdGhpcy5mYXZvcml0ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBldmVyeSA9IHRoaXMuZmF2b3JpdGVzLmV2ZXJ5KChzZWxlY3RlZCkgPT4gc2VsZWN0ZWQuZW50cnkuaXNGYXZvcml0ZSk7XG5cbiAgICAgICAgaWYgKGV2ZXJ5KSB7XG4gICAgICAgICAgICBjb25zdCBiYXRjaCA9IHRoaXMuZmF2b3JpdGVzLm1hcCgoc2VsZWN0ZWQ6IE5vZGVFbnRyeSB8IFNoYXJlZExpbmtFbnRyeSkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHNoYXJlZCBmaWxlcyBoYXZlIG5vZGVJZFxuICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gKDxTaGFyZWRMaW5rRW50cnk+IHNlbGVjdGVkKS5lbnRyeS5ub2RlSWQgfHwgc2VsZWN0ZWQuZW50cnkuaWQ7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5mYXZvcml0ZXNBcGkucmVtb3ZlRmF2b3JpdGVTaXRlKCctbWUtJywgaWQpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBmb3JrSm9pbihiYXRjaCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYXZvcml0ZXMubWFwKChzZWxlY3RlZCkgPT4gc2VsZWN0ZWQuZW50cnkuaXNGYXZvcml0ZSA9IGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGUuZW1pdCgpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycm9yKSA9PiB0aGlzLmVycm9yLmVtaXQoZXJyb3IpXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFldmVyeSkge1xuICAgICAgICAgICAgY29uc3Qgbm90RmF2b3JpdGUgPSB0aGlzLmZhdm9yaXRlcy5maWx0ZXIoKG5vZGUpID0+ICFub2RlLmVudHJ5LmlzRmF2b3JpdGUpO1xuICAgICAgICAgICAgY29uc3QgYm9keTogRmF2b3JpdGVCb2R5W10gPSBub3RGYXZvcml0ZS5tYXAoKG5vZGUpID0+IHRoaXMuY3JlYXRlRmF2b3JpdGVCb2R5KG5vZGUpKTtcblxuICAgICAgICAgICAgZnJvbSh0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5mYXZvcml0ZXNBcGkuYWRkRmF2b3JpdGUoJy1tZS0nLCA8YW55PiBib2R5KSlcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub3RGYXZvcml0ZS5tYXAoKHNlbGVjdGVkKSA9PiBzZWxlY3RlZC5lbnRyeS5pc0Zhdm9yaXRlID0gdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZS5lbWl0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIChlcnJvcikgPT4gdGhpcy5lcnJvci5lbWl0KGVycm9yKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtYXJrRmF2b3JpdGVzTm9kZXMoc2VsZWN0aW9uOiBOb2RlRW50cnlbXSkge1xuICAgICAgICBpZiAoc2VsZWN0aW9uLmxlbmd0aCA8PSB0aGlzLmZhdm9yaXRlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld0Zhdm9yaXRlcyA9IHRoaXMucmVkdWNlKHRoaXMuZmF2b3JpdGVzLCBzZWxlY3Rpb24pO1xuICAgICAgICAgICAgdGhpcy5mYXZvcml0ZXMgPSBuZXdGYXZvcml0ZXM7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmRpZmYoc2VsZWN0aW9uLCB0aGlzLmZhdm9yaXRlcyk7XG4gICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5nZXRQcm9jZXNzQmF0Y2gocmVzdWx0KTtcblxuICAgICAgICBmb3JrSm9pbihiYXRjaCkuc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmZhdm9yaXRlcy5wdXNoKC4uLmRhdGEpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBoYXNGYXZvcml0ZXMoKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLmZhdm9yaXRlcyAmJiAhdGhpcy5mYXZvcml0ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5mYXZvcml0ZXMuZXZlcnkoKHNlbGVjdGVkKSA9PiBzZWxlY3RlZC5lbnRyeS5pc0Zhdm9yaXRlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFByb2Nlc3NCYXRjaChzZWxlY3Rpb24pOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBzZWxlY3Rpb24ubWFwKChzZWxlY3RlZDogTm9kZUVudHJ5KSA9PiB0aGlzLmdldEZhdm9yaXRlKHNlbGVjdGVkKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRGYXZvcml0ZShzZWxlY3RlZDogTm9kZUVudHJ5IHwgU2hhcmVkTGlua0VudHJ5KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3Qgbm9kZTogTm9kZSB8IFNoYXJlZExpbmsgPSBzZWxlY3RlZC5lbnRyeTtcblxuICAgICAgICAvLyBBQ1MgNi54IHdpdGggJ2lzRmF2b3JpdGUnIGluY2x1ZGVcbiAgICAgICAgaWYgKG5vZGUgJiYgbm9kZS5oYXNPd25Qcm9wZXJ0eSgnaXNGYXZvcml0ZScpKSB7XG4gICAgICAgICAgICByZXR1cm4gb2Yoc2VsZWN0ZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQUNTIDUueCBhbmQgNi54IHdpdGhvdXQgJ2lzRmF2b3JpdGUnIGluY2x1ZGVcbiAgICAgICAgY29uc3QgeyBuYW1lLCBpc0ZpbGUsIGlzRm9sZGVyIH0gPSA8Tm9kZT4gbm9kZTtcbiAgICAgICAgY29uc3QgaWQgPSAgKDxTaGFyZWRMaW5rPiBub2RlKS5ub2RlSWQgfHwgbm9kZS5pZDtcblxuICAgICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UuZmF2b3JpdGVzQXBpLmdldEZhdm9yaXRlKCctbWUtJywgaWQpO1xuXG4gICAgICAgIHJldHVybiBmcm9tKHByb21pc2UpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKCkgPT4gKHtcbiAgICAgICAgICAgICAgICBlbnRyeToge1xuICAgICAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICAgICAgaXNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgIGlzRmlsZSxcbiAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgaXNGYXZvcml0ZTogdHJ1ZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBvZih7XG4gICAgICAgICAgICAgICAgICAgIGVudHJ5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNGaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzRmF2b3JpdGU6IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVGYXZvcml0ZUJvZHkobm9kZSk6IEZhdm9yaXRlQm9keSB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLmdldE5vZGVUeXBlKG5vZGUpO1xuICAgICAgICAvLyBzaGFyZWQgZmlsZXMgaGF2ZSBub2RlSWRcbiAgICAgICAgY29uc3QgaWQgPSBub2RlLmVudHJ5Lm5vZGVJZCB8fCBub2RlLmVudHJ5LmlkO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0YXJnZXQ6IHtcbiAgICAgICAgICAgICAgICBbdHlwZV06IHtcbiAgICAgICAgICAgICAgICAgICAgZ3VpZDogaWRcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXROb2RlVHlwZShub2RlKTogc3RyaW5nIHtcbiAgICAgICAgLy8gc2hhcmVkIGNvdWxkIG9ubHkgYmUgZmlsZXNcbiAgICAgICAgaWYgKCFub2RlLmVudHJ5LmlzRmlsZSAmJiAhbm9kZS5lbnRyeS5pc0ZvbGRlcikge1xuICAgICAgICAgICAgcmV0dXJuICdmaWxlJztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBub2RlLmVudHJ5LmlzRmlsZSA/ICdmaWxlJyA6ICdmb2xkZXInO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGlmZihsaXN0LCBwYXRjaCk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgaWRzID0gcGF0Y2gubWFwKChpdGVtKSA9PiBpdGVtLmVudHJ5LmlkKTtcblxuICAgICAgICByZXR1cm4gbGlzdC5maWx0ZXIoKGl0ZW0pID0+IGlkcy5pbmNsdWRlcyhpdGVtLmVudHJ5LmlkKSA/IG51bGwgOiBpdGVtKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlZHVjZShwYXRjaCwgY29tcGFyYXRvcik6IGFueVtdIHtcbiAgICAgICAgY29uc3QgaWRzID0gY29tcGFyYXRvci5tYXAoKGl0ZW0pID0+IGl0ZW0uZW50cnkuaWQpO1xuXG4gICAgICAgIHJldHVybiBwYXRjaC5maWx0ZXIoKGl0ZW0pID0+IGlkcy5pbmNsdWRlcyhpdGVtLmVudHJ5LmlkKSA/IGl0ZW0gOiBudWxsKTtcbiAgICB9XG59XG4iXX0=