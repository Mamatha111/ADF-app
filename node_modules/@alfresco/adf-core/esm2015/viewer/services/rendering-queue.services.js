/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/* tslint:disable:adf-license-banner  */
/* Copyright 2012 Mozilla Foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
/**
 *
 * RenderingQueueServices rendering of the views for pages and thumbnails.
 *
 */
export class RenderingQueueServices {
    constructor() {
        this.renderingStates = {
            INITIAL: 0,
            RUNNING: 1,
            PAUSED: 2,
            FINISHED: 3
        };
        this.CLEANUP_TIMEOUT = 30000;
        this.pdfViewer = null;
        this.pdfThumbnailViewer = null;
        this.onIdle = null;
        this.highestPriorityPage = null;
        this.idleTimeout = null;
        this.printing = false;
        this.isThumbnailViewEnabled = false;
    }
    /**
     * @param {?} pdfViewer
     * @return {?}
     */
    setViewer(pdfViewer) {
        this.pdfViewer = pdfViewer;
    }
    /**
     * @param {?} pdfThumbnailViewer
     * @return {?}
     */
    setThumbnailViewer(pdfThumbnailViewer) {
        this.pdfThumbnailViewer = pdfThumbnailViewer;
    }
    /**
     * @param {?} view
     * @return {?}
     */
    isHighestPriority(view) {
        return this.highestPriorityPage === view.renderingId;
    }
    /**
     * @param {?} currentlyVisiblePages
     * @return {?}
     */
    renderHighestPriority(currentlyVisiblePages) {
        if (this.idleTimeout) {
            clearTimeout(this.idleTimeout);
            this.idleTimeout = null;
        }
        // Pages have a higher priority than thumbnails, so check them first.
        if (this.pdfViewer.forceRendering(currentlyVisiblePages)) {
            return;
        }
        // No pages needed rendering so check thumbnails.
        if (this.pdfThumbnailViewer && this.isThumbnailViewEnabled) {
            if (this.pdfThumbnailViewer.forceRendering()) {
                return;
            }
        }
        if (this.printing) {
            // If printing is currently ongoing do not reschedule cleanup.
            return;
        }
        if (this.onIdle) {
            this.idleTimeout = setTimeout(this.onIdle.bind(this), this.CLEANUP_TIMEOUT);
        }
    }
    /**
     * @param {?} visible
     * @param {?} views
     * @param {?} scrolledDown
     * @return {?}
     */
    getHighestPriority(visible, views, scrolledDown) {
        // The state has changed figure out which page has the highest priority to
        // render next (if any).
        // Priority:
        // 1 visible pages
        // 2 if last scrolled down page after the visible pages
        // 2 if last scrolled up page before the visible pages
        /** @type {?} */
        let visibleViews = visible.views;
        /** @type {?} */
        let numVisible = visibleViews.length;
        if (numVisible === 0) {
            return false;
        }
        for (let i = 0; i < numVisible; ++i) {
            /** @type {?} */
            let view = visibleViews[i].view;
            if (!this.isViewFinished(view)) {
                return view;
            }
        }
        // All the visible views have rendered, try to render next/previous pages.
        if (scrolledDown) {
            /** @type {?} */
            let nextPageIndex = visible.last.id;
            // ID's start at 1 so no need to add 1.
            if (views[nextPageIndex] && !this.isViewFinished(views[nextPageIndex])) {
                return views[nextPageIndex];
            }
        }
        else {
            /** @type {?} */
            let previousPageIndex = visible.first.id - 2;
            if (views[previousPageIndex] && !this.isViewFinished(views[previousPageIndex])) {
                return views[previousPageIndex];
            }
        }
        // Everything that needs to be rendered has been.
        return null;
    }
    /**
     * @param {?} view
     * @return {?}
     */
    isViewFinished(view) {
        return view.renderingState === this.renderingStates.FINISHED;
    }
    /**
     * Render a page or thumbnail view. This calls the appropriate function
     * based on the views state. If the view is already rendered it will return
     * false.
     * @param {?} view
     * @return {?}
     */
    renderView(view) {
        /** @type {?} */
        let state = view.renderingState;
        switch (state) {
            case this.renderingStates.FINISHED:
                return false;
            case this.renderingStates.PAUSED:
                this.highestPriorityPage = view.renderingId;
                view.resume();
                break;
            case this.renderingStates.RUNNING:
                this.highestPriorityPage = view.renderingId;
                break;
            case this.renderingStates.INITIAL:
                this.highestPriorityPage = view.renderingId;
                /** @type {?} */
                let continueRendering = function () {
                    this.renderHighestPriority();
                }.bind(this);
                view.draw().then(continueRendering, continueRendering);
                break;
            default:
                break;
        }
        return true;
    }
}
RenderingQueueServices.decorators = [
    { type: Injectable }
];
if (false) {
    /** @type {?} */
    RenderingQueueServices.prototype.renderingStates;
    /** @type {?} */
    RenderingQueueServices.prototype.CLEANUP_TIMEOUT;
    /** @type {?} */
    RenderingQueueServices.prototype.pdfViewer;
    /** @type {?} */
    RenderingQueueServices.prototype.pdfThumbnailViewer;
    /** @type {?} */
    RenderingQueueServices.prototype.onIdle;
    /** @type {?} */
    RenderingQueueServices.prototype.highestPriorityPage;
    /** @type {?} */
    RenderingQueueServices.prototype.idleTimeout;
    /** @type {?} */
    RenderingQueueServices.prototype.printing;
    /** @type {?} */
    RenderingQueueServices.prototype.isThumbnailViewEnabled;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyaW5nLXF1ZXVlLnNlcnZpY2VzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1jb3JlLyIsInNvdXJjZXMiOlsidmlld2VyL3NlcnZpY2VzL3JlbmRlcmluZy1xdWV1ZS5zZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7Ozs7OztBQVEzQyxNQUFNLE9BQU8sc0JBQXNCO0lBRG5DO1FBR0ksb0JBQWUsR0FBRztZQUNkLE9BQU8sRUFBRSxDQUFDO1lBQ1YsT0FBTyxFQUFFLENBQUM7WUFDVixNQUFNLEVBQUUsQ0FBQztZQUNULFFBQVEsRUFBRSxDQUFDO1NBQ2QsQ0FBQztRQUVGLG9CQUFlLEdBQVcsS0FBSyxDQUFDO1FBRWhDLGNBQVMsR0FBUSxJQUFJLENBQUM7UUFDdEIsdUJBQWtCLEdBQVEsSUFBSSxDQUFDO1FBQy9CLFdBQU0sR0FBUSxJQUFJLENBQUM7UUFFbkIsd0JBQW1CLEdBQVEsSUFBSSxDQUFDO1FBQ2hDLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLGFBQVEsR0FBUSxLQUFLLENBQUM7UUFDdEIsMkJBQXNCLEdBQVEsS0FBSyxDQUFDO0lBNEh4QyxDQUFDOzs7OztJQXZIRyxTQUFTLENBQUMsU0FBUztRQUNmLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQy9CLENBQUM7Ozs7O0lBS0Qsa0JBQWtCLENBQUMsa0JBQWtCO1FBQ2pDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQztJQUNqRCxDQUFDOzs7OztJQUtELGlCQUFpQixDQUFDLElBQVM7UUFDdkIsT0FBTyxJQUFJLENBQUMsbUJBQW1CLEtBQUssSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUN6RCxDQUFDOzs7OztJQUVELHFCQUFxQixDQUFDLHFCQUFxQjtRQUN2QyxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFD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VyxDQUFDO2dCQUM1QyxNQUFNO1lBQ1YsS0FBSyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU87Z0JBQzdCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDOztvQkFDeEMsaUJBQWlCLEdBQUc7b0JBQ3BCLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO2dCQUNqQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDWixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLENBQUM7Z0JBQ3ZELE1BQU07WUFDVjtnQkFDSSxNQUFNO1NBQ2I7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzs7WUE5SUosVUFBVTs7OztJQUdQLGlEQUtFOztJQUVGLGlEQUFnQzs7SUFFaEMsMkNBQXNCOztJQUN0QixvREFBK0I7O0lBQy9CLHdDQUFtQjs7SUFFbkIscURBQWdDOztJQUNoQyw2Q0FBd0I7O0lBQ3hCLDBDQUFzQjs7SUFDdEIsd0RBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6YWRmLWxpY2Vuc2UtYmFubmVyICAqL1xuXG4vKiBDb3B5cmlnaHQgMjAxMiBNb3ppbGxhIEZvdW5kYXRpb25cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG4vKipcbiAqXG4gKiBSZW5kZXJpbmdRdWV1ZVNlcnZpY2VzIHJlbmRlcmluZyBvZiB0aGUgdmlld3MgZm9yIHBhZ2VzIGFuZCB0aHVtYm5haWxzLlxuICpcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJlbmRlcmluZ1F1ZXVlU2VydmljZXMge1xuXG4gICAgcmVuZGVyaW5nU3RhdGVzID0ge1xuICAgICAgICBJTklUSUFMOiAwLFxuICAgICAgICBSVU5OSU5HOiAxLFxuICAgICAgICBQQVVTRUQ6IDIsXG4gICAgICAgIEZJTklTSEVEOiAzXG4gICAgfTtcblxuICAgIENMRUFOVVBfVElNRU9VVDogbnVtYmVyID0gMzAwMDA7XG5cbiAgICBwZGZWaWV3ZXI6IGFueSA9IG51bGw7XG4gICAgcGRmVGh1bWJuYWlsVmlld2VyOiBhbnkgPSBudWxsO1xuICAgIG9uSWRsZTogYW55ID0gbnVsbDtcblxuICAgIGhpZ2hlc3RQcmlvcml0eVBhZ2U6IGFueSA9IG51bGw7XG4gICAgaWRsZVRpbWVvdXQ6IGFueSA9IG51bGw7XG4gICAgcHJpbnRpbmc6IGFueSA9IGZhbHNlO1xuICAgIGlzVGh1bWJuYWlsVmlld0VuYWJsZWQ6IGFueSA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHBkZlZpZXdlclxuICAgICAqL1xuICAgIHNldFZpZXdlcihwZGZWaWV3ZXIpIHtcbiAgICAgICAgdGhpcy5wZGZWaWV3ZXIgPSBwZGZWaWV3ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHBkZlRodW1ibmFpbFZpZXdlclxuICAgICAqL1xuICAgIHNldFRodW1ibmFpbFZpZXdlcihwZGZUaHVtYm5haWxWaWV3ZXIpIHtcbiAgICAgICAgdGhpcy5wZGZUaHVtYm5haWxWaWV3ZXIgPSBwZGZUaHVtYm5haWxWaWV3ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtICB2aWV3XG4gICAgICovXG4gICAgaXNIaWdoZXN0UHJpb3JpdHkodmlldzogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhpZ2hlc3RQcmlvcml0eVBhZ2UgPT09IHZpZXcucmVuZGVyaW5nSWQ7XG4gICAgfVxuXG4gICAgcmVuZGVySGlnaGVzdFByaW9yaXR5KGN1cnJlbnRseVZpc2libGVQYWdlcykge1xuICAgICAgICBpZiAodGhpcy5pZGxlVGltZW91dCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaWRsZVRpbWVvdXQpO1xuICAgICAgICAgICAgdGhpcy5pZGxlVGltZW91dCA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYWdlcyBoYXZlIGEgaGlnaGVyIHByaW9yaXR5IHRoYW4gdGh1bWJuYWlscywgc28gY2hlY2sgdGhlbSBmaXJzdC5cbiAgICAgICAgaWYgKHRoaXMucGRmVmlld2VyLmZvcmNlUmVuZGVyaW5nKGN1cnJlbnRseVZpc2libGVQYWdlcykpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyBObyBwYWdlcyBuZWVkZWQgcmVuZGVyaW5nIHNvIGNoZWNrIHRodW1ibmFpbHMuXG4gICAgICAgIGlmICh0aGlzLnBkZlRodW1ibmFpbFZpZXdlciAmJiB0aGlzLmlzVGh1bWJuYWlsVmlld0VuYWJsZWQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnBkZlRodW1ibmFpbFZpZXdlci5mb3JjZVJlbmRlcmluZygpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMucHJpbnRpbmcpIHtcbiAgICAgICAgICAgIC8vIElmIHByaW50aW5nIGlzIGN1cnJlbnRseSBvbmdvaW5nIGRvIG5vdCByZXNjaGVkdWxlIGNsZWFudXAuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vbklkbGUpIHtcbiAgICAgICAgICAgIHRoaXMuaWRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMub25JZGxlLmJpbmQodGhpcyksIHRoaXMuQ0xFQU5VUF9USU1FT1VUKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldEhpZ2hlc3RQcmlvcml0eSh2aXNpYmxlLCB2aWV3cywgc2Nyb2xsZWREb3duKSB7XG4gICAgICAgIC8vIFRoZSBzdGF0ZSBoYXMgY2hhbmdlZCBmaWd1cmUgb3V0IHdoaWNoIHBhZ2UgaGFzIHRoZSBoaWdoZXN0IHByaW9yaXR5IHRvXG4gICAgICAgIC8vIHJlbmRlciBuZXh0IChpZiBhbnkpLlxuICAgICAgICAvLyBQcmlvcml0eTpcbiAgICAgICAgLy8gMSB2aXNpYmxlIHBhZ2VzXG4gICAgICAgIC8vIDIgaWYgbGFzdCBzY3JvbGxlZCBkb3duIHBhZ2UgYWZ0ZXIgdGhlIHZpc2libGUgcGFnZXNcbiAgICAgICAgLy8gMiBpZiBsYXN0IHNjcm9sbGVkIHVwIHBhZ2UgYmVmb3JlIHRoZSB2aXNpYmxlIHBhZ2VzXG4gICAgICAgIGxldCB2aXNpYmxlVmlld3MgPSB2aXNpYmxlLnZpZXdzO1xuXG4gICAgICAgIGxldCBudW1WaXNpYmxlID0gdmlzaWJsZVZpZXdzLmxlbmd0aDtcbiAgICAgICAgaWYgKG51bVZpc2libGUgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZpc2libGU7ICsraSkge1xuICAgICAgICAgICAgbGV0IHZpZXcgPSB2aXNpYmxlVmlld3NbaV0udmlldztcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1ZpZXdGaW5pc2hlZCh2aWV3KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB2aWV3O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gQWxsIHRoZSB2aXNpYmxlIHZpZXdzIGhhdmUgcmVuZGVyZWQsIHRyeSB0byByZW5kZXIgbmV4dC9wcmV2aW91cyBwYWdlcy5cbiAgICAgICAgaWYgKHNjcm9sbGVkRG93bikge1xuICAgICAgICAgICAgbGV0IG5leHRQYWdlSW5kZXggPSB2aXNpYmxlLmxhc3QuaWQ7XG4gICAgICAgICAgICAvLyBJRCdzIHN0YXJ0IGF0IDEgc28gbm8gbmVlZCB0byBhZGQgMS5cbiAgICAgICAgICAgIGlmICh2aWV3c1tuZXh0UGFnZUluZGV4XSAmJiAhdGhpcy5pc1ZpZXdGaW5pc2hlZCh2aWV3c1tuZXh0UGFnZUluZGV4XSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdmlld3NbbmV4dFBhZ2VJbmRleF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgcHJldmlvdXNQYWdlSW5kZXggPSB2aXNpYmxlLmZpcnN0LmlkIC0gMjtcbiAgICAgICAgICAgIGlmICh2aWV3c1twcmV2aW91c1BhZ2VJbmRleF0gJiYgIXRoaXMuaXNWaWV3RmluaXNoZWQodmlld3NbcHJldmlvdXNQYWdlSW5kZXhdKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB2aWV3c1twcmV2aW91c1BhZ2VJbmRleF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gRXZlcnl0aGluZyB0aGF0IG5lZWRzIHRvIGJlIHJlbmRlcmVkIGhhcyBiZWVuLlxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0gdmlld1xuICAgICAqL1xuICAgIGlzVmlld0ZpbmlzaGVkKHZpZXcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHZpZXcucmVuZGVyaW5nU3RhdGUgPT09IHRoaXMucmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbmRlciBhIHBhZ2Ugb3IgdGh1bWJuYWlsIHZpZXcuIFRoaXMgY2FsbHMgdGhlIGFwcHJvcHJpYXRlIGZ1bmN0aW9uXG4gICAgICogYmFzZWQgb24gdGhlIHZpZXdzIHN0YXRlLiBJZiB0aGUgdmlldyBpcyBhbHJlYWR5IHJlbmRlcmVkIGl0IHdpbGwgcmV0dXJuXG4gICAgICogZmFsc2UuXG4gICAgICogQHBhcmFtIHZpZXdcbiAgICAgKi9cbiAgICByZW5kZXJWaWV3KHZpZXc6IGFueSkge1xuICAgICAgICBsZXQgc3RhdGUgPSB2aWV3LnJlbmRlcmluZ1N0YXRlO1xuICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7XG4gICAgICAgICAgICBjYXNlIHRoaXMucmVuZGVyaW5nU3RhdGVzLkZJTklTSEVEOlxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGNhc2UgdGhpcy5yZW5kZXJpbmdTdGF0ZXMuUEFVU0VEOlxuICAgICAgICAgICAgICAgIHRoaXMuaGlnaGVzdFByaW9yaXR5UGFnZSA9IHZpZXcucmVuZGVyaW5nSWQ7XG4gICAgICAgICAgICAgICAgdmlldy5yZXN1bWUoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgdGhpcy5yZW5kZXJpbmdTdGF0ZXMuUlVOTklORzpcbiAgICAgICAgICAgICAgICB0aGlzLmhpZ2hlc3RQcmlvcml0eVBhZ2UgPSB2aWV3LnJlbmRlcmluZ0lkO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSB0aGlzLnJlbmRlcmluZ1N0YXRlcy5JTklUSUFMOlxuICAgICAgICAgICAgICAgIHRoaXMuaGlnaGVzdFByaW9yaXR5UGFnZSA9IHZpZXcucmVuZGVyaW5nSWQ7XG4gICAgICAgICAgICAgICAgbGV0IGNvbnRpbnVlUmVuZGVyaW5nID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckhpZ2hlc3RQcmlvcml0eSgpO1xuICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2aWV3LmRyYXcoKS50aGVuKGNvbnRpbnVlUmVuZGVyaW5nLCBjb250aW51ZVJlbmRlcmluZyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cbiJdfQ==