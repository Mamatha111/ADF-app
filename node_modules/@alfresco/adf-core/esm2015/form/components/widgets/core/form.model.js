/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector  */
import { FormFieldEvent } from './../../../events/form-field.event';
import { ValidateFormFieldEvent } from './../../../events/validate-form-field.event';
import { ValidateFormEvent } from './../../../events/validate-form.event';
import { ContainerModel } from './container.model';
import { FormFieldTypes } from './form-field-types';
import { FormFieldModel } from './form-field.model';
import { FormOutcomeModel } from './form-outcome.model';
import { TabModel } from './tab.model';
import { FORM_FIELD_VALIDATORS } from './form-field-validator';
export class FormModel {
    /**
     * @param {?=} json
     * @param {?=} formValues
     * @param {?=} readOnly
     * @param {?=} formService
     */
    constructor(json, formValues, readOnly = false, formService) {
        this.formService = formService;
        this.taskName = FormModel.UNSET_TASK_NAME;
        this._isValid = true;
        this.readOnly = false;
        this.tabs = [];
        /**
         * Stores root containers
         */
        this.fields = [];
        this.outcomes = [];
        this.customFieldTemplates = {};
        this.fieldValidators = [...FORM_FIELD_VALIDATORS];
        this.values = {};
        this.readOnly = readOnly;
        if (json) {
            this.json = json;
            this.id = json.id;
            this.name = json.name;
            this.taskId = json.taskId;
            this.taskName = json.taskName || json.name || FormModel.UNSET_TASK_NAME;
            this.processDefinitionId = json.processDefinitionId;
            this.customFieldTemplates = json.customFieldTemplates || {};
            this.selectedOutcome = json.selectedOutcome || {};
            this.className = json.className || '';
            /** @type {?} */
            let tabCache = {};
            this.processVariables = json.processVariables;
            this.tabs = (json.tabs || []).map((t) => {
                /** @type {?} */
                let model = new TabModel(this, t);
                tabCache[model.id] = model;
                return model;
            });
            this.fields = this.parseRootFields(json);
            if (formValues) {
                this.loadData(formValues);
            }
            for (let i = 0; i < this.fields.length; i++) {
                /** @type {?} */
                let field = this.fields[i];
                if (field.tab) {
                    /** @type {?} */
                    let tab = tabCache[field.tab];
                    if (tab) {
                        tab.fields.push(field);
                    }
                }
            }
            if (json.fields) {
                /** @type {?} */
                let saveOutcome = new FormOutcomeModel(this, {
                    id: FormModel.SAVE_OUTCOME,
                    name: 'SAVE',
                    isSystem: true
                });
                /** @type {?} */
                let completeOutcome = new FormOutcomeModel(this, {
                    id: FormModel.COMPLETE_OUTCOME,
                    name: 'COMPLETE',
                    isSystem: true
                });
                /** @type {?} */
                let startProcessOutcome = new FormOutcomeModel(this, {
                    id: FormModel.START_PROCESS_OUTCOME,
                    name: 'START PROCESS',
                    isSystem: true
                });
                /** @type {?} */
                let customOutcomes = (json.outcomes || []).map((obj) => new FormOutcomeModel(this, obj));
                this.outcomes = [saveOutcome].concat(customOutcomes.length > 0 ? customOutcomes : [completeOutcome, startProcessOutcome]);
            }
        }
        this.validateForm();
    }
    /**
     * @return {?}
     */
    get isValid() {
        return this._isValid;
    }
    /**
     * @return {?}
     */
    hasTabs() {
        return this.tabs && this.tabs.length > 0;
    }
    /**
     * @return {?}
     */
    hasFields() {
        return this.fields && this.fields.length > 0;
    }
    /**
     * @return {?}
     */
    hasOutcomes() {
        return this.outcomes && this.outcomes.length > 0;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    onFormFieldChanged(field) {
        this.validateField(field);
        if (this.formService) {
            this.formService.formFieldValueChanged.next(new FormFieldEvent(this, field));
        }
    }
    /**
     * @param {?} fieldId
     * @return {?}
     */
    getFieldById(fieldId) {
        return this.getFormFields().find((field) => field.id === fieldId);
    }
    // TODO: consider evaluating and caching once the form is loaded
    /**
     * @return {?}
     */
    getFormFields() {
        /** @type {?} */
        let formFieldModel = [];
        for (let i = 0; i < this.fields.length; i++) {
            /** @type {?} */
            let field = this.fields[i];
            if (field instanceof ContainerModel) {
                /** @type {?} */
                let container = (/** @type {?} */ (field));
                formFieldModel.push(container.field);
                container.field.columns.forEach((column) => {
                    formFieldModel.push(...column.fields);
                });
            }
        }
        return formFieldModel;
    }
    /**
     * @return {?}
     */
    markAsInvalid() {
        this._isValid = false;
    }
    /**
     * Validates entire form and all form fields.
     *
     * \@memberof FormModel
     * @return {?}
     */
    validateForm() {
        /** @type {?} */
        const validateFormEvent = new ValidateFormEvent(this);
        /** @type {?} */
        let errorsField = [];
        /** @type {?} */
        let fields = this.getFormFields();
        for (let i = 0; i < fields.length; i++) {
            if (!fields[i].validate()) {
                errorsField.push(fields[i]);
            }
        }
        this._isValid = errorsField.length > 0 ? false : true;
        if (this.formService) {
            validateFormEvent.isValid = this._isValid;
            validateFormEvent.errorsField = errorsField;
            this.formService.validateForm.next(validateFormEvent);
        }
    }
    /**
     * Validates a specific form field, triggers form validation.
     *
     * \@memberof FormModel
     * @param {?} field Form field to validate.
     * @return {?}
     */
    validateField(field) {
        if (!field) {
            return;
        }
        /** @type {?} */
        const validateFieldEvent = new ValidateFormFieldEvent(this, field);
        if (this.formService) {
            this.formService.validateFormField.next(validateFieldEvent);
        }
        if (!validateFieldEvent.isValid) {
            this._isValid = false;
            return;
        }
        if (validateFieldEvent.defaultPrevented) {
            return;
        }
        if (!field.validate()) {
            this._isValid = false;
        }
        this.validateForm();
    }
    // Activiti supports 3 types of root fields: container|group|dynamic-table
    /**
     * @private
     * @param {?} json
     * @return {?}
     */
    parseRootFields(json) {
        /** @type {?} */
        let fields = [];
        if (json.fields) {
            fields = json.fields;
        }
        else if (json.formDefinition && json.formDefinition.fields) {
            fields = json.formDefinition.fields;
        }
        /** @type {?} */
        let formWidgetModel = [];
        for (let field of fields) {
            if (field.type === FormFieldTypes.DISPLAY_VALUE) {
                // workaround for dynamic table on a completed/readonly form
                if (field.params) {
                    /** @type {?} */
                    let originalField = field.params['field'];
                    if (originalField.type === FormFieldTypes.DYNAMIC_TABLE) {
                        formWidgetModel.push(new ContainerModel(new FormFieldModel(this, field)));
                    }
                }
            }
            else {
                formWidgetModel.push(new ContainerModel(new FormFieldModel(this, field)));
            }
        }
        return formWidgetModel;
    }
    // Loads external data and overrides field values
    // Typically used when form definition and form data coming from different sources
    /**
     * @private
     * @param {?} formValues
     * @return {?}
     */
    loadData(formValues) {
        for (let field of this.getFormFields()) {
            if (formValues[field.id]) {
                field.json.value = formValues[field.id];
                field.value = field.parseValue(field.json);
            }
        }
    }
}
FormModel.UNSET_TASK_NAME = 'Nameless task';
FormModel.SAVE_OUTCOME = '$save';
FormModel.COMPLETE_OUTCOME = '$complete';
FormModel.START_PROCESS_OUTCOME = '$startProcess';
if (false) {
    /** @type {?} */
    FormModel.UNSET_TASK_NAME;
    /** @type {?} */
    FormModel.SAVE_OUTCOME;
    /** @type {?} */
    FormModel.COMPLETE_OUTCOME;
    /** @type {?} */
    FormModel.START_PROCESS_OUTCOME;
    /** @type {?} */
    FormModel.prototype.id;
    /** @type {?} */
    FormModel.prototype.name;
    /** @type {?} */
    FormModel.prototype.taskId;
    /** @type {?} */
    FormModel.prototype.taskName;
    /** @type {?} */
    FormModel.prototype.processDefinitionId;
    /**
     * @type {?}
     * @private
     */
    FormModel.prototype._isValid;
    /** @type {?} */
    FormModel.prototype.className;
    /** @type {?} */
    FormModel.prototype.readOnly;
    /** @type {?} */
    FormModel.prototype.tabs;
    /**
     * Stores root containers
     * @type {?}
     */
    FormModel.prototype.fields;
    /** @type {?} */
    FormModel.prototype.outcomes;
    /** @type {?} */
    FormModel.prototype.customFieldTemplates;
    /** @type {?} */
    FormModel.prototype.fieldValidators;
    /** @type {?} */
    FormModel.prototype.selectedOutcome;
    /** @type {?} */
    FormModel.prototype.values;
    /** @type {?} */
    FormModel.prototype.processVariables;
    /** @type {?} */
    FormModel.prototype.json;
    /**
     * @type {?}
     * @protected
     */
    FormModel.prototype.formService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29yZS8iLCJzb3VyY2VzIjpbImZvcm0vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvZm9ybS5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFtQkEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZDQUE2QyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBRTFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVuRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR3hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFdkMsT0FBTyxFQUNILHFCQUFxQixFQUV4QixNQUFNLHdCQUF3QixDQUFDO0FBRWhDLE1BQU0sT0FBTyxTQUFTOzs7Ozs7O0lBNkNsQixZQUFZLElBQVUsRUFBRSxVQUF1QixFQUFFLFdBQW9CLEtBQUssRUFBWSxXQUF5QjtRQUF6QixnQkFBVyxHQUFYLFdBQVcsQ0FBYztRQW5DdEcsYUFBUSxHQUFXLFNBQVMsQ0FBQyxlQUFlLENBQUM7UUFFOUMsYUFBUSxHQUFZLElBQUksQ0FBQztRQU9qQyxhQUFRLEdBQVksS0FBSyxDQUFDO1FBQzFCLFNBQUksR0FBZSxFQUFFLENBQUM7Ozs7UUFFdEIsV0FBTSxHQUFzQixFQUFFLENBQUM7UUFDL0IsYUFBUSxHQUF1QixFQUFFLENBQUM7UUFDbEMseUJBQW9CLEdBQXVCLEVBQUUsQ0FBQztRQUM5QyxvQkFBZSxHQUF5QixD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QyxLQUFLLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDOUM7U0FDSjtJQUNMLENBQUM7O0FBclBNLHlCQUFlLEdBQVcsZUFBZSxDQUFDO0FBQzFDLHNCQUFZLEdBQVcsT0FBTyxDQUFDO0FBQy9CLDBCQUFnQixHQUFXLFdBQVcsQ0FBQztBQUN2QywrQkFBcUIsR0FBVyxlQUFlLENBQUM7OztJQUh2RCwwQkFBaUQ7O0lBQ2pELHVCQUFzQzs7SUFDdEMsMkJBQThDOztJQUM5QyxnQ0FBdUQ7O0lBRXZELHVCQUFvQjs7SUFDcEIseUJBQXNCOztJQUN0QiwyQkFBd0I7O0lBQ3hCLDZCQUFzRDs7SUFDdEQsd0NBQTRCOzs7OztJQUM1Qiw2QkFBaUM7O0lBTWpDLDhCQUFrQjs7SUFDbEIsNkJBQTBCOztJQUMxQix5QkFBc0I7Ozs7O0lBRXRCLDJCQUErQjs7SUFDL0IsNkJBQWtDOztJQUNsQyx5Q0FBOEM7O0lBQzlDLG9DQUFtRTs7SUFDbkUsb0NBQWlDOztJQUVqQywyQkFBd0I7O0lBQ3hCLHFDQUFzQjs7SUFFdEIseUJBQW1COzs7OztJQWN5RCxnQ0FBbUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgICovXG5cbmltcG9ydCB7IEZvcm1GaWVsZEV2ZW50IH0gZnJvbSAnLi8uLi8uLi8uLi9ldmVudHMvZm9ybS1maWVsZC5ldmVudCc7XG5pbXBvcnQgeyBWYWxpZGF0ZUZvcm1GaWVsZEV2ZW50IH0gZnJvbSAnLi8uLi8uLi8uLi9ldmVudHMvdmFsaWRhdGUtZm9ybS1maWVsZC5ldmVudCc7XG5pbXBvcnQgeyBWYWxpZGF0ZUZvcm1FdmVudCB9IGZyb20gJy4vLi4vLi4vLi4vZXZlbnRzL3ZhbGlkYXRlLWZvcm0uZXZlbnQnO1xuaW1wb3J0IHsgRm9ybVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uLy4uL3NlcnZpY2VzL2Zvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBDb250YWluZXJNb2RlbCB9IGZyb20gJy4vY29udGFpbmVyLm1vZGVsJztcbmltcG9ydCB7IEZvcm1GaWVsZFRlbXBsYXRlcyB9IGZyb20gJy4vZm9ybS1maWVsZC10ZW1wbGF0ZXMnO1xuaW1wb3J0IHsgRm9ybUZpZWxkVHlwZXMgfSBmcm9tICcuL2Zvcm0tZmllbGQtdHlwZXMnO1xuaW1wb3J0IHsgRm9ybUZpZWxkTW9kZWwgfSBmcm9tICcuL2Zvcm0tZmllbGQubW9kZWwnO1xuaW1wb3J0IHsgRm9ybU91dGNvbWVNb2RlbCB9IGZyb20gJy4vZm9ybS1vdXRjb21lLm1vZGVsJztcbmltcG9ydCB7IEZvcm1WYWx1ZXMgfSBmcm9tICcuL2Zvcm0tdmFsdWVzJztcbmltcG9ydCB7IEZvcm1XaWRnZXRNb2RlbCwgRm9ybVdpZGdldE1vZGVsQ2FjaGUgfSBmcm9tICcuL2Zvcm0td2lkZ2V0Lm1vZGVsJztcbmltcG9ydCB7IFRhYk1vZGVsIH0gZnJvbSAnLi90YWIubW9kZWwnO1xuXG5pbXBvcnQge1xuICAgIEZPUk1fRklFTERfVkFMSURBVE9SUyxcbiAgICBGb3JtRmllbGRWYWxpZGF0b3Jcbn0gZnJvbSAnLi9mb3JtLWZpZWxkLXZhbGlkYXRvcic7XG5cbmV4cG9ydCBjbGFzcyBGb3JtTW9kZWwge1xuXG4gICAgc3RhdGljIFVOU0VUX1RBU0tfTkFNRTogc3RyaW5nID0gJ05hbWVsZXNzIHRhc2snO1xuICAgIHN0YXRpYyBTQVZFX09VVENPTUU6IHN0cmluZyA9ICckc2F2ZSc7XG4gICAgc3RhdGljIENPTVBMRVRFX09VVENPTUU6IHN0cmluZyA9ICckY29tcGxldGUnO1xuICAgIHN0YXRpYyBTVEFSVF9QUk9DRVNTX09VVENPTUU6IHN0cmluZyA9ICckc3RhcnRQcm9jZXNzJztcblxuICAgIHJlYWRvbmx5IGlkOiBudW1iZXI7XG4gICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHRhc2tJZDogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHRhc2tOYW1lOiBzdHJpbmcgPSBGb3JtTW9kZWwuVU5TRVRfVEFTS19OQU1FO1xuICAgIHByb2Nlc3NEZWZpbml0aW9uSWQ6IHN0cmluZztcbiAgICBwcml2YXRlIF9pc1ZhbGlkOiBib29sZWFuID0gdHJ1ZTtcblxuICAgIGdldCBpc1ZhbGlkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faXNWYWxpZDtcbiAgICB9XG5cbiAgICBjbGFzc05hbWU6IHN0cmluZztcbiAgICByZWFkT25seTogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHRhYnM6IFRhYk1vZGVsW10gPSBbXTtcbiAgICAvKiogU3RvcmVzIHJvb3QgY29udGFpbmVycyAqL1xuICAgIGZpZWxkczogRm9ybVdpZGdldE1vZGVsW10gPSBbXTtcbiAgICBvdXRjb21lczogRm9ybU91dGNvbWVNb2RlbFtdID0gW107XG4gICAgY3VzdG9tRmllbGRUZW1wbGF0ZXM6IEZvcm1GaWVsZFRlbXBsYXRlcyA9IHt9O1xuICAgIGZpZWxkVmFsaWRhdG9yczogRm9ybUZpZWxkVmFsaWRhdG9yW10gPSBbLi4uRk9STV9GSUVMRF9WQUxJREFUT1JTXTtcbiAgICByZWFkb25seSBzZWxlY3RlZE91dGNvbWU6IHN0cmluZztcblxuICAgIHZhbHVlczogRm9ybVZhbHVlcyA9IHt9O1xuICAgIHByb2Nlc3NWYXJpYWJsZXM6IGFueTtcblxuICAgIHJlYWRvbmx5IGpzb246IGFueTtcblxuICAgIGhhc1RhYnMoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRhYnMgJiYgdGhpcy50YWJzLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgaGFzRmllbGRzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5maWVsZHMgJiYgdGhpcy5maWVsZHMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBoYXNPdXRjb21lcygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3V0Y29tZXMgJiYgdGhpcy5vdXRjb21lcy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGpzb24/OiBhbnksIGZvcm1WYWx1ZXM/OiBGb3JtVmFsdWVzLCByZWFkT25seTogYm9vbGVhbiA9IGZhbHNlLCBwcm90ZWN0ZWQgZm9ybVNlcnZpY2U/OiBGb3JtU2VydmljZSkge1xuICAgICAgICB0aGlzLnJlYWRPbmx5ID0gcmVhZE9ubHk7XG5cbiAgICAgICAgaWYgKGpzb24pIHtcbiAgICAgICAgICAgIHRoaXMuanNvbiA9IGpzb247XG5cbiAgICAgICAgICAgIHRoaXMuaWQgPSBqc29uLmlkO1xuICAgICAgICAgICAgdGhpcy5uYW1lID0ganNvbi5uYW1lO1xuICAgICAgICAgICAgdGhpcy50YXNrSWQgPSBqc29uLnRhc2tJZDtcbiAgICAgICAgICAgIHRoaXMudGFza05hbWUgPSBqc29uLnRhc2tOYW1lIHx8IGpzb24ubmFtZSB8fCBGb3JtTW9kZWwuVU5TRVRfVEFTS19OQU1FO1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzRGVmaW5pdGlvbklkID0ganNvbi5wcm9jZXNzRGVmaW5pdGlvbklkO1xuICAgICAgICAgICAgdGhpcy5jdXN0b21GaWVsZFRlbXBsYXRlcyA9IGpzb24uY3VzdG9tRmllbGRUZW1wbGF0ZXMgfHwge307XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkT3V0Y29tZSA9IGpzb24uc2VsZWN0ZWRPdXRjb21lIHx8IHt9O1xuICAgICAgICAgICAgdGhpcy5jbGFzc05hbWUgPSBqc29uLmNsYXNzTmFtZSB8fCAnJztcblxuICAgICAgICAgICAgbGV0IHRhYkNhY2hlOiBGb3JtV2lkZ2V0TW9kZWxDYWNoZTxUYWJNb2RlbD4gPSB7fTtcblxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzVmFyaWFibGVzID0ganNvbi5wcm9jZXNzVmFyaWFibGVzO1xuXG4gICAgICAgICAgICB0aGlzLnRhYnMgPSAoanNvbi50YWJzIHx8IFtdKS5tYXAoKHQpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWwgPSBuZXcgVGFiTW9kZWwodGhpcywgdCk7XG4gICAgICAgICAgICAgICAgdGFiQ2FjaGVbbW9kZWwuaWRdID0gbW9kZWw7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuZmllbGRzID0gdGhpcy5wYXJzZVJvb3RGaWVsZHMoanNvbik7XG5cbiAgICAgICAgICAgIGlmIChmb3JtVmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkRGF0YShmb3JtVmFsdWVzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmZpZWxkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCBmaWVsZCA9IHRoaXMuZmllbGRzW2ldO1xuICAgICAgICAgICAgICAgIGlmIChmaWVsZC50YWIpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRhYiA9IHRhYkNhY2hlW2ZpZWxkLnRhYl07XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YWIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYi5maWVsZHMucHVzaChmaWVsZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChqc29uLmZpZWxkcykge1xuICAgICAgICAgICAgICAgIGxldCBzYXZlT3V0Y29tZSA9IG5ldyBGb3JtT3V0Y29tZU1vZGVsKHRoaXMsIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IEZvcm1Nb2RlbC5TQVZFX09VVENPTUUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdTQVZFJyxcbiAgICAgICAgICAgICAgICAgICAgaXNTeXN0ZW06IHRydWVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBsZXQgY29tcGxldGVPdXRjb21lID0gbmV3IEZvcm1PdXRjb21lTW9kZWwodGhpcywge1xuICAgICAgICAgICAgICAgICAgICBpZDogRm9ybU1vZGVsLkNPTVBMRVRFX09VVENPTUUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdDT01QTEVURScsXG4gICAgICAgICAgICAgICAgICAgIGlzU3lzdGVtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbGV0IHN0YXJ0UHJvY2Vzc091dGNvbWUgPSBuZXcgRm9ybU91dGNvbWVNb2RlbCh0aGlzLCB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBGb3JtTW9kZWwuU1RBUlRfUFJPQ0VTU19PVVRDT01FLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnU1RBUlQgUFJPQ0VTUycsXG4gICAgICAgICAgICAgICAgICAgIGlzU3lzdGVtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgY3VzdG9tT3V0Y29tZXMgPSAoanNvbi5vdXRjb21lcyB8fCBbXSkubWFwKChvYmopID0+IG5ldyBGb3JtT3V0Y29tZU1vZGVsKHRoaXMsIG9iaikpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5vdXRjb21lcyA9IFtzYXZlT3V0Y29tZV0uY29uY2F0KFxuICAgICAgICAgICAgICAgICAgICBjdXN0b21PdXRjb21lcy5sZW5ndGggPiAwID8gY3VzdG9tT3V0Y29tZXMgOiBbY29tcGxldGVPdXRjb21lLCBzdGFydFByb2Nlc3NPdXRjb21lXVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnZhbGlkYXRlRm9ybSgpO1xuICAgIH1cblxuICAgIG9uRm9ybUZpZWxkQ2hhbmdlZChmaWVsZDogRm9ybUZpZWxkTW9kZWwpIHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZUZpZWxkKGZpZWxkKTtcbiAgICAgICAgaWYgKHRoaXMuZm9ybVNlcnZpY2UpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2UuZm9ybUZpZWxkVmFsdWVDaGFuZ2VkLm5leHQobmV3IEZvcm1GaWVsZEV2ZW50KHRoaXMsIGZpZWxkKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRGaWVsZEJ5SWQoZmllbGRJZDogc3RyaW5nKTogRm9ybUZpZWxkTW9kZWwge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRGb3JtRmllbGRzKCkuZmluZCgoZmllbGQpID0+IGZpZWxkLmlkID09PSBmaWVsZElkKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBjb25zaWRlciBldmFsdWF0aW5nIGFuZCBjYWNoaW5nIG9uY2UgdGhlIGZvcm0gaXMgbG9hZGVkXG4gICAgZ2V0Rm9ybUZpZWxkcygpOiBGb3JtRmllbGRNb2RlbFtdIHtcbiAgICAgICAgbGV0IGZvcm1GaWVsZE1vZGVsOiBGb3JtRmllbGRNb2RlbFtdID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmZpZWxkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGZpZWxkID0gdGhpcy5maWVsZHNbaV07XG5cbiAgICAgICAgICAgIGlmIChmaWVsZCBpbnN0YW5jZW9mIENvbnRhaW5lck1vZGVsKSB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbnRhaW5lciA9IDxDb250YWluZXJNb2RlbD4gZmllbGQ7XG4gICAgICAgICAgICAgICAgZm9ybUZpZWxkTW9kZWwucHVzaChjb250YWluZXIuZmllbGQpO1xuXG4gICAgICAgICAgICAgICAgY29udGFpbmVyLmZpZWxkLmNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGZvcm1GaWVsZE1vZGVsLnB1c2goLi4uY29sdW1uLmZpZWxkcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZm9ybUZpZWxkTW9kZWw7XG4gICAgfVxuXG4gICAgbWFya0FzSW52YWxpZCgpIHtcbiAgICAgICAgdGhpcy5faXNWYWxpZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlcyBlbnRpcmUgZm9ybSBhbmQgYWxsIGZvcm0gZmllbGRzLlxuICAgICAqXG4gICAgICogQG1lbWJlcm9mIEZvcm1Nb2RlbFxuICAgICAqL1xuICAgIHZhbGlkYXRlRm9ybSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgdmFsaWRhdGVGb3JtRXZlbnQ6IGFueSA9IG5ldyBWYWxpZGF0ZUZvcm1FdmVudCh0aGlzKTtcblxuICAgICAgICBsZXQgZXJyb3JzRmllbGQ6IEZvcm1GaWVsZE1vZGVsW10gPSBbXTtcblxuICAgICAgICBsZXQgZmllbGRzID0gdGhpcy5nZXRGb3JtRmllbGRzKCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmllbGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAoIWZpZWxkc1tpXS52YWxpZGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgZXJyb3JzRmllbGQucHVzaChmaWVsZHNbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5faXNWYWxpZCA9IGVycm9yc0ZpZWxkLmxlbmd0aCA+IDAgPyBmYWxzZSA6IHRydWU7XG5cbiAgICAgICAgaWYgKHRoaXMuZm9ybVNlcnZpY2UpIHtcbiAgICAgICAgICAgIHZhbGlkYXRlRm9ybUV2ZW50LmlzVmFsaWQgPSB0aGlzLl9pc1ZhbGlkO1xuICAgICAgICAgICAgdmFsaWRhdGVGb3JtRXZlbnQuZXJyb3JzRmllbGQgPSBlcnJvcnNGaWVsZDtcbiAgICAgICAgICAgIHRoaXMuZm9ybVNlcnZpY2UudmFsaWRhdGVGb3JtLm5leHQodmFsaWRhdGVGb3JtRXZlbnQpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgYSBzcGVjaWZpYyBmb3JtIGZpZWxkLCB0cmlnZ2VycyBmb3JtIHZhbGlkYXRpb24uXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmllbGQgRm9ybSBmaWVsZCB0byB2YWxpZGF0ZS5cbiAgICAgKiBAbWVtYmVyb2YgRm9ybU1vZGVsXG4gICAgICovXG4gICAgdmFsaWRhdGVGaWVsZChmaWVsZDogRm9ybUZpZWxkTW9kZWwpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFmaWVsZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdmFsaWRhdGVGaWVsZEV2ZW50ID0gbmV3IFZhbGlkYXRlRm9ybUZpZWxkRXZlbnQodGhpcywgZmllbGQpO1xuXG4gICAgICAgIGlmICh0aGlzLmZvcm1TZXJ2aWNlKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLnZhbGlkYXRlRm9ybUZpZWxkLm5leHQodmFsaWRhdGVGaWVsZEV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdmFsaWRhdGVGaWVsZEV2ZW50LmlzVmFsaWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2lzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWxpZGF0ZUZpZWxkRXZlbnQuZGVmYXVsdFByZXZlbnRlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFmaWVsZC52YWxpZGF0ZSgpKSB7XG4gICAgICAgICAgICB0aGlzLl9pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnZhbGlkYXRlRm9ybSgpO1xuICAgIH1cblxuICAgIC8vIEFjdGl2aXRpIHN1cHBvcnRzIDMgdHlwZXMgb2Ygcm9vdCBmaWVsZHM6IGNvbnRhaW5lcnxncm91cHxkeW5hbWljLXRhYmxlXG4gICAgcHJpdmF0ZSBwYXJzZVJvb3RGaWVsZHMoanNvbjogYW55KTogRm9ybVdpZGdldE1vZGVsW10ge1xuICAgICAgICBsZXQgZmllbGRzID0gW107XG5cbiAgICAgICAgaWYgKGpzb24uZmllbGRzKSB7XG4gICAgICAgICAgICBmaWVsZHMgPSBqc29uLmZpZWxkcztcbiAgICAgICAgfSBlbHNlIGlmIChqc29uLmZvcm1EZWZpbml0aW9uICYmIGpzb24uZm9ybURlZmluaXRpb24uZmllbGRzKSB7XG4gICAgICAgICAgICBmaWVsZHMgPSBqc29uLmZvcm1EZWZpbml0aW9uLmZpZWxkcztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmb3JtV2lkZ2V0TW9kZWw6IEZvcm1XaWRnZXRNb2RlbFtdID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgZmllbGQgb2YgZmllbGRzKSB7XG4gICAgICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gRm9ybUZpZWxkVHlwZXMuRElTUExBWV9WQUxVRSkge1xuICAgICAgICAgICAgICAgIC8vIHdvcmthcm91bmQgZm9yIGR5bmFtaWMgdGFibGUgb24gYSBjb21wbGV0ZWQvcmVhZG9ubHkgZm9ybVxuICAgICAgICAgICAgICAgIGlmIChmaWVsZC5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9yaWdpbmFsRmllbGQgPSBmaWVsZC5wYXJhbXNbJ2ZpZWxkJ107XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbEZpZWxkLnR5cGUgPT09IEZvcm1GaWVsZFR5cGVzLkRZTkFNSUNfVEFCTEUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1XaWRnZXRNb2RlbC5wdXNoKG5ldyBDb250YWluZXJNb2RlbChuZXcgRm9ybUZpZWxkTW9kZWwodGhpcywgZmllbGQpKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvcm1XaWRnZXRNb2RlbC5wdXNoKG5ldyBDb250YWluZXJNb2RlbChuZXcgRm9ybUZpZWxkTW9kZWwodGhpcywgZmllbGQpKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZm9ybVdpZGdldE1vZGVsO1xuICAgIH1cblxuICAgIC8vIExvYWRzIGV4dGVybmFsIGRhdGEgYW5kIG92ZXJyaWRlcyBmaWVsZCB2YWx1ZXNcbiAgICAvLyBUeXBpY2FsbHkgdXNlZCB3aGVuIGZvcm0gZGVmaW5pdGlvbiBhbmQgZm9ybSBkYXRhIGNvbWluZyBmcm9tIGRpZmZlcmVudCBzb3VyY2VzXG4gICAgcHJpdmF0ZSBsb2FkRGF0YShmb3JtVmFsdWVzOiBGb3JtVmFsdWVzKSB7XG4gICAgICAgIGZvciAobGV0IGZpZWxkIG9mIHRoaXMuZ2V0Rm9ybUZpZWxkcygpKSB7XG4gICAgICAgICAgICBpZiAoZm9ybVZhbHVlc1tmaWVsZC5pZF0pIHtcbiAgICAgICAgICAgICAgICBmaWVsZC5qc29uLnZhbHVlID0gZm9ybVZhbHVlc1tmaWVsZC5pZF07XG4gICAgICAgICAgICAgICAgZmllbGQudmFsdWUgPSBmaWVsZC5wYXJzZVZhbHVlKGZpZWxkLmpzb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19