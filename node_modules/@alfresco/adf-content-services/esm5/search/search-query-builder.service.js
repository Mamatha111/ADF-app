/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { AlfrescoApiService, AppConfigService } from '@alfresco/adf-core';
import { RequestSortDefinitionInner } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
var SearchQueryBuilderService = /** @class */ (function () {
    function SearchQueryBuilderService(appConfig, alfrescoApiService) {
        this.appConfig = appConfig;
        this.alfrescoApiService = alfrescoApiService;
        this._userQuery = '';
        this.updated = new Subject();
        this.executed = new Subject();
        this.categories = [];
        this.queryFragments = {};
        this.filterQueries = [];
        this.paging = null;
        this.sorting = [];
        this.userFacetBuckets = {};
        // TODO: to be supported in future iterations
        this.ranges = {};
        this.resetToDefaults();
    }
    Object.defineProperty(SearchQueryBuilderService.prototype, "userQuery", {
        get: /**
         * @return {?}
         */
        function () {
            return this._userQuery;
        },
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            value = (value || '').trim();
            this._userQuery = value ? "(" + value + ")" : '';
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Resets the query to the defaults specified in the app config.
     */
    /**
     * Resets the query to the defaults specified in the app config.
     * @return {?}
     */
    SearchQueryBuilderService.prototype.resetToDefaults = /**
     * Resets the query to the defaults specified in the app config.
     * @return {?}
     */
    function () {
        /** @type {?} */
        var template = this.appConfig.get('search');
        if (template) {
            this.config = JSON.parse(JSON.stringify(template));
            this.categories = (this.config.categories || []).filter(function (category) { return category.enabled; });
            this.filterQueries = this.config.filterQueries || [];
            this.userFacetBuckets = {};
            if (this.config.sorting) {
                this.sorting = this.config.sorting.defaults || [];
            }
        }
    };
    /**
     * Adds a facet bucket to a field.
     * @param field The target field
     * @param bucket Bucket to add
     */
    /**
     * Adds a facet bucket to a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to add
     * @return {?}
     */
    SearchQueryBuilderService.prototype.addUserFacetBucket = /**
     * Adds a facet bucket to a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to add
     * @return {?}
     */
    function (field, bucket) {
        if (field && field.field && bucket) {
            /** @type {?} */
            var buckets = this.userFacetBuckets[field.field] || [];
            /** @type {?} */
            var existing = buckets.find(function (facetBucket) { return facetBucket.label === bucket.label; });
            if (!existing) {
                buckets.push(bucket);
            }
            this.userFacetBuckets[field.field] = buckets;
        }
    };
    /**
     * Gets the buckets currently added to a field
     * @param field The target fields
     * @returns Bucket array
     */
    /**
     * Gets the buckets currently added to a field
     * @param {?} field The target fields
     * @return {?} Bucket array
     */
    SearchQueryBuilderService.prototype.getUserFacetBuckets = /**
     * Gets the buckets currently added to a field
     * @param {?} field The target fields
     * @return {?} Bucket array
     */
    function (field) {
        return this.userFacetBuckets[field] || [];
    };
    /**
     * Removes an existing bucket from a field.
     * @param field The target field
     * @param bucket Bucket to remove
     */
    /**
     * Removes an existing bucket from a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to remove
     * @return {?}
     */
    SearchQueryBuilderService.prototype.removeUserFacetBucket = /**
     * Removes an existing bucket from a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to remove
     * @return {?}
     */
    function (field, bucket) {
        if (field && field.field && bucket) {
            /** @type {?} */
            var buckets = this.userFacetBuckets[field.field] || [];
            this.userFacetBuckets[field.field] = buckets
                .filter(function (facetBucket) { return facetBucket.label !== bucket.label; });
        }
    };
    /**
     * Adds a filter query to the current query.
     * @param query Query string to add
     */
    /**
     * Adds a filter query to the current query.
     * @param {?} query Query string to add
     * @return {?}
     */
    SearchQueryBuilderService.prototype.addFilterQuery = /**
     * Adds a filter query to the current query.
     * @param {?} query Query string to add
     * @return {?}
     */
    function (query) {
        if (query) {
            /** @type {?} */
            var existing = this.filterQueries.find(function (filterQuery) { return filterQuery.query === query; });
            if (!existing) {
                this.filterQueries.push({ query: query });
            }
        }
    };
    /**
     * Removes an existing filter query.
     * @param query The query to remove
     */
    /**
     * Removes an existing filter query.
     * @param {?} query The query to remove
     * @return {?}
     */
    SearchQueryBuilderService.prototype.removeFilterQuery = /**
     * Removes an existing filter query.
     * @param {?} query The query to remove
     * @return {?}
     */
    function (query) {
        if (query) {
            this.filterQueries = this.filterQueries
                .filter(function (filterQuery) { return filterQuery.query !== query; });
        }
    };
    /**
     * Gets a facet query by label.
     * @param label Label of the query
     * @returns Facet query data
     */
    /**
     * Gets a facet query by label.
     * @param {?} label Label of the query
     * @return {?} Facet query data
     */
    SearchQueryBuilderService.prototype.getFacetQuery = /**
     * Gets a facet query by label.
     * @param {?} label Label of the query
     * @return {?} Facet query data
     */
    function (label) {
        if (label && this.hasFacetQueries) {
            /** @type {?} */
            var result = this.config.facetQueries.queries.find(function (query) { return query.label === label; });
            if (result) {
                return tslib_1.__assign({}, result);
            }
        }
        return null;
    };
    /**
     * Gets a facet field by label.
     * @param label Label of the facet field
     * @returns Facet field data
     */
    /**
     * Gets a facet field by label.
     * @param {?} label Label of the facet field
     * @return {?} Facet field data
     */
    SearchQueryBuilderService.prototype.getFacetField = /**
     * Gets a facet field by label.
     * @param {?} label Label of the facet field
     * @return {?} Facet field data
     */
    function (label) {
        if (label) {
            /** @type {?} */
            var fields = this.config.facetFields.fields || [];
            /** @type {?} */
            var result = fields.find(function (field) { return field.label === label; });
            if (result) {
                return tslib_1.__assign({}, result);
            }
        }
        return null;
    };
    /**
     * Builds the current query and triggers the `updated` event.
     */
    /**
     * Builds the current query and triggers the `updated` event.
     * @return {?}
     */
    SearchQueryBuilderService.prototype.update = /**
     * Builds the current query and triggers the `updated` event.
     * @return {?}
     */
    function () {
        /** @type {?} */
        var query = this.buildQuery();
        this.updated.next(query);
    };
    /**
     * Builds and executes the current query.
     * @returns Nothing
     */
    /**
     * Builds and executes the current query.
     * @return {?} Nothing
     */
    SearchQueryBuilderService.prototype.execute = /**
     * Builds and executes the current query.
     * @return {?} Nothing
     */
    function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var query, resultSetPaging;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        query = this.buildQuery();
                        if (!query) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.alfrescoApiService.searchApi.search(query)];
                    case 1:
                        resultSetPaging = _a.sent();
                        this.executed.next(resultSetPaging);
                        _a.label = 2;
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Builds the current query.
     * @returns The finished query
     */
    /**
     * Builds the current query.
     * @return {?} The finished query
     */
    SearchQueryBuilderService.prototype.buildQuery = /**
     * Builds the current query.
     * @return {?} The finished query
     */
    function () {
        /** @type {?} */
        var query = this.getFinalQuery();
        /** @type {?} */
        var include = this.config.include || [];
        if (include.length === 0) {
            include.push('path', 'allowableOperations');
        }
        if (query) {
            /** @type {?} */
            var result = (/** @type {?} */ ({
                query: {
                    query: query,
                    language: 'afts'
                },
                include: include,
                paging: this.paging,
                fields: this.config.fields,
                filterQueries: this.filterQueries,
                facetQueries: this.facetQueries,
                facetFields: this.facetFields,
                sort: this.sort
            }));
            result['facetFormat'] = 'V2';
            return result;
        }
        return null;
    };
    /**
     * Gets the primary sorting definition.
     * @returns The primary sorting definition
     */
    /**
     * Gets the primary sorting definition.
     * @return {?} The primary sorting definition
     */
    SearchQueryBuilderService.prototype.getPrimarySorting = /**
     * Gets the primary sorting definition.
     * @return {?} The primary sorting definition
     */
    function () {
        if (this.sorting && this.sorting.length > 0) {
            return this.sorting[0];
        }
        return null;
    };
    /**
     * Gets all pre-configured sorting options that users can choose from.
     * @returns Pre-configured sorting options
     */
    /**
     * Gets all pre-configured sorting options that users can choose from.
     * @return {?} Pre-configured sorting options
     */
    SearchQueryBuilderService.prototype.getSortingOptions = /**
     * Gets all pre-configured sorting options that users can choose from.
     * @return {?} Pre-configured sorting options
     */
    function () {
        if (this.config && this.config.sorting) {
            return this.config.sorting.options || [];
        }
        return [];
    };
    /**
     * Gets the query group.
     * @param query Target query
     * @returns Query group
     */
    /**
     * Gets the query group.
     * @param {?} query Target query
     * @return {?} Query group
     */
    SearchQueryBuilderService.prototype.getQueryGroup = /**
     * Gets the query group.
     * @param {?} query Target query
     * @return {?} Query group
     */
    function (query) {
        return query.group || this.config.facetQueries.label || 'Facet Queries';
    };
    Object.defineProperty(SearchQueryBuilderService.prototype, "hasFacetQueries", {
        /**
         * Checks if FacetQueries has been defined
         * @returns True if defined, false otherwise
         */
        get: /**
         * Checks if FacetQueries has been defined
         * @return {?} True if defined, false otherwise
         */
        function () {
            if (this.config
                && this.config.facetQueries
                && this.config.facetQueries.queries
                && this.config.facetQueries.queries.length > 0) {
                return true;
            }
            return false;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchQueryBuilderService.prototype, "sort", {
        get: /**
         * @protected
         * @return {?}
         */
        function () {
            return this.sorting.map(function (def) {
                return new RequestSortDefinitionInner({
                    type: def.type,
                    field: def.field,
                    ascending: def.ascending
                });
            });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchQueryBuilderService.prototype, "facetQueries", {
        get: /**
         * @protected
         * @return {?}
         */
        function () {
            var _this = this;
            if (this.hasFacetQueries) {
                return this.config.facetQueries.queries.map(function (query) {
                    query.group = _this.getQueryGroup(query);
                    return (/** @type {?} */ (tslib_1.__assign({}, query)));
                });
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @protected
     * @return {?}
     */
    SearchQueryBuilderService.prototype.getFinalQuery = /**
     * @protected
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var query = '';
        this.categories.forEach(function (facet) {
            /** @type {?} */
            var customQuery = _this.queryFragments[facet.id];
            if (customQuery) {
                if (query.length > 0) {
                    query += ' AND ';
                }
                query += "(" + customQuery + ")";
            }
        });
        /** @type {?} */
        var result = [this.userQuery, query]
            .filter(function (entry) { return entry; })
            .join(' AND ');
        if (this.userFacetBuckets) {
            Object.keys(this.userFacetBuckets).forEach(function (key) {
                /** @type {?} */
                var subQuery = (_this.userFacetBuckets[key] || [])
                    .map(function (bucket) { return bucket.filterQuery; })
                    .join(' OR ');
                if (subQuery) {
                    if (result.length > 0) {
                        result += ' AND ';
                    }
                    result += "(" + subQuery + ")";
                }
            });
        }
        return result;
    };
    Object.defineProperty(SearchQueryBuilderService.prototype, "facetFields", {
        get: /**
         * @protected
         * @return {?}
         */
        function () {
            /** @type {?} */
            var facetFields = this.config.facetFields && this.config.facetFields.fields;
            if (facetFields && facetFields.length > 0) {
                return {
                    facets: facetFields.map(function (facet) { return (/** @type {?} */ ({
                        field: facet.field,
                        mincount: facet.mincount,
                        label: facet.label,
                        limit: facet.limit,
                        offset: facet.offset,
                        prefix: facet.prefix
                    })); })
                };
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    SearchQueryBuilderService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    SearchQueryBuilderService.ctorParameters = function () { return [
        { type: AppConfigService },
        { type: AlfrescoApiService }
    ]; };
    /** @nocollapse */ SearchQueryBuilderService.ngInjectableDef = i0.defineInjectable({ factory: function SearchQueryBuilderService_Factory() { return new SearchQueryBuilderService(i0.inject(i1.AppConfigService), i0.inject(i1.AlfrescoApiService)); }, token: SearchQueryBuilderService, providedIn: "root" });
    return SearchQueryBuilderService;
}());
export { SearchQueryBuilderService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype._userQuery;
    /** @type {?} */
    SearchQueryBuilderService.prototype.updated;
    /** @type {?} */
    SearchQueryBuilderService.prototype.executed;
    /** @type {?} */
    SearchQueryBuilderService.prototype.categories;
    /** @type {?} */
    SearchQueryBuilderService.prototype.queryFragments;
    /** @type {?} */
    SearchQueryBuilderService.prototype.filterQueries;
    /** @type {?} */
    SearchQueryBuilderService.prototype.paging;
    /** @type {?} */
    SearchQueryBuilderService.prototype.sorting;
    /**
     * @type {?}
     * @protected
     */
    SearchQueryBuilderService.prototype.userFacetBuckets;
    /** @type {?} */
    SearchQueryBuilderService.prototype.config;
    /** @type {?} */
    SearchQueryBuilderService.prototype.ranges;
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype.appConfig;
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype.alfrescoApiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXF1ZXJ5LWJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29udGVudC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNlYXJjaC9zZWFyY2gtcXVlcnktYnVpbGRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDMUUsT0FBTyxFQUlILDBCQUEwQixFQUU3QixNQUFNLGtCQUFrQixDQUFDOzs7QUFVMUI7SUFnQ0ksbUNBQW9CLFNBQTJCLEVBQVUsa0JBQXNDO1FBQTNFLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQVUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQTNCdkYsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUV4QixZQUFPLEdBQXVCLElBQUksT0FBTyxFQUFFLENBQUM7UUFDNUMsYUFBUSxHQUE2QixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRW5ELGVBQVUsR0FBMEIsRUFBRSxDQUFDO1FBQ3ZDLG1CQUFjLEdBQTZCLEVBQUUsQ0FBQztRQUM5QyxrQkFBYSxHQUFrQixFQUFFLENBQUM7UUFDbEMsV0FBTSxHQUE4QyxJQUFJLENBQUM7UUFDekQsWUFBTyxHQUFtQyxFQUFFLENBQUM7UUFFbkMscUJBQWdCLEdBQStDLEVBQUUsQ0FBQzs7UUFjNUUsV0FBTSxHQUFrQyxFQUFFLENBQUM7UUFHdkMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFoQkQsc0JBQUksZ0RBQVM7Ozs7UUFBYjtZQUNJLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUMzQixDQUFDOzs7OztRQUVELFVB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Q0gsTUFBTSxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBQyxLQUFLLFdBQUssbUJBQW9CO3dCQUNuRCxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7d0JBQ2xCLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUTt3QkFDeEIsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO3dCQUNsQixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7d0JBQ2xCLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTt3QkFDcEIsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNO3FCQUN2QixFQUFBLEdBQUEsQ0FBQztpQkFDTCxDQUFDO2FBQ0w7WUFFRCxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDOzs7T0FBQTs7Z0JBNVRKLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7Z0JBbkI0QixnQkFBZ0I7Z0JBQXBDLGtCQUFrQjs7O29DQW5CM0I7Q0FpV0MsQUE3VEQsSUE2VEM7U0ExVFkseUJBQXlCOzs7Ozs7SUFFbEMsK0NBQXdCOztJQUV4Qiw0Q0FBNEM7O0lBQzVDLDZDQUFtRDs7SUFFbkQsK0NBQXVDOztJQUN2QyxtREFBOEM7O0lBQzlDLGtEQUFrQzs7SUFDbEMsMkNBQXlEOztJQUN6RCw0Q0FBNkM7Ozs7O0lBRTdDLHFEQUE0RTs7SUFXNUUsMkNBQTRCOztJQUc1QiwyQ0FBMkM7Ozs7O0lBRS9CLDhDQUFtQzs7Ozs7SUFBRSx1REFBOEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UsIEFwcENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHtcbiAgICBRdWVyeUJvZHksXG4gICAgUmVxdWVzdEZhY2V0RmllbGRzLFxuICAgIFJlcXVlc3RGYWNldEZpZWxkLFxuICAgIFJlcXVlc3RTb3J0RGVmaW5pdGlvbklubmVyLFxuICAgIFJlc3VsdFNldFBhZ2luZ1xufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IFNlYXJjaENhdGVnb3J5IH0gZnJvbSAnLi9zZWFyY2gtY2F0ZWdvcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7IEZpbHRlclF1ZXJ5IH0gZnJvbSAnLi9maWx0ZXItcXVlcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7IFNlYXJjaFJhbmdlIH0gZnJvbSAnLi9zZWFyY2gtcmFuZ2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IFNlYXJjaENvbmZpZ3VyYXRpb24gfSBmcm9tICcuL3NlYXJjaC1jb25maWd1cmF0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBGYWNldFF1ZXJ5IH0gZnJvbSAnLi9mYWNldC1xdWVyeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU2VhcmNoU29ydGluZ0RlZmluaXRpb24gfSBmcm9tICcuL3NlYXJjaC1zb3J0aW5nLWRlZmluaXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEZhY2V0RmllbGQgfSBmcm9tICcuL2ZhY2V0LWZpZWxkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBGYWNldEZpZWxkQnVja2V0IH0gZnJvbSAnLi9mYWNldC1maWVsZC1idWNrZXQuaW50ZXJmYWNlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBTZWFyY2hRdWVyeUJ1aWxkZXJTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgX3VzZXJRdWVyeSA9ICcnO1xuXG4gICAgdXBkYXRlZDogU3ViamVjdDxRdWVyeUJvZHk+ID0gbmV3IFN1YmplY3QoKTtcbiAgICBleGVjdXRlZDogU3ViamVjdDxSZXN1bHRTZXRQYWdpbmc+ID0gbmV3IFN1YmplY3QoKTtcblxuICAgIGNhdGVnb3JpZXM6IEFycmF5PFNlYXJjaENhdGVnb3J5PiA9IFtdO1xuICAgIHF1ZXJ5RnJhZ21lbnRzOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcbiAgICBmaWx0ZXJRdWVyaWVzOiBGaWx0ZXJRdWVyeVtdID0gW107XG4gICAgcGFnaW5nOiB7IG1heEl0ZW1zPzogbnVtYmVyOyBza2lwQ291bnQ/OiBudW1iZXIgfSA9IG51bGw7XG4gICAgc29ydGluZzogQXJyYXk8U2VhcmNoU29ydGluZ0RlZmluaXRpb24+ID0gW107XG5cbiAgICBwcm90ZWN0ZWQgdXNlckZhY2V0QnVja2V0czogeyBba2V5OiBzdHJpbmddOiBBcnJheTxGYWNldEZpZWxkQnVja2V0PiB9ID0ge307XG5cbiAgICBnZXQgdXNlclF1ZXJ5KCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl91c2VyUXVlcnk7XG4gICAgfVxuXG4gICAgc2V0IHVzZXJRdWVyeSh2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIHZhbHVlID0gKHZhbHVlIHx8ICcnKS50cmltKCk7XG4gICAgICAgIHRoaXMuX3VzZXJRdWVyeSA9IHZhbHVlID8gYCgke3ZhbHVlfSlgIDogJyc7XG4gICAgfVxuXG4gICAgY29uZmlnOiBTZWFyY2hDb25maWd1cmF0aW9uO1xuXG4gICAgLy8gVE9ETzogdG8gYmUgc3VwcG9ydGVkIGluIGZ1dHVyZSBpdGVyYXRpb25zXG4gICAgcmFuZ2VzOiB7IFtpZDogc3RyaW5nXTogU2VhcmNoUmFuZ2UgfSA9IHt9O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHBDb25maWc6IEFwcENvbmZpZ1NlcnZpY2UsIHByaXZhdGUgYWxmcmVzY29BcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5yZXNldFRvRGVmYXVsdHMoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXNldHMgdGhlIHF1ZXJ5IHRvIHRoZSBkZWZhdWx0cyBzcGVjaWZpZWQgaW4gdGhlIGFwcCBjb25maWcuXG4gICAgICovXG4gICAgcmVzZXRUb0RlZmF1bHRzKCkge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHRoaXMuYXBwQ29uZmlnLmdldDxTZWFyY2hDb25maWd1cmF0aW9uPignc2VhcmNoJyk7XG4gICAgICAgIGlmICh0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgdGhpcy5jb25maWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRlbXBsYXRlKSk7XG4gICAgICAgICAgICB0aGlzLmNhdGVnb3JpZXMgPSAodGhpcy5jb25maWcuY2F0ZWdvcmllcyB8fCBbXSkuZmlsdGVyKChjYXRlZ29yeSkgPT4gY2F0ZWdvcnkuZW5hYmxlZCk7XG4gICAgICAgICAgICB0aGlzLmZpbHRlclF1ZXJpZXMgPSB0aGlzLmNvbmZpZy5maWx0ZXJRdWVyaWVzIHx8IFtdO1xuICAgICAgICAgICAgdGhpcy51c2VyRmFjZXRCdWNrZXRzID0ge307XG4gICAgICAgICAgICBpZiAodGhpcy5jb25maWcuc29ydGluZykge1xuICAgICAgICAgICAgICAgIHRoaXMuc29ydGluZyA9IHRoaXMuY29uZmlnLnNvcnRpbmcuZGVmYXVsdHMgfHwgW107XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgZmFjZXQgYnVja2V0IHRvIGEgZmllbGQuXG4gICAgICogQHBhcmFtIGZpZWxkIFRoZSB0YXJnZXQgZmllbGRcbiAgICAgKiBAcGFyYW0gYnVja2V0IEJ1Y2tldCB0byBhZGRcbiAgICAgKi9cbiAgICBhZGRVc2VyRmFjZXRCdWNrZXQoZmllbGQ6IEZhY2V0RmllbGQsIGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCkge1xuICAgICAgICBpZiAoZmllbGQgJiYgZmllbGQuZmllbGQgJiYgYnVja2V0KSB7XG4gICAgICAgICAgICBjb25zdCBidWNrZXRzID0gdGhpcy51c2VyRmFjZXRCdWNrZXRzW2ZpZWxkLmZpZWxkXSB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYnVja2V0cy5maW5kKChmYWNldEJ1Y2tldCkgPT4gZmFjZXRCdWNrZXQubGFiZWwgPT09IGJ1Y2tldC5sYWJlbCk7XG4gICAgICAgICAgICBpZiAoIWV4aXN0aW5nKSB7XG4gICAgICAgICAgICAgICAgYnVja2V0cy5wdXNoKGJ1Y2tldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnVzZXJGYWNldEJ1Y2tldHNbZmllbGQuZmllbGRdID0gYnVja2V0cztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGJ1Y2tldHMgY3VycmVudGx5IGFkZGVkIHRvIGEgZmllbGRcbiAgICAgKiBAcGFyYW0gZmllbGQgVGhlIHRhcmdldCBmaWVsZHNcbiAgICAgKiBAcmV0dXJucyBCdWNrZXQgYXJyYXlcbiAgICAgKi9cbiAgICBnZXRVc2VyRmFjZXRCdWNrZXRzKGZpZWxkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZF0gfHwgW107XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBhbiBleGlzdGluZyBidWNrZXQgZnJvbSBhIGZpZWxkLlxuICAgICAqIEBwYXJhbSBmaWVsZCBUaGUgdGFyZ2V0IGZpZWxkXG4gICAgICogQHBhcmFtIGJ1Y2tldCBCdWNrZXQgdG8gcmVtb3ZlXG4gICAgICovXG4gICAgcmVtb3ZlVXNlckZhY2V0QnVja2V0KGZpZWxkOiBGYWNldEZpZWxkLCBidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGZpZWxkLmZpZWxkICYmIGJ1Y2tldCkge1xuICAgICAgICAgICAgY29uc3QgYnVja2V0cyA9IHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZC5maWVsZF0gfHwgW107XG4gICAgICAgICAgICB0aGlzLnVzZXJGYWNldEJ1Y2tldHNbZmllbGQuZmllbGRdID0gYnVja2V0c1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGZhY2V0QnVja2V0KSA9PiBmYWNldEJ1Y2tldC5sYWJlbCAhPT0gYnVja2V0LmxhYmVsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBmaWx0ZXIgcXVlcnkgdG8gdGhlIGN1cnJlbnQgcXVlcnkuXG4gICAgICogQHBhcmFtIHF1ZXJ5IFF1ZXJ5IHN0cmluZyB0byBhZGRcbiAgICAgKi9cbiAgICBhZGRGaWx0ZXJRdWVyeShxdWVyeTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLmZpbHRlclF1ZXJpZXMuZmluZCgoZmlsdGVyUXVlcnkpID0+IGZpbHRlclF1ZXJ5LnF1ZXJ5ID09PSBxdWVyeSk7XG4gICAgICAgICAgICBpZiAoIWV4aXN0aW5nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJRdWVyaWVzLnB1c2goeyBxdWVyeTogcXVlcnkgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmVzIGFuIGV4aXN0aW5nIGZpbHRlciBxdWVyeS5cbiAgICAgKiBAcGFyYW0gcXVlcnkgVGhlIHF1ZXJ5IHRvIHJlbW92ZVxuICAgICAqL1xuICAgIHJlbW92ZUZpbHRlclF1ZXJ5KHF1ZXJ5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlclF1ZXJpZXMgPSB0aGlzLmZpbHRlclF1ZXJpZXNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChmaWx0ZXJRdWVyeSkgPT4gZmlsdGVyUXVlcnkucXVlcnkgIT09IHF1ZXJ5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmYWNldCBxdWVyeSBieSBsYWJlbC5cbiAgICAgKiBAcGFyYW0gbGFiZWwgTGFiZWwgb2YgdGhlIHF1ZXJ5XG4gICAgICogQHJldHVybnMgRmFjZXQgcXVlcnkgZGF0YVxuICAgICAqL1xuICAgIGdldEZhY2V0UXVlcnkobGFiZWw6IHN0cmluZyk6IEZhY2V0UXVlcnkge1xuICAgICAgICBpZiAobGFiZWwgJiYgdGhpcy5oYXNGYWNldFF1ZXJpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5xdWVyaWVzLmZpbmQoKHF1ZXJ5KSA9PiBxdWVyeS5sYWJlbCA9PT0gbGFiZWwpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLnJlc3VsdCB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmYWNldCBmaWVsZCBieSBsYWJlbC5cbiAgICAgKiBAcGFyYW0gbGFiZWwgTGFiZWwgb2YgdGhlIGZhY2V0IGZpZWxkXG4gICAgICogQHJldHVybnMgRmFjZXQgZmllbGQgZGF0YVxuICAgICAqL1xuICAgIGdldEZhY2V0RmllbGQobGFiZWw6IHN0cmluZyk6IEZhY2V0RmllbGQge1xuICAgICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkcyA9IHRoaXMuY29uZmlnLmZhY2V0RmllbGRzLmZpZWxkcyB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGQubGFiZWwgPT09IGxhYmVsKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyAuLi5yZXN1bHQgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCdWlsZHMgdGhlIGN1cnJlbnQgcXVlcnkgYW5kIHRyaWdnZXJzIHRoZSBgdXBkYXRlZGAgZXZlbnQuXG4gICAgICovXG4gICAgdXBkYXRlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBxdWVyeSA9IHRoaXMuYnVpbGRRdWVyeSgpO1xuICAgICAgICB0aGlzLnVwZGF0ZWQubmV4dChxdWVyeSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQnVpbGRzIGFuZCBleGVjdXRlcyB0aGUgY3VycmVudCBxdWVyeS5cbiAgICAgKiBAcmV0dXJucyBOb3RoaW5nXG4gICAgICovXG4gICAgYXN5bmMgZXhlY3V0ZSgpIHtcbiAgICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLmJ1aWxkUXVlcnkoKTtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHRTZXRQYWdpbmc6IFJlc3VsdFNldFBhZ2luZyA9IGF3YWl0IHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLnNlYXJjaEFwaS5zZWFyY2gocXVlcnkpO1xuICAgICAgICAgICAgdGhpcy5leGVjdXRlZC5uZXh0KHJlc3VsdFNldFBhZ2luZyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCdWlsZHMgdGhlIGN1cnJlbnQgcXVlcnkuXG4gICAgICogQHJldHVybnMgVGhlIGZpbmlzaGVkIHF1ZXJ5XG4gICAgICovXG4gICAgYnVpbGRRdWVyeSgpOiBRdWVyeUJvZHkge1xuICAgICAgICBsZXQgcXVlcnkgPSB0aGlzLmdldEZpbmFsUXVlcnkoKTtcblxuICAgICAgICBjb25zdCBpbmNsdWRlID0gdGhpcy5jb25maWcuaW5jbHVkZSB8fCBbXTtcbiAgICAgICAgaWYgKGluY2x1ZGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBpbmNsdWRlLnB1c2goJ3BhdGgnLCAnYWxsb3dhYmxlT3BlcmF0aW9ucycpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQ6IFF1ZXJ5Qm9keSA9IDxRdWVyeUJvZHk+IHtcbiAgICAgICAgICAgICAgICBxdWVyeToge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksXG4gICAgICAgICAgICAgICAgICAgIGxhbmd1YWdlOiAnYWZ0cydcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGluY2x1ZGU6IGluY2x1ZGUsXG4gICAgICAgICAgICAgICAgcGFnaW5nOiB0aGlzLnBhZ2luZyxcbiAgICAgICAgICAgICAgICBmaWVsZHM6IHRoaXMuY29uZmlnLmZpZWxkcyxcbiAgICAgICAgICAgICAgICBmaWx0ZXJRdWVyaWVzOiB0aGlzLmZpbHRlclF1ZXJpZXMsXG4gICAgICAgICAgICAgICAgZmFjZXRRdWVyaWVzOiB0aGlzLmZhY2V0UXVlcmllcyxcbiAgICAgICAgICAgICAgICBmYWNldEZpZWxkczogdGhpcy5mYWNldEZpZWxkcyxcbiAgICAgICAgICAgICAgICBzb3J0OiB0aGlzLnNvcnRcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHJlc3VsdFsnZmFjZXRGb3JtYXQnXSA9ICdWMic7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgcHJpbWFyeSBzb3J0aW5nIGRlZmluaXRpb24uXG4gICAgICogQHJldHVybnMgVGhlIHByaW1hcnkgc29ydGluZyBkZWZpbml0aW9uXG4gICAgICovXG4gICAgZ2V0UHJpbWFyeVNvcnRpbmcoKTogU2VhcmNoU29ydGluZ0RlZmluaXRpb24ge1xuICAgICAgICBpZiAodGhpcy5zb3J0aW5nICYmIHRoaXMuc29ydGluZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zb3J0aW5nWzBdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIHByZS1jb25maWd1cmVkIHNvcnRpbmcgb3B0aW9ucyB0aGF0IHVzZXJzIGNhbiBjaG9vc2UgZnJvbS5cbiAgICAgKiBAcmV0dXJucyBQcmUtY29uZmlndXJlZCBzb3J0aW5nIG9wdGlvbnNcbiAgICAgKi9cbiAgICBnZXRTb3J0aW5nT3B0aW9ucygpOiBTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbltdIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLnNvcnRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5zb3J0aW5nLm9wdGlvbnMgfHwgW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHF1ZXJ5IGdyb3VwLlxuICAgICAqIEBwYXJhbSBxdWVyeSBUYXJnZXQgcXVlcnlcbiAgICAgKiBAcmV0dXJucyBRdWVyeSBncm91cFxuICAgICAqL1xuICAgIGdldFF1ZXJ5R3JvdXAocXVlcnkpIHtcbiAgICAgICAgcmV0dXJuIHF1ZXJ5Lmdyb3VwIHx8IHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5sYWJlbCB8fCAnRmFjZXQgUXVlcmllcyc7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIEZhY2V0UXVlcmllcyBoYXMgYmVlbiBkZWZpbmVkXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiBkZWZpbmVkLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBnZXQgaGFzRmFjZXRRdWVyaWVzKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5jb25maWdcbiAgICAgICAgICAgICYmIHRoaXMuY29uZmlnLmZhY2V0UXVlcmllc1xuICAgICAgICAgICAgJiYgdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzLnF1ZXJpZXNcbiAgICAgICAgICAgICYmIHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5xdWVyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IHNvcnQoKTogUmVxdWVzdFNvcnREZWZpbml0aW9uSW5uZXJbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNvcnRpbmcubWFwKChkZWYpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmVxdWVzdFNvcnREZWZpbml0aW9uSW5uZXIoe1xuICAgICAgICAgICAgICAgIHR5cGU6IGRlZi50eXBlLFxuICAgICAgICAgICAgICAgIGZpZWxkOiBkZWYuZmllbGQsXG4gICAgICAgICAgICAgICAgYXNjZW5kaW5nOiBkZWYuYXNjZW5kaW5nXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBmYWNldFF1ZXJpZXMoKTogRmFjZXRRdWVyeVtdIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzRmFjZXRRdWVyaWVzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzLnF1ZXJpZXMubWFwKChxdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHF1ZXJ5Lmdyb3VwID0gdGhpcy5nZXRRdWVyeUdyb3VwKHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gPEZhY2V0UXVlcnk+IHsgLi4ucXVlcnkgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldEZpbmFsUXVlcnkoKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IHF1ZXJ5ID0gJyc7XG5cbiAgICAgICAgdGhpcy5jYXRlZ29yaWVzLmZvckVhY2goKGZhY2V0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjdXN0b21RdWVyeSA9IHRoaXMucXVlcnlGcmFnbWVudHNbZmFjZXQuaWRdO1xuICAgICAgICAgICAgaWYgKGN1c3RvbVF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgaWYgKHF1ZXJ5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnkgKz0gJyBBTkQgJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcXVlcnkgKz0gYCgke2N1c3RvbVF1ZXJ5fSlgO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgcmVzdWx0ID0gW3RoaXMudXNlclF1ZXJ5LCBxdWVyeV1cbiAgICAgICAgICAgIC5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeSlcbiAgICAgICAgICAgIC5qb2luKCcgQU5EICcpO1xuXG4gICAgICAgIGlmICh0aGlzLnVzZXJGYWNldEJ1Y2tldHMpIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMudXNlckZhY2V0QnVja2V0cykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3ViUXVlcnkgPSAodGhpcy51c2VyRmFjZXRCdWNrZXRzW2tleV0gfHwgW10pXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoKGJ1Y2tldCkgPT4gYnVja2V0LmZpbHRlclF1ZXJ5KVxuICAgICAgICAgICAgICAgICAgICAuam9pbignIE9SICcpO1xuICAgICAgICAgICAgICAgIGlmIChzdWJRdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSAnIEFORCAnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSBgKCR7c3ViUXVlcnl9KWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXQgZmFjZXRGaWVsZHMoKTogUmVxdWVzdEZhY2V0RmllbGRzIHtcbiAgICAgICAgY29uc3QgZmFjZXRGaWVsZHMgPSB0aGlzLmNvbmZpZy5mYWNldEZpZWxkcyAmJiB0aGlzLmNvbmZpZy5mYWNldEZpZWxkcy5maWVsZHM7XG5cbiAgICAgICAgaWYgKGZhY2V0RmllbGRzICYmIGZhY2V0RmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgZmFjZXRzOiBmYWNldEZpZWxkcy5tYXAoKGZhY2V0KSA9PiA8UmVxdWVzdEZhY2V0RmllbGQ+IHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGZhY2V0LmZpZWxkLFxuICAgICAgICAgICAgICAgICAgICBtaW5jb3VudDogZmFjZXQubWluY291bnQsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiBmYWNldC5sYWJlbCxcbiAgICAgICAgICAgICAgICAgICAgbGltaXQ6IGZhY2V0LmxpbWl0LFxuICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IGZhY2V0Lm9mZnNldCxcbiAgICAgICAgICAgICAgICAgICAgcHJlZml4OiBmYWNldC5wcmVmaXhcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbn1cbiJdfQ==