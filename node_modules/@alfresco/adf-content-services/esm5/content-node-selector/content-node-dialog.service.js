/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { MatDialog } from '@angular/material';
import { EventEmitter, Injectable, Output } from '@angular/core';
import { ContentService } from '@alfresco/adf-core';
import { Subject, throwError } from 'rxjs';
import { SitesService, TranslationService, AllowableOperationsEnum } from '@alfresco/adf-core';
import { DocumentListService } from '../document-list/services/document-list.service';
import { ContentNodeSelectorComponent } from './content-node-selector.component';
import { NodeLockDialogComponent } from '../dialogs/node-lock.dialog';
import { switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "@alfresco/adf-core";
import * as i3 from "../document-list/services/document-list.service";
var ContentNodeDialogService = /** @class */ (function () {
    function ContentNodeDialogService(dialog, contentService, documentListService, siteService, translation) {
        this.dialog = dialog;
        this.contentService = contentService;
        this.documentListService = documentListService;
        this.siteService = siteService;
        this.translation = translation;
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
    }
    /**
     * Opens a file browser at a chosen folder location.
     * @param folderNodeId ID of the folder to use
     * @returns Information about the selected file(s)
     */
    /**
     * Opens a file browser at a chosen folder location.
     * @param {?} folderNodeId ID of the folder to use
     * @return {?} Information about the selected file(s)
     */
    ContentNodeDialogService.prototype.openFileBrowseDialogByFolderId = /**
     * Opens a file browser at a chosen folder location.
     * @param {?} folderNodeId ID of the folder to use
     * @return {?} Information about the selected file(s)
     */
    function (folderNodeId) {
        var _this = this;
        return this.documentListService.getFolderNode(folderNodeId).pipe(switchMap(function (nodeEntry) {
            return _this.openUploadFileDialog('Choose', nodeEntry.entry);
        }));
    };
    /**
     * Opens a lock node dialog.
     * @param contentEntry Node to lock
     * @returns Error/status message (if any)
     */
    /**
     * Opens a lock node dialog.
     * @param {?} contentEntry Node to lock
     * @return {?} Error/status message (if any)
     */
    ContentNodeDialogService.prototype.openLockNodeDialog = /**
     * Opens a lock node dialog.
     * @param {?} contentEntry Node to lock
     * @return {?} Error/status message (if any)
     */
    function (contentEntry) {
        var _this = this;
        /** @type {?} */
        var observable = new Subject();
        if (this.contentService.hasAllowableOperations(contentEntry, AllowableOperationsEnum.LOCK)) {
            this.dialog.open(NodeLockDialogComponent, {
                data: {
                    node: contentEntry,
                    onError: function (error) {
                        _this.error.emit(error);
                        observable.error(error);
                    }
                },
                width: '400px'
            });
        }
        else {
            observable.error('OPERATION.FAIL.NODE.NO_PERMISSION');
        }
        return observable;
    };
    /**
     * Opens a file browser at a chosen site location.
     * @returns Information about the selected file(s)
     */
    /**
     * Opens a file browser at a chosen site location.
     * @return {?} Information about the selected file(s)
     */
    ContentNodeDialogService.prototype.openFileBrowseDialogBySite = /**
     * Opens a file browser at a chosen site location.
     * @return {?} Information about the selected file(s)
     */
    function () {
        var _this = this;
        return this.siteService.getSites().pipe(switchMap(function (response) {
            return _this.openFileBrowseDialogByFolderId(response.list.entries[0].entry.guid);
        }));
    };
    /**
     * Opens a folder browser at a chosen site location.
     * @returns Information about the selected folder(s)
     */
    /**
     * Opens a folder browser at a chosen site location.
     * @return {?} Information about the selected folder(s)
     */
    ContentNodeDialogService.prototype.openFolderBrowseDialogBySite = /**
     * Opens a folder browser at a chosen site location.
     * @return {?} Information about the selected folder(s)
     */
    function () {
        return this.openFolderBrowseDialogByFolderId('-my-');
    };
    /**
     * Opens a folder browser at a chosen folder location.
     * @param folderNodeId ID of the folder to use
     * @returns Information about the selected folder(s)
     */
    /**
     * Opens a folder browser at a chosen folder location.
     * @param {?} folderNodeId ID of the folder to use
     * @return {?} Information about the selected folder(s)
     */
    ContentNodeDialogService.prototype.openFolderBrowseDialogByFolderId = /**
     * Opens a folder browser at a chosen folder location.
     * @param {?} folderNodeId ID of the folder to use
     * @return {?} Information about the selected folder(s)
     */
    function (folderNodeId) {
        var _this = this;
        return this.documentListService.getFolderNode(folderNodeId).pipe(switchMap(function (node) {
            return _this.openUploadFolderDialog('Choose', node.entry);
        }));
    };
    /**
     * Opens a dialog to copy or move an item to a new location.
     * @param action Name of the action (eg, "Copy" or "Move") to show in the title
     * @param contentEntry Item to be copied or moved
     * @param permission Permission for the operation
     * @param excludeSiteContent The site content that should be filtered out
     * @returns Information about files that were copied/moved
     */
    /**
     * Opens a dialog to copy or move an item to a new location.
     * @param {?} action Name of the action (eg, "Copy" or "Move") to show in the title
     * @param {?} contentEntry Item to be copied or moved
     * @param {?=} permission Permission for the operation
     * @param {?=} excludeSiteContent The site content that should be filtered out
     * @return {?} Information about files that were copied/moved
     */
    ContentNodeDialogService.prototype.openCopyMoveDialog = /**
     * Opens a dialog to copy or move an item to a new location.
     * @param {?} action Name of the action (eg, "Copy" or "Move") to show in the title
     * @param {?} contentEntry Item to be copied or moved
     * @param {?=} permission Permission for the operation
     * @param {?=} excludeSiteContent The site content that should be filtered out
     * @return {?} Information about files that were copied/moved
     */
    function (action, contentEntry, permission, excludeSiteContent) {
        if (this.contentService.hasAllowableOperations(contentEntry, permission)) {
            /** @type {?} */
            var select = new Subject();
            select.subscribe({
                complete: this.close.bind(this)
            });
            /** @type {?} */
            var title = this.getTitleTranslation(action, contentEntry.name);
            /** @type {?} */
            var data = {
                title: title,
                actionName: action,
                currentFolderId: contentEntry.parentId,
                imageResolver: this.imageResolver.bind(this),
                where: '(isFolder=true)',
                isSelectionValid: this.isCopyMoveSelectionValid.bind(this),
                excludeSiteContent: excludeSiteContent || ContentNodeDialogService.nonDocumentSiteContent,
                select: select
            };
            this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
            return select;
        }
        else {
            /** @type {?} */
            var errors = new Error(JSON.stringify({ error: { statusCode: 403 } }));
            return throwError(errors);
        }
    };
    /**
     * Gets the translation of the dialog title.
     * @param action Name of the action to display in the dialog title
     * @param name Name of the item on which the action is being performed
     * @returns Translated version of the title
     */
    /**
     * Gets the translation of the dialog title.
     * @param {?} action Name of the action to display in the dialog title
     * @param {?} name Name of the item on which the action is being performed
     * @return {?} Translated version of the title
     */
    ContentNodeDialogService.prototype.getTitleTranslation = /**
     * Gets the translation of the dialog title.
     * @param {?} action Name of the action to display in the dialog title
     * @param {?} name Name of the item on which the action is being performed
     * @return {?} Translated version of the title
     */
    function (action, name) {
        return this.translation.instant("NODE_SELECTOR." + action.toUpperCase() + "_ITEM", { name: name });
    };
    /**
     * Opens a dialog to choose folders to upload.
     * @param action Name of the action to show in the title
     * @param contentEntry  Item to upload
     * @returns Information about the chosen folder(s)
     */
    /**
     * Opens a dialog to choose folders to upload.
     * @param {?} action Name of the action to show in the title
     * @param {?} contentEntry  Item to upload
     * @return {?} Information about the chosen folder(s)
     */
    ContentNodeDialogService.prototype.openUploadFolderDialog = /**
     * Opens a dialog to choose folders to upload.
     * @param {?} action Name of the action to show in the title
     * @param {?} contentEntry  Item to upload
     * @return {?} Information about the chosen folder(s)
     */
    function (action, contentEntry) {
        /** @type {?} */
        var select = new Subject();
        select.subscribe({
            complete: this.close.bind(this)
        });
        /** @type {?} */
        var data = {
            title: action + " '" + contentEntry.name + "' to ...",
            actionName: action,
            currentFolderId: contentEntry.id,
            imageResolver: this.imageResolver.bind(this),
            isSelectionValid: this.hasAllowableOperationsOnNodeFolder.bind(this),
            where: '(isFolder=true)',
            select: select
        };
        this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
        return select;
    };
    /**
     * Opens a dialog to choose a file to upload.
     * @param action Name of the action to show in the title
     * @param contentEntry Item to upload
     * @returns Information about the chosen file(s)
     */
    /**
     * Opens a dialog to choose a file to upload.
     * @param {?} action Name of the action to show in the title
     * @param {?} contentEntry Item to upload
     * @return {?} Information about the chosen file(s)
     */
    ContentNodeDialogService.prototype.openUploadFileDialog = /**
     * Opens a dialog to choose a file to upload.
     * @param {?} action Name of the action to show in the title
     * @param {?} contentEntry Item to upload
     * @return {?} Information about the chosen file(s)
     */
    function (action, contentEntry) {
        /** @type {?} */
        var select = new Subject();
        select.subscribe({
            complete: this.close.bind(this)
        });
        /** @type {?} */
        var data = {
            title: action + " '" + contentEntry.name + "' to ...",
            actionName: action,
            currentFolderId: contentEntry.id,
            imageResolver: this.imageResolver.bind(this),
            isSelectionValid: this.isNodeFile.bind(this),
            select: select
        };
        this.openContentNodeDialog(data, 'adf-content-node-selector-dialog', '630px');
        return select;
    };
    /**
     * @private
     * @param {?} data
     * @param {?} currentPanelClass
     * @param {?} chosenWidth
     * @return {?}
     */
    ContentNodeDialogService.prototype.openContentNodeDialog = /**
     * @private
     * @param {?} data
     * @param {?} currentPanelClass
     * @param {?} chosenWidth
     * @return {?}
     */
    function (data, currentPanelClass, chosenWidth) {
        this.dialog.open(ContentNodeSelectorComponent, { data: data, panelClass: currentPanelClass, width: chosenWidth });
    };
    /**
     * @private
     * @param {?} row
     * @param {?} col
     * @return {?}
     */
    ContentNodeDialogService.prototype.imageResolver = /**
     * @private
     * @param {?} row
     * @param {?} col
     * @return {?}
     */
    function (row, col) {
        /** @type {?} */
        var entry = row.node.entry;
        if (!this.contentService.hasAllowableOperations(entry, 'create')) {
            return this.documentListService.getMimeTypeIcon('disable/folder');
        }
        return null;
    };
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    ContentNodeDialogService.prototype.isNodeFile = /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    function (entry) {
        return entry.isFile;
    };
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    ContentNodeDialogService.prototype.hasAllowableOperationsOnNodeFolder = /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    function (entry) {
        return this.isNodeFolder(entry) && this.contentService.hasAllowableOperations(entry, 'create');
    };
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    ContentNodeDialogService.prototype.isNodeFolder = /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    function (entry) {
        return entry.isFolder;
    };
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    ContentNodeDialogService.prototype.isCopyMoveSelectionValid = /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    function (entry) {
        return this.hasEntityCreatePermission(entry) && !this.isSite(entry);
    };
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    ContentNodeDialogService.prototype.hasEntityCreatePermission = /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    function (entry) {
        return this.contentService.hasAllowableOperations(entry, 'create');
    };
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    ContentNodeDialogService.prototype.isSite = /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    function (entry) {
        return !!entry.guid || entry.nodeType === 'st:site' || entry.nodeType === 'st:sites';
    };
    /** Closes the currently open dialog. */
    /**
     * Closes the currently open dialog.
     * @return {?}
     */
    ContentNodeDialogService.prototype.close = /**
     * Closes the currently open dialog.
     * @return {?}
     */
    function () {
        this.dialog.closeAll();
    };
    ContentNodeDialogService.nonDocumentSiteContent = [
        'blog',
        'calendar',
        'dataLists',
        'discussions',
        'links',
        'wiki'
    ];
    ContentNodeDialogService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ContentNodeDialogService.ctorParameters = function () { return [
        { type: MatDialog },
        { type: ContentService },
        { type: DocumentListService },
        { type: SitesService },
        { type: TranslationService }
    ]; };
    ContentNodeDialogService.propDecorators = {
        error: [{ type: Output }]
    };
    /** @nocollapse */ ContentNodeDialogService.ngInjectableDef = i0.defineInjectable({ factory: function ContentNodeDialogService_Factory() { return new ContentNodeDialogService(i0.inject(i1.MatDialog), i0.inject(i2.ContentService), i0.inject(i3.DocumentListService), i0.inject(i2.SitesService), i0.inject(i2.TranslationService)); }, token: ContentNodeDialogService, providedIn: "root" });
    return ContentNodeDialogService;
}());
export { ContentNodeDialogService };
if (false) {
    /** @type {?} */
    ContentNodeDialogService.nonDocumentSiteContent;
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    ContentNodeDialogService.prototype.error;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.dialog;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.contentService;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.documentListService;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.siteService;
    /**
     * @type {?}
     * @private
     */
    ContentNodeDialogService.prototype.translation;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1ub2RlLWRpYWxvZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1jb250ZW50LXNlcnZpY2VzLyIsInNvdXJjZXMiOlsiY29udGVudC1ub2RlLXNlbGVjdG9yL2NvbnRlbnQtbm9kZS1kaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUd2RCxPQUFPLEVBQWMsWUFBWSxFQUFFLGtCQUFrQixFQUFFLHVCQUF1QixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDM0csT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0saURBQWlELENBQUM7QUFDdEYsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFakYsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDdEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQUUzQztJQWlCSSxrQ0FBb0IsTUFBaUIsRUFDakIsY0FBOEIsRUFDOUIsbUJBQXdDLEVBQ3hDLFdBQXlCLEVBQ3pCLFdBQStCO1FBSi9CLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDakIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsZ0JBQVcsR0FBWCxXQUFXLENBQWM7UUFDekIsZ0JBQVcsR0FBWCxXQUFXLENBQW9COzs7O1FBTm5ELFVBQUssR0FBc0IsSUFB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LENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEUsQ0FBQzs7Ozs7O0lBRU8sNERBQXlCOzs7OztJQUFqQyxVQUFrQyxLQUFXO1FBQ3pDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDdkUsQ0FBQzs7Ozs7O0lBRU8seUNBQU07Ozs7O0lBQWQsVUFBZSxLQUFLO1FBQ2hCLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLFFBQVEsS0FBSyxTQUFTLElBQUksS0FBSyxDQUFDLFFBQVEsS0FBSyxVQUFVLENBQUM7SUFDekYsQ0FBQztJQUVELHdDQUF3Qzs7Ozs7SUFDeEMsd0NBQUs7Ozs7SUFBTDtRQUNJLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQWpPTSwrQ0FBc0IsR0FBRztRQUM1QixNQUFNO1FBQ04sVUFBVTtRQUNWLFdBQVc7UUFDWCxhQUFhO1FBQ2IsT0FBTztRQUNQLE1BQU07S0FDVCxDQUFDOztnQkFYTCxVQUFVLFNBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCOzs7O2dCQWZRLFNBQVM7Z0JBRVQsY0FBYztnQkFLZCxtQkFBbUI7Z0JBRFAsWUFBWTtnQkFBRSxrQkFBa0I7Ozt3QkFxQmhELE1BQU07OzttQ0E1Q1g7Q0FxUUMsQUF2T0QsSUF1T0M7U0FwT1ksd0JBQXdCOzs7SUFDakMsZ0RBT0U7Ozs7O0lBR0YseUNBQ21EOzs7OztJQUV2QywwQ0FBeUI7Ozs7O0lBQ3pCLGtEQUFzQzs7Ozs7SUFDdEMsdURBQWdEOzs7OztJQUNoRCwrQ0FBaUM7Ozs7O0lBQ2pDLCtDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IE1hdERpYWxvZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciwgSW5qZWN0YWJsZSwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb250ZW50U2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBTaGFyZURhdGFSb3cgfSBmcm9tICcuLi9kb2N1bWVudC1saXN0L2RhdGEvc2hhcmUtZGF0YS1yb3cubW9kZWwnO1xuaW1wb3J0IHsgTm9kZSwgTm9kZUVudHJ5LCBTaXRlUGFnaW5nIH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBEYXRhQ29sdW1uLCBTaXRlc1NlcnZpY2UsIFRyYW5zbGF0aW9uU2VydmljZSwgQWxsb3dhYmxlT3BlcmF0aW9uc0VudW0gfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgRG9jdW1lbnRMaXN0U2VydmljZSB9IGZyb20gJy4uL2RvY3VtZW50LWxpc3Qvc2VydmljZXMvZG9jdW1lbnQtbGlzdC5zZXJ2aWNlJztcbmltcG9ydCB7IENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICcuL2NvbnRlbnQtbm9kZS1zZWxlY3Rvci5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29udGVudE5vZGVTZWxlY3RvckNvbXBvbmVudERhdGEgfSBmcm9tICcuL2NvbnRlbnQtbm9kZS1zZWxlY3Rvci5jb21wb25lbnQtZGF0YS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgTm9kZUxvY2tEaWFsb2dDb21wb25lbnQgfSBmcm9tICcuLi9kaWFsb2dzL25vZGUtbG9jay5kaWFsb2cnO1xuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENvbnRlbnROb2RlRGlhbG9nU2VydmljZSB7XG4gICAgc3RhdGljIG5vbkRvY3VtZW50U2l0ZUNvbnRlbnQgPSBbXG4gICAgICAgICdibG9nJyxcbiAgICAgICAgJ2NhbGVuZGFyJyxcbiAgICAgICAgJ2RhdGFMaXN0cycsXG4gICAgICAgICdkaXNjdXNzaW9ucycsXG4gICAgICAgICdsaW5rcycsXG4gICAgICAgICd3aWtpJ1xuICAgIF07XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3Vycy4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBlcnJvcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZGlhbG9nOiBNYXREaWFsb2csXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb250ZW50U2VydmljZTogQ29udGVudFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkb2N1bWVudExpc3RTZXJ2aWNlOiBEb2N1bWVudExpc3RTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgc2l0ZVNlcnZpY2U6IFNpdGVzU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcGVucyBhIGZpbGUgYnJvd3NlciBhdCBhIGNob3NlbiBmb2xkZXIgbG9jYXRpb24uXG4gICAgICogQHBhcmFtIGZvbGRlck5vZGVJZCBJRCBvZiB0aGUgZm9sZGVyIHRvIHVzZVxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIGFib3V0IHRoZSBzZWxlY3RlZCBmaWxlKHMpXG4gICAgICovXG4gICAgb3BlbkZpbGVCcm93c2VEaWFsb2dCeUZvbGRlcklkKGZvbGRlck5vZGVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxOb2RlW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRMaXN0U2VydmljZS5nZXRGb2xkZXJOb2RlKGZvbGRlck5vZGVJZCkucGlwZShzd2l0Y2hNYXAoKG5vZGVFbnRyeTogTm9kZUVudHJ5KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcGVuVXBsb2FkRmlsZURpYWxvZygnQ2hvb3NlJywgbm9kZUVudHJ5LmVudHJ5KTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgbG9jayBub2RlIGRpYWxvZy5cbiAgICAgKiBAcGFyYW0gY29udGVudEVudHJ5IE5vZGUgdG8gbG9ja1xuICAgICAqIEByZXR1cm5zIEVycm9yL3N0YXR1cyBtZXNzYWdlIChpZiBhbnkpXG4gICAgICovXG4gICAgcHVibGljIG9wZW5Mb2NrTm9kZURpYWxvZyhjb250ZW50RW50cnk6IE5vZGUpOiBTdWJqZWN0PHN0cmluZz4ge1xuICAgICAgICBjb25zdCBvYnNlcnZhYmxlOiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XG5cbiAgICAgICAgaWYgKHRoaXMuY29udGVudFNlcnZpY2UuaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyhjb250ZW50RW50cnksIEFsbG93YWJsZU9wZXJhdGlvbnNFbnVtLkxPQ0spKSB7XG4gICAgICAgICAgICB0aGlzLmRpYWxvZy5vcGVuKE5vZGVMb2NrRGlhbG9nQ29tcG9uZW50LCB7XG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICBub2RlOiBjb250ZW50RW50cnksXG4gICAgICAgICAgICAgICAgICAgIG9uRXJyb3I6IChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmFibGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB3aWR0aDogJzQwMHB4J1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvYnNlcnZhYmxlLmVycm9yKCdPUEVSQVRJT04uRkFJTC5OT0RFLk5PX1BFUk1JU1NJT04nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvYnNlcnZhYmxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZmlsZSBicm93c2VyIGF0IGEgY2hvc2VuIHNpdGUgbG9jYXRpb24uXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlbGVjdGVkIGZpbGUocylcbiAgICAgKi9cbiAgICBvcGVuRmlsZUJyb3dzZURpYWxvZ0J5U2l0ZSgpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zaXRlU2VydmljZS5nZXRTaXRlcygpLnBpcGUoc3dpdGNoTWFwKChyZXNwb25zZTogU2l0ZVBhZ2luZykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3BlbkZpbGVCcm93c2VEaWFsb2dCeUZvbGRlcklkKHJlc3BvbnNlLmxpc3QuZW50cmllc1swXS5lbnRyeS5ndWlkKTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZm9sZGVyIGJyb3dzZXIgYXQgYSBjaG9zZW4gc2l0ZSBsb2NhdGlvbi5cbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VsZWN0ZWQgZm9sZGVyKHMpXG4gICAgICovXG4gICAgb3BlbkZvbGRlckJyb3dzZURpYWxvZ0J5U2l0ZSgpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5vcGVuRm9sZGVyQnJvd3NlRGlhbG9nQnlGb2xkZXJJZCgnLW15LScpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZm9sZGVyIGJyb3dzZXIgYXQgYSBjaG9zZW4gZm9sZGVyIGxvY2F0aW9uLlxuICAgICAqIEBwYXJhbSBmb2xkZXJOb2RlSWQgSUQgb2YgdGhlIGZvbGRlciB0byB1c2VcbiAgICAgKiBAcmV0dXJucyBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VsZWN0ZWQgZm9sZGVyKHMpXG4gICAgICovXG4gICAgb3BlbkZvbGRlckJyb3dzZURpYWxvZ0J5Rm9sZGVySWQoZm9sZGVyTm9kZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudExpc3RTZXJ2aWNlLmdldEZvbGRlck5vZGUoZm9sZGVyTm9kZUlkKS5waXBlKHN3aXRjaE1hcCgobm9kZTogTm9kZUVudHJ5KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcGVuVXBsb2FkRm9sZGVyRGlhbG9nKCdDaG9vc2UnLCBub2RlLmVudHJ5KTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZGlhbG9nIHRvIGNvcHkgb3IgbW92ZSBhbiBpdGVtIHRvIGEgbmV3IGxvY2F0aW9uLlxuICAgICAqIEBwYXJhbSBhY3Rpb24gTmFtZSBvZiB0aGUgYWN0aW9uIChlZywgXCJDb3B5XCIgb3IgXCJNb3ZlXCIpIHRvIHNob3cgaW4gdGhlIHRpdGxlXG4gICAgICogQHBhcmFtIGNvbnRlbnRFbnRyeSBJdGVtIHRvIGJlIGNvcGllZCBvciBtb3ZlZFxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9uIFBlcm1pc3Npb24gZm9yIHRoZSBvcGVyYXRpb25cbiAgICAgKiBAcGFyYW0gZXhjbHVkZVNpdGVDb250ZW50IFRoZSBzaXRlIGNvbnRlbnQgdGhhdCBzaG91bGQgYmUgZmlsdGVyZWQgb3V0XG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgZmlsZXMgdGhhdCB3ZXJlIGNvcGllZC9tb3ZlZFxuICAgICAqL1xuICAgIG9wZW5Db3B5TW92ZURpYWxvZyhhY3Rpb246IHN0cmluZywgY29udGVudEVudHJ5OiBOb2RlLCBwZXJtaXNzaW9uPzogc3RyaW5nLCBleGNsdWRlU2l0ZUNvbnRlbnQ/OiBzdHJpbmdbXSk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnRTZXJ2aWNlLmhhc0FsbG93YWJsZU9wZXJhdGlvbnMoY29udGVudEVudHJ5LCBwZXJtaXNzaW9uKSkge1xuXG4gICAgICAgICAgICBjb25zdCBzZWxlY3QgPSBuZXcgU3ViamVjdDxOb2RlW10+KCk7XG4gICAgICAgICAgICBzZWxlY3Quc3Vic2NyaWJlKHtcbiAgICAgICAgICAgICAgICBjb21wbGV0ZTogdGhpcy5jbG9zZS5iaW5kKHRoaXMpXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgdGl0bGUgPSB0aGlzLmdldFRpdGxlVHJhbnNsYXRpb24oYWN0aW9uLCBjb250ZW50RW50cnkubmFtZSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGRhdGE6IENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnREYXRhID0ge1xuICAgICAgICAgICAgICAgIHRpdGxlOiB0aXRsZSxcbiAgICAgICAgICAgICAgICBhY3Rpb25OYW1lOiBhY3Rpb24sXG4gICAgICAgICAgICAgICAgY3VycmVudEZvbGRlcklkOiBjb250ZW50RW50cnkucGFyZW50SWQsXG4gICAgICAgICAgICAgICAgaW1hZ2VSZXNvbHZlcjogdGhpcy5pbWFnZVJlc29sdmVyLmJpbmQodGhpcyksXG4gICAgICAgICAgICAgICAgd2hlcmU6ICcoaXNGb2xkZXI9dHJ1ZSknLFxuICAgICAgICAgICAgICAgIGlzU2VsZWN0aW9uVmFsaWQ6IHRoaXMuaXNDb3B5TW92ZVNlbGVjdGlvblZhbGlkLmJpbmQodGhpcyksXG4gICAgICAgICAgICAgICAgZXhjbHVkZVNpdGVDb250ZW50OiBleGNsdWRlU2l0ZUNvbnRlbnQgfHwgQ29udGVudE5vZGVEaWFsb2dTZXJ2aWNlLm5vbkRvY3VtZW50U2l0ZUNvbnRlbnQsXG4gICAgICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3RcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRoaXMub3BlbkNvbnRlbnROb2RlRGlhbG9nKGRhdGEsICdhZGYtY29udGVudC1ub2RlLXNlbGVjdG9yLWRpYWxvZycsICc2MzBweCcpO1xuXG4gICAgICAgICAgICByZXR1cm4gc2VsZWN0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IGVycm9ycyA9IG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeSh7IGVycm9yOiB7IHN0YXR1c0NvZGU6IDQwMyB9IH0pKTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9ycyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSB0cmFuc2xhdGlvbiBvZiB0aGUgZGlhbG9nIHRpdGxlLlxuICAgICAqIEBwYXJhbSBhY3Rpb24gTmFtZSBvZiB0aGUgYWN0aW9uIHRvIGRpc3BsYXkgaW4gdGhlIGRpYWxvZyB0aXRsZVxuICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgb2YgdGhlIGl0ZW0gb24gd2hpY2ggdGhlIGFjdGlvbiBpcyBiZWluZyBwZXJmb3JtZWRcbiAgICAgKiBAcmV0dXJucyBUcmFuc2xhdGVkIHZlcnNpb24gb2YgdGhlIHRpdGxlXG4gICAgICovXG4gICAgZ2V0VGl0bGVUcmFuc2xhdGlvbihhY3Rpb246IHN0cmluZywgbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb24uaW5zdGFudChgTk9ERV9TRUxFQ1RPUi4ke2FjdGlvbi50b1VwcGVyQ2FzZSgpfV9JVEVNYCwgeyBuYW1lIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9wZW5zIGEgZGlhbG9nIHRvIGNob29zZSBmb2xkZXJzIHRvIHVwbG9hZC5cbiAgICAgKiBAcGFyYW0gYWN0aW9uIE5hbWUgb2YgdGhlIGFjdGlvbiB0byBzaG93IGluIHRoZSB0aXRsZVxuICAgICAqIEBwYXJhbSBjb250ZW50RW50cnkgIEl0ZW0gdG8gdXBsb2FkXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIGNob3NlbiBmb2xkZXIocylcbiAgICAgKi9cbiAgICBvcGVuVXBsb2FkRm9sZGVyRGlhbG9nKGFjdGlvbjogc3RyaW5nLCBjb250ZW50RW50cnk6IE5vZGUpOiBPYnNlcnZhYmxlPE5vZGVbXT4ge1xuICAgICAgICBjb25zdCBzZWxlY3QgPSBuZXcgU3ViamVjdDxOb2RlW10+KCk7XG4gICAgICAgIHNlbGVjdC5zdWJzY3JpYmUoe1xuICAgICAgICAgICAgY29tcGxldGU6IHRoaXMuY2xvc2UuYmluZCh0aGlzKVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkYXRhOiBDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50RGF0YSA9IHtcbiAgICAgICAgICAgIHRpdGxlOiBgJHthY3Rpb259ICcke2NvbnRlbnRFbnRyeS5uYW1lfScgdG8gLi4uYCxcbiAgICAgICAgICAgIGFjdGlvbk5hbWU6IGFjdGlvbixcbiAgICAgICAgICAgIGN1cnJlbnRGb2xkZXJJZDogY29udGVudEVudHJ5LmlkLFxuICAgICAgICAgICAgaW1hZ2VSZXNvbHZlcjogdGhpcy5pbWFnZVJlc29sdmVyLmJpbmQodGhpcyksXG4gICAgICAgICAgICBpc1NlbGVjdGlvblZhbGlkOiB0aGlzLmhhc0FsbG93YWJsZU9wZXJhdGlvbnNPbk5vZGVGb2xkZXIuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIHdoZXJlOiAnKGlzRm9sZGVyPXRydWUpJyxcbiAgICAgICAgICAgIHNlbGVjdDogc2VsZWN0XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5vcGVuQ29udGVudE5vZGVEaWFsb2coZGF0YSwgJ2FkZi1jb250ZW50LW5vZGUtc2VsZWN0b3ItZGlhbG9nJywgJzYzMHB4Jyk7XG4gICAgICAgIHJldHVybiBzZWxlY3Q7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBkaWFsb2cgdG8gY2hvb3NlIGEgZmlsZSB0byB1cGxvYWQuXG4gICAgICogQHBhcmFtIGFjdGlvbiBOYW1lIG9mIHRoZSBhY3Rpb24gdG8gc2hvdyBpbiB0aGUgdGl0bGVcbiAgICAgKiBAcGFyYW0gY29udGVudEVudHJ5IEl0ZW0gdG8gdXBsb2FkXG4gICAgICogQHJldHVybnMgSW5mb3JtYXRpb24gYWJvdXQgdGhlIGNob3NlbiBmaWxlKHMpXG4gICAgICovXG4gICAgb3BlblVwbG9hZEZpbGVEaWFsb2coYWN0aW9uOiBzdHJpbmcsIGNvbnRlbnRFbnRyeTogTm9kZSk6IE9ic2VydmFibGU8Tm9kZVtdPiB7XG4gICAgICAgIGNvbnN0IHNlbGVjdCA9IG5ldyBTdWJqZWN0PE5vZGVbXT4oKTtcbiAgICAgICAgc2VsZWN0LnN1YnNjcmliZSh7XG4gICAgICAgICAgICBjb21wbGV0ZTogdGhpcy5jbG9zZS5iaW5kKHRoaXMpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGRhdGE6IENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnREYXRhID0ge1xuICAgICAgICAgICAgdGl0bGU6IGAke2FjdGlvbn0gJyR7Y29udGVudEVudHJ5Lm5hbWV9JyB0byAuLi5gLFxuICAgICAgICAgICAgYWN0aW9uTmFtZTogYWN0aW9uLFxuICAgICAgICAgICAgY3VycmVudEZvbGRlcklkOiBjb250ZW50RW50cnkuaWQsXG4gICAgICAgICAgICBpbWFnZVJlc29sdmVyOiB0aGlzLmltYWdlUmVzb2x2ZXIuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIGlzU2VsZWN0aW9uVmFsaWQ6IHRoaXMuaXNOb2RlRmlsZS5iaW5kKHRoaXMpLFxuICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3RcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLm9wZW5Db250ZW50Tm9kZURpYWxvZyhkYXRhLCAnYWRmLWNvbnRlbnQtbm9kZS1zZWxlY3Rvci1kaWFsb2cnLCAnNjMwcHgnKTtcbiAgICAgICAgcmV0dXJuIHNlbGVjdDtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5Db250ZW50Tm9kZURpYWxvZyhkYXRhOiBDb250ZW50Tm9kZVNlbGVjdG9yQ29tcG9uZW50RGF0YSwgY3VycmVudFBhbmVsQ2xhc3M6IHN0cmluZywgY2hvc2VuV2lkdGg6IHN0cmluZykge1xuICAgICAgICB0aGlzLmRpYWxvZy5vcGVuKENvbnRlbnROb2RlU2VsZWN0b3JDb21wb25lbnQsIHsgZGF0YSwgcGFuZWxDbGFzczogY3VycmVudFBhbmVsQ2xhc3MsIHdpZHRoOiBjaG9zZW5XaWR0aCB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGltYWdlUmVzb2x2ZXIocm93OiBTaGFyZURhdGFSb3csIGNvbDogRGF0YUNvbHVtbik6IHN0cmluZyB8IG51bGwge1xuICAgICAgICBjb25zdCBlbnRyeTogTm9kZSA9IHJvdy5ub2RlLmVudHJ5O1xuICAgICAgICBpZiAoIXRoaXMuY29udGVudFNlcnZpY2UuaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyhlbnRyeSwgJ2NyZWF0ZScpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudExpc3RTZXJ2aWNlLmdldE1pbWVUeXBlSWNvbignZGlzYWJsZS9mb2xkZXInKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNOb2RlRmlsZShlbnRyeTogTm9kZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZW50cnkuaXNGaWxlO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzQWxsb3dhYmxlT3BlcmF0aW9uc09uTm9kZUZvbGRlcihlbnRyeTogTm9kZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pc05vZGVGb2xkZXIoZW50cnkpICYmIHRoaXMuY29udGVudFNlcnZpY2UuaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyhlbnRyeSwgJ2NyZWF0ZScpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNOb2RlRm9sZGVyKGVudHJ5OiBOb2RlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBlbnRyeS5pc0ZvbGRlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzQ29weU1vdmVTZWxlY3Rpb25WYWxpZChlbnRyeTogTm9kZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNFbnRpdHlDcmVhdGVQZXJtaXNzaW9uKGVudHJ5KSAmJiAhdGhpcy5pc1NpdGUoZW50cnkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzRW50aXR5Q3JlYXRlUGVybWlzc2lvbihlbnRyeTogTm9kZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50U2VydmljZS5oYXNBbGxvd2FibGVPcGVyYXRpb25zKGVudHJ5LCAnY3JlYXRlJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1NpdGUoZW50cnkpIHtcbiAgICAgICAgcmV0dXJuICEhZW50cnkuZ3VpZCB8fCBlbnRyeS5ub2RlVHlwZSA9PT0gJ3N0OnNpdGUnIHx8IGVudHJ5Lm5vZGVUeXBlID09PSAnc3Q6c2l0ZXMnO1xuICAgIH1cblxuICAgIC8qKiBDbG9zZXMgdGhlIGN1cnJlbnRseSBvcGVuIGRpYWxvZy4gKi9cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5kaWFsb2cuY2xvc2VBbGwoKTtcbiAgICB9XG5cbn1cbiJdfQ==