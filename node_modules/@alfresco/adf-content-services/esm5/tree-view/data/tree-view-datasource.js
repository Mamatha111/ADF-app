/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { BehaviorSubject, merge } from 'rxjs';
import { map } from 'rxjs/operators';
import { FlatTreeControl } from '@angular/cdk/tree';
import { TreeViewService } from '../services/tree-view.service';
var TreeViewDataSource = /** @class */ (function () {
    function TreeViewDataSource(treeControl, treeViewService) {
        var _this = this;
        this.treeControl = treeControl;
        this.treeViewService = treeViewService;
        this.dataChange = new BehaviorSubject([]);
        this.childrenSubscription = null;
        this.changeSubscription = null;
        this.dataChange.subscribe(function (treeNodes) { return _this.treeNodes = treeNodes; });
    }
    Object.defineProperty(TreeViewDataSource.prototype, "data", {
        get: /**
         * @return {?}
         */
        function () {
            return this.treeNodes;
        },
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            this.treeControl.dataNodes = value;
            this.dataChange.next(value);
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} collectionViewer
     * @return {?}
     */
    TreeViewDataSource.prototype.connect = /**
     * @param {?} collectionViewer
     * @return {?}
     */
    function (collectionViewer) {
        var _this = this;
        this.changeSubscription = this.treeControl.expansionModel.onChange.subscribe(function (change) {
            if (((/** @type {?} */ (change))).added &&
                ((/** @type {?} */ (change))).added.length > 0) {
                _this.expandTreeNodes((/** @type {?} */ (change)));
            }
            else if (((/** @type {?} */ (change))).removed) {
                _this.reduceTreeNodes((/** @type {?} */ (change)));
            }
        });
        return merge(collectionViewer.viewChange, this.dataChange).pipe(map(function () { return _this.data; }));
    };
    /**
     * @return {?}
     */
    TreeViewDataSource.prototype.disconnect = /**
     * @return {?}
     */
    function () {
        if (this.childrenSubscription) {
            this.childrenSubscription.unsubscribe();
        }
        if (this.changeSubscription) {
            this.changeSubscription.unsubscribe();
        }
    };
    /**
     * @private
     * @param {?} change
     * @return {?}
     */
    TreeViewDataSource.prototype.expandTreeNodes = /**
     * @private
     * @param {?} change
     * @return {?}
     */
    function (change) {
        var _this = this;
        change.added.forEach(function (node) { return _this.expandNode(node); });
    };
    /**
     * @private
     * @param {?} change
     * @return {?}
     */
    TreeViewDataSource.prototype.reduceTreeNodes = /**
     * @private
     * @param {?} change
     * @return {?}
     */
    function (change) {
        var _this = this;
        change.removed.slice().reverse().forEach(function (node) { return _this.toggleNode(node); });
    };
    /**
     * @private
     * @param {?} node
     * @return {?}
     */
    TreeViewDataSource.prototype.expandNode = /**
     * @private
     * @param {?} node
     * @return {?}
     */
    function (node) {
        var _this = this;
        this.childrenSubscription = this.treeViewService.getTreeNodes(node.nodeId)
            .subscribe(function (children) {
            var _a;
            /** @type {?} */
            var index = _this.data.indexOf(node);
            if (!children || index < 0) {
                node.expandable = false;
                return;
            }
            /** @type {?} */
            var nodes = children.map(function (actualNode) {
                actualNode.level = node.level + 1;
                return actualNode;
            });
            (_a = _this.data).splice.apply(_a, tslib_1.__spread([index + 1, 0], nodes));
            _this.dataChange.next(_this.data);
        });
    };
    /**
     * @param {?} node
     * @return {?}
     */
    TreeViewDataSource.prototype.toggleNode = /**
     * @param {?} node
     * @return {?}
     */
    function (node) {
        /** @type {?} */
        var index = this.data.indexOf(node);
        /** @type {?} */
        var count = 0;
        for (var i = index + 1; i < this.data.length
            && this.data[i].level > node.level; i++, count++) { }
        this.data.splice(index + 1, count);
        this.dataChange.next(this.data);
    };
    TreeViewDataSource.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    TreeViewDataSource.ctorParameters = function () { return [
        { type: FlatTreeControl },
        { type: TreeViewService }
    ]; };
    return TreeViewDataSource;
}());
export { TreeViewDataSource };
if (false) {
    /** @type {?} */
    TreeViewDataSource.prototype.treeNodes;
    /** @type {?} */
    TreeViewDataSource.prototype.dataChange;
    /** @type {?} */
    TreeViewDataSource.prototype.childrenSubscription;
    /** @type {?} */
    TreeViewDataSource.prototype.changeSubscription;
    /**
     * @type {?}
     * @private
     */
    TreeViewDataSource.prototype.treeControl;
    /**
     * @type {?}
     * @private
     */
    TreeViewDataSource.prototype.treeViewService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS12aWV3LWRhdGFzb3VyY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJ0cmVlLXZpZXcvZGF0YS90cmVlLXZpZXctZGF0YXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUVoRTtJQWlCSSw0QkFBb0IsV0FBMEMsRUFDMUMsZUFBZ0M7UUFEcEQsaUJBR0M7UUFIbUIsZ0JBQVcsR0FBWCxXQUFXLENBQStCO1FBQzFDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQWRwRCxlQUFVLEdBQUcsSUFBSSxlQUFlLENBQWlCLEVBQUUsQ0FBQyxDQUFDO1FBQ3JELHlCQUFvQixHQUFHLElBQUksQ0FBQztRQUM1Qix1QkFBa0IsR0FBRyxJQUFJLENBQUM7UUFhdEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsVUFBQyxTQUFTLElBQUssT0FBQSxLQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsRUFBMUIsQ0FBMEIsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFaRCxzQkFBSSxvQ0FBSTs7OztRQUFSO1lBQ0ksT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzFCLENBQUM7Ozs7O1FBRUQsVUFBUyxLQUFxQjtZQUMxQixJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7WUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJ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LENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQzs7Ozs7SUFFRCx1Q0FBVTs7OztJQUFWLFVBQVcsSUFBa0I7O1lBQ25CLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7O1lBQ2pDLEtBQUssR0FBRyxDQUFDO1FBQ2IsS0FBSyxJQUFJLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU07ZUFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRyxLQUFLLEVBQUUsRUFBRSxHQUFHO1FBQzFELElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BDLENBQUM7O2dCQTNFSixVQUFVOzs7O2dCQUpGLGVBQWU7Z0JBRWYsZUFBZTs7SUErRXhCLHlCQUFDO0NBQUEsQUE3RUQsSUE2RUM7U0E1RVksa0JBQWtCOzs7SUFFM0IsdUNBQTBCOztJQUMxQix3Q0FBcUQ7O0lBQ3JELGtEQUE0Qjs7SUFDNUIsZ0RBQTBCOzs7OztJQVdkLHlDQUFrRDs7Ozs7SUFDbEQsNkNBQXdDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29sbGVjdGlvblZpZXdlciwgU2VsZWN0aW9uQ2hhbmdlIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvbGxlY3Rpb25zJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgbWVyZ2UsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZsYXRUcmVlQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay90cmVlJztcbmltcG9ydCB7IFRyZWVCYXNlTm9kZSB9IGZyb20gJy4uL21vZGVscy90cmVlLXZpZXcubW9kZWwnO1xuaW1wb3J0IHsgVHJlZVZpZXdTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvdHJlZS12aWV3LnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVHJlZVZpZXdEYXRhU291cmNlIHtcblxuICAgIHRyZWVOb2RlczogVHJlZUJhc2VOb2RlW107XG4gICAgZGF0YUNoYW5nZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8VHJlZUJhc2VOb2RlW10+KFtdKTtcbiAgICBjaGlsZHJlblN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgY2hhbmdlU3Vic2NyaXB0aW9uID0gbnVsbDtcblxuICAgIGdldCBkYXRhKCk6IFRyZWVCYXNlTm9kZVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudHJlZU5vZGVzO1xuICAgIH1cblxuICAgIHNldCBkYXRhKHZhbHVlOiBUcmVlQmFzZU5vZGVbXSkge1xuICAgICAgICB0aGlzLnRyZWVDb250cm9sLmRhdGFOb2RlcyA9IHZhbHVlO1xuICAgICAgICB0aGlzLmRhdGFDaGFuZ2UubmV4dCh2YWx1ZSk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB0cmVlQ29udHJvbDogRmxhdFRyZWVDb250cm9sPFRyZWVCYXNlTm9kZT4sXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSB0cmVlVmlld1NlcnZpY2U6IFRyZWVWaWV3U2VydmljZSkge1xuICAgICAgICB0aGlzLmRhdGFDaGFuZ2Uuc3Vic2NyaWJlKCh0cmVlTm9kZXMpID0+IHRoaXMudHJlZU5vZGVzID0gdHJlZU5vZGVzKTtcbiAgICB9XG5cbiAgICBjb25uZWN0KGNvbGxlY3Rpb25WaWV3ZXI6IENvbGxlY3Rpb25WaWV3ZXIpOiBPYnNlcnZhYmxlPFRyZWVCYXNlTm9kZVtdPiB7XG4gICAgICAgIHRoaXMuY2hhbmdlU3Vic2NyaXB0aW9uID0gdGhpcy50cmVlQ29udHJvbC5leHBhbnNpb25Nb2RlbC5vbkNoYW5nZS5zdWJzY3JpYmUoKGNoYW5nZSkgPT4ge1xuICAgICAgICAgICAgaWYgKChjaGFuZ2UgYXMgU2VsZWN0aW9uQ2hhbmdlPFRyZWVCYXNlTm9kZT4pLmFkZGVkICYmXG4gICAgICAgICAgICAgICAgKGNoYW5nZSBhcyBTZWxlY3Rpb25DaGFuZ2U8VHJlZUJhc2VOb2RlPikuYWRkZWQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZXhwYW5kVHJlZU5vZGVzKGNoYW5nZSBhcyBTZWxlY3Rpb25DaGFuZ2U8VHJlZUJhc2VOb2RlPik7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKChjaGFuZ2UgYXMgU2VsZWN0aW9uQ2hhbmdlPFRyZWVCYXNlTm9kZT4pLnJlbW92ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZHVjZVRyZWVOb2RlcyhjaGFuZ2UgYXMgU2VsZWN0aW9uQ2hhbmdlPFRyZWVCYXNlTm9kZT4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG1lcmdlKGNvbGxlY3Rpb25WaWV3ZXIudmlld0NoYW5nZSwgdGhpcy5kYXRhQ2hhbmdlKS5waXBlKG1hcCgoKSA9PiB0aGlzLmRhdGEpKTtcbiAgICB9XG5cbiAgICBkaXNjb25uZWN0KCkge1xuICAgICAgICBpZiAodGhpcy5jaGlsZHJlblN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgdGhpcy5jaGlsZHJlblN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNoYW5nZVN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZXhwYW5kVHJlZU5vZGVzKGNoYW5nZTogU2VsZWN0aW9uQ2hhbmdlPFRyZWVCYXNlTm9kZT4pIHtcbiAgICAgICAgY2hhbmdlLmFkZGVkLmZvckVhY2goKG5vZGUpID0+IHRoaXMuZXhwYW5kTm9kZShub2RlKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWR1Y2VUcmVlTm9kZXMoY2hhbmdlOiBTZWxlY3Rpb25DaGFuZ2U8VHJlZUJhc2VOb2RlPikge1xuICAgICAgICBjaGFuZ2UucmVtb3ZlZC5zbGljZSgpLnJldmVyc2UoKS5mb3JFYWNoKChub2RlKSA9PiB0aGlzLnRvZ2dsZU5vZGUobm9kZSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZXhwYW5kTm9kZShub2RlOiBUcmVlQmFzZU5vZGUpIHtcbiAgICAgICAgdGhpcy5jaGlsZHJlblN1YnNjcmlwdGlvbiA9IHRoaXMudHJlZVZpZXdTZXJ2aWNlLmdldFRyZWVOb2Rlcyhub2RlLm5vZGVJZClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKGNoaWxkcmVuKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmRhdGEuaW5kZXhPZihub2RlKTtcbiAgICAgICAgICAgICAgICBpZiAoIWNoaWxkcmVuIHx8IGluZGV4IDwgMCkge1xuICAgICAgICAgICAgICAgICAgICBub2RlLmV4cGFuZGFibGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBub2RlcyA9IGNoaWxkcmVuLm1hcCgoYWN0dWFsTm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhY3R1YWxOb2RlLmxldmVsID0gbm9kZS5sZXZlbCArIDE7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhY3R1YWxOb2RlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5zcGxpY2UoaW5kZXggKyAxLCAwLCAuLi5ub2Rlcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhQ2hhbmdlLm5leHQodGhpcy5kYXRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHRvZ2dsZU5vZGUobm9kZTogVHJlZUJhc2VOb2RlKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5kYXRhLmluZGV4T2Yobm9kZSk7XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIGZvciAobGV0IGkgPSBpbmRleCArIDE7IGkgPCB0aGlzLmRhdGEubGVuZ3RoXG4gICAgICAgICAgICAmJiB0aGlzLmRhdGFbaV0ubGV2ZWwgPiBub2RlLmxldmVsOyBpKysgLCBjb3VudCsrKSB7IH1cbiAgICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCArIDEsIGNvdW50KTtcbiAgICAgICAgdGhpcy5kYXRhQ2hhbmdlLm5leHQodGhpcy5kYXRhKTtcbiAgICB9XG5cbn1cbiJdfQ==