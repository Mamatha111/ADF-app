/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { of, from, throwError } from 'rxjs';
import { AlfrescoApiService, SearchService, NodesApiService, TranslationService } from '@alfresco/adf-core';
import { switchMap, map } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class NodePermissionService {
    /**
     * @param {?} apiService
     * @param {?} searchApiService
     * @param {?} nodeService
     * @param {?} translation
     */
    constructor(apiService, searchApiService, nodeService, translation) {
        this.apiService = apiService;
        this.searchApiService = searchApiService;
        this.nodeService = nodeService;
        this.translation = translation;
    }
    /**
     * Gets a list of roles for the current node.
     * @param {?} node The target node
     * @return {?} Array of strings representing the roles
     */
    getNodeRoles(node) {
        /** @type {?} */
        const retrieveSiteQueryBody = this.buildRetrieveSiteQueryBody(node.path.elements);
        return this.searchApiService.searchByQueryBody(retrieveSiteQueryBody)
            .pipe(switchMap((siteNodeList) => {
            if (siteNodeList.list.entries.length > 0) {
                /** @type {?} */
                let siteName = siteNodeList.list.entries[0].entry.name;
                return this.getGroupMembersBySiteName(siteName);
            }
            else {
                return of(node.permissions.settable);
            }
        }));
    }
    /**
     * Updates the permission role for a node.
     * @param {?} node Target node
     * @param {?} updatedPermissionRole Permission role to update or add
     * @return {?} Node with updated permission
     */
    updatePermissionRole(node, updatedPermissionRole) {
        /** @type {?} */
        let permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(updatedPermissionRole.authorityId);
        permissionBody.permissions.locallySet = permissionBody.permissions.locallySet.concat(node.permissions.locallySet);
        if (index !== -1) {
            permissionBody.permissions.locallySet[index] = updatedPermissionRole;
        }
        else {
            permissionBody.permissions.locallySet.push(updatedPermissionRole);
        }
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    /**
     * Update permissions for a node.
     * @param {?} nodeId ID of the target node
     * @param {?} permissionList New permission settings
     * @return {?} Node with updated permissions
     */
    updateNodePermissions(nodeId, permissionList) {
        return this.nodeService.getNode(nodeId).pipe(switchMap((node) => {
            return this.getNodeRoles(node).pipe(switchMap((nodeRoles) => of({ node, nodeRoles })));
        }), switchMap(({ node, nodeRoles }) => this.updateLocallySetPermissions(node, permissionList, nodeRoles)));
    }
    /**
     * Updates the locally set permissions for a node.
     * @param {?} node ID of the target node
     * @param {?} nodes Permission settings
     * @param {?} nodeRole Permission role
     * @return {?} Node with updated permissions
     */
    updateLocallySetPermissions(node, nodes, nodeRole) {
        /** @type {?} */
        let permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        const permissionList = this.transformNodeToPermissionElement(nodes, nodeRole[0]);
        /** @type {?} */
        const duplicatedPermissions = this.getDuplicatedPermissions(node.permissions.locallySet, permissionList);
        if (duplicatedPermissions.length > 0) {
            /** @type {?} */
            const list = duplicatedPermissions.map((permission) => 'authority -> ' + permission.authorityId + ' / role -> ' + permission.name).join(', ');
            /** @type {?} */
            const duplicatePermissionMessage = this.translation.instant('PERMISSION_MANAGER.ERROR.DUPLICATE-PERMISSION', { list });
            return throwError(duplicatePermissionMessage);
        }
        permissionBody.permissions.locallySet = node.permissions.locallySet ? node.permissions.locallySet.concat(permissionList) : permissionList;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    /**
     * @private
     * @param {?} nodeLocallySet
     * @param {?} permissionListAdded
     * @return {?}
     */
    getDuplicatedPermissions(nodeLocallySet, permissionListAdded) {
        /** @type {?} */
        let duplicatePermissions = [];
        if (nodeLocallySet) {
            permissionListAdded.forEach((permission) => {
                /** @type {?} */
                const duplicate = nodeLocallySet.find((localPermission) => this.isEqualPermission(localPermission, permission));
                if (duplicate) {
                    duplicatePermissions.push(duplicate);
                }
            });
        }
        return duplicatePermissions;
    }
    /**
     * @private
     * @param {?} oldPermission
     * @param {?} newPermission
     * @return {?}
     */
    isEqualPermission(oldPermission, newPermission) {
        return oldPermission.accessStatus === newPermission.accessStatus &&
            oldPermission.authorityId === newPermission.authorityId &&
            oldPermission.name === newPermission.name;
    }
    /**
     * @private
     * @param {?} nodes
     * @param {?} nodeRole
     * @return {?}
     */
    transformNodeToPermissionElement(nodes, nodeRole) {
        return nodes.map((node) => {
            /** @type {?} */
            let newPermissionElement = (/** @type {?} */ ({
                'authorityId': node.entry.properties['cm:authorityName'] ?
                    node.entry.properties['cm:authorityName'] :
                    node.entry.properties['cm:userName'],
                'name': nodeRole,
                'accessStatus': 'ALLOWED'
            }));
            return newPermissionElement;
        });
    }
    /**
     * Removes a permission setting from a node.
     * @param {?} node ID of the target node
     * @param {?} permissionToRemove Permission setting to remove
     * @return {?} Node with modified permissions
     */
    removePermission(node, permissionToRemove) {
        /** @type {?} */
        let permissionBody = { permissions: { locallySet: [] } };
        /** @type {?} */
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(permissionToRemove.authorityId);
        if (index !== -1) {
            node.permissions.locallySet.splice(index, 1);
            permissionBody.permissions.locallySet = node.permissions.locallySet;
            return this.nodeService.updateNode(node.id, permissionBody);
        }
    }
    /**
     * @private
     * @param {?} siteName
     * @return {?}
     */
    getGroupMembersBySiteName(siteName) {
        /** @type {?} */
        const groupName = 'GROUP_site_' + siteName;
        return this.getGroupMemberByGroupName(groupName)
            .pipe(map((groupMemberPaging) => {
            /** @type {?} */
            let displayResult = [];
            groupMemberPaging.list.entries.forEach((member) => {
                displayResult.push(this.formattedRoleName(member.entry.displayName, 'site_' + siteName));
            });
            return displayResult;
        }));
    }
    /**
     * Gets all members related to a group name.
     * @param {?} groupName Name of group to look for members
     * @param {?=} opts Extra options supported by JS-API
     * @return {?} List of members
     */
    getGroupMemberByGroupName(groupName, opts) {
        return from(this.apiService.groupsApi.getGroupMembers(groupName, opts));
    }
    /**
     * @private
     * @param {?} displayName
     * @param {?} siteName
     * @return {?}
     */
    formattedRoleName(displayName, siteName) {
        return displayName.replace(siteName + '_', '');
    }
    /**
     * @private
     * @param {?} nodePath
     * @return {?}
     */
    buildRetrieveSiteQueryBody(nodePath) {
        /** @type {?} */
        const pathNames = nodePath.map((node) => 'name: "' + node.name + '"');
        /** @type {?} */
        const buildedPathNames = pathNames.join(' OR ');
        return {
            'query': {
                'query': buildedPathNames
            },
            'paging': {
                'maxItems': 100,
                'skipCount': 0
            },
            'include': ['aspectNames', 'properties'],
            'filterQueries': [
                {
                    'query': "TYPE:'st:site'"
                }
            ]
        };
    }
}
NodePermissionService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
NodePermissionService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: SearchService },
    { type: NodesApiService },
    { type: TranslationService }
];
/** @nocollapse */ NodePermissionService.ngInjectableDef = i0.defineInjectable({ factory: function NodePermissionService_Factory() { return new NodePermissionService(i0.inject(i1.AlfrescoApiService), i0.inject(i1.SearchService), i0.inject(i1.NodesApiService), i0.inject(i1.TranslationService)); }, token: NodePermissionService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.apiService;
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.searchApiService;
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.nodeService;
    /**
     * @type {?}
     * @private
     */
    NodePermissionService.prototype.translation;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJwZXJtaXNzaW9uLW1hbmFnZXIvc2VydmljZXMvbm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU1RyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFLaEQsTUFBTSxPQUFPLHFCQUFxQjs7Ozs7OztJQUU5QixZQUFvQixVQUE4QixFQUM5QixnQkFBK0IsRUFDL0IsV0FBNEIsRUFDNUIsV0FBK0I7UUFIL0IsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFDOUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFlO1FBQy9CLGdCQUFXLEdBQVgsV0FBVyxDQUFpQjtRQUM1QixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7SUFDbkQsQ0FBQzs7Ozs7O0lBT0QsWUFBWSxDQUFDLElBQVU7O2NBQ2IscUJBQXFCLEdBQWMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzVGLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDO2FBQ2hFLElBQUksQ0FDRCxTQUFTLENBQUMsQ0FBQyxZQUFpQixFQUFFLEVBQUU7WUFDNUIsSUFBSyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFN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LGdCQUFnQjthQUM1QjtZQUNELFFBQVEsRUFBRTtnQkFDTixVQUFVLEVBQUUsR0FBRztnQkFDZixXQUFXLEVBQUUsQ0FBQzthQUNqQjtZQUNELFNBQVMsRUFBRSxDQUFDLGFBQWEsRUFBRSxZQUFZLENBQUM7WUFDeEMsZUFBZSxFQUFFO2dCQUNiO29CQUNJLE9BQU8sRUFDSCxnQkFBZ0I7aUJBQ3ZCO2FBQ0o7U0FDSixDQUFDO0lBQ04sQ0FBQzs7O1lBckxKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7OztZQU5RLGtCQUFrQjtZQUFFLGFBQWE7WUFBRSxlQUFlO1lBQUUsa0JBQWtCOzs7Ozs7OztJQVMvRCwyQ0FBc0M7Ozs7O0lBQ3RDLGlEQUF1Qzs7Ozs7SUFDdkMsNENBQW9DOzs7OztJQUNwQyw0Q0FBdUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgZnJvbSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBTZWFyY2hTZXJ2aWNlLCBOb2Rlc0FwaVNlcnZpY2UsIFRyYW5zbGF0aW9uU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBRdWVyeUJvZHksIE5vZGUsIE5vZGVFbnRyeSwgUGF0aEVsZW1lbnQsIEdyb3VwTWVtYmVyRW50cnksIEdyb3VwTWVtYmVyUGFnaW5nLCBQZXJtaXNzaW9uRWxlbWVudCB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgc3dpdGNoTWFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTm9kZVBlcm1pc3Npb25TZXJ2aWNlIHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgc2VhcmNoQXBpU2VydmljZTogU2VhcmNoU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIG5vZGVTZXJ2aWNlOiBOb2Rlc0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSB0cmFuc2xhdGlvbjogVHJhbnNsYXRpb25TZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGxpc3Qgb2Ygcm9sZXMgZm9yIHRoZSBjdXJyZW50IG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgVGhlIHRhcmdldCBub2RlXG4gICAgICogQHJldHVybnMgQXJyYXkgb2Ygc3RyaW5ncyByZXByZXNlbnRpbmcgdGhlIHJvbGVzXG4gICAgICovXG4gICAgZ2V0Tm9kZVJvbGVzKG5vZGU6IE5vZGUpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XG4gICAgICAgIGNvbnN0IHJldHJpZXZlU2l0ZVF1ZXJ5Qm9keTogUXVlcnlCb2R5ID0gdGhpcy5idWlsZFJldHJpZXZlU2l0ZVF1ZXJ5Qm9keShub2RlLnBhdGguZWxlbWVudHMpO1xuICAgICAgICByZXR1cm4gdGhpcy5zZWFyY2hBcGlTZXJ2aWNlLnNlYXJjaEJ5UXVlcnlCb2R5KHJldHJpZXZlU2l0ZVF1ZXJ5Qm9keSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoc2l0ZU5vZGVMaXN0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBzaXRlTm9kZUxpc3QubGlzdC5lbnRyaWVzLmxlbmd0aCA+IDAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2l0ZU5hbWUgPSBzaXRlTm9kZUxpc3QubGlzdC5lbnRyaWVzWzBdLmVudHJ5Lm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRHcm91cE1lbWJlcnNCeVNpdGVOYW1lKHNpdGVOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihub2RlLnBlcm1pc3Npb25zLnNldHRhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIHBlcm1pc3Npb24gcm9sZSBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIFRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHVwZGF0ZWRQZXJtaXNzaW9uUm9sZSBQZXJtaXNzaW9uIHJvbGUgdG8gdXBkYXRlIG9yIGFkZFxuICAgICAqIEByZXR1cm5zIE5vZGUgd2l0aCB1cGRhdGVkIHBlcm1pc3Npb25cbiAgICAgKi9cbiAgICB1cGRhdGVQZXJtaXNzaW9uUm9sZShub2RlOiBOb2RlLCB1cGRhdGVkUGVybWlzc2lvblJvbGU6IFBlcm1pc3Npb25FbGVtZW50KTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgIGxldCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW119IH07XG4gICAgICAgIGNvbnN0IGluZGV4ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0Lm1hcCgocGVybWlzc2lvbikgPT4gcGVybWlzc2lvbi5hdXRob3JpdHlJZCkuaW5kZXhPZih1cGRhdGVkUGVybWlzc2lvblJvbGUuYXV0aG9yaXR5SWQpO1xuICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID0gcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldC5jb25jYXQobm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0KTtcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgcGVybWlzc2lvbkJvZHkucGVybWlzc2lvbnMubG9jYWxseVNldFtpbmRleF0gPSB1cGRhdGVkUGVybWlzc2lvblJvbGU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LnB1c2godXBkYXRlZFBlcm1pc3Npb25Sb2xlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgcGVybWlzc2lvbnMgZm9yIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZUlkIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9uTGlzdCBOZXcgcGVybWlzc2lvbiBzZXR0aW5nc1xuICAgICAqIEByZXR1cm5zIE5vZGUgd2l0aCB1cGRhdGVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgdXBkYXRlTm9kZVBlcm1pc3Npb25zKG5vZGVJZDogc3RyaW5nLCBwZXJtaXNzaW9uTGlzdDogTm9kZUVudHJ5W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS5nZXROb2RlKG5vZGVJZCkucGlwZShcbiAgICAgICAgICAgc3dpdGNoTWFwKChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Tm9kZVJvbGVzKG5vZGUpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgobm9kZVJvbGVzKSA9PiBvZih7bm9kZSwgbm9kZVJvbGVzfSkgKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoe25vZGUsIG5vZGVSb2xlc30pID0+IHRoaXMudXBkYXRlTG9jYWxseVNldFBlcm1pc3Npb25zKG5vZGUsIHBlcm1pc3Npb25MaXN0LCBub2RlUm9sZXMpKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIGxvY2FsbHkgc2V0IHBlcm1pc3Npb25zIGZvciBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIG5vZGVzIFBlcm1pc3Npb24gc2V0dGluZ3NcbiAgICAgKiBAcGFyYW0gbm9kZVJvbGUgUGVybWlzc2lvbiByb2xlXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIHVwZGF0ZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVMb2NhbGx5U2V0UGVybWlzc2lvbnMobm9kZTogTm9kZSwgbm9kZXM6IE5vZGVFbnRyeVtdLCBub2RlUm9sZTogc3RyaW5nW10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgbGV0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXX0gfTtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkxpc3QgPSB0aGlzLnRyYW5zZm9ybU5vZGVUb1Blcm1pc3Npb25FbGVtZW50KG5vZGVzLCBub2RlUm9sZVswXSk7XG4gICAgICAgIGNvbnN0IGR1cGxpY2F0ZWRQZXJtaXNzaW9ucyA9IHRoaXMuZ2V0RHVwbGljYXRlZFBlcm1pc3Npb25zKG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldCwgcGVybWlzc2lvbkxpc3QpO1xuICAgICAgICBpZiAoZHVwbGljYXRlZFBlcm1pc3Npb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSBkdXBsaWNhdGVkUGVybWlzc2lvbnMubWFwKChwZXJtaXNzaW9uKSA9PiAnYXV0aG9yaXR5IC0+ICcgKyBwZXJtaXNzaW9uLmF1dGhvcml0eUlkICsgJyAvIHJvbGUgLT4gJyArIHBlcm1pc3Npb24ubmFtZSkuam9pbignLCAnKTtcbiAgICAgICAgICAgIGNvbnN0IGR1cGxpY2F0ZVBlcm1pc3Npb25NZXNzYWdlOiBzdHJpbmcgPSB0aGlzLnRyYW5zbGF0aW9uLmluc3RhbnQoJ1BFUk1JU1NJT05fTUFOQUdFUi5FUlJPUi5EVVBMSUNBVEUtUEVSTUlTU0lPTicsICB7bGlzdH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZHVwbGljYXRlUGVybWlzc2lvbk1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPyBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuY29uY2F0KHBlcm1pc3Npb25MaXN0KSA6IHBlcm1pc3Npb25MaXN0O1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldER1cGxpY2F0ZWRQZXJtaXNzaW9ucyhub2RlTG9jYWxseVNldDogUGVybWlzc2lvbkVsZW1lbnRbXSwgcGVybWlzc2lvbkxpc3RBZGRlZDogUGVybWlzc2lvbkVsZW1lbnRbXSk6IFBlcm1pc3Npb25FbGVtZW50W10ge1xuICAgICAgICBsZXQgZHVwbGljYXRlUGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10gPSBbXTtcbiAgICAgICAgaWYgKG5vZGVMb2NhbGx5U2V0KSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uTGlzdEFkZGVkLmZvckVhY2goKHBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlID0gbm9kZUxvY2FsbHlTZXQuZmluZCgobG9jYWxQZXJtaXNzaW9uKSA9PiB0aGlzLmlzRXF1YWxQZXJtaXNzaW9uKGxvY2FsUGVybWlzc2lvbiwgcGVybWlzc2lvbikpO1xuICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZHVwbGljYXRlUGVybWlzc2lvbnMucHVzaChkdXBsaWNhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkdXBsaWNhdGVQZXJtaXNzaW9ucztcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRXF1YWxQZXJtaXNzaW9uKG9sZFBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50LCBuZXdQZXJtaXNzaW9uOiBQZXJtaXNzaW9uRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gb2xkUGVybWlzc2lvbi5hY2Nlc3NTdGF0dXMgPT09IG5ld1Blcm1pc3Npb24uYWNjZXNzU3RhdHVzICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLmF1dGhvcml0eUlkID09PSBuZXdQZXJtaXNzaW9uLmF1dGhvcml0eUlkICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLm5hbWUgPT09IG5ld1Blcm1pc3Npb24ubmFtZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybU5vZGVUb1Blcm1pc3Npb25FbGVtZW50KG5vZGVzOiBOb2RlRW50cnlbXSwgbm9kZVJvbGU6IGFueSk6IFBlcm1pc3Npb25FbGVtZW50W10ge1xuICAgICAgICByZXR1cm4gbm9kZXMubWFwKChub2RlKSA9PiB7XG4gICAgICAgICAgICBsZXQgbmV3UGVybWlzc2lvbkVsZW1lbnQ6IFBlcm1pc3Npb25FbGVtZW50ID0gPFBlcm1pc3Npb25FbGVtZW50PiB7XG4gICAgICAgICAgICAgICAgJ2F1dGhvcml0eUlkJzogbm9kZS5lbnRyeS5wcm9wZXJ0aWVzWydjbTphdXRob3JpdHlOYW1lJ10gP1xuICAgICAgICAgICAgICAgICAgICBub2RlLmVudHJ5LnByb3BlcnRpZXNbJ2NtOmF1dGhvcml0eU5hbWUnXSA6XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuZW50cnkucHJvcGVydGllc1snY206dXNlck5hbWUnXSxcbiAgICAgICAgICAgICAgICAnbmFtZSc6IG5vZGVSb2xlLFxuICAgICAgICAgICAgICAgICdhY2Nlc3NTdGF0dXMnOiAnQUxMT1dFRCdcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gbmV3UGVybWlzc2lvbkVsZW1lbnQ7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgYSBwZXJtaXNzaW9uIHNldHRpbmcgZnJvbSBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHBlcm1pc3Npb25Ub1JlbW92ZSBQZXJtaXNzaW9uIHNldHRpbmcgdG8gcmVtb3ZlXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIG1vZGlmaWVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgcmVtb3ZlUGVybWlzc2lvbihub2RlOiBOb2RlLCBwZXJtaXNzaW9uVG9SZW1vdmU6IFBlcm1pc3Npb25FbGVtZW50KTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgIGxldCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW10gfSB9O1xuICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5tYXAoKHBlcm1pc3Npb24pID0+IHBlcm1pc3Npb24uYXV0aG9yaXR5SWQpLmluZGV4T2YocGVybWlzc2lvblRvUmVtb3ZlLmF1dGhvcml0eUlkKTtcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0O1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEdyb3VwTWVtYmVyc0J5U2l0ZU5hbWUoc2l0ZU5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcbiAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gJ0dST1VQX3NpdGVfJyArIHNpdGVOYW1lO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRHcm91cE1lbWJlckJ5R3JvdXBOYW1lKGdyb3VwTmFtZSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoZ3JvdXBNZW1iZXJQYWdpbmc6IEdyb3VwTWVtYmVyUGFnaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBkaXNwbGF5UmVzdWx0OiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBncm91cE1lbWJlclBhZ2luZy5saXN0LmVudHJpZXMuZm9yRWFjaCgobWVtYmVyOiBHcm91cE1lbWJlckVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5UmVzdWx0LnB1c2godGhpcy5mb3JtYXR0ZWRSb2xlTmFtZShtZW1iZXIuZW50cnkuZGlzcGxheU5hbWUsICdzaXRlXycgKyBzaXRlTmFtZSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlSZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgbWVtYmVycyByZWxhdGVkIHRvIGEgZ3JvdXAgbmFtZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBOYW1lIE5hbWUgb2YgZ3JvdXAgdG8gbG9vayBmb3IgbWVtYmVyc1xuICAgICAqIEBwYXJhbSBvcHRzIEV4dHJhIG9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgbWVtYmVyc1xuICAgICAqL1xuICAgIGdldEdyb3VwTWVtYmVyQnlHcm91cE5hbWUoZ3JvdXBOYW1lOiBzdHJpbmcsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPEdyb3VwTWVtYmVyUGFnaW5nPiB7XG4gICAgICAgIHJldHVybiBmcm9tPEdyb3VwTWVtYmVyUGFnaW5nPih0aGlzLmFwaVNlcnZpY2UuZ3JvdXBzQXBpLmdldEdyb3VwTWVtYmVycyhncm91cE5hbWUsIG9wdHMpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcm1hdHRlZFJvbGVOYW1lKGRpc3BsYXlOYW1lLCBzaXRlTmFtZSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBkaXNwbGF5TmFtZS5yZXBsYWNlKHNpdGVOYW1lICsgJ18nLCAnJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZFJldHJpZXZlU2l0ZVF1ZXJ5Qm9keShub2RlUGF0aDogUGF0aEVsZW1lbnRbXSk6IFF1ZXJ5Qm9keSB7XG4gICAgICAgIGNvbnN0IHBhdGhOYW1lcyA9IG5vZGVQYXRoLm1hcCgobm9kZTogUGF0aEVsZW1lbnQpID0+ICduYW1lOiBcIicgKyBub2RlLm5hbWUgKyAnXCInKTtcbiAgICAgICAgY29uc3QgYnVpbGRlZFBhdGhOYW1lcyA9IHBhdGhOYW1lcy5qb2luKCcgT1IgJyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAncXVlcnknOiB7XG4gICAgICAgICAgICAgICAgJ3F1ZXJ5JzogYnVpbGRlZFBhdGhOYW1lc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdwYWdpbmcnOiB7XG4gICAgICAgICAgICAgICAgJ21heEl0ZW1zJzogMTAwLFxuICAgICAgICAgICAgICAgICdza2lwQ291bnQnOiAwXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2luY2x1ZGUnOiBbJ2FzcGVjdE5hbWVzJywgJ3Byb3BlcnRpZXMnXSxcbiAgICAgICAgICAgICdmaWx0ZXJRdWVyaWVzJzogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgJ3F1ZXJ5JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiVFlQRTonc3Q6c2l0ZSdcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICB9XG5cbn1cbiJdfQ==