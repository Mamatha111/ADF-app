/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Component, ViewEncapsulation } from '@angular/core';
import { SearchService, TranslationService } from '@alfresco/adf-core';
import { SearchQueryBuilderService } from '../../search-query-builder.service';
import { SearchFilterList } from './models/search-filter-list.model';
import { takeWhile } from 'rxjs/operators';
export class SearchFilterComponent {
    /**
     * @param {?} queryBuilder
     * @param {?} searchService
     * @param {?} translationService
     */
    constructor(queryBuilder, searchService, translationService) {
        this.queryBuilder = queryBuilder;
        this.searchService = searchService;
        this.translationService = translationService;
        this.DEFAULT_PAGE_SIZE = 5;
        this.isAlive = true;
        this.responseFacets = null;
        this.facetQueriesPageSize = this.DEFAULT_PAGE_SIZE;
        this.facetQueriesLabel = 'Facet Queries';
        this.facetQueriesExpanded = false;
        this.facetFieldsExpanded = false;
        this.selectedBuckets = [];
        if (queryBuilder.config && queryBuilder.config.facetQueries) {
            this.facetQueriesLabel = queryBuilder.config.facetQueries.label || 'Facet Queries';
            this.facetQueriesPageSize = queryBuilder.config.facetQueries.pageSize || this.DEFAULT_PAGE_SIZE;
            this.facetQueriesExpanded = queryBuilder.config.facetQueries.expanded;
        }
        if (queryBuilder.config && queryBuilder.config.facetFields) {
            this.facetFieldsExpanded = queryBuilder.config.facetFields.expanded;
        }
        this.queryBuilder.updated.pipe(takeWhile(() => this.isAlive)).subscribe(() => {
            this.queryBuilder.execute();
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.queryBuilder) {
            this.queryBuilder.executed.pipe(takeWhile(() => this.isAlive)).subscribe((resultSetPaging) => {
                this.onDataLoaded(resultSetPaging);
                this.searchService.dataLoaded.next(resultSetPaging);
            });
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.isAlive = false;
    }
    /**
     * @private
     * @return {?}
     */
    updateSelectedBuckets() {
        if (this.responseFacets) {
            this.selectedBuckets = [];
            for (let field of this.responseFacets) {
                if (field.buckets) {
                    this.selectedBuckets.push(...this.queryBuilder.getUserFacetBuckets(field.field)
                        .filter((bucket) => bucket.checked)
                        .map((bucket) => {
                        return { field, bucket };
                    }));
                }
            }
        }
        else {
            this.selectedBuckets = [];
        }
    }
    /**
     * @param {?} event
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    onToggleBucket(event, field, bucket) {
        if (event && bucket) {
            if (event.checked) {
                this.selectFacetBucket(field, bucket);
            }
            else {
                this.unselectFacetBucket(field, bucket);
            }
        }
    }
    /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    selectFacetBucket(field, bucket) {
        if (bucket) {
            bucket.checked = true;
            this.queryBuilder.addUserFacetBucket(field, bucket);
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    }
    /**
     * @param {?} field
     * @param {?} bucket
     * @return {?}
     */
    unselectFacetBucket(field, bucket) {
        if (bucket) {
            bucket.checked = false;
            this.queryBuilder.removeUserFacetBucket(field, bucket);
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    }
    /**
     * @param {?} field
     * @return {?}
     */
    canResetSelectedBuckets(field) {
        if (field && field.buckets) {
            return field.buckets.items.some((bucket) => bucket.checked);
        }
        return false;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    resetSelectedBuckets(field) {
        if (field && field.buckets) {
            for (let bucket of field.buckets.items) {
                bucket.checked = false;
                this.queryBuilder.removeUserFacetBucket(field, bucket);
            }
            this.updateSelectedBuckets();
            this.queryBuilder.update();
        }
    }
    /**
     * @param {?} field
     * @return {?}
     */
    shouldExpand(field) {
        return field.type === 'query' ? this.facetQueriesExpanded : this.facetFieldsExpanded;
    }
    /**
     * @param {?} data
     * @return {?}
     */
    onDataLoaded(data) {
        /** @type {?} */
        const context = data.list.context;
        if (context) {
            this.parseFacets(context);
        }
        else {
            this.responseFacets = null;
        }
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    parseFacets(context) {
        if (!this.responseFacets) {
            /** @type {?} */
            const responseFacetFields = this.parseFacetFields(context);
            /** @type {?} */
            const responseGroupedFacetQueries = this.parseFacetQueries(context);
            this.responseFacets = responseFacetFields.concat(...responseGroupedFacetQueries);
        }
        else {
            this.responseFacets = this.responseFacets
                .map((field) => {
                /** @type {?} */
                let responseField = (context.facets || []).find((response) => response.label === field.label && response.type === field.type);
                (field && field.buckets && field.buckets.items || [])
                    .map((bucket) => {
                    /** @type {?} */
                    const responseBucket = ((responseField && responseField.buckets) || []).find((respBucket) => respBucket.label === bucket.label);
                    bucket.count = responseBucket ? this.getCountValue(responseBucket) : 0;
                    return bucket;
                });
                return field;
            });
        }
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    parseFacetFields(context) {
        /** @type {?} */
        const configFacetFields = this.queryBuilder.config.facetFields && this.queryBuilder.config.facetFields.fields || [];
        return configFacetFields.map((field) => {
            /** @type {?} */
            const responseField = (context.facets || []).find((response) => response.type === 'field' && response.label === field.label) || {};
            /** @type {?} */
            const responseBuckets = this.getResponseBuckets(responseField);
            /** @type {?} */
            const bucketList = new SearchFilterList(responseBuckets, field.pageSize);
            bucketList.filter = (bucket) => {
                if (bucket && bucketList.filterText) {
                    /** @type {?} */
                    const pattern = (bucketList.filterText || '').toLowerCase();
                    /** @type {?} */
                    const label = (this.translationService.instant(bucket.display) || this.translationService.instant(bucket.label)).toLowerCase();
                    return this.queryBuilder.config.filterWithContains ? label.indexOf(pattern) !== -1 : label.startsWith(pattern);
                }
                return true;
            };
            return (/** @type {?} */ (Object.assign({}, field, { type: responseField.type, label: field.label, pageSize: field.pageSize | this.DEFAULT_PAGE_SIZE, currentPageSize: field.pageSize | this.DEFAULT_PAGE_SIZE, buckets: bucketList })));
        });
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    parseFacetQueries(context) {
        /** @type {?} */
        const configFacetQueries = this.queryBuilder.config.facetQueries && this.queryBuilder.config.facetQueries.queries || [];
        /** @type {?} */
        const configGroups = configFacetQueries.reduce((acc, query) => {
            /** @type {?} */
            const group = this.queryBuilder.getQueryGroup(query);
            if (acc[group]) {
                acc[group].push(query);
            }
            else {
                acc[group] = [query];
            }
            return acc;
        }, []);
        /** @type {?} */
        const result = [];
        Object.keys(configGroups).forEach((group) => {
            /** @type {?} */
            const responseField = (context.facets || []).find((response) => response.type === 'query' && response.label === group) || {};
            /** @type {?} */
            const responseBuckets = this.getResponseQueryBuckets(responseField, configGroups[group]);
            /** @type {?} */
            const bucketList = new SearchFilterList(responseBuckets, this.facetQueriesPageSize);
            bucketList.filter = (bucket) => {
                if (bucket && bucketList.filterText) {
                    /** @type {?} */
                    const pattern = (bucketList.filterText || '').toLowerCase();
                    /** @type {?} */
                    const label = (this.translationService.instant(bucket.display) || this.translationService.instant(bucket.label)).toLowerCase();
                    return this.queryBuilder.config.filterWithContains ? label.indexOf(pattern) !== -1 : label.startsWith(pattern);
                }
                return true;
            };
            result.push((/** @type {?} */ ({
                field: group,
                type: responseField.type,
                label: group,
                pageSize: this.DEFAULT_PAGE_SIZE,
                currentPageSize: this.DEFAULT_PAGE_SIZE,
                buckets: bucketList
            })));
        });
        return result;
    }
    /**
     * @private
     * @param {?} responseField
     * @return {?}
     */
    getResponseBuckets(responseField) {
        return ((responseField && responseField.buckets) || []).map((respBucket) => {
            respBucket['count'] = this.getCountValue(respBucket);
            return (/** @type {?} */ (Object.assign({}, respBucket, { checked: false, display: respBucket.display, label: respBucket.label })));
        });
    }
    /**
     * @private
     * @param {?} responseField
     * @param {?} configGroup
     * @return {?}
     */
    getResponseQueryBuckets(responseField, configGroup) {
        return (configGroup || []).map((query) => {
            /** @type {?} */
            const respBucket = ((responseField && responseField.buckets) || [])
                .find((bucket) => bucket.label === query.label);
            respBucket['count'] = this.getCountValue(respBucket);
            return (/** @type {?} */ (Object.assign({}, respBucket, { checked: false, display: respBucket.display, label: respBucket.label })));
        }).filter((bucket) => {
            /** @type {?} */
            let mincount = this.queryBuilder.config.facetQueries.mincount;
            if (mincount === undefined) {
                mincount = 1;
            }
            return bucket.count >= mincount;
        });
    }
    /**
     * @private
     * @param {?} bucket
     * @return {?}
     */
    getCountValue(bucket) {
        return (!!bucket && !!bucket.metrics && bucket.metrics[0] && bucket.metrics[0].value && bucket.metrics[0].value.count)
            || 0;
    }
}
SearchFilterComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-search-filter',
                template: "<mat-accordion multi=\"true\" displayMode=\"flat\">\n\n    <mat-expansion-panel\n        *ngFor=\"let category of queryBuilder.categories\"\n        [attr.data-automation-id]=\"'expansion-panel-'+category.name\"\n        [(expanded)]=\"category.expanded\">\n        <mat-expansion-panel-header>\n            <mat-panel-title>\n                {{ category.name | translate }}\n            </mat-panel-title>\n        </mat-expansion-panel-header>\n        <adf-search-widget-container\n            [id]=\"category.id\"\n            [selector]=\"category.component.selector\"\n            [settings]=\"category.component.settings\">\n        </adf-search-widget-container>\n    </mat-expansion-panel>\n\n    <ng-container *ngIf=\"responseFacets\">\n        <mat-expansion-panel [attr.data-automation-id]=\"'expansion-panel-'+field.label\" *ngFor=\"let field of responseFacets\"\n                             [expanded]=\"shouldExpand(field)\">\n            <mat-expansion-panel-header>\n                <mat-panel-title>{{ field.label | translate }}</mat-panel-title>\n            </mat-expansion-panel-header>\n\n            <div class=\"adf-facet-result-filter\">\n                <mat-form-field>\n                    <input\n                        matInput\n                        placeholder=\"{{ 'SEARCH.FILTER.ACTIONS.FILTER-CATEGORY' | translate }}\"\n                        [attr.data-automation-id]=\"'facet-result-filter-'+field.label\"\n                        [(ngModel)]=\"field.buckets.filterText\">\n                    <button *ngIf=\"field.buckets.filterText\"\n                        mat-button matSuffix mat-icon-button\n                        (click)=\"field.buckets.filterText = ''\">\n                        <mat-icon>close</mat-icon>\n                    </button>\n                </mat-form-field>\n            </div>\n\n            <div class=\"adf-checklist\">\n                <mat-checkbox\n                    *ngFor=\"let bucket of field.buckets\"\n                    [checked]=\"bucket.checked\"\n                    [attr.data-automation-id]=\"'checkbox-'+field.label+'-'+(bucket.display || bucket.label)\"\n                    (change)=\"onToggleBucket($event, field, bucket)\">\n                    <div \n                        matTooltip=\"{{ bucket.display || bucket.label | translate }}\"\n                        matTooltipPosition=\"right\"\n                        class=\"adf-facet-label\">\n                        {{ bucket.display || bucket.label | translate }} \n                        <span *ngIf=\"bucket.count!==null\">(</span>\n                        {{ bucket.count }}\n                        <span *ngIf=\"bucket.count!==null\">)</span>\n                    </div>\n                </mat-checkbox>\n            </div>\n\n            <div class=\"adf-facet-buttons\" *ngIf=\"field.buckets.fitsPage\">\n                <button *ngIf=\"canResetSelectedBuckets(field)\"\n                    mat-button\n                    color=\"primary\"\n                    (click)=\"resetSelectedBuckets(field)\">\n                    {{ 'SEARCH.FILTER.ACTIONS.CLEAR-ALL' | translate }}\n                </button>\n            </div>\n\n            <div class=\"adf-facet-buttons\" *ngIf=\"!field.buckets.fitsPage\">\n                <button mat-icon-button\n                    *ngIf=\"canResetSelectedBuckets(field)\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.CLEAR-ALL' | translate }}\"\n                    (click)=\"resetSelectedBuckets(field)\">\n                    <mat-icon>clear</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"field.buckets.canShowLessItems\"\n                    (click)=\"field.buckets.showLessItems()\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-LESS' | translate }}\">\n                    <mat-icon>keyboard_arrow_up</mat-icon>\n                </button>\n                <button mat-icon-button\n                    *ngIf=\"field.buckets.canShowMoreItems\"\n                    (click)=\"field.buckets.showMoreItems()\"\n                    title=\"{{ 'SEARCH.FILTER.ACTIONS.SHOW-MORE' | translate }}\">\n                    <mat-icon>keyboard_arrow_down</mat-icon>\n                </button>\n            </div>\n        </mat-expansion-panel>\n    </ng-container>\n</mat-accordion>\n",
                encapsulation: ViewEncapsulation.None,
                host: { class: 'adf-search-filter' },
                styles: [".adf-search-filter .adf-checklist{display:flex;flex-direction:column}.adf-search-filter .adf-checklist .mat-checkbox-label{text-overflow:ellipsis;overflow:hidden;width:100%}.adf-search-filter .adf-checklist .mat-checkbox-layout{width:100%}.adf-search-filter .adf-checklist .adf-facet-label{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.adf-search-filter .adf-checklist .mat-checkbox{margin:5px}.adf-search-filter .adf-checklist .mat-checkbox.mat-checkbox-checked .mat-checkbox-label{font-weight:700}.adf-search-filter .adf-facet-result-filter{display:flex;flex-direction:column}.adf-search-filter .adf-facet-result-filter>*{width:100%}.adf-search-filter .adf-facet-buttons{text-align:right}.adf-search-filter .adf-facet-buttons .mat-button{text-transform:uppercase}.adf-search-filter .adf-facet-buttons--topSpace{padding-top:15px}"]
            }] }
];
/** @nocollapse */
SearchFilterComponent.ctorParameters = () => [
    { type: SearchQueryBuilderService },
    { type: SearchService },
    { type: TranslationService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.DEFAULT_PAGE_SIZE;
    /** @type {?} */
    SearchFilterComponent.prototype.isAlive;
    /** @type {?} */
    SearchFilterComponent.prototype.responseFacets;
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.facetQueriesPageSize;
    /** @type {?} */
    SearchFilterComponent.prototype.facetQueriesLabel;
    /** @type {?} */
    SearchFilterComponent.prototype.facetQueriesExpanded;
    /** @type {?} */
    SearchFilterComponent.prototype.facetFieldsExpanded;
    /** @type {?} */
    SearchFilterComponent.prototype.selectedBuckets;
    /** @type {?} */
    SearchFilterComponent.prototype.queryBuilder;
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.searchService;
    /**
     * @type {?}
     * @private
     */
    SearchFilterComponent.prototype.translationService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZpbHRlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJzZWFyY2gvY29tcG9uZW50cy9zZWFyY2gtZmlsdGVyL3NlYXJjaC1maWx0ZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBRWhGLE9BQU8sRUFBRSxhQUFhLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN2RSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUcvRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNyRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFVM0MsTUFBTSxPQUFPLHFCQUFxQjs7Ozs7O0lBYzlCLFlBQW1CLFlBQXVDLEVBQ3RDLGFBQTRCLEVBQzVCLGtCQUFzQztRQUZ2QyxpQkFBWSxHQUFaLFlBQVksQ0FBMkI7UUFDdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQWRsRCxzQkFBaUIsR0FBRyxDQUFDLENBQUM7UUFFOUIsWUFBTyxHQUFHLElBQUksQ0FBQztRQUNmLG1CQUFjLEdBQWlCLElBQUksQ0FBQztRQUU1Qix5QkFBb0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUM7UUFDdEQsc0JBQWlCLEdBQVcsZUFBZSxDQUFDO1FBQzVDLHlCQUFvQixHQUFHLEtBQUssQ0FBQztRQUM3Qix3QkFBbUIsR0FBRyxLQUFLLENBQUM7UUFFNUIsb0JBQWUsR0FBMkQsRUFBRSxDQUFDO1FBS3pFLElBQUksWUFBWSxDQUFDLE1BQU0sSUFBSSxZQUFZLENBQUMsTUFBTSxDQUFD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QUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7ZUFDL0csQ0FBQyxDQUFDO0lBQ2IsQ0FBQzs7O1lBelFKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsbUJBQW1CO2dCQUM3QixneElBQTZDO2dCQUU3QyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTtnQkFDckMsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLG1CQUFtQixFQUFFOzthQUN2Qzs7OztZQWJRLHlCQUF5QjtZQUR6QixhQUFhO1lBQUUsa0JBQWtCOzs7Ozs7O0lBaUJ0QyxrREFBOEI7O0lBRTlCLHdDQUFlOztJQUNmLCtDQUFvQzs7Ozs7SUFFcEMscURBQXNEOztJQUN0RCxrREFBNEM7O0lBQzVDLHFEQUE2Qjs7SUFDN0Isb0RBQTRCOztJQUU1QixnREFBNkU7O0lBRWpFLDZDQUE4Qzs7Ozs7SUFDOUMsOENBQW9DOzs7OztJQUNwQyxtREFBOEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBDb21wb25lbnQsIFZpZXdFbmNhcHN1bGF0aW9uLCBPbkluaXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTWF0Q2hlY2tib3hDaGFuZ2UgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbCc7XG5pbXBvcnQgeyBTZWFyY2hTZXJ2aWNlLCBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgU2VhcmNoUXVlcnlCdWlsZGVyU2VydmljZSB9IGZyb20gJy4uLy4uL3NlYXJjaC1xdWVyeS1idWlsZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgRmFjZXRGaWVsZEJ1Y2tldCB9IGZyb20gJy4uLy4uL2ZhY2V0LWZpZWxkLWJ1Y2tldC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRmFjZXRGaWVsZCB9IGZyb20gJy4uLy4uL2ZhY2V0LWZpZWxkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBTZWFyY2hGaWx0ZXJMaXN0IH0gZnJvbSAnLi9tb2RlbHMvc2VhcmNoLWZpbHRlci1saXN0Lm1vZGVsJztcbmltcG9ydCB7IHRha2VXaGlsZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJlc3VsdFNldFBhZ2luZywgR2VuZXJpY0J1Y2tldCwgR2VuZXJpY0ZhY2V0UmVzcG9uc2UsIFJlc3VsdFNldENvbnRleHQgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhZGYtc2VhcmNoLWZpbHRlcicsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3NlYXJjaC1maWx0ZXIuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL3NlYXJjaC1maWx0ZXIuY29tcG9uZW50LnNjc3MnXSxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICAgIGhvc3Q6IHsgY2xhc3M6ICdhZGYtc2VhcmNoLWZpbHRlcicgfVxufSlcbmV4cG9ydCBjbGFzcyBTZWFyY2hGaWx0ZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG5cbiAgICBwcml2YXRlIERFRkFVTFRfUEFHRV9TSVpFID0gNTtcblxuICAgIGlzQWxpdmUgPSB0cnVlO1xuICAgIHJlc3BvbnNlRmFjZXRzOiBGYWNldEZpZWxkW10gPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBmYWNldFF1ZXJpZXNQYWdlU2l6ZSA9IHRoaXMuREVGQVVMVF9QQUdFX1NJWkU7XG4gICAgZmFjZXRRdWVyaWVzTGFiZWw6IHN0cmluZyA9ICdGYWNldCBRdWVyaWVzJztcbiAgICBmYWNldFF1ZXJpZXNFeHBhbmRlZCA9IGZhbHNlO1xuICAgIGZhY2V0RmllbGRzRXhwYW5kZWQgPSBmYWxzZTtcblxuICAgIHNlbGVjdGVkQnVja2V0czogQXJyYXk8eyBmaWVsZDogRmFjZXRGaWVsZCwgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0IH0+ID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgcXVlcnlCdWlsZGVyOiBTZWFyY2hRdWVyeUJ1aWxkZXJTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgc2VhcmNoU2VydmljZTogU2VhcmNoU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlKSB7XG4gICAgICAgIGlmIChxdWVyeUJ1aWxkZXIuY29uZmlnICYmIHF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzKSB7XG4gICAgICAgICAgICB0aGlzLmZhY2V0UXVlcmllc0xhYmVsID0gcXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMubGFiZWwgfHwgJ0ZhY2V0IFF1ZXJpZXMnO1xuICAgICAgICAgICAgdGhpcy5mYWNldFF1ZXJpZXNQYWdlU2l6ZSA9IHF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzLnBhZ2VTaXplIHx8IHRoaXMuREVGQVVMVF9QQUdFX1NJWkU7XG4gICAgICAgICAgICB0aGlzLmZhY2V0UXVlcmllc0V4cGFuZGVkID0gcXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMuZXhwYW5kZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHF1ZXJ5QnVpbGRlci5jb25maWcgJiYgcXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldEZpZWxkcykge1xuICAgICAgICAgICAgdGhpcy5mYWNldEZpZWxkc0V4cGFuZGVkID0gcXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldEZpZWxkcy5leHBhbmRlZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZWQucGlwZShcbiAgICAgICAgICAgIHRha2VXaGlsZSgoKSA9PiB0aGlzLmlzQWxpdmUpXG4gICAgICAgICkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLmV4ZWN1dGUoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIGlmICh0aGlzLnF1ZXJ5QnVpbGRlcikge1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIuZXhlY3V0ZWQucGlwZShcbiAgICAgICAgICAgICAgICB0YWtlV2hpbGUoKCkgPT4gdGhpcy5pc0FsaXZlKVxuICAgICAgICAgICAgKS5zdWJzY3JpYmUoKHJlc3VsdFNldFBhZ2luZzogUmVzdWx0U2V0UGFnaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkRhdGFMb2FkZWQocmVzdWx0U2V0UGFnaW5nKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaFNlcnZpY2UuZGF0YUxvYWRlZC5uZXh0KHJlc3VsdFNldFBhZ2luZyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLmlzQWxpdmUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZVNlbGVjdGVkQnVja2V0cygpIHtcbiAgICAgICAgaWYgKHRoaXMucmVzcG9uc2VGYWNldHMpIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRCdWNrZXRzID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCBmaWVsZCBvZiB0aGlzLnJlc3BvbnNlRmFjZXRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkLmJ1Y2tldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEJ1Y2tldHMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnRoaXMucXVlcnlCdWlsZGVyLmdldFVzZXJGYWNldEJ1Y2tldHMoZmllbGQuZmllbGQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigoYnVja2V0KSA9PiBidWNrZXQuY2hlY2tlZClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKChidWNrZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgZmllbGQsIGJ1Y2tldCB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEJ1Y2tldHMgPSBbXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uVG9nZ2xlQnVja2V0KGV2ZW50OiBNYXRDaGVja2JveENoYW5nZSwgZmllbGQ6IEZhY2V0RmllbGQsIGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCkge1xuICAgICAgICBpZiAoZXZlbnQgJiYgYnVja2V0KSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQuY2hlY2tlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMudW5zZWxlY3RGYWNldEJ1Y2tldChmaWVsZCwgYnVja2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNlbGVjdEZhY2V0QnVja2V0KGZpZWxkOiBGYWNldEZpZWxkLCBidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpIHtcbiAgICAgICAgaWYgKGJ1Y2tldCkge1xuICAgICAgICAgICAgYnVja2V0LmNoZWNrZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIuYWRkVXNlckZhY2V0QnVja2V0KGZpZWxkLCBidWNrZXQpO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3RlZEJ1Y2tldHMoKTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdW5zZWxlY3RGYWNldEJ1Y2tldChmaWVsZDogRmFjZXRGaWVsZCwgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0KSB7XG4gICAgICAgIGlmIChidWNrZXQpIHtcbiAgICAgICAgICAgIGJ1Y2tldC5jaGVja2VkID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5QnVpbGRlci5yZW1vdmVVc2VyRmFjZXRCdWNrZXQoZmllbGQsIGJ1Y2tldCk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkQnVja2V0cygpO1xuICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIudXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjYW5SZXNldFNlbGVjdGVkQnVja2V0cyhmaWVsZDogRmFjZXRGaWVsZCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoZmllbGQgJiYgZmllbGQuYnVja2V0cykge1xuICAgICAgICAgICAgcmV0dXJuIGZpZWxkLmJ1Y2tldHMuaXRlbXMuc29tZSgoYnVja2V0KSA9PiBidWNrZXQuY2hlY2tlZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJlc2V0U2VsZWN0ZWRCdWNrZXRzKGZpZWxkOiBGYWNldEZpZWxkKSB7XG4gICAgICAgIGlmIChmaWVsZCAmJiBmaWVsZC5idWNrZXRzKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBidWNrZXQgb2YgZmllbGQuYnVja2V0cy5pdGVtcykge1xuICAgICAgICAgICAgICAgIGJ1Y2tldC5jaGVja2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5xdWVyeUJ1aWxkZXIucmVtb3ZlVXNlckZhY2V0QnVja2V0KGZpZWxkLCBidWNrZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3RlZEJ1Y2tldHMoKTtcbiAgICAgICAgICAgIHRoaXMucXVlcnlCdWlsZGVyLnVwZGF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2hvdWxkRXhwYW5kKGZpZWxkOiBGYWNldEZpZWxkKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBmaWVsZC50eXBlID09PSAncXVlcnknID8gdGhpcy5mYWNldFF1ZXJpZXNFeHBhbmRlZCA6IHRoaXMuZmFjZXRGaWVsZHNFeHBhbmRlZDtcbiAgICB9XG5cbiAgICBvbkRhdGFMb2FkZWQoZGF0YTogYW55KSB7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSBkYXRhLmxpc3QuY29udGV4dDtcblxuICAgICAgICBpZiAoY29udGV4dCkge1xuICAgICAgICAgICAgdGhpcy5wYXJzZUZhY2V0cyhjb250ZXh0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VGYWNldHMgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUZhY2V0cyhjb250ZXh0OiBSZXN1bHRTZXRDb250ZXh0KSB7XG4gICAgICAgIGlmICghdGhpcy5yZXNwb25zZUZhY2V0cykge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VGYWNldEZpZWxkcyA9IHRoaXMucGFyc2VGYWNldEZpZWxkcyhjb250ZXh0KTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlR3JvdXBlZEZhY2V0UXVlcmllcyA9IHRoaXMucGFyc2VGYWNldFF1ZXJpZXMoY29udGV4dCk7XG4gICAgICAgICAgICB0aGlzLnJlc3BvbnNlRmFjZXRzID0gcmVzcG9uc2VGYWNldEZpZWxkcy5jb25jYXQoLi4ucmVzcG9uc2VHcm91cGVkRmFjZXRRdWVyaWVzKTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZXNwb25zZUZhY2V0cyA9IHRoaXMucmVzcG9uc2VGYWNldHNcbiAgICAgICAgICAgICAgICAubWFwKChmaWVsZCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCByZXNwb25zZUZpZWxkID0gKGNvbnRleHQuZmFjZXRzIHx8IFtdKS5maW5kKChyZXNwb25zZSkgPT4gcmVzcG9uc2UubGFiZWwgPT09IGZpZWxkLmxhYmVsICYmIHJlc3BvbnNlLnR5cGUgPT09IGZpZWxkLnR5cGUpO1xuXG4gICAgICAgICAgICAgICAgICAgIChmaWVsZCAmJiBmaWVsZC5idWNrZXRzICYmIGZpZWxkLmJ1Y2tldHMuaXRlbXMgfHwgW10pXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKChidWNrZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZUJ1Y2tldCA9ICgocmVzcG9uc2VGaWVsZCAmJiByZXNwb25zZUZpZWxkLmJ1Y2tldHMpIHx8IFtdKS5maW5kKChyZXNwQnVja2V0KSA9PiByZXNwQnVja2V0LmxhYmVsID09PSBidWNrZXQubGFiZWwpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0LmNvdW50ID0gcmVzcG9uc2VCdWNrZXQgPyB0aGlzLmdldENvdW50VmFsdWUocmVzcG9uc2VCdWNrZXQpIDogMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnVja2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUZhY2V0RmllbGRzKGNvbnRleHQ6IFJlc3VsdFNldENvbnRleHQpOiBGYWNldEZpZWxkW10ge1xuICAgICAgICBjb25zdCBjb25maWdGYWNldEZpZWxkcyA9IHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldEZpZWxkcyAmJiB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRGaWVsZHMuZmllbGRzIHx8IFtdO1xuXG4gICAgICAgIHJldHVybiBjb25maWdGYWNldEZpZWxkcy5tYXAoKGZpZWxkKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUZpZWxkID0gKGNvbnRleHQuZmFjZXRzIHx8IFtdKS5maW5kKChyZXNwb25zZSkgPT4gcmVzcG9uc2UudHlwZSA9PT0gJ2ZpZWxkJyAmJiByZXNwb25zZS5sYWJlbCA9PT0gZmllbGQubGFiZWwpIHx8IHt9O1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VCdWNrZXRzID0gdGhpcy5nZXRSZXNwb25zZUJ1Y2tldHMocmVzcG9uc2VGaWVsZCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGJ1Y2tldExpc3QgPSBuZXcgU2VhcmNoRmlsdGVyTGlzdDxGYWNldEZpZWxkQnVja2V0PihyZXNwb25zZUJ1Y2tldHMsIGZpZWxkLnBhZ2VTaXplKTtcbiAgICAgICAgICAgIGJ1Y2tldExpc3QuZmlsdGVyID0gKGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCk6IGJvb2xlYW4gPT4ge1xuICAgICAgICAgICAgICAgIGlmIChidWNrZXQgJiYgYnVja2V0TGlzdC5maWx0ZXJUZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdHRlcm4gPSAoYnVja2V0TGlzdC5maWx0ZXJUZXh0IHx8ICcnKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9ICh0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5pbnN0YW50KGJ1Y2tldC5kaXNwbGF5KSB8fCB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5pbnN0YW50KGJ1Y2tldC5sYWJlbCkpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmlsdGVyV2l0aENvbnRhaW5zID8gbGFiZWwuaW5kZXhPZihwYXR0ZXJuKSAhPT0gLTEgOiBsYWJlbC5zdGFydHNXaXRoKHBhdHRlcm4pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHJldHVybiA8RmFjZXRGaWVsZD4ge1xuICAgICAgICAgICAgICAgIC4uLmZpZWxkLFxuICAgICAgICAgICAgICAgIHR5cGU6IHJlc3BvbnNlRmllbGQudHlwZSxcbiAgICAgICAgICAgICAgICBsYWJlbDogZmllbGQubGFiZWwsXG4gICAgICAgICAgICAgICAgcGFnZVNpemU6IGZpZWxkLnBhZ2VTaXplIHwgdGhpcy5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICAgICAgICBjdXJyZW50UGFnZVNpemU6IGZpZWxkLnBhZ2VTaXplIHwgdGhpcy5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICAgICAgICBidWNrZXRzOiBidWNrZXRMaXN0XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlRmFjZXRRdWVyaWVzKGNvbnRleHQ6IFJlc3VsdFNldENvbnRleHQpOiBGYWNldEZpZWxkW10ge1xuICAgICAgICBjb25zdCBjb25maWdGYWNldFF1ZXJpZXMgPSB0aGlzLnF1ZXJ5QnVpbGRlci5jb25maWcuZmFjZXRRdWVyaWVzICYmIHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMucXVlcmllcyB8fCBbXTtcbiAgICAgICAgY29uc3QgY29uZmlnR3JvdXBzID0gY29uZmlnRmFjZXRRdWVyaWVzLnJlZHVjZSgoYWNjLCBxdWVyeSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSB0aGlzLnF1ZXJ5QnVpbGRlci5nZXRRdWVyeUdyb3VwKHF1ZXJ5KTtcbiAgICAgICAgICAgIGlmIChhY2NbZ3JvdXBdKSB7XG4gICAgICAgICAgICAgICAgYWNjW2dyb3VwXS5wdXNoKHF1ZXJ5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYWNjW2dyb3VwXSA9IFtxdWVyeV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LCBbXSk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XG5cbiAgICAgICAgT2JqZWN0LmtleXMoY29uZmlnR3JvdXBzKS5mb3JFYWNoKChncm91cCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VGaWVsZCA9IChjb250ZXh0LmZhY2V0cyB8fCBbXSkuZmluZCgocmVzcG9uc2UpID0+IHJlc3BvbnNlLnR5cGUgPT09ICdxdWVyeScgJiYgcmVzcG9uc2UubGFiZWwgPT09IGdyb3VwKSB8fCB7fTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlQnVja2V0cyA9IHRoaXMuZ2V0UmVzcG9uc2VRdWVyeUJ1Y2tldHMocmVzcG9uc2VGaWVsZCwgY29uZmlnR3JvdXBzW2dyb3VwXSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGJ1Y2tldExpc3QgPSBuZXcgU2VhcmNoRmlsdGVyTGlzdDxGYWNldEZpZWxkQnVja2V0PihyZXNwb25zZUJ1Y2tldHMsIHRoaXMuZmFjZXRRdWVyaWVzUGFnZVNpemUpO1xuICAgICAgICAgICAgYnVja2V0TGlzdC5maWx0ZXIgPSAoYnVja2V0OiBGYWNldEZpZWxkQnVja2V0KTogYm9vbGVhbiA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGJ1Y2tldCAmJiBidWNrZXRMaXN0LmZpbHRlclRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGF0dGVybiA9IChidWNrZXRMaXN0LmZpbHRlclRleHQgfHwgJycpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gKHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmluc3RhbnQoYnVja2V0LmRpc3BsYXkpIHx8IHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmluc3RhbnQoYnVja2V0LmxhYmVsKSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5maWx0ZXJXaXRoQ29udGFpbnMgPyBsYWJlbC5pbmRleE9mKHBhdHRlcm4pICE9PSAtMSA6IGxhYmVsLnN0YXJ0c1dpdGgocGF0dGVybik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcmVzdWx0LnB1c2goPEZhY2V0RmllbGQ+IHtcbiAgICAgICAgICAgICAgICBmaWVsZDogZ3JvdXAsXG4gICAgICAgICAgICAgICAgdHlwZTogcmVzcG9uc2VGaWVsZC50eXBlLFxuICAgICAgICAgICAgICAgIGxhYmVsOiBncm91cCxcbiAgICAgICAgICAgICAgICBwYWdlU2l6ZTogdGhpcy5ERUZBVUxUX1BBR0VfU0laRSxcbiAgICAgICAgICAgICAgICBjdXJyZW50UGFnZVNpemU6IHRoaXMuREVGQVVMVF9QQUdFX1NJWkUsXG4gICAgICAgICAgICAgICAgYnVja2V0czogYnVja2V0TGlzdFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSZXNwb25zZUJ1Y2tldHMocmVzcG9uc2VGaWVsZDogR2VuZXJpY0ZhY2V0UmVzcG9uc2UpOiBGYWNldEZpZWxkQnVja2V0W10ge1xuICAgICAgICByZXR1cm4gKChyZXNwb25zZUZpZWxkICYmIHJlc3BvbnNlRmllbGQuYnVja2V0cykgfHwgW10pLm1hcCgocmVzcEJ1Y2tldCkgPT4ge1xuXG4gICAgICAgICAgICByZXNwQnVja2V0Wydjb3VudCddID0gdGhpcy5nZXRDb3VudFZhbHVlKHJlc3BCdWNrZXQpO1xuICAgICAgICAgICAgcmV0dXJuIDxGYWNldEZpZWxkQnVja2V0PiB7XG4gICAgICAgICAgICAgICAgLi4ucmVzcEJ1Y2tldCxcbiAgICAgICAgICAgICAgICBjaGVja2VkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBkaXNwbGF5OiByZXNwQnVja2V0LmRpc3BsYXksXG4gICAgICAgICAgICAgICAgbGFiZWw6IHJlc3BCdWNrZXQubGFiZWxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UmVzcG9uc2VRdWVyeUJ1Y2tldHMocmVzcG9uc2VGaWVsZDogR2VuZXJpY0ZhY2V0UmVzcG9uc2UsIGNvbmZpZ0dyb3VwOiBhbnkpOiBGYWNldEZpZWxkQnVja2V0W10ge1xuICAgICAgICByZXR1cm4gKGNvbmZpZ0dyb3VwIHx8IFtdKS5tYXAoKHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwQnVja2V0ID0gKChyZXNwb25zZUZpZWxkICYmIHJlc3BvbnNlRmllbGQuYnVja2V0cykgfHwgW10pXG4gICAgICAgICAgICAgICAgLmZpbmQoKGJ1Y2tldCkgPT4gYnVja2V0LmxhYmVsID09PSBxdWVyeS5sYWJlbCk7XG5cbiAgICAgICAgICAgIHJlc3BCdWNrZXRbJ2NvdW50J10gPSB0aGlzLmdldENvdW50VmFsdWUocmVzcEJ1Y2tldCk7XG4gICAgICAgICAgICByZXR1cm4gPEZhY2V0RmllbGRCdWNrZXQ+IHtcbiAgICAgICAgICAgICAgICAuLi5yZXNwQnVja2V0LFxuICAgICAgICAgICAgICAgIGNoZWNrZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGRpc3BsYXk6IHJlc3BCdWNrZXQuZGlzcGxheSxcbiAgICAgICAgICAgICAgICBsYWJlbDogcmVzcEJ1Y2tldC5sYWJlbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSkuZmlsdGVyKChidWNrZXQpID0+IHtcbiAgICAgICAgICAgIGxldCBtaW5jb3VudCA9IHRoaXMucXVlcnlCdWlsZGVyLmNvbmZpZy5mYWNldFF1ZXJpZXMubWluY291bnQ7XG4gICAgICAgICAgICBpZiAobWluY291bnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBtaW5jb3VudCA9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYnVja2V0LmNvdW50ID49IG1pbmNvdW50O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENvdW50VmFsdWUoYnVja2V0OiBHZW5lcmljQnVja2V0KTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuICghIWJ1Y2tldCAmJiAhIWJ1Y2tldC5tZXRyaWNzICYmIGJ1Y2tldC5tZXRyaWNzWzBdICYmIGJ1Y2tldC5tZXRyaWNzWzBdLnZhbHVlICYmIGJ1Y2tldC5tZXRyaWNzWzBdLnZhbHVlLmNvdW50KVxuICAgICAgICAgICAgfHwgMDtcbiAgICB9XG59XG4iXX0=