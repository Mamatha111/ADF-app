/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { AlfrescoApiService, AppConfigService } from '@alfresco/adf-core';
import { RequestSortDefinitionInner } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class SearchQueryBuilderService {
    /**
     * @param {?} appConfig
     * @param {?} alfrescoApiService
     */
    constructor(appConfig, alfrescoApiService) {
        this.appConfig = appConfig;
        this.alfrescoApiService = alfrescoApiService;
        this._userQuery = '';
        this.updated = new Subject();
        this.executed = new Subject();
        this.categories = [];
        this.queryFragments = {};
        this.filterQueries = [];
        this.paging = null;
        this.sorting = [];
        this.userFacetBuckets = {};
        // TODO: to be supported in future iterations
        this.ranges = {};
        this.resetToDefaults();
    }
    /**
     * @return {?}
     */
    get userQuery() {
        return this._userQuery;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set userQuery(value) {
        value = (value || '').trim();
        this._userQuery = value ? `(${value})` : '';
    }
    /**
     * Resets the query to the defaults specified in the app config.
     * @return {?}
     */
    resetToDefaults() {
        /** @type {?} */
        const template = this.appConfig.get('search');
        if (template) {
            this.config = JSON.parse(JSON.stringify(template));
            this.categories = (this.config.categories || []).filter((category) => category.enabled);
            this.filterQueries = this.config.filterQueries || [];
            this.userFacetBuckets = {};
            if (this.config.sorting) {
                this.sorting = this.config.sorting.defaults || [];
            }
        }
    }
    /**
     * Adds a facet bucket to a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to add
     * @return {?}
     */
    addUserFacetBucket(field, bucket) {
        if (field && field.field && bucket) {
            /** @type {?} */
            const buckets = this.userFacetBuckets[field.field] || [];
            /** @type {?} */
            const existing = buckets.find((facetBucket) => facetBucket.label === bucket.label);
            if (!existing) {
                buckets.push(bucket);
            }
            this.userFacetBuckets[field.field] = buckets;
        }
    }
    /**
     * Gets the buckets currently added to a field
     * @param {?} field The target fields
     * @return {?} Bucket array
     */
    getUserFacetBuckets(field) {
        return this.userFacetBuckets[field] || [];
    }
    /**
     * Removes an existing bucket from a field.
     * @param {?} field The target field
     * @param {?} bucket Bucket to remove
     * @return {?}
     */
    removeUserFacetBucket(field, bucket) {
        if (field && field.field && bucket) {
            /** @type {?} */
            const buckets = this.userFacetBuckets[field.field] || [];
            this.userFacetBuckets[field.field] = buckets
                .filter((facetBucket) => facetBucket.label !== bucket.label);
        }
    }
    /**
     * Adds a filter query to the current query.
     * @param {?} query Query string to add
     * @return {?}
     */
    addFilterQuery(query) {
        if (query) {
            /** @type {?} */
            const existing = this.filterQueries.find((filterQuery) => filterQuery.query === query);
            if (!existing) {
                this.filterQueries.push({ query: query });
            }
        }
    }
    /**
     * Removes an existing filter query.
     * @param {?} query The query to remove
     * @return {?}
     */
    removeFilterQuery(query) {
        if (query) {
            this.filterQueries = this.filterQueries
                .filter((filterQuery) => filterQuery.query !== query);
        }
    }
    /**
     * Gets a facet query by label.
     * @param {?} label Label of the query
     * @return {?} Facet query data
     */
    getFacetQuery(label) {
        if (label && this.hasFacetQueries) {
            /** @type {?} */
            const result = this.config.facetQueries.queries.find((query) => query.label === label);
            if (result) {
                return Object.assign({}, result);
            }
        }
        return null;
    }
    /**
     * Gets a facet field by label.
     * @param {?} label Label of the facet field
     * @return {?} Facet field data
     */
    getFacetField(label) {
        if (label) {
            /** @type {?} */
            const fields = this.config.facetFields.fields || [];
            /** @type {?} */
            const result = fields.find((field) => field.label === label);
            if (result) {
                return Object.assign({}, result);
            }
        }
        return null;
    }
    /**
     * Builds the current query and triggers the `updated` event.
     * @return {?}
     */
    update() {
        /** @type {?} */
        const query = this.buildQuery();
        this.updated.next(query);
    }
    /**
     * Builds and executes the current query.
     * @return {?} Nothing
     */
    execute() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const query = this.buildQuery();
            if (query) {
                /** @type {?} */
                const resultSetPaging = yield this.alfrescoApiService.searchApi.search(query);
                this.executed.next(resultSetPaging);
            }
        });
    }
    /**
     * Builds the current query.
     * @return {?} The finished query
     */
    buildQuery() {
        /** @type {?} */
        let query = this.getFinalQuery();
        /** @type {?} */
        const include = this.config.include || [];
        if (include.length === 0) {
            include.push('path', 'allowableOperations');
        }
        if (query) {
            /** @type {?} */
            const result = (/** @type {?} */ ({
                query: {
                    query: query,
                    language: 'afts'
                },
                include: include,
                paging: this.paging,
                fields: this.config.fields,
                filterQueries: this.filterQueries,
                facetQueries: this.facetQueries,
                facetFields: this.facetFields,
                sort: this.sort
            }));
            result['facetFormat'] = 'V2';
            return result;
        }
        return null;
    }
    /**
     * Gets the primary sorting definition.
     * @return {?} The primary sorting definition
     */
    getPrimarySorting() {
        if (this.sorting && this.sorting.length > 0) {
            return this.sorting[0];
        }
        return null;
    }
    /**
     * Gets all pre-configured sorting options that users can choose from.
     * @return {?} Pre-configured sorting options
     */
    getSortingOptions() {
        if (this.config && this.config.sorting) {
            return this.config.sorting.options || [];
        }
        return [];
    }
    /**
     * Gets the query group.
     * @param {?} query Target query
     * @return {?} Query group
     */
    getQueryGroup(query) {
        return query.group || this.config.facetQueries.label || 'Facet Queries';
    }
    /**
     * Checks if FacetQueries has been defined
     * @return {?} True if defined, false otherwise
     */
    get hasFacetQueries() {
        if (this.config
            && this.config.facetQueries
            && this.config.facetQueries.queries
            && this.config.facetQueries.queries.length > 0) {
            return true;
        }
        return false;
    }
    /**
     * @protected
     * @return {?}
     */
    get sort() {
        return this.sorting.map((def) => {
            return new RequestSortDefinitionInner({
                type: def.type,
                field: def.field,
                ascending: def.ascending
            });
        });
    }
    /**
     * @protected
     * @return {?}
     */
    get facetQueries() {
        if (this.hasFacetQueries) {
            return this.config.facetQueries.queries.map((query) => {
                query.group = this.getQueryGroup(query);
                return (/** @type {?} */ (Object.assign({}, query)));
            });
        }
        return null;
    }
    /**
     * @protected
     * @return {?}
     */
    getFinalQuery() {
        /** @type {?} */
        let query = '';
        this.categories.forEach((facet) => {
            /** @type {?} */
            const customQuery = this.queryFragments[facet.id];
            if (customQuery) {
                if (query.length > 0) {
                    query += ' AND ';
                }
                query += `(${customQuery})`;
            }
        });
        /** @type {?} */
        let result = [this.userQuery, query]
            .filter((entry) => entry)
            .join(' AND ');
        if (this.userFacetBuckets) {
            Object.keys(this.userFacetBuckets).forEach((key) => {
                /** @type {?} */
                const subQuery = (this.userFacetBuckets[key] || [])
                    .map((bucket) => bucket.filterQuery)
                    .join(' OR ');
                if (subQuery) {
                    if (result.length > 0) {
                        result += ' AND ';
                    }
                    result += `(${subQuery})`;
                }
            });
        }
        return result;
    }
    /**
     * @protected
     * @return {?}
     */
    get facetFields() {
        /** @type {?} */
        const facetFields = this.config.facetFields && this.config.facetFields.fields;
        if (facetFields && facetFields.length > 0) {
            return {
                facets: facetFields.map((facet) => (/** @type {?} */ ({
                    field: facet.field,
                    mincount: facet.mincount,
                    label: facet.label,
                    limit: facet.limit,
                    offset: facet.offset,
                    prefix: facet.prefix
                })))
            };
        }
        return null;
    }
}
SearchQueryBuilderService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
SearchQueryBuilderService.ctorParameters = () => [
    { type: AppConfigService },
    { type: AlfrescoApiService }
];
/** @nocollapse */ SearchQueryBuilderService.ngInjectableDef = i0.defineInjectable({ factory: function SearchQueryBuilderService_Factory() { return new SearchQueryBuilderService(i0.inject(i1.AppConfigService), i0.inject(i1.AlfrescoApiService)); }, token: SearchQueryBuilderService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype._userQuery;
    /** @type {?} */
    SearchQueryBuilderService.prototype.updated;
    /** @type {?} */
    SearchQueryBuilderService.prototype.executed;
    /** @type {?} */
    SearchQueryBuilderService.prototype.categories;
    /** @type {?} */
    SearchQueryBuilderService.prototype.queryFragments;
    /** @type {?} */
    SearchQueryBuilderService.prototype.filterQueries;
    /** @type {?} */
    SearchQueryBuilderService.prototype.paging;
    /** @type {?} */
    SearchQueryBuilderService.prototype.sorting;
    /**
     * @type {?}
     * @protected
     */
    SearchQueryBuilderService.prototype.userFacetBuckets;
    /** @type {?} */
    SearchQueryBuilderService.prototype.config;
    /** @type {?} */
    SearchQueryBuilderService.prototype.ranges;
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype.appConfig;
    /**
     * @type {?}
     * @private
     */
    SearchQueryBuilderService.prototype.alfrescoApiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXF1ZXJ5LWJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29udGVudC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNlYXJjaC9zZWFyY2gtcXVlcnktYnVpbGRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDMUUsT0FBTyxFQUlILDBCQUEwQixFQUU3QixNQUFNLGtCQUFrQixDQUFDOzs7QUFhMUIsTUFBTSxPQUFPLHlCQUF5Qjs7Ozs7SUE2QmxDLFlBQW9CLFNBQTJCLEVBQVUsa0JBQXNDO1FBQTNFLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQVUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQTNCdkYsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUV4QixZQUFPLEdBQXVCLElBQUksT0FBTyxFQUFFLENBQUM7UUFDNUMsYUFBUSxHQUE2QixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRW5ELGVBQVUsR0FBMEIsRUFBRSxDQUFDO1FBQ3ZDLG1CQUFjLEdBQTZCLEVBQUUsQ0FBQztRQUM5QyxrQkFBYSxHQUFrQixFQUFFLENBQUM7UUFDbEMsV0FBTSxHQUE4QyxJQUFJLENBQUM7UUFDekQsWUFBTyxHQUFtQyxFQUFFLENBQUM7UUFFbkMscUJBQWdCLEdBQStDLEVBQUUsQ0FBQzs7UUFjNUUsV0FBTSxHQUFrQyxFQUFFLENBQUM7UUFHdkMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzNCLENBQUM7Ozs7SUFoQkQsSUFBSSxTQUFTO1FBQ1QsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQzNCLENB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QW1EOztJQUVuRCwrQ0FBdUM7O0lBQ3ZDLG1EQUE4Qzs7SUFDOUMsa0RBQWtDOztJQUNsQywyQ0FBeUQ7O0lBQ3pELDRDQUE2Qzs7Ozs7SUFFN0MscURBQTRFOztJQVc1RSwyQ0FBNEI7O0lBRzVCLDJDQUEyQzs7Ozs7SUFFL0IsOENBQW1DOzs7OztJQUFFLHVEQUE4QyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgQXBwQ29uZmlnU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQge1xuICAgIFF1ZXJ5Qm9keSxcbiAgICBSZXF1ZXN0RmFjZXRGaWVsZHMsXG4gICAgUmVxdWVzdEZhY2V0RmllbGQsXG4gICAgUmVxdWVzdFNvcnREZWZpbml0aW9uSW5uZXIsXG4gICAgUmVzdWx0U2V0UGFnaW5nXG59IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgU2VhcmNoQ2F0ZWdvcnkgfSBmcm9tICcuL3NlYXJjaC1jYXRlZ29yeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRmlsdGVyUXVlcnkgfSBmcm9tICcuL2ZpbHRlci1xdWVyeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU2VhcmNoUmFuZ2UgfSBmcm9tICcuL3NlYXJjaC1yYW5nZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU2VhcmNoQ29uZmlndXJhdGlvbiB9IGZyb20gJy4vc2VhcmNoLWNvbmZpZ3VyYXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEZhY2V0UXVlcnkgfSBmcm9tICcuL2ZhY2V0LXF1ZXJ5LmludGVyZmFjZSc7XG5pbXBvcnQgeyBTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbiB9IGZyb20gJy4vc2VhcmNoLXNvcnRpbmctZGVmaW5pdGlvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRmFjZXRGaWVsZCB9IGZyb20gJy4vZmFjZXQtZmllbGQuaW50ZXJmYWNlJztcbmltcG9ydCB7IEZhY2V0RmllbGRCdWNrZXQgfSBmcm9tICcuL2ZhY2V0LWZpZWxkLWJ1Y2tldC5pbnRlcmZhY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFNlYXJjaFF1ZXJ5QnVpbGRlclNlcnZpY2Uge1xuXG4gICAgcHJpdmF0ZSBfdXNlclF1ZXJ5ID0gJyc7XG5cbiAgICB1cGRhdGVkOiBTdWJqZWN0PFF1ZXJ5Qm9keT4gPSBuZXcgU3ViamVjdCgpO1xuICAgIGV4ZWN1dGVkOiBTdWJqZWN0PFJlc3VsdFNldFBhZ2luZz4gPSBuZXcgU3ViamVjdCgpO1xuXG4gICAgY2F0ZWdvcmllczogQXJyYXk8U2VhcmNoQ2F0ZWdvcnk+ID0gW107XG4gICAgcXVlcnlGcmFnbWVudHM6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuICAgIGZpbHRlclF1ZXJpZXM6IEZpbHRlclF1ZXJ5W10gPSBbXTtcbiAgICBwYWdpbmc6IHsgbWF4SXRlbXM/OiBudW1iZXI7IHNraXBDb3VudD86IG51bWJlciB9ID0gbnVsbDtcbiAgICBzb3J0aW5nOiBBcnJheTxTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbj4gPSBbXTtcblxuICAgIHByb3RlY3RlZCB1c2VyRmFjZXRCdWNrZXRzOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PEZhY2V0RmllbGRCdWNrZXQ+IH0gPSB7fTtcblxuICAgIGdldCB1c2VyUXVlcnkoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VzZXJRdWVyeTtcbiAgICB9XG5cbiAgICBzZXQgdXNlclF1ZXJ5KHZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgdmFsdWUgPSAodmFsdWUgfHwgJycpLnRyaW0oKTtcbiAgICAgICAgdGhpcy5fdXNlclF1ZXJ5ID0gdmFsdWUgPyBgKCR7dmFsdWV9KWAgOiAnJztcbiAgICB9XG5cbiAgICBjb25maWc6IFNlYXJjaENvbmZpZ3VyYXRpb247XG5cbiAgICAvLyBUT0RPOiB0byBiZSBzdXBwb3J0ZWQgaW4gZnV0dXJlIGl0ZXJhdGlvbnNcbiAgICByYW5nZXM6IHsgW2lkOiBzdHJpbmddOiBTZWFyY2hSYW5nZSB9ID0ge307XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcENvbmZpZzogQXBwQ29uZmlnU2VydmljZSwgcHJpdmF0ZSBhbGZyZXNjb0FwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSkge1xuICAgICAgICB0aGlzLnJlc2V0VG9EZWZhdWx0cygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlc2V0cyB0aGUgcXVlcnkgdG8gdGhlIGRlZmF1bHRzIHNwZWNpZmllZCBpbiB0aGUgYXBwIGNvbmZpZy5cbiAgICAgKi9cbiAgICByZXNldFRvRGVmYXVsdHMoKSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5hcHBDb25maWcuZ2V0PFNlYXJjaENvbmZpZ3VyYXRpb24+KCdzZWFyY2gnKTtcbiAgICAgICAgaWYgKHRlbXBsYXRlKSB7XG4gICAgICAgICAgICB0aGlzLmNvbmZpZyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGVtcGxhdGUpKTtcbiAgICAgICAgICAgIHRoaXMuY2F0ZWdvcmllcyA9ICh0aGlzLmNvbmZpZy5jYXRlZ29yaWVzIHx8IFtdKS5maWx0ZXIoKGNhdGVnb3J5KSA9PiBjYXRlZ29yeS5lbmFibGVkKTtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUXVlcmllcyA9IHRoaXMuY29uZmlnLmZpbHRlclF1ZXJpZXMgfHwgW107XG4gICAgICAgICAgICB0aGlzLnVzZXJGYWNldEJ1Y2tldHMgPSB7fTtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy5zb3J0aW5nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zb3J0aW5nID0gdGhpcy5jb25maWcuc29ydGluZy5kZWZhdWx0cyB8fCBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBmYWNldCBidWNrZXQgdG8gYSBmaWVsZC5cbiAgICAgKiBAcGFyYW0gZmllbGQgVGhlIHRhcmdldCBmaWVsZFxuICAgICAqIEBwYXJhbSBidWNrZXQgQnVja2V0IHRvIGFkZFxuICAgICAqL1xuICAgIGFkZFVzZXJGYWNldEJ1Y2tldChmaWVsZDogRmFjZXRGaWVsZCwgYnVja2V0OiBGYWNldEZpZWxkQnVja2V0KSB7XG4gICAgICAgIGlmIChmaWVsZCAmJiBmaWVsZC5maWVsZCAmJiBidWNrZXQpIHtcbiAgICAgICAgICAgIGNvbnN0IGJ1Y2tldHMgPSB0aGlzLnVzZXJGYWNldEJ1Y2tldHNbZmllbGQuZmllbGRdIHx8IFtdO1xuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBidWNrZXRzLmZpbmQoKGZhY2V0QnVja2V0KSA9PiBmYWNldEJ1Y2tldC5sYWJlbCA9PT0gYnVja2V0LmxhYmVsKTtcbiAgICAgICAgICAgIGlmICghZXhpc3RpbmcpIHtcbiAgICAgICAgICAgICAgICBidWNrZXRzLnB1c2goYnVja2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZC5maWVsZF0gPSBidWNrZXRzO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgYnVja2V0cyBjdXJyZW50bHkgYWRkZWQgdG8gYSBmaWVsZFxuICAgICAqIEBwYXJhbSBmaWVsZCBUaGUgdGFyZ2V0IGZpZWxkc1xuICAgICAqIEByZXR1cm5zIEJ1Y2tldCBhcnJheVxuICAgICAqL1xuICAgIGdldFVzZXJGYWNldEJ1Y2tldHMoZmllbGQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy51c2VyRmFjZXRCdWNrZXRzW2ZpZWxkXSB8fCBbXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmVzIGFuIGV4aXN0aW5nIGJ1Y2tldCBmcm9tIGEgZmllbGQuXG4gICAgICogQHBhcmFtIGZpZWxkIFRoZSB0YXJnZXQgZmllbGRcbiAgICAgKiBAcGFyYW0gYnVja2V0IEJ1Y2tldCB0byByZW1vdmVcbiAgICAgKi9cbiAgICByZW1vdmVVc2VyRmFjZXRCdWNrZXQoZmllbGQ6IEZhY2V0RmllbGQsIGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCkge1xuICAgICAgICBpZiAoZmllbGQgJiYgZmllbGQuZmllbGQgJiYgYnVja2V0KSB7XG4gICAgICAgICAgICBjb25zdCBidWNrZXRzID0gdGhpcy51c2VyRmFjZXRCdWNrZXRzW2ZpZWxkLmZpZWxkXSB8fCBbXTtcbiAgICAgICAgICAgIHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZC5maWVsZF0gPSBidWNrZXRzXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoZmFjZXRCdWNrZXQpID0+IGZhY2V0QnVja2V0LmxhYmVsICE9PSBidWNrZXQubGFiZWwpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGZpbHRlciBxdWVyeSB0byB0aGUgY3VycmVudCBxdWVyeS5cbiAgICAgKiBAcGFyYW0gcXVlcnkgUXVlcnkgc3RyaW5nIHRvIGFkZFxuICAgICAqL1xuICAgIGFkZEZpbHRlclF1ZXJ5KHF1ZXJ5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuZmlsdGVyUXVlcmllcy5maW5kKChmaWx0ZXJRdWVyeSkgPT4gZmlsdGVyUXVlcnkucXVlcnkgPT09IHF1ZXJ5KTtcbiAgICAgICAgICAgIGlmICghZXhpc3RpbmcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlclF1ZXJpZXMucHVzaCh7IHF1ZXJ5OiBxdWVyeSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgYW4gZXhpc3RpbmcgZmlsdGVyIHF1ZXJ5LlxuICAgICAqIEBwYXJhbSBxdWVyeSBUaGUgcXVlcnkgdG8gcmVtb3ZlXG4gICAgICovXG4gICAgcmVtb3ZlRmlsdGVyUXVlcnkocXVlcnk6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUXVlcmllcyA9IHRoaXMuZmlsdGVyUXVlcmllc1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGZpbHRlclF1ZXJ5KSA9PiBmaWx0ZXJRdWVyeS5xdWVyeSAhPT0gcXVlcnkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGZhY2V0IHF1ZXJ5IGJ5IGxhYmVsLlxuICAgICAqIEBwYXJhbSBsYWJlbCBMYWJlbCBvZiB0aGUgcXVlcnlcbiAgICAgKiBAcmV0dXJucyBGYWNldCBxdWVyeSBkYXRhXG4gICAgICovXG4gICAgZ2V0RmFjZXRRdWVyeShsYWJlbDogc3RyaW5nKTogRmFjZXRRdWVyeSB7XG4gICAgICAgIGlmIChsYWJlbCAmJiB0aGlzLmhhc0ZhY2V0UXVlcmllcykge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzLnF1ZXJpZXMuZmluZCgocXVlcnkpID0+IHF1ZXJ5LmxhYmVsID09PSBsYWJlbCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgLi4ucmVzdWx0IH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGZhY2V0IGZpZWxkIGJ5IGxhYmVsLlxuICAgICAqIEBwYXJhbSBsYWJlbCBMYWJlbCBvZiB0aGUgZmFjZXQgZmllbGRcbiAgICAgKiBAcmV0dXJucyBGYWNldCBmaWVsZCBkYXRhXG4gICAgICovXG4gICAgZ2V0RmFjZXRGaWVsZChsYWJlbDogc3RyaW5nKTogRmFjZXRGaWVsZCB7XG4gICAgICAgIGlmIChsYWJlbCkge1xuICAgICAgICAgICAgY29uc3QgZmllbGRzID0gdGhpcy5jb25maWcuZmFjZXRGaWVsZHMuZmllbGRzIHx8IFtdO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZmllbGRzLmZpbmQoKGZpZWxkKSA9PiBmaWVsZC5sYWJlbCA9PT0gbGFiZWwpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLnJlc3VsdCB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkcyB0aGUgY3VycmVudCBxdWVyeSBhbmQgdHJpZ2dlcnMgdGhlIGB1cGRhdGVkYCBldmVudC5cbiAgICAgKi9cbiAgICB1cGRhdGUoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5idWlsZFF1ZXJ5KCk7XG4gICAgICAgIHRoaXMudXBkYXRlZC5uZXh0KHF1ZXJ5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCdWlsZHMgYW5kIGV4ZWN1dGVzIHRoZSBjdXJyZW50IHF1ZXJ5LlxuICAgICAqIEByZXR1cm5zIE5vdGhpbmdcbiAgICAgKi9cbiAgICBhc3luYyBleGVjdXRlKCkge1xuICAgICAgICBjb25zdCBxdWVyeSA9IHRoaXMuYnVpbGRRdWVyeSgpO1xuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdFNldFBhZ2luZzogUmVzdWx0U2V0UGFnaW5nID0gYXdhaXQgdGhpcy5hbGZyZXNjb0FwaVNlcnZpY2Uuc2VhcmNoQXBpLnNlYXJjaChxdWVyeSk7XG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGVkLm5leHQocmVzdWx0U2V0UGFnaW5nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkcyB0aGUgY3VycmVudCBxdWVyeS5cbiAgICAgKiBAcmV0dXJucyBUaGUgZmluaXNoZWQgcXVlcnlcbiAgICAgKi9cbiAgICBidWlsZFF1ZXJ5KCk6IFF1ZXJ5Qm9keSB7XG4gICAgICAgIGxldCBxdWVyeSA9IHRoaXMuZ2V0RmluYWxRdWVyeSgpO1xuXG4gICAgICAgIGNvbnN0IGluY2x1ZGUgPSB0aGlzLmNvbmZpZy5pbmNsdWRlIHx8IFtdO1xuICAgICAgICBpZiAoaW5jbHVkZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGluY2x1ZGUucHVzaCgncGF0aCcsICdhbGxvd2FibGVPcGVyYXRpb25zJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogUXVlcnlCb2R5ID0gPFF1ZXJ5Qm9keT4ge1xuICAgICAgICAgICAgICAgIHF1ZXJ5OiB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSxcbiAgICAgICAgICAgICAgICAgICAgbGFuZ3VhZ2U6ICdhZnRzJ1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaW5jbHVkZTogaW5jbHVkZSxcbiAgICAgICAgICAgICAgICBwYWdpbmc6IHRoaXMucGFnaW5nLFxuICAgICAgICAgICAgICAgIGZpZWxkczogdGhpcy5jb25maWcuZmllbGRzLFxuICAgICAgICAgICAgICAgIGZpbHRlclF1ZXJpZXM6IHRoaXMuZmlsdGVyUXVlcmllcyxcbiAgICAgICAgICAgICAgICBmYWNldFF1ZXJpZXM6IHRoaXMuZmFjZXRRdWVyaWVzLFxuICAgICAgICAgICAgICAgIGZhY2V0RmllbGRzOiB0aGlzLmZhY2V0RmllbGRzLFxuICAgICAgICAgICAgICAgIHNvcnQ6IHRoaXMuc29ydFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcmVzdWx0WydmYWNldEZvcm1hdCddID0gJ1YyJztcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBwcmltYXJ5IHNvcnRpbmcgZGVmaW5pdGlvbi5cbiAgICAgKiBAcmV0dXJucyBUaGUgcHJpbWFyeSBzb3J0aW5nIGRlZmluaXRpb25cbiAgICAgKi9cbiAgICBnZXRQcmltYXJ5U29ydGluZygpOiBTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbiB7XG4gICAgICAgIGlmICh0aGlzLnNvcnRpbmcgJiYgdGhpcy5zb3J0aW5nLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNvcnRpbmdbMF07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgcHJlLWNvbmZpZ3VyZWQgc29ydGluZyBvcHRpb25zIHRoYXQgdXNlcnMgY2FuIGNob29zZSBmcm9tLlxuICAgICAqIEByZXR1cm5zIFByZS1jb25maWd1cmVkIHNvcnRpbmcgb3B0aW9uc1xuICAgICAqL1xuICAgIGdldFNvcnRpbmdPcHRpb25zKCk6IFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uW10ge1xuICAgICAgICBpZiAodGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcuc29ydGluZykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLnNvcnRpbmcub3B0aW9ucyB8fCBbXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgcXVlcnkgZ3JvdXAuXG4gICAgICogQHBhcmFtIHF1ZXJ5IFRhcmdldCBxdWVyeVxuICAgICAqIEByZXR1cm5zIFF1ZXJ5IGdyb3VwXG4gICAgICovXG4gICAgZ2V0UXVlcnlHcm91cChxdWVyeSkge1xuICAgICAgICByZXR1cm4gcXVlcnkuZ3JvdXAgfHwgdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzLmxhYmVsIHx8ICdGYWNldCBRdWVyaWVzJztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgRmFjZXRRdWVyaWVzIGhhcyBiZWVuIGRlZmluZWRcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIGRlZmluZWQsIGZhbHNlIG90aGVyd2lzZVxuICAgICAqL1xuICAgIGdldCBoYXNGYWNldFF1ZXJpZXMoKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZ1xuICAgICAgICAgICAgJiYgdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzXG4gICAgICAgICAgICAmJiB0aGlzLmNvbmZpZy5mYWNldFF1ZXJpZXMucXVlcmllc1xuICAgICAgICAgICAgJiYgdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzLnF1ZXJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXQgc29ydCgpOiBSZXF1ZXN0U29ydERlZmluaXRpb25Jbm5lcltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc29ydGluZy5tYXAoKGRlZikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZXF1ZXN0U29ydERlZmluaXRpb25Jbm5lcih7XG4gICAgICAgICAgICAgICAgdHlwZTogZGVmLnR5cGUsXG4gICAgICAgICAgICAgICAgZmllbGQ6IGRlZi5maWVsZCxcbiAgICAgICAgICAgICAgICBhc2NlbmRpbmc6IGRlZi5hc2NlbmRpbmdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IGZhY2V0UXVlcmllcygpOiBGYWNldFF1ZXJ5W10ge1xuICAgICAgICBpZiAodGhpcy5oYXNGYWNldFF1ZXJpZXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5mYWNldFF1ZXJpZXMucXVlcmllcy5tYXAoKHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgcXVlcnkuZ3JvdXAgPSB0aGlzLmdldFF1ZXJ5R3JvdXAocXVlcnkpO1xuICAgICAgICAgICAgICAgIHJldHVybiA8RmFjZXRRdWVyeT4geyAuLi5xdWVyeSB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0RmluYWxRdWVyeSgpOiBzdHJpbmcge1xuICAgICAgICBsZXQgcXVlcnkgPSAnJztcblxuICAgICAgICB0aGlzLmNhdGVnb3JpZXMuZm9yRWFjaCgoZmFjZXQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbVF1ZXJ5ID0gdGhpcy5xdWVyeUZyYWdtZW50c1tmYWNldC5pZF07XG4gICAgICAgICAgICBpZiAoY3VzdG9tUXVlcnkpIHtcbiAgICAgICAgICAgICAgICBpZiAocXVlcnkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeSArPSAnIEFORCAnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBxdWVyeSArPSBgKCR7Y3VzdG9tUXVlcnl9KWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCByZXN1bHQgPSBbdGhpcy51c2VyUXVlcnksIHF1ZXJ5XVxuICAgICAgICAgICAgLmZpbHRlcigoZW50cnkpID0+IGVudHJ5KVxuICAgICAgICAgICAgLmpvaW4oJyBBTkQgJyk7XG5cbiAgICAgICAgaWYgKHRoaXMudXNlckZhY2V0QnVja2V0cykge1xuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy51c2VyRmFjZXRCdWNrZXRzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJRdWVyeSA9ICh0aGlzLnVzZXJGYWNldEJ1Y2tldHNba2V5XSB8fCBbXSlcbiAgICAgICAgICAgICAgICAgICAgLm1hcCgoYnVja2V0KSA9PiBidWNrZXQuZmlsdGVyUXVlcnkpXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKCcgT1IgJyk7XG4gICAgICAgICAgICAgICAgaWYgKHN1YlF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICcgQU5EICc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IGAoJHtzdWJRdWVyeX0pYDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBmYWNldEZpZWxkcygpOiBSZXF1ZXN0RmFjZXRGaWVsZHMge1xuICAgICAgICBjb25zdCBmYWNldEZpZWxkcyA9IHRoaXMuY29uZmlnLmZhY2V0RmllbGRzICYmIHRoaXMuY29uZmlnLmZhY2V0RmllbGRzLmZpZWxkcztcblxuICAgICAgICBpZiAoZmFjZXRGaWVsZHMgJiYgZmFjZXRGaWVsZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBmYWNldHM6IGZhY2V0RmllbGRzLm1hcCgoZmFjZXQpID0+IDxSZXF1ZXN0RmFjZXRGaWVsZD4ge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZDogZmFjZXQuZmllbGQsXG4gICAgICAgICAgICAgICAgICAgIG1pbmNvdW50OiBmYWNldC5taW5jb3VudCxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGZhY2V0LmxhYmVsLFxuICAgICAgICAgICAgICAgICAgICBsaW1pdDogZmFjZXQubGltaXQsXG4gICAgICAgICAgICAgICAgICAgIG9mZnNldDogZmFjZXQub2Zmc2V0LFxuICAgICAgICAgICAgICAgICAgICBwcmVmaXg6IGZhY2V0LnByZWZpeFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufVxuIl19